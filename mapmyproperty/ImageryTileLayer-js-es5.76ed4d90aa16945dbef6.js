!function(){function e(t,r,n){return(e="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=m(e)););return e}(e,t);if(n){var a=Object.getOwnPropertyDescriptor(n,t);return a.get?a.get.call(r):a.value}})(t,r,n||t)}function t(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=e&&("undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]);if(null==r)return;var n,a,i=[],o=!0,s=!1;try{for(r=r.call(e);!(o=(n=r.next()).done)&&(i.push(n.value),!t||i.length!==t);o=!0);}catch(l){s=!0,a=l}finally{try{o||null==r.return||r.return()}finally{if(s)throw a}}return i}(e,t)||function(e,t){if(!e)return;if("string"==typeof e)return r(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return r(e,t)}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function a(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?n(Object(r),!0).forEach((function(t){i(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):n(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function i(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function o(e,t,r,n,a,i,o){try{var s=e[i](o),l=s.value}catch(u){return void r(u)}s.done?t(l):Promise.resolve(l).then(n,a)}function s(e){return function(){var t=this,r=arguments;return new Promise((function(n,a){var i=e.apply(t,r);function s(e){o(i,n,a,s,l,"next",e)}function l(e){o(i,n,a,s,l,"throw",e)}s(void 0)}))}}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function u(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function c(e,t,r){return t&&u(e.prototype,t),r&&u(e,r),e}function f(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}function p(e,t){return(p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=m(e);if(t){var a=m(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return d(this,r)}}function d(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function m(e){return(m=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{mRf7:function(r,n,i){"use strict";i.r(n);var o=i("pO5D"),u=(i("wSAH"),i("srIe")),p=i("6S2I"),d=i("zqDF"),y=i("WbKI"),b=i("+opI"),v=i("RI0u"),g=i("r88o"),x=i("04ZG"),w=i("zlDU"),O=i("4EHJ"),k=(i("ju1D"),i("9AIY"),i("SFah")),I=i("pqNC"),j=i("5pQd"),R=i("IvSi"),S=i("uRH/"),T=i("ukD5"),C=i("ofM5"),_=i("mXvl"),M=i("DbUH"),P=i("jhcG"),F=i("WmKv"),D=i("9Ruv"),B=i("Stxv"),N=i("f4Nx"),H=i("WZb1"),E=i("OvF4"),z=(i("4GrV"),i("Lqtk")),L=i("VLTf"),A=i("3/ME"),J=i("tidM"),q=i("2mvb"),U=i("HM2S"),W=i("ciAr"),G=p.a.getLogger("esri.layers.mixins.ImageryTileMixin"),V=i("SuVq"),Y=i("8prj"),X=i("pPNP"),K=i("ag7Y"),Z=function(e){f(r,e);var t=h(r);function r(){var e;return l(this,r),(e=t.apply(this,arguments)).blockWidth=void 0,e.blockHeight=void 0,e.compression=null,e.origin=null,e.firstPyramidLevel=null,e.maximumPyramidLevel=null,e.pyramidScalingFactor=2,e.pyramidBlockWidth=null,e.pyramidBlockHeight=null,e.isVirtualTileInfo=!1,e.tileInfo=null,e.blockBoundary=null,e}return r}(K.a);Object(o.a)([Object(y.b)({type:Number,json:{write:!0}})],Z.prototype,"blockWidth",void 0),Object(o.a)([Object(y.b)({type:Number,json:{write:!0}})],Z.prototype,"blockHeight",void 0),Object(o.a)([Object(y.b)({type:String,json:{write:!0}})],Z.prototype,"compression",void 0),Object(o.a)([Object(y.b)({type:V.a,json:{write:!0}})],Z.prototype,"origin",void 0),Object(o.a)([Object(y.b)({type:Number,json:{write:!0}})],Z.prototype,"firstPyramidLevel",void 0),Object(o.a)([Object(y.b)({type:Number,json:{write:!0}})],Z.prototype,"maximumPyramidLevel",void 0),Object(o.a)([Object(y.b)()],Z.prototype,"pyramidScalingFactor",void 0),Object(o.a)([Object(y.b)({type:Number,json:{write:!0}})],Z.prototype,"pyramidBlockWidth",void 0),Object(o.a)([Object(y.b)({type:Number,json:{write:!0}})],Z.prototype,"pyramidBlockHeight",void 0),Object(o.a)([Object(y.b)({type:Boolean,json:{write:!0}})],Z.prototype,"isVirtualTileInfo",void 0),Object(o.a)([Object(y.b)({json:{write:!0}})],Z.prototype,"tileInfo",void 0),Object(o.a)([Object(y.b)()],Z.prototype,"blockBoundary",void 0);var $=Z=Object(o.a)([Object(x.a)("esri.layers.support.RasterStorageInfo")],Z),Q=i("9MzC"),ee=i("+rMe"),te=i("FFFX"),re=i("ne7T"),ne=i("tODX"),ae=i("IYxN"),ie=function(e){f(x,e);var r,n,i,o,d,m,y,b,v,g=h(x);function x(){var e;return l(this,x),(e=g.apply(this,arguments)).rasterJobHandler=null,e.datasetName=null,e.datasetFormat=null,e.rasterInfo=null,e.ioConfig={sampling:"closest"},e}return c(x,[{key:"init",value:(v=s(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=Object(ne.d)(),this.addResolvingPromise(t),e.next=4,this.when();case 4:case"end":return e.stop()}}),e,this)}))),function(){return v.apply(this,arguments)})},{key:"normalizeCtorArgs",value:function(e){return e&&e.ioConfig&&(e=a(a({},e),{},{ioConfig:a({resolution:null,bandIds:null,sampling:"closest",tileInfo:A.a.create()},e.ioConfig)})),e}},{key:"url",set:function(e){this._set("url",Object(L.g)(e,p.a.getLogger(this.declaredClass)))}},{key:"open",value:(b=s(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new w.a("BaseRaster:open-not-implemented","open() is not implemented");case 1:case"end":return e.stop()}}),e)}))),function(e){return b.apply(this,arguments)})},{key:"fetchTile",value:(y=s(regeneratorRuntime.mark((function e(t,r,n){var i,o,s,l,c,f=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=f.length>3&&void 0!==f[3]?f[3]:{},s=i.tileInfo,l=s.lodAt(t),c=this.getTileExtent({x:l.resolution,y:l.resolution},r,n,s.origin,s.spatialReference,s.size),e.abrupt("return",(null!=(o=i.multidimensionalDefinition)&&o.length&&Object(u.k)(this.rasterInfo.multidimensionalInfo)&&null==i.sliceId&&(i=a(a({},i),{},{sliceId:this.getSliceIndex(i.multidimensionalDefinition)||0})),this.fetchPixels(c,s.size[0],s.size[1],i)));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return y.apply(this,arguments)})},{key:"identify",value:(m=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s,l,c,f,p,h,d,m,y,b,v,g,x,w=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=w.length>1&&void 0!==w[1]?w[1]:{},n=this.rasterInfo,a=n.spatialReference,i=n.extent,o=r.datumTransformation,s=Object(ne.f)(t,a,o),i.intersects(s)){e.next=5;break}return e.abrupt("return",{location:s,value:null});case 5:if(!Object(u.k)(this.rasterInfo.transform)){e.next=10;break}if(l=this.rasterInfo.transform.inverseTransform(s),this.rasterInfo.nativeExtent.intersects(l)){e.next=9;break}return e.abrupt("return",{location:l,value:null});case 9:s=l;case 10:if(c=0,!r.srcResolution){e.next=15;break}c=Object(ne.h)(r.srcResolution,this.rasterInfo,this.ioConfig.sampling).pyramidLevel,e.next=20;break;case 15:return e.next=17,this.computeBestPyramidLevelForLocation(t,r);case 17:if(null!=(c=e.sent)){e.next=20;break}return e.abrupt("return",{location:s,value:null});case 20:if(null!==(f=this.identifyPixelLocation(s,c,null))){e.next=23;break}return e.abrupt("return",{location:s,value:null});case 23:return p=f.row,h=f.col,d=f.rowOffset,m=f.colOffset,y=Object(ae.d)(this.url,r.sliceId),b="".concat(c,"/").concat(p,"/").concat(h),v=Object(ae.c)(y,null,b),Object(u.k)(v)||(v=this.fetchRawTile(c,p,h,r),Object(ae.e)(y,null,b,v)),e.next=28,v;case 28:if((g=e.sent)&&g.pixels&&g.pixels.length>0){e.next=31;break}return e.abrupt("return",{location:s,value:null});case 31:return x=d*this.rasterInfo.storageInfo.blockHeight+m,e.abrupt("return",{location:s,value:!g.mask||g.mask[x]?g.pixels.map((function(e){return e[x]})):null,pyramidLevel:c});case 33:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)})},{key:"fetchPixels",value:(d=s(regeneratorRuntime.mark((function e(t,r,n){var a,i,o,s,l,c,f,p,h,d,m,y,b,v,g,x,w,O,k,I,j,R,S,T,C,_=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=_.length>3&&void 0!==_[3]?_[3]:{},i=t.clone().normalize(),o=this.rasterInfo.spatialReference,s=!(t=i[0]).spatialReference.equals(o),l=a.datumTransformation,c=new V.a({x:(t.xmax-t.xmin)/r,y:(t.ymax-t.ymin)/n,spatialReference:t.spatialReference}),f=a.srcResolution||(s?Object(ne.g)(c,o,t,l):c)){e.next=4;break}return e.abrupt("return",null);case 4:if(p=Object(ne.h)(f,this.rasterInfo,this.ioConfig.sampling),h=p.pyramidLevel,d=p.pyramidResolution,!p.excessiveReading){e.next=7;break}return e.abrupt("return",null);case 7:if(m=this.rasterInfo.storageInfo,y=s?Object(ne.e)(t,o,l):t,(b=Object(u.q)(this.rasterInfo.transform))&&(y=b.inverseTransform(y)),null!=y){e.next=12;break}return e.abrupt("return",null);case 12:if(v={x:Math.floor((y.xmin-m.origin.x)/d.x+.1),y:Math.floor((m.origin.y-y.ymax)/d.y+.1)},g=Math.ceil((y.xmax-y.xmin)/d.x-.1),x=Math.ceil((y.ymax-y.ymin)/d.y-.1),!(g/r>8||x/n>8)){e.next=15;break}return e.abrupt("return",null);case 15:return e.next=17,this.fetchRawPixels(h,v,{width:g,height:x},a);case 17:if(w=e.sent){e.next=20;break}return e.abrupt("return",null);case 20:if(s||1!==w.pixelBlocks.length||(h>0?m.pyramidBlockWidth:m.blockWidth)!==r||(h>0?m.pyramidBlockHeight:m.blockHeight)!==n||f.x!==c.x||f.y!==c.y){e.next=22;break}return e.abrupt("return",{extent:t,srcExtent:y,pixelBlock:w.pixelBlocks[0]});case 22:if(O=Object(ne.c)(t,w.extent,c,l,b),I=!a.requestRawData,j={rows:O.spacing[0],cols:O.spacing[1]},R=w.pixelBlocks,S=w.mosaicSize,T=w.isPartiallyFilled,!this.rasterJobHandler){e.next=30;break}return e.next=27,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:R,srcMosaicSize:S,destDimension:I?{width:r,height:n}:null,coefs:I?O.coefficients:null,sampleSpacing:I?j:null,interpolation:a.interpolation},a);case 27:k=e.sent,e.next=32;break;case 30:C=Object(re.j)(R,S),k=I?Object(re.a)(C,{width:r,height:n},O.coefficients,j,a.interpolation):C;case 32:return e.abrupt("return",a.requestRawData?{srcExtent:y,pixelBlock:k,transformGrid:O,extent:t,isPartiallyFilled:T}:{srcExtent:y,extent:t,pixelBlock:k});case 33:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return d.apply(this,arguments)})},{key:"fetchRawPixels",value:(o=s(regeneratorRuntime.mark((function e(t,r,n,a){var i,o,s,l,u,c,f,p,h,d,m,y,b,v,g,x,w,O,k,I,j,R,S,T,C,_,M,P,F,D,B;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this.rasterInfo.storageInfo,o=i.origin,s=i.blockBoundary,l=this.getBlockWidthHeight(t),u=l.blockWidth,c=l.blockHeight,f=r.x,p=r.y,h=n.width,d=n.height,a.buffer&&(f-=a.buffer.cols,p-=a.buffer.rows,h+=2*a.buffer.cols,d+=2*a.buffer.rows),m=Math.floor(f/u),y=Math.floor(p/c),b=Math.floor((f+h-1)/u),v=Math.floor((p+d-1)/c),g=s[t]){e.next=6;break}return e.abrupt("return",null);case 6:if(x=g.minRow,w=g.minCol,O=g.maxCol,k=g.maxRow,!(v<x||b<w||y>k||m>O)){e.next=9;break}return e.abrupt("return",null);case 9:for(I=[],R=!1,S=y;S<=v;S++)for(T=m;T<=b;T++)S>=x&&T>=w&&k>=S&&O>=T?(j=this._fetchRawTile(t,S,T,a),this.ioConfig.allowPartialFill&&(j=new Promise((function(e){j.then((function(t){return e(t)})).catch((function(){R=!0,e(null)}))}))),I.push(j)):I.push(null);if(0!==I.length){e.next=14;break}return e.abrupt("return",null);case 14:return e.next=16,Promise.all(I);case 16:return C=e.sent,_={height:(v-y+1)*u,width:(b-m+1)*c},M=this.rasterInfo,P=M.nativePixelSize,F=M.spatialReference,D=P.x*Math.pow(2,t),B=P.y*Math.pow(2,t),e.abrupt("return",{extent:new E.a({xmin:o.x+m*u*D,xmax:o.x+(b+1)*u*D,ymin:o.y-(v+1)*c*B,ymax:o.y-y*c*B,spatialReference:F}),pixelBlocks:C,mosaicSize:_,isPartiallyFilled:R});case 24:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return o.apply(this,arguments)})},{key:"fetchRawTile",value:(i=s(regeneratorRuntime.mark((function e(t,r,n,a){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new w.a("BaseRaster:read-not-implemented","fetchRawTile() is not implemented");case 1:case"end":return e.stop()}}),e)}))),function(e,t,r,n){return i.apply(this,arguments)})},{key:"computeExtent",value:function(e){return Object(ne.e)(this.rasterInfo.extent,e)}},{key:"decodePixelBlock",value:function(e,t){return!this.rasterJobHandler||t.useCanvas?Object(te.a)(e,t):this.rasterJobHandler.decode({data:e,options:t})}},{key:"request",value:(n=s(regeneratorRuntime.mark((function e(t,r,n){var i,o,s,l,u,c,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=this.ioConfig.customFetchParameters,l=r.range,u=r.query,c=r.headers,n=null!=(i=null!=(o=n)?o:r.retryCount)?i:this.ioConfig.retryCount,f=l?{Range:"bytes=".concat(l.from,"-").concat(l.to)}:null,e.prev=3,e.next=6,Object(z.default)(t,a(a({},r),{},{query:a(a({},u),s),headers:a(a({},c),f)}));case 6:return e.abrupt("return",e.sent);case 9:if(e.prev=9,e.t0=e.catch(3),!(n>0)){e.next=13;break}return e.abrupt("return",(n--,this.request(t,r,n)));case 13:throw e.t0;case 14:case"end":return e.stop()}}),e,this,[[3,9]])}))),function(e,t,r){return n.apply(this,arguments)})},{key:"getSliceIndex",value:function(e){var t=this,r=this.rasterInfo.multidimensionalInfo;if(!Object(u.k)(r)||null==e||!e.length)return null;for(var n=0,a=e[0].variableName,i=function(i){var o=r.variables[i],s=o.dimensions;if(o.name!==a)return n+=s.map((function(e){return t._getDimensionValuesCount(e)})).reduce((function(e,t){return e+t})),"break";for(var l=s.map((function(e){return t._getDimensionValuesCount(e)})),u=s.length,c=function(r){var a=e.filter((function(e){return e.dimensionName===s[r].name}))[0];if(null==a)return{v:{v:null}};var i=Array.isArray(a.values[0])?a.values[0][0]:a.values[0],o=t._getIndexFromDimensions(i,s[r]);if(-1===o)return{v:{v:null}};l.shift(),n+=r===u-1?o:o*l.reduce((function(e,t){return e+t}))},f=0;f<u;f++){var p=c(f);if("object"==typeof p)return p.v}},o=0;o<r.variables.length;o++){var s=i(o);if("break"===s)break;if("object"==typeof s)return s.v}return n}},{key:"updateTileInfo",value:function(){var e=this.rasterInfo,t=e.storageInfo,r=e.spatialReference,n=e.extent,a=e.pixelSize;if(!t.tileInfo){for(var i=[],o=t.maximumPyramidLevel||0,s=Math.max(a.x,a.y),l=1/.0254*96*s,u=0;u<=o;u++)i.push({level:o-u,resolution:s,scale:l}),s*=2,l*=2;var c=new V.a({x:n.xmin,y:n.ymax,spatialReference:r});t.tileInfo=new A.a({origin:c,size:[t.blockWidth,t.blockHeight],spatialReference:r,lods:i}),t.isVirtualTileInfo=!0}}},{key:"createRemoteDatasetStorageInfo",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:512,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:512,n=arguments.length>3?arguments[3]:void 0,a=e.width,i=e.height,o=e.nativeExtent,s=e.pixelSize,l=e.spatialReference,u=new V.a({x:o.xmin,y:o.ymax,spatialReference:l});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(a,i))/Math.LN2-8)));var c=this._computeBlockBoundary(o,s,n,512,512);e.storageInfo=new $({blockWidth:t,blockHeight:r,pyramidBlockWidth:t,pyramidBlockHeight:r,origin:u,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:c})}},{key:"computeBestPyramidLevelForLocation",value:(r=s(regeneratorRuntime.mark((function e(t){var r=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.length>1&&void 0!==r[1]&&r[1],e.abrupt("return",0);case 2:case"end":return e.stop()}}),e)}))),function(e){return r.apply(this,arguments)})},{key:"identifyPixelLocation",value:function(e,t,r){var n=this.rasterInfo,a=n.spatialReference,i=n.nativePixelSize,o=n.nativeExtent,s=this.rasterInfo.storageInfo,l=s.blockWidth,u=s.blockHeight,c=s.maximumPyramidLevel,f=s.pyramidScalingFactor,p=s.origin,h=Object(ne.f)(e,a,r);if(!o.intersects(h))return null;if(t<0||t>c)return null;var d=Math.pow(f,t),m=(p.y-h.y)/(d*i.y)/u,y=(h.x-p.x)/(d*i.x)/l,b=Math.min(u-1,Math.floor((m-Math.floor(m))*u)),v=Math.min(l-1,Math.floor((y-Math.floor(y))*l));return{pyramidLevel:t,row:Math.floor(m),col:Math.floor(y),rowOffset:b,colOffset:v,srcLocation:h}}},{key:"getTileExtent",value:function(e,r,n,a,i,o){var s=t(o,2),l=s[0],u=s[1],c=a.x+n*l*e.x,f=a.y-r*u*e.y;return new E.a({xmin:c,xmax:c+l*e.x,ymin:f-u*e.y,ymax:f,spatialReference:i})}},{key:"getBlockWidthHeight",value:function(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}},{key:"isBlockOutside",value:function(e,t,r){var n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<r||n.minRow>t||n.minCol>r}},{key:"_computeBlockBoundary",value:function(e,t,r,n,a){var i=t.x,o=t.y,s=e.xmin,l=e.ymax,u=[{minCol:Math.floor((e.xmin-s+.1*i)/n/i),maxCol:Math.floor((e.xmax-s-.1*i)/n/i),minRow:Math.floor((l-e.ymax+.1*o)/a/o),maxRow:Math.floor((l-e.ymin-.1*o)/a/o)}];if(r>0)for(var c=0;c<r;c++)i*=2,o*=2,u.push({minCol:Math.floor((e.xmin-s+.1*i)/n/i),maxCol:Math.floor((e.xmax-s-.1*i)/n/i),minRow:Math.floor((l-e.ymax+.1*o)/a/i),maxRow:Math.floor((l-e.ymin-.1*o)/a/i)});return u}},{key:"_fetchRawTile",value:function(e,t,r,n){var i=this.rasterInfo.storageInfo.blockBoundary[e];if(!i)return Promise.resolve(null);var o=i.minRow,s=i.minCol,l=i.maxCol,c=i.maxRow;if(t<o||r<s||t>c||r>l)return Promise.resolve(null);var f=Object(ae.d)(this.url,n.sliceId),p="".concat(e,"/").concat(t,"/").concat(r),h=Object(ae.c)(f,n.registryId,p);if(!Object(u.k)(h)){var d=Object(Q.d)();h=this.fetchRawTile(e,t,r,a(a({},n),{},{signal:d.signal})),Object(ae.e)(f,n.registryId,p,h,d),h.catch((function(){Object(ae.b)(f,n.registryId,p)}))}return n.signal&&Object(Q.p)(n,(function(){Object(ae.a)(f,n.registryId,p)})),h}},{key:"_getIndexFromDimensions",value:function(e,t){var r=t.extent,n=t.interval,a=t.unit,i=t.values;if(null!=i&&i.length)return Array.isArray(i[0])?i.findIndex((function(t){return t[0]<=e&&t[1]>=e})):i.indexOf(e);if(e>r[1])return-1;var o=r[0],s=-1;if("ISO8601"===a){var l;switch((null==(l=t.intervalUnit)?void 0:l.toLowerCase())||"seconds"){case"seconds":s=Math.round((e-o)/1e3/n);break;case"minutes":s=Math.round((e-o)/6e4/n);break;case"hours":s=Math.round((e-o)/36e5/n);break;case"days":s=Math.round((e-o)/864e5/n);break;case"years":s=Math.round((new Date(e).getUTCFullYear()-new Date(o).getUTCFullYear())/n);break;case"decades":s=Math.round((new Date(e).getUTCFullYear()-new Date(o).getUTCFullYear())/10/n)}return s}return Math.round((e-o)/n)}},{key:"_getDimensionValuesCount",value:function(e){var t=e.extent,r=e.interval,n=e.unit,a=e.values,i=(null==a?void 0:a.length)||0;if(i)return i;var o=t[0];if(0===i&&"ISO8601"===n){var s;switch((null==(s=e.intervalUnit)?void 0:s.toLowerCase())||"seconds"){case"seconds":i=Math.round((t[1]-t[0])/1e3/r);break;case"minutes":i=Math.round((t[1]-t[0])/6e4/r);break;case"hours":i=Math.round((t[1]-t[0])/36e5/r);break;case"days":i=Math.round((t[1]-t[0])/864e5/r);break;case"years":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(o).getUTCFullYear())/r);break;case"decades":i=Math.round((new Date(t[1]).getUTCFullYear()-new Date(o).getUTCFullYear())/10/r)}return i}return Math.round((t[1]-t[0])/r)}}]),x}(Object(ee.b)(K.a));Object(o.a)([Object(y.b)(R.n)],ie.prototype,"url",null),Object(o.a)([Object(y.b)({type:String,json:{write:!0}})],ie.prototype,"datasetName",void 0),Object(o.a)([Object(y.b)({type:String,json:{write:!0}})],ie.prototype,"datasetFormat",void 0),Object(o.a)([Object(y.b)()],ie.prototype,"rasterInfo",void 0),Object(o.a)([Object(y.b)()],ie.prototype,"ioConfig",void 0),Object(o.a)([Object(y.b)()],ie.prototype,"sourceJSON",void 0);var oe=ie=Object(o.a)([Object(x.a)("esri.layers.support.rasterDatasets.BaseRaster")],ie),se=i("dCrW");function le(e){var t=e.fields,r=e.records,n=t.some((function(e){return"oid"===e.name.toLowerCase()}))?"OBJECTID":"OID",a=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map((function(e){return{name:e.name,type:"esriFieldType"+e.typeName,alias:e.name}}))),i=a.map((function(e){return e.name})),o=[],s=0,l=0;return r.forEach((function(e){var t={};for(t[n]=s++,l=1;l<i.length;l++)t[i[l]]=e[l-1];o.push({attributes:t})})),{displayFieldName:"",fields:a,features:o}}var ue=function(e){f(r,e);var t=h(r);function r(){var e;return l(this,r),(e=t.apply(this,arguments)).type="identity",e}return c(r,[{key:"forwardTransform",value:function(e){return e}},{key:"inverseTransform",value:function(e){return e}}]),r}(K.a);Object(o.a)([Object(y.b)({json:{write:!0}})],ue.prototype,"spatialReference",void 0),Object(o.a)([Object(v.a)({IdentityXform:"identity"})],ue.prototype,"type",void 0);var ce=ue=Object(o.a)([Object(x.a)("esri.layers.support.rasterTransforms.IdentityTransform")],ue),fe=i("Cduq");function pe(e,t,r){var n=t.x,a=t.y;if(r<2)return{x:e[0]+n*e[2]+a*e[4],y:e[1]+n*e[3]+a*e[5]};if(2===r){var i=n*n,o=a*a,s=n*a;return{x:e[0]+n*e[2]+a*e[4]+i*e[6]+s*e[8]+o*e[10],y:e[1]+n*e[3]+a*e[5]+i*e[7]+s*e[9]+o*e[11]}}var l=n*n,u=a*a,c=n*a,f=l*n,p=l*a,h=n*u,d=a*u;return{x:e[0]+n*e[2]+a*e[4]+l*e[6]+c*e[8]+u*e[10]+f*e[12]+p*e[14]+h*e[16]+d*e[18],y:e[1]+n*e[3]+a*e[5]+l*e[7]+c*e[9]+u*e[11]+f*e[13]+p*e[15]+h*e[17]+d*e[19]}}function he(e,t,r){var n=t.xmin,a=t.ymin,i=t.xmax,o=t.ymax,s=t.spatialReference,l=[];if(r<2)l.push({x:n,y:o}),l.push({x:i,y:o}),l.push({x:n,y:a}),l.push({x:i,y:a});else{for(var u=10,c=0;c<u;c++)l.push({x:n,y:a+(o-a)*c/(u-1)}),l.push({x:i,y:a+(o-a)*c/(u-1)});u=8;for(var f=1;f<=u;f++)l.push({x:n+(i-n)*f/u,y:a}),l.push({x:n+(i-n)*f/u,y:o})}var p=(l=l.map((function(t){return pe(e,t,r)}))).map((function(e){return e.x})),h=l.map((function(e){return e.y}));return new E.a({xmin:Math.min.apply(null,p),xmax:Math.max.apply(null,p),ymin:Math.min.apply(null,h),ymax:Math.max.apply(null,h),spatialReference:s})}var de=function(e){f(n,e);var r=h(n);function n(){var e;return l(this,n),(e=r.apply(this,arguments)).polynomialOrder=1,e.type="polynomial",e}return c(n,[{key:"readForwardCoefficients",value:function(e,t){var r=t.coeffX,n=t.coeffY;if(null==r||!r.length||null==n||!n.length||r.length!==n.length)return null;for(var a=[],i=0;i<r.length;i++)a.push(r[i]),a.push(n[i]);return a}},{key:"writeForwardCoefficients",value:function(e,t,r){for(var n=[],a=[],i=0;i<(null==e?void 0:e.length);i++)i%2==0?n.push(e[i]):a.push(e[i]);t.coeffX=n,t.coeffY=a}},{key:"inverseCoefficients",get:function(){var e=this._get("inverseCoefficients"),r=this._get("forwardCoefficients");return!e&&r&&this.polynomialOrder<2&&(e=function(e){var r=t(e,6),n=r[0],a=r[1],i=r[2],o=r[3],s=r[4],l=r[5],u=i*l-s*o,c=s*o-i*l;return[(s*a-n*l)/u,(i*a-n*o)/c,l/u,o/c,-s/u,-i/c]}(r)),e},set:function(e){this._set("inverseCoefficients",e)}},{key:"readInverseCoefficients",value:function(e,t){var r=t.inverseCoeffX,n=t.inverseCoeffY;if(null==r||!r.length||null==n||!n.length||r.length!==n.length)return null;for(var a=[],i=0;i<r.length;i++)a.push(r[i]),a.push(n[i]);return a}},{key:"writeInverseCoefficients",value:function(e,t,r){for(var n=[],a=[],i=0;i<(null==e?void 0:e.length);i++)i%2==0?n.push(e[i]):a.push(e[i]);t.inverseCoeffX=n,t.inverseCoeffY=a}},{key:"forwardTransform",value:function(e){if("point"===e.type){var t=pe(this.forwardCoefficients,e,this.polynomialOrder);return new V.a({x:t.x,y:t.y,spatialReference:e.spatialReference})}return he(this.forwardCoefficients,e,this.polynomialOrder)}},{key:"inverseTransform",value:function(e){if("point"===e.type){var t=pe(this.inverseCoefficients,e,this.polynomialOrder);return new V.a({x:t.x,y:t.y,spatialReference:e.spatialReference})}return he(this.inverseCoefficients,e,this.polynomialOrder)}}]),n}(K.a);Object(o.a)([Object(y.b)({json:{write:!0}})],de.prototype,"polynomialOrder",void 0),Object(o.a)([Object(y.b)()],de.prototype,"forwardCoefficients",void 0),Object(o.a)([Object(g.a)("forwardCoefficients",["coeffX","coeffY"])],de.prototype,"readForwardCoefficients",null),Object(o.a)([Object(fe.a)("forwardCoefficients")],de.prototype,"writeForwardCoefficients",null),Object(o.a)([Object(y.b)({json:{write:!0}})],de.prototype,"inverseCoefficients",null),Object(o.a)([Object(g.a)("inverseCoefficients",["inverseCoeffX","inverseCoeffY"])],de.prototype,"readInverseCoefficients",null),Object(o.a)([Object(fe.a)("inverseCoefficients")],de.prototype,"writeInverseCoefficients",null),Object(o.a)([Object(y.b)({json:{write:!0}})],de.prototype,"spatialReference",void 0),Object(o.a)([Object(v.a)({PolynomialXform:"polynomial"})],de.prototype,"type",void 0);var me=de=Object(o.a)([Object(x.a)("esri.layers.support.rasterTransforms.PolynomialTransform")],de),ye={PolynomialXform:me,IdentityXform:ce},be=Object.keys(ye),ve=new Map;ve.set("int16","esriFieldTypeSmallInteger"),ve.set("int32","esriFieldTypeInteger"),ve.set("int64","esriFieldTypeInteger"),ve.set("float32","esriFieldTypeSingle"),ve.set("float64","esriFieldTypeDouble"),ve.set("text","esriFieldTypeString");var ge=function(e){f(i,e);var t,r,n,a=h(i);function i(){var e;return l(this,i),(e=a.apply(this,arguments)).storageInfo=null,e.datasetFormat="CRF",e}return c(i,[{key:"open",value:(n=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this.request(this.url+"/conf.json",{signal:null==t?void 0:t.signal});case 4:if(r=e.sent,n=r.data,this._validateHeader(n)){e.next=8;break}throw new w.a("cloudraster:open","Invalid or unsupported conf.json.");case 8:if(this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),a=this._parseHeader(n),i=a.storageInfo,"thematic"!==(o=a.rasterInfo).dataType){e.next=15;break}return e.next=13,this._fetchAuxiliaryInformation();case 13:s=e.sent,o.attributeTable=s;case 15:this._set("storageInfo",i),this._set("rasterInfo",o),this.ioConfig.retryCount=this.ioConfig.retryCount||0;case 16:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"fetchRawTile",value:(r=s(regeneratorRuntime.mark((function e(t,r,n){var a,i,o,s,l,u,c,f,p=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=p.length>3&&void 0!==p[3]?p[3]:{},!((i=this.rasterInfo.storageInfo.maximumPyramidLevel-t)<0)){e.next=4;break}return e.abrupt("return",null);case 4:return o=this._buildCacheFilePath(i,r,n,a.multidimensionalDefinition),s=this._getIndexRecordFromBundle(r,n),e.next=8,this.request(o,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:a.signal});case 8:if(l=e.sent){e.next=11;break}return e.abrupt("return",null);case 11:if(u=new Uint8Array(l.data),0!==(c=this._getTileEndAndContentType(u,s)).recordSize){e.next=14;break}return e.abrupt("return",null);case 14:return e.next=16,this.request(o,{range:{from:c.position,to:c.position+c.recordSize},responseType:"array-buffer",signal:a.signal});case 16:return f=e.sent,e.abrupt("return",f?this.decodePixelBlock(f.data,{width:this.rasterInfo.storageInfo.tileInfo.size[0],height:this.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null}):null);case 18:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"_validateHeader",value:function(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((function(t){return!e[t]}))}},{key:"_parseHeader",value:function(e){var t,r,n=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],a=e.bandCount,i=e.histograms,o=e.colormap,s=e.blockWidth,l=e.blockHeight,u=e.firstPyramidLevel,c=e.maximumPyramidLevel,f=e.statistics&&e.statistics.map((function(e){return{min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}})),p=e.extent.spatialReference,h=null==(t=e.geodataXform)?void 0:t.spatialReference,d=new H.a(null!=p&&p.wkid||null!=p&&p.wkt?p:h),m=new E.a({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:d}),y=new V.a({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:d}),b=Math.round((m.xmax-m.xmin)/y.x),v=Math.round((m.ymax-m.ymin)/y.y),g=this._parseTransform(e.geodataXform),x=g?m:null;g&&(m=g.forwardTransform(m),y.x=(m.xmax-m.xmin)/b,y.y=(m.ymax-m.ymin)/v);var w,O,k,I,j=null!=(r=e.properties)?r:{},R=e.format.toLowerCase().replace("cache/",""),S=new V.a(e.origin.x,e.origin.y,d);if(o&&o.colors)for(w=[],O=0;O<o.colors.length;O++)k=o.colors[O],I=o.values?o.values[O]:O,w.push([I,255&k,k<<16>>>24,k<<8>>>24,k>>>24]);var T=e.LODInfos,C=[];for(O=0;O<T.levels.length;O++)C.push({level:T.levels[O],resolution:T.resolutions[O],scale:96/.0254*T.resolutions[O]});var _=new A.a({dpi:96,lods:C,format:R,origin:S,size:[s,l],spatialReference:d}),M={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},P=[{maxCol:Math.ceil(b/s)-1,maxRow:Math.ceil(v/l)-1,minCol:0,minRow:0}],F=2;if(c>0)for(O=0;O<c;O++)P.push({maxCol:Math.ceil(b/F/s)-1,maxRow:Math.ceil(v/F/l)-1,minCol:0,minRow:0}),F*=2;return{storageInfo:M,rasterInfo:new X.a({width:b,height:v,pixelType:n,bandCount:a,extent:m,nativeExtent:x,transform:g,spatialReference:d,pixelSize:y,keyProperties:j,statistics:f,histograms:i,multidimensionalInfo:e.mdInfo,colormap:w,storageInfo:new $({blockWidth:s,blockHeight:l,pyramidBlockWidth:s,pyramidBlockHeight:l,origin:S,tileInfo:_,firstPyramidLevel:u,maximumPyramidLevel:c,blockBoundary:P})})}}},{key:"_parseTransform",value:function(e){var t,r,n;if((n=e)&&!be.includes(null==n?void 0:n.type))throw new w.a("cloudraster:open","the data contains unsupported geodata transform types");var a=function(e){if(!(null==e?void 0:e.type))return null;var t=ye[null==e?void 0:e.type];if(t){var r=new t;return r.read(e),r}return null}(e);if("identity"===a.type)return null;if(null==(t=a.forwardCoefficients)||!t.length||null==(r=a.inverseCoefficients)||!r.length)throw new w.a("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return a}},{key:"_fetchAuxiliaryInformation",value:(t=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s,u;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.request(this.url+"/conf.vat.json",{signal:t}).then((function(e){return e.data})).catch((function(){return null})),n=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:t}).then((function(e){return e.data})).catch((function(){return null})),e.next=4,Promise.all([r,n]);case 4:return(a=e.sent)[0]&&(o=a[0].fields,s=a[0].values,o&&s&&(o=o.map((function(e){return{type:"OID"===e.name?"esriFieldTypeOID":ve.get(e.type),name:e.name,alias:e.alias||e.name}})),u=s.map((function(e){return{attributes:e}})),o&&s&&(i={fields:o,features:u}))),e.abrupt("return",(!i&&a[1]&&(i=function(){function e(){l(this,e)}return c(e,null,[{key:"supportedVersions",get:function(){return[5]}},{key:"parse",value:function(e){var t=new DataView(e),r=3&t.getUint8(0);if(3!==r)return{header:{version:r},recordSet:null};var n,a=t.getUint32(4,!0),i=t.getUint16(8,!0),o=t.getUint16(10,!0),s={version:r,recordCount:a,headerByteCount:i,recordByteCount:o},l=32,u=[],c=[];if(3===r){for(;13!==t.getUint8(l);)n=String.fromCharCode(t.getUint8(l+11)).trim(),u.push({name:Object(se.a)(new Uint8Array(e,l,11)),type:n,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(n)],length:t.getUint8(l+16)}),l+=32;if(l+=1,u.length>0)for(var f=function(){var r=[];32===t.getUint8(l)?(l+=1,u.forEach((function(t){if("C"===t.type)r.push(Object(se.a)(new Uint8Array(e,l,t.length)).trim());else if("N"===t.type)r.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim(),10));else if("F"===t.type)r.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim()));else if("D"===t.type){var n=String.fromCharCode.apply(null,new Uint8Array(e,l,t.length)).trim();r.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}l+=t.length})),c.push(r)):l+=o};c.length<a&&e.byteLength-l>o;)f()}return{header:s,fields:u,records:c,recordSet:le({fields:u,records:c})}}}]),e}().parse(a[1]).recordSet),Y.default.fromJSON(i)));case 7:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"_buildCacheFilePath",value:function(e,t,r,n){var a=this.storageInfo.packetSize,i=Math.floor(t/a)*a,o=Math.floor(r/a)*a,s="R"+this._toHexString4(i)+"C"+this._toHexString4(o),l="L";l+=e>=10?e.toString():"0"+e.toString();var c=this.rasterInfo.multidimensionalInfo,f=null==n?void 0:n[0];if(!Object(u.k)(c)||!f)return"".concat(this.url,"/_alllayers/").concat(l,"/").concat(s,".bundle");for(var p=c.variables.filter((function(e){return e.name===f.variableName}))[0].dimensions[0].values.indexOf(f.values[0]).toString(16),h=4-p.length,d=0;d<h;d++)p="0"+p;return p="S"+p,"".concat(this.url,"/_alllayers/").concat(f.variableName,"/").concat(p,"/").concat(l,"/").concat(s,".bundle")}},{key:"_getIndexRecordFromBundle",value:function(e,t){var r=this.storageInfo.packetSize,n=r*(e%r)+t%r;if(n<0)throw"Invalid level / row / col";return 20+n*this.storageInfo.recordSize+44}},{key:"_getTileEndAndContentType",value:function(e,t){var r,n=e.subarray(t,t+8),a=0;for(r=0;r<5;r++)a|=(255&n[r])<<8*r;var i=0xffffffffff&a;for(a=0,r=5;r<8;r++)a|=(255&n[r])<<8*(r-5);return{position:i,recordSize:0xffffffffff&a}}},{key:"_toHexString4",value:function(e){var t=e.toString(16);if(4!==t.length)for(var r=4-t.length;r-- >0;)t="0"+t;return t}}]),i}(oe);Object(o.a)([Object(y.b)({readOnly:!0})],ge.prototype,"storageInfo",void 0),Object(o.a)([Object(y.b)({type:String,json:{write:!0}})],ge.prototype,"datasetFormat",void 0);var xe=ge=Object(o.a)([Object(x.a)("esri.layers.support.rasterDatasets.CloudRaster")],ge),we=function(e){f(a,e);var t,r,n=h(a);function a(){var e;return l(this,a),(e=n.apply(this,arguments)).datasetFormat="MEMORY",e}return c(a,[{key:"open",value:(r=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s,l,u,c,f,p,h,d,m,y;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return n=this.data,a=n.pixelBlock,i=n.statistics,o=n.histograms,s=n.name,l=n.keyProperties,u=n.nativeExtent,c=n.transform,f=a.width,p=a.height,h=a.pixelType,d=this.data.extent||new E.a({xmin:-.5,ymin:.5,xmax:f-.5,ymax:p-.5,spatialReference:new H.a({wkid:3857})}),m=null!=(r=this.data.isPseudoSpatialReference)?r:!this.data.extent,y=new X.a({width:f,height:p,pixelType:h,extent:d,nativeExtent:u,transform:c,pixelSize:{x:d.width/f,y:d.height/p},spatialReference:d.spatialReference,bandCount:3,keyProperties:l||{},statistics:i,isPseudoSpatialReference:m,histograms:o}),this.createRemoteDatasetStorageInfo(y,512,512),this._set("rasterInfo",y),this.updateTileInfo(),e.next=8,this._buildInMemoryRaster(a,{width:512,height:512},t);case 8:this.datasetName=s,this.url="/InMemory/"+s;case 10:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"fetchRawTile",value:function(e,t,r){var n=this._pixelBlockTiles.get("".concat(e,"/").concat(t,"/").concat(r));return Promise.resolve(n)}},{key:"_buildInMemoryRaster",value:(t=s(regeneratorRuntime.mark((function e(t,r,n){var a,i,o,s,l,c,f,p;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this.rasterInfo.storageInfo.maximumPyramidLevel,i=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:t,tileSize:r,maximumPyramidLevel:a},n):Promise.resolve(Object(re.n)(t,r,a)),o=Object(u.k)(this.rasterInfo.statistics),s=Object(u.k)(this.rasterInfo.histograms),l=o&&s?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:t},n):Promise.resolve(Object(re.g)(t)),e.next=7,Object(Q.j)([i,l]);case 7:if((c=e.sent)[0].value||!c[1].value){e.next=10;break}throw new w.a("inmemory-raster:open","failed to build in memory raster");case 10:this._pixelBlockTiles=c[0].value,o||(this.rasterInfo.statistics=null==(f=c[1].value)?void 0:f.statistics),s&&(this.rasterInfo.histograms=null==(p=c[1].value)?void 0:p.histograms);case 11:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})}]),a}(oe);Object(o.a)([Object(y.b)({type:String,json:{write:!0}})],we.prototype,"datasetFormat",void 0),Object(o.a)([Object(y.b)()],we.prototype,"data",void 0);var Oe=we=Object(o.a)([Object(x.a)("esri.layers.support.rasterDatasets.InMemoryRaster")],we);function ke(e,t){if(!e||!t)return[];var r=t;t.indexOf("/")>-1?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=[];if(t){for(var a=ke(e,r),i=0;i<a.length;i++)ke(a[i],t).forEach((function(e){return n.push(e)}));return n}var o=e.getElementsByTagNameNS("*",r);if(!o||0===o.length)return[];for(var s=0;s<o.length;s++)n.push(o[s]||o.item[s]);return n}function Ie(e,t){if(!e||!t)return null;var r=t;t.indexOf("/")>-1?(r=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";var n=ke(e,r);return n.length>0?t?Ie(n[0],t):n[0]:null}function je(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=r?Ie(e,r):e;return n?(t=n.textContent||n.nodeValue)?t.trim():null:null}function Re(e,t){return function(e,t){for(var r,n=ke(e,t),a=[],i=0;i<n.length;i++)(r=n[i].textContent||n[i].nodeValue)&&(""!==(r=r.trim())&&a.push(r));return a}(e,t).map((function(e){return Number(e)}))}function Se(e,t){var r=je(e,t);return Number(r)}function Te(e,t){var r,n=null==e||null==(r=e.nodeName)?void 0:r.toLowerCase(),a=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===a}function Ce(e,t){if(!e||!t)return null;for(var r=[],n=0;n<e.length;n++)r.push(e[n]),r.push(t[n]);return r}function _e(e){if(!e)return null;var t=Number(e);if(!isNaN(t)&&0!==t)return new H.a({wkid:t});if(!(e=String(e)).startsWith("GEOGCS")&&!e.startsWith("PROJCS"))return null;var r=e.replace(/\]/g,"[").replace(/\"/g,"").split("[").map((function(e){return e.trim()})).filter((function(e){return""!==e})),n=r[r.length-1].split(",");return"EPSG"===n[0]&&e.endsWith('"]]')&&(t=Number(n[1]),!isNaN(t)&&0!==t)?new H.a({wkid:t}):new H.a({wkt:e})}function Me(e){var t;if("pamdataset"!==(null==e||null==(t=e.documentElement.tagName)?void 0:t.toLowerCase()))return{};var r={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((function(e){if(1===e.nodeType)if(Te(e,"SRS")){if(!r.spatialReference){var t=je(e);r.spatialReference=_e(t)}}else if(Te(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){var n=function(e){var t,r=Ie(e,"GeodataXform"),n=_e(Se(r,"SpatialReference/WKID")||je(r,"SpatialReference/WKT"));if("typens:PolynomialXform"!==r.getAttribute("xsi:type"))return{spatialReference:n,transform:null};var a=null!=(t=Se(r,"PolynomialOrder"))?t:1,i=Re(r,"CoeffX/Double"),o=Re(r,"CoeffY/Double"),s=Re(r,"InverseCoeffX/Double"),l=Re(r,"InverseCoeffY/Double"),u=Ce(i,o),c=Ce(s,l);return{spatialReference:n,transform:new me({spatialReference:n,polynomialOrder:a,forwardCoefficients:u,inverseCoefficients:c})}}(e),a=n.spatialReference,i=n.transform;r.transform=i,r.spatialReference||(r.spatialReference=a)}else ke(e,"MDI").forEach((function(e){return r.metadata[e.getAttribute("key")]=je(e)}));else if(Te(e,"PAMRasterBand")){var o=function(e){var t,r,n,a,i,o=Se(e,"NoDataValue"),s=Ie(e,"Histograms/HistItem"),l=Se(s,"HistMin"),u=Se(s,"HistMax"),c=Se(s,"BucketCount"),f=null==(t=je(s,"HistCounts"))?void 0:t.split("|").map((function(e){return Number(e)}));ke(e,"Metadata/MDI").forEach((function(e){var t,o=Number(null!=(t=e.textContent)?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":r=o;break;case"STATISTICS_MAXIMUM":n=o;break;case"STATISTICS_MEAN":a=o;break;case"STATISTICS_STDDEV":i=o}}));var p=Se(e,"Metadata/SourceBandIndex");return{noDataValue:o,histogram:null!=f&&f.length&&null!=r&&null!=n?{min:l,max:u,size:c||f.length,counts:f}:null,sourceBandIndex:p,statistics:null!=r&&null!=n?{min:r,max:n,avg:a,stddev:i}:null}}(e);null!=o.sourceBandIndex&&null==r.rasterBands[o.sourceBandIndex]?r.rasterBands[o.sourceBandIndex]=o:r.rasterBands.push(o)}}));var n=r.rasterBands;return n&&(r.statistics=n[0].statistics?n.map((function(e){return e.statistics})):null,r.histograms=n[0].histogram?n.map((function(e){return e.histogram})):null),r}var Pe=function(e){f(i,e);var t,r,n,a=h(i);function i(){return l(this,i),a.apply(this,arguments)}return c(i,[{key:"open",value:(n=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s,l,u,c,f,p,h,d;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return e.next=4,this._fetchData(t);case 4:return r=e.sent,e.next=7,this._fetchAuxiliaryData(t);case 7:return n=e.sent,a=n.spatialReference,i=n.statistics,o=n.histograms,s=n.transform,(l=!a)&&(a=new H.a({wkid:3857})),null!=o&&o.length&&null==i&&(i=Object(re.f)(o)),u=r.width,c=r.height,f=new E.a({xmin:-.5,ymin:.5-c,xmax:u-.5,ymax:.5,spatialReference:a}),p=s?s.forwardTransform(f):f,s&&((h=s.forwardCoefficients)&&0===h[1]&&0===h[2]&&(s=null,f=p)),d=new Oe({data:{extent:p,nativeExtent:f,transform:s,pixelBlock:r,statistics:i,histograms:o,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:l}}),e.next=22,d.open();case 22:this._set("rasterInfo",d.rasterInfo),this._inMemoryRaster=d;case 24:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"fetchRawTile",value:function(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{};return this._inMemoryRaster.fetchRawTile(e,t,r,n)}},{key:"_fetchData",value:(r=s(regeneratorRuntime.mark((function e(t){var r,n,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.request(this.url,{responseType:"array-buffer",signal:null==t?void 0:t.signal});case 2:if(r=e.sent,n=r.data,"JPG"===(a=Object(te.b)(n).toUpperCase())||"PNG"===a||"GIF"===a||"BMP"===a){e.next=7;break}throw new w.a("image-aux-raster:open","the data is not a supported format");case 7:return this._set("datasetFormat",a),e.next=10,this.decodePixelBlock(n,{format:"jpg",width:1,height:1,useCanvas:!0});case 10:return e.abrupt("return",e.sent);case 11:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"_fetchAuxiliaryData",value:(t=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s,l,c,f,p,h;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Object(u.q)(null==t?void 0:t.signal),i=null!=(r=this.ioConfig.skipExtensions)?r:[],o=i.indexOf("aux.xml")>-1?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:a}),s=this.datasetFormat,l="JPG"===s?"jgw":"PNG"===s?"pgw":"BMP"===s?"bpw":null,c=i.indexOf(l)>-1?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+l,{responseType:"text",signal:a}),e.next=8,Object(Q.j)([o,c]);case 8:if(f=e.sent,null==a||!a.aborted){e.next=11;break}throw Object(Q.e)();case 11:return(p=Me(null==(n=f[0].value)?void 0:n.data)).transform||(h=f[1].value?f[1].value.data.split("\n").slice(0,6).map((function(e){return Number(e)})):null,p.transform=6===(null==h?void 0:h.length)?new me({forwardCoefficients:[h[4],h[5],h[0],-h[1],h[2],-h[3]]}):null),e.abrupt("return",p);case 14:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),i}(oe);Object(o.a)([Object(y.b)({type:String,json:{write:!0}})],Pe.prototype,"datasetFormat",void 0);var Fe=Pe=Object(o.a)([Object(x.a)("esri.layers.support.rasterDatasets.ImageAuxRaster")],Pe),De=i("q2iW"),Be=i("llFo"),Ne=function(e){f(m,e);var r,n,a,i,o,p,d=h(m);function m(){var e;return l(this,m),(e=d.apply(this,arguments))._levelOffset=0,e._slices=null,e._tilemapCache=null,e.datasetFormat="RasterTileServer",e}return c(m,[{key:"open",value:(p=s(regeneratorRuntime.mark((function e(r){var n,a,i,o,s,l,c,f,p,h,d,m,y,b,v,g,x,k,I,j,R,S,T;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:if(n=r&&r.signal,!this.sourceJSON){e.next=7;break}e.t0={data:this.sourceJSON},e.next=10;break;case 7:return e.next=9,this.request(this.url,{query:{f:"json"},signal:n});case 9:e.t0=e.sent;case 10:if((a=e.t0).ssl&&(this.url=this.url.replace(/^http:/i,"https:")),i=a.data,this.sourceJSON=i,i){e.next=15;break}throw new w.a("imageserverraster:open","cannot initialize tiled image service, missing service info");case 15:if(i.tileInfo){e.next=17;break}throw new w.a("imageserverraster:open","use ImageryLayer to open non-tiled image services");case 17:return this._fixScaleInServiceInfo(),this.tileType=i.cacheType,null==this.tileType&&(this.tileType=["jpg","jpeg","png","png8","png24","png32","mixed"].indexOf(i.tileInfo.format.toLowerCase())>-1?"Map":"lerc"===i.tileInfo.format.toLowerCase()?"Elevation":"Raster"),this.datasetName=i.name.slice(i.name.indexOf("/")+1),e.next=20,this._fetchRasterInfo({signal:n});case 20:if(o=e.sent,Object(u.k)(o)){e.next=23;break}throw new w.a("image-server-raster:open","cannot initialize image service");case 23:if(s="Map"===this.tileType?Object(De.a)(i.tileInfo,i):A.a.fromJSON(i.tileInfo),l=o.extent,c=o.pixelSize,f=.5/o.width*c.x,d=s.lodAt(Math.max.apply(null,s.lods.map((function(e){return e.level})))),"Map"!==this.tileType&&0!==i.maxScale&&("Raster"===this.tileType?(p=s.lods.filter((function(e){return e.resolution===c.x}))[0])||(p=s.lods[s.lods.length-1]):(p=s.lods.filter((function(e){return Math.abs(e.scale-i.maxScale)<f}))[0])||(p=s.lods.filter((function(e){return e.scale>i.maxScale})).sort((function(e,t){return e.scale>t.scale?1:-1}))[0]),c.x=c.y=p.resolution,o.width=Math.ceil((l.xmax-l.xmin)/c.x-.1),o.height=Math.ceil((l.ymax-l.ymin)/c.y-.1)),p||(p=d),m=s.lodAt(Math.min.apply(null,s.lods.map((function(e){return e.level})))),"Map"===this.tileType?this._levelOffset=s.lods[0].level:0!==i.minScale&&"Elevation"===this.tileType&&(h=s.lods.filter((function(e){return Math.abs(e.scale-i.minScale)<f}))[0],this._levelOffset=h.level-m.level),h||(h=m),y=Math.max(c.x,c.y),(Math.abs(c.x-c.y)>f||!s.lods.some((function(e){return Math.abs(e.resolution-y)<f})))&&(c.x=c.y=p.resolution,o.width=Math.ceil((l.xmax-l.xmin)/c.x-.1),o.height=Math.ceil((l.ymax-l.ymin)/c.y-.1)),b=p.level-h.level,v=t(s.size,2),g=v[0],x=v[1],k=s.origin,I=c.x,j=c.y,R=[{minCol:Math.floor((l.xmin-k.x+.1*I)/g/I),maxCol:Math.floor((l.xmax-k.x-.1*I)/g/I),minRow:Math.floor((k.y-l.ymax+.1*j)/x/j),maxRow:Math.floor((k.y-l.ymin-.1*j)/x/j)}],b>0)for(S=0;S<b;S++)I*=2,j*=2,R.push({minCol:Math.floor((l.xmin-k.x+.1*I)/g/I),maxCol:Math.floor((l.xmax-k.x-.1*I)/g/I),minRow:Math.floor((k.y-l.ymax+.1*j)/x/I),maxRow:Math.floor((k.y-l.ymin-.1*j)/x/I)});o.storageInfo=new $({blockWidth:s.size[0],blockHeight:s.size[1],pyramidBlockWidth:s.size[0],pyramidBlockHeight:s.size[1],compression:s.format,origin:s.origin,firstPyramidLevel:1,maximumPyramidLevel:b,tileInfo:s,blockBoundary:R}),this._set("rasterInfo",o),i.capabilities.toLowerCase().indexOf("tilemap")>-1&&(T={tileInfo:o.storageInfo.tileInfo,parsedUrl:Object(O.J)(this.url),url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new Be.a({layer:T}));case 36:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"fetchRawTile",value:(o=s(regeneratorRuntime.mark((function e(t,r,n){var a,i,o,s,l,u,c,f,p,h,d,m,y,b,v,g,x,w,O,k,I,j,R,S=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=S.length>3&&void 0!==S[3]?S[3]:{},i=this.rasterInfo,o=i.storageInfo,s=i.extent,l=i.pixelSize,u="".concat(this.url,"/tile/").concat(o.maximumPyramidLevel-t+this._levelOffset,"/").concat(r,"/").concat(n),c=this._slices?{sliceId:a.sliceId||0}:null,e.next=9,this.request(u,{query:c,responseType:"array-buffer",signal:a.signal});case 9:if(f=e.sent,p=f.data){e.next=13;break}return e.abrupt("return",null);case 13:return e.next=15,this.decodePixelBlock(p,{width:o.tileInfo.size[0],height:o.tileInfo.size[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType});case 15:if(h=e.sent,d=o.blockBoundary[t],!("jpg"!==o.compression||n>d.minCol&&n<d.maxCol&&r>d.minRow&&r<d.maxRow)){e.next=19;break}return e.abrupt("return",h);case 19:return m=o.origin,y=o.blockWidth,b=o.blockHeight,v=Math.pow(2,t),g=Math.round((s.xmin-m.x)/(l.x*v))%y,x=Math.round((s.xmax-m.x)/(l.x*v))%y,w=Math.round((m.y-s.ymax)/(l.x*v))%b,O=Math.round((m.y-s.ymin)/(l.x*v))%b,k=n===d.minCol?g:0,I=r===d.minRow?w:0,j=n===d.maxCol?x:y,R=r===d.maxRow?O:b,e.abrupt("return",(Object(re.m)(h,{x:k,y:I},{width:j-k,height:R-I}),h));case 21:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return o.apply(this,arguments)})},{key:"getSliceIndex",value:function(e){if(null==e||!e.length||!this._slices)return null;for(var t=e,r=0;r<this._slices.length;r++){var n=this._slices[r].multidimensionalDefinition;if(n.length===t.length&&!n.some((function(e){var r=t.filter((function(t){return e.variableName===t.variableName&&t.dimensionName===e.dimensionName}))[0];return!r||(Array.isArray(e.values[0])?e.values[0][0]:e.values[0])!==(Array.isArray(r.values[0])?r.values[0][0]:r.values[0])})))return r}return null}},{key:"fetchVariableStatisticsHistograms",value:(i=s(regeneratorRuntime.mark((function e(t,r){var n,a,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.request(this.url+"/statistics",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null==(t=e.data)?void 0:t.statistics})),a=this.request(this.url+"/histograms",{query:{variable:t,f:"json"},signal:r}).then((function(e){var t;return null==(t=e.data)?void 0:t.histograms})),e.next=4,Promise.all([n,a]);case 4:return i=e.sent,e.abrupt("return",(i[0]&&i[0].forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation})),{statistics:i[0]||null,histograms:i[1]||null}));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"computeBestPyramidLevelForLocation",value:(a=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s,l=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=l.length>1&&void 0!==l[1]?l[1]:{},this._tilemapCache){e.next=3;break}return e.abrupt("return",0);case 3:if(null!==(n=this.identifyPixelLocation(t,0,Object(u.q)(r.datumTransformation)))){e.next=6;break}return e.abrupt("return",null);case 6:a=0,i=this.rasterInfo.storageInfo.maximumPyramidLevel,o=i-a+this._levelOffset,s=n.srcLocation;case 10:if(!(o>=0)){e.next=25;break}return e.prev=11,e.next=14,this._tilemapCache.fetchAvailability(o,n.row,n.col,r);case 14:if(e.t0=e.sent,"available"!==e.t0){e.next=17;break}return e.abrupt("break",25);case 17:e.next=21;break;case 19:e.prev=19,e.t1=e.catch(11);case 21:if(o--,a++,null!==(n=this.identifyPixelLocation(s,a,Object(u.q)(r.datumTransformation)))){e.next=23;break}return e.abrupt("return",null);case 23:e.next=10;break;case 25:return e.abrupt("return",-1===o||null==n?null:a);case 26:case"end":return e.stop()}}),e,this,[[11,19]])}))),function(e){return a.apply(this,arguments)})},{key:"_fetchRasterInfo",value:(n=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s,l,u,c,f,p,h,d=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.sourceJSON,n=Math.ceil((r.extent.xmax-r.extent.xmin)/r.pixelSizeX-.1),a=Math.ceil((r.extent.ymax-r.extent.ymin)/r.pixelSizeY-.1),i=H.a.fromJSON(r.spatialReference||r.extent.spatialReference),"Map"!==this.tileType){e.next=3;break}return e.abrupt("return",new X.a({width:n,height:a,bandCount:3,extent:E.a.fromJSON(r.extent),spatialReference:i,pixelSize:new V.a({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:i}),pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}}));case 3:return o=t.slice,s=t.signal,l=!!r.hasRasterAttributeTable&&this.request(this.url+"/rasterAttributeTable",{query:{slice:o,f:"json"},signal:s}).then((function(e){return Y.default.fromJSON(e.data)})).catch((function(){return null})),u=!!r.hasColormap&&this.request(this.url+"/colormap",{query:{slice:o,f:"json"},signal:s}).then((function(e){var t;return null==(t=e.data)?void 0:t.colormap})),c=!!r.hasHistograms&&this.request(this.url+"/histograms",{query:{slice:o,f:"json"},signal:s}).then((function(e){var t;return null==(t=e.data)?void 0:t.histograms})),f=this.request(this.url+"/keyProperties",{query:{f:"json"},signal:s}).then((function(e){return e.data})).catch((function(){})),p=!!r.hasMultidimensions&&this._fetchMultidimensionalInfo(),h=!!r.hasMultidimensions&&this.request(this.url+"/slices",{query:{f:"json"},signal:s}).then((function(e){return e.data&&e.data.slices})).catch((function(){})),e.abrupt("return",Promise.all([l,u,c,f,p,h]).then((function(e){var t=null;if(r.minValues&&r.minValues.length===r.bandCount){t=[];for(var o=0;o<r.minValues.length;o++)t.push({min:r.minValues[o],max:r.maxValues[o],avg:r.meanValues[o],stddev:r.stdvValues[o]})}return d._slices=e[5]||null,new X.a({width:n,height:a,bandCount:r.bandCount,extent:E.a.fromJSON(r.extent),spatialReference:i,pixelSize:new V.a({x:r.pixelSizeX,y:r.pixelSizeY,spatialReference:i}),pixelType:r.pixelType.toLowerCase(),statistics:t,attributeTable:e[0]||null,colormap:e[1]||null,histograms:e[2]||null,keyProperties:e[3]||{},multidimensionalInfo:e[4]||null})})));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"_fetchMultidimensionalInfo",value:(r=s(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.request(this.url+"/multidimensionalInfo",{query:{f:"json"},signal:t}).then((function(e){var t;return null==(t=e.data)?void 0:t.multidimensionalInfo}));case 2:return n=e.sent,e.abrupt("return",(null!=(r=n.variables)&&r.length&&n.variables.forEach((function(e){var t;null!=(t=e.statistics)&&t.length&&e.statistics.forEach((function(e){e.avg=e.mean,e.stddev=e.standardDeviation}))})),n));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"_fixScaleInServiceInfo",value:function(){var e=this.sourceJSON;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}}]),m}(oe);Object(o.a)([Object(y.b)({type:String,json:{write:!0}})],Ne.prototype,"datasetFormat",void 0),Object(o.a)([Object(y.b)()],Ne.prototype,"tileType",void 0);var He=Ne=Object(o.a)([Object(x.a)("esri.layers.support.rasterDatasets.ImageServerRaster")],Ne),Ee=i("Piei"),ze=i("5VpP"),Le=new Map;Le.set("Int8","s8"),Le.set("UInt8","u8"),Le.set("Int16","s16"),Le.set("UInt16","u16"),Le.set("Int32","s32"),Le.set("UInt32","u32"),Le.set("Float32","f32"),Le.set("Float64","f32"),Le.set("Double64","f32");var Ae=new Map;Ae.set("lerc",".lrc"),Ae.set("none",".til"),Ae.set("deflate",".pzp"),Ae.set("jpeg",".jzp");var Je=function(e){f(i,e);var t,r,n,a=h(i);function i(){var e;return l(this,i),(e=a.apply(this,arguments))._files=null,e._storageIndex=null,e.datasetFormat="MRF",e}return c(i,[{key:"open",value:(n=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s,l,c,f,p,h,d,m,y,b,v,g,x,w,O,k,I,j,R;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),n=t?Object(u.q)(t.signal):null,e.next=6,this.request(this.url,{responseType:"xml",signal:n});case 6:if(a=e.sent,i=this._parseHeader(a.data),o=i.rasterInfo,s=i.files,-1!==(null==(r=this.ioConfig.skipExtensions)?void 0:r.indexOf("aux.xml"))){e.next=15;break}return e.next=13,this._fetchAuxiliaryData(t);case 13:null!=(l=e.sent)&&(o.statistics=null!=(c=l.statistics)?c:o.statistics,o.histograms=l.histograms,l.histograms&&!Object(u.k)(o.statistics)&&(o.statistics=Object(re.f)(l.histograms)));case 15:return this._set("rasterInfo",o),this._files=s,e.next=18,this.request(s.index,{responseType:"array-buffer",signal:n});case 18:for(f=e.sent,this._storageIndex=this._parseIndex(f.data),d=0,m=-1,y=this.rasterInfo.storageInfo,b=y.blockWidth,v=y.blockHeight,g=y.compression,x=this.rasterInfo.storageInfo.pyramidScalingFactor,w=this.rasterInfo,O=w.width,k=w.height,I=w.bandCount,j=[],R="none"===g?1:I;d<this._storageIndex.length;)m++,p=Math.ceil(O/b/Math.pow(x,m)),h=Math.ceil(k/v/Math.pow(x,m)),d+=p*h*R*4,j.push({maxRow:h,maxCol:p,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=j,m>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=m),this.updateTileInfo();case 24:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"fetchRawTile",value:(r=s(regeneratorRuntime.mark((function e(t,r,n){var a,i,o,s,l,u,c,f,p,h,d,m,y,b,v,g,x,w,O,k,I,j,R,S,T,C,_,M,P=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=P.length>3&&void 0!==P[3]?P[3]:{},i=this.rasterInfo.storageInfo,o=i.blockWidth,s=i.blockHeight,l=i.blockBoundary,u=i.compression,!(!(c=l[t])||c.maxRow<r||c.maxCol<n||c.minRow>r||c.minCol>n)){e.next=4;break}return e.abrupt("return",null);case 4:if(f=this.rasterInfo,p=f.bandCount,h=f.pixelType,d=this._getTileLocation(t,r,n),m=d.ranges,y=d.actualTileWidth,b=d.actualTileHeight,m&&0!==m.length){e.next=7;break}return e.abrupt("return",null);case 7:if(0!==m[0].from||0!==m[0].to){e.next=10;break}return v=new Uint8Array(o*s),e.abrupt("return",new Ee.a({width:o,height:s,pixels:null,mask:v,validPixelCount:0}));case 10:for(g=this.ioConfig.bandIds,x="none"===u?1:p,w=[],O=0,O=0;O<x;O++)(!g||g.indexOf[O]>-1)&&w.push(this.request(this._files.data,{range:{from:m[O].from,to:m[O].to},responseType:"array-buffer",signal:a.signal}));return e.next=15,Promise.all(w);case 15:for(k=e.sent,I=k.map((function(e){return e.data.byteLength})).reduce((function(e,t){return e+t})),j=new Uint8Array(I),R=0,O=0;O<x;O++)j.set(new Uint8Array(k[O].data),R),R+=k[O].data.byteLength;return S="lerc"===this.rasterInfo.storageInfo.compression?"lerc":"bip",e.next=23,this.decodePixelBlock(j.buffer,{width:o,height:s,format:S,pixelType:h});case 23:if(T=e.sent,C=0,_=0,y!==o||b!==s)if(M=T.mask)for(O=0;O<s;O++)if(_=O*o,O<b)for(C=y;C<o;C++)M[_+C]=0;else for(C=0;C<o;C++)M[_+C]=0;else for(M=new Uint8Array(o*s),T.mask=M,O=0;O<b;O++)for(_=O*o,C=0;C<y;C++)M[_+C]=1;return e.abrupt("return",T);case 27:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"_parseIndex",value:function(e){if(e.byteLength%16>0)throw"invalid array buffer must be multiples of 16";var t,r,n,a,i,o;if(ze.a){for(r=new Uint8Array(e),a=new ArrayBuffer(e.byteLength),n=new Uint8Array(a),i=0;i<e.byteLength/4;i++)for(o=0;o<4;o++)n[4*i+o]=r[4*i+3-o];t=new Uint32Array(a)}else t=new Uint32Array(e);return t}},{key:"_getTileLocation",value:function(e,t,r){var n,a,i,o=this.rasterInfo.storageInfo,s=o.blockWidth,l=o.blockHeight,u=o.pyramidScalingFactor,c=o.compression,f=this.rasterInfo,p=f.width,h=f.height,d=f.bandCount,m="none"===c?1:d,y=0,b=0;for(i=0;i<e;i++)b=Math.pow(u,i),y+=(n=Math.ceil(p/s/b))*(a=Math.ceil(h/l/b));b=Math.pow(u,e),n=Math.ceil(p/s/b),a=Math.ceil(h/l/b),y+=t*n+r,y*=4*m;for(var v=this._storageIndex.subarray(y,y+4*m),g=0,x=0,w=[],O=0;O<m;O++)x=(g=v[4*O+0]*Math.pow(2,32)+v[4*O+1])+v[4*O+2]*Math.pow(2,32)+v[4*O+3],w.push({from:g,to:x});return{ranges:w,actualTileWidth:r<n-1?s:Math.ceil(p/b)-s*(n-1),actualTileHeight:t<a-1?l:Math.ceil(h/b)-l*(a-1)}}},{key:"_parseHeader",value:function(e){var t=Ie(e,"MRF_META/Raster");if(!t)throw new w.a("mrf:open","not a valid MRF format");var r=Ie(t,"Size"),n=parseInt(r.getAttribute("x"),10),a=parseInt(r.getAttribute("y"),10),i=parseInt(r.getAttribute("c"),10),o=(je(t,"Compression")||"none").toLowerCase();if(!o||-1===["none","lerc"].indexOf(o))throw new w.a("mrf:open","currently does not support compression "+o);var s=je(t,"DataType")||"UInt8",l=Le.get(s);if(null==l)throw new w.a("mrf:open","currently does not support pixel type "+s);var u,c,f=Ie(t,"PageSize"),p=parseInt(f.getAttribute("x"),10),h=parseInt(f.getAttribute("y"),10),d=Ie(t,"DataValues");if(d&&(null!=(c=d.getAttribute("NoData"))&&(u=c.trim().split(" ").map((function(e){return parseFloat(e)})))),Ie(e,"MRF_META/CachedSource"))throw new w.a("mrf:open","currently does not support MRF referencing other data files");var m=Ie(e,"MRF_META/GeoTags"),y=Ie(m,"BoundingBox");if(null==y)throw new w.a("mrf:open","missing node MRF_META/GeoTags/BoundingBox");var b,v=parseFloat(y.getAttribute("minx")),g=parseFloat(y.getAttribute("miny")),x=parseFloat(y.getAttribute("maxx")),O=parseFloat(y.getAttribute("maxy")),k=je(m,"Projection")||"",I=je(e,"datafile"),j=je(e,"IndexFile");if("LOCAL_CS[]"!==k)if(k.toLowerCase().startsWith("epsg:")){var R=Number(k.slice(5));isNaN(R)||0===R||(b=new H.a({wkid:R}))}else b=_e(k);var S=new E.a(v,g,x,O);S.spatialReference=b;var T=Ie(e,"MRF_META/Rsets"),C=parseInt(T&&T.getAttribute("scale")||"2",10),_=new $({origin:new V.a({x:S.xmin,y:S.ymax,spatialReference:b}),blockWidth:p,blockHeight:h,pyramidBlockWidth:p,pyramidBlockHeight:h,compression:o,pyramidScalingFactor:C}),M=new V.a({x:(x-v)/n,y:(O-g)/a,spatialReference:b});return{rasterInfo:new X.a({width:n,height:a,extent:S,spatialReference:b,bandCount:i,pixelType:l,pixelSize:M,noDataValue:u,storageInfo:_}),files:{mrf:this.url,index:j||this.url.replace(".mrf",".idx"),data:I||this.url.replace(".mrf",Ae.get(o))}}}},{key:"_fetchAuxiliaryData",value:(t=s(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null==t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",Me(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(e){return t.apply(this,arguments)})}]),i}(oe);Object(o.a)([Object(y.b)()],Je.prototype,"_files",void 0),Object(o.a)([Object(y.b)()],Je.prototype,"_storageIndex",void 0),Object(o.a)([Object(y.b)({type:String,json:{write:!0}})],Je.prototype,"datasetFormat",void 0);var qe=Je=Object(o.a)([Object(x.a)("esri.layers.support.rasterIO.MRFRaster")],Je),Ue=i("D/0F"),We=i("bT0G"),Ge=function(e,t){var r=e.get(t);return r&&r.values},Ve=function(e,t){var r=e.get(t);return r&&r.values[0]},Ye=function(e){f(d,e);var t,r,n,i,o,p=h(d);function d(){var e;return l(this,d),(e=p.apply(this,arguments))._files=null,e._headerInfo=null,e._bufferSize=1048576,e.datasetFormat="TIFF",e}return c(d,[{key:"open",value:(o=s(regeneratorRuntime.mark((function e(t){var r,n,i,o,s,l,c,f,p,h,d,m,y,b,v,g,x,O,k,I,j,R,S,T,C,_,M,P,F,D,B,N,H;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.init();case 2:return n=t?Object(u.q)(t.signal):null,e.next=5,this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:n});case 5:if(i=e.sent,o=i.data){e.next=9;break}throw new w.a("tiffraster:open","failed to open url "+this.url);case 9:return this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),s=Object(We.f)(o),l=s.littleEndian,c=s.firstIFD,f=s.isBigTiff,p=[],e.next=13,this.readIFDs(p,o,l,c,0,f?8:4,n);case 13:if(h=Object(We.c)(p),d=h.width,m=h.height,y=h.tileWidth,b=h.tileHeight,v=h.planes,g=h.pixelType,x=h.compression,O=h.firstPyramidLevel,k=h.maximumPyramidLevel,I=h.pyramidBlockWidth,j=h.pyramidBlockHeight,R=h.tileBoundary,S=h.affine,T=h.metadata,C=E.a.fromJSON(h.extent),_=C.spatialReference,M=new V.a(C?{x:C.xmin,y:C.ymax,spatialReference:_}:{x:0,y:0}),P=new $({blockWidth:y,blockHeight:b,pyramidBlockWidth:I,pyramidBlockHeight:j,compression:x,origin:M,firstPyramidLevel:O,maximumPyramidLevel:k,blockBoundary:R}),F=new V.a({x:(C.xmax-C.xmin)/d,y:(C.ymax-C.ymin)/m,spatialReference:_}),D=new X.a({width:d,height:m,bandCount:v,pixelType:g,compression:x,pixelSize:F,storageInfo:P,spatialReference:_,keyProperties:T?{BandProperties:T.bandProperties,DataType:T.dataType}:{},extent:C,statistics:T?T.statistics:null}),null!=S&&S.length&&(D.nativeExtent=new E.a({xmin:-.5,ymin:.5-m,xmax:d-.5,ymax:.5,spatialReference:_}),D.transform=new me({polynomialOrder:1,forwardCoefficients:[S[2]+S[0]/2,S[5]-S[3]/2,S[0],S[3],-S[1],-S[4]]}),D.extent=D.transform.forwardTransform(D.nativeExtent),D.pixelSize=new V.a({x:(C.xmax-C.xmin)/d,y:(C.ymax-C.ymin)/m,spatialReference:_}),P.origin.x=-.5,P.origin.y=.5),null!=(r=this.ioConfig.skipExtensions)&&r.includes("aux.xml")){e.next=19;break}return e.next=17,this._fetchAuxiliaryData(t);case 17:null!=(B=e.sent)&&(D.statistics=null!=(N=B.statistics)?N:D.statistics,D.histograms=B.histograms,B.histograms&&!Object(u.k)(D.statistics)&&(D.statistics=Object(re.f)(B.histograms)),B.transform&&!S&&(D.transform=B.transform,D.nativeExtent=D.extent,H=D.transform.forwardTransform(D.nativeExtent),D.pixelSize=new V.a({x:(H.xmax-H.xmin)/d,y:(H.ymax-H.ymin)/m,spatialReference:_}),D.extent=H),D.spatialReference||(D.spatialReference=B.spatialReference));case 19:if(this._set("rasterInfo",D),this._headerInfo=a({littleEndian:l,isBigTiff:f,ifds:p},h),this._headerInfo.isSupported){e.next=21;break}throw new w.a("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);case 21:this.updateTileInfo();case 22:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"fetchRawTile",value:(i=s(regeneratorRuntime.mark((function e(t,r,n){var a,i,o,s,l,u,c,f,p,h,d,m,y,b,v,g,x,w=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=w.length>3&&void 0!==w[3]?w[3]:{},null!=(i=this._headerInfo)&&i.isSupported&&!this.isBlockOutside(t,r,n)){e.next=3;break}return e.abrupt("return",null);case 3:if(o=this.getTileLocation(t,r,n)){e.next=6;break}return e.abrupt("return",null);case 6:return s=o.range,l=o.actualTileWidth,u=o.actualTileHeight,c=o.ifd,e.next=12,this.request(this.url,{range:s,responseType:"array-buffer",signal:a.signal});case 12:return f=e.sent,p=f.data,h=this.getBlockWidthHeight(t),d=h.blockWidth,m=h.blockHeight,e.next=19,this.decodePixelBlock(p,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:c,offset:0,size:0},width:d,height:m,planes:null,pixelType:null});case 19:if(y=e.sent,l!==d||u!==m)if(x=y.mask)for(b=0;b<m;b++)if(g=b*d,b<u)for(v=l;v<d;v++)x[g+v]=0;else for(v=0;v<d;v++)x[g+v]=0;else for(x=new Uint8Array(d*m),y.mask=x,b=0;b<u;b++)for(g=b*d,v=0;v<l;v++)x[g+v]=1;return e.abrupt("return",y);case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return i.apply(this,arguments)})},{key:"readIFDs",value:(n=s(regeneratorRuntime.mark((function e(t,r,n,a,i){var o,s,l,u=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=u.length>5&&void 0!==u[5]?u[5]:4,s=u.length>6?u[6]:void 0,a){e.next=4;break}return e.abrupt("return",null);case 4:if(e.t0=a>=r.byteLength||a<0,!e.t0){e.next=11;break}return e.next=8,this.request(this.url,{range:{from:a+i,to:a+i+this._bufferSize},responseType:"array-buffer",signal:s});case 8:r=e.sent.data,i=a+i,a=0;case 11:return e.next=13,this.readIFD(r,n,a,i,Ue.a.TIFF_TAGS,o,s);case 13:if(l=e.sent,t.push(l.ifd),l.nextIFD){e.next=16;break}return e.abrupt("return",null);case 16:return e.next=18,this.readIFDs(t,r,n,l.nextIFD-i,i,o,s);case 18:case"end":return e.stop()}}),e,this)}))),function(e,t,r,a,i){return n.apply(this,arguments)})},{key:"readIFD",value:(r=s(regeneratorRuntime.mark((function e(t,r,n,a){var i,o,s,l,u,c,f,p,h,d,m,y,b,v,g=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=g.length>4&&void 0!==g[4]?g[4]:Ue.a.TIFF_TAGS,o=g.length>5&&void 0!==g[5]?g[5]:4,s=g.length>6?g[6]:void 0,t){e.next=5;break}return e.abrupt("return",null);case 5:if(!(l=Object(We.e)(t,r,n,a,i,o)).success){e.next=25;break}if(u=[],l.ifd.forEach((function(e){e.values||u.push(e)})),!(u.length>0)){e.next=16;break}if(c=u.map((function(e){return e.offlineOffsetSize})),f=Math.min.apply(null,c.map((function(e){return e[0]}))),!(Math.min.apply(null,c.map((function(e){return e[0]+e[1]})))-f<=this._bufferSize)){e.next=16;break}return e.next=13,this.request(this.url,{range:{from:f,to:f+this._bufferSize},responseType:"array-buffer",signal:s});case 13:p=e.sent,h=p.data,t=h,a=f,u.forEach((function(e){return Object(We.d)(t,r,e,a)}));case 16:if(!l.ifd.has("GEOKEYDIRECTORY")){e.next=24;break}if(d=l.ifd.get("GEOKEYDIRECTORY"),!((m=d.values)&&m.length>4)){e.next=24;break}return y=m[0]+"."+m[1]+"."+m[2],e.next=22,this.readIFD(t,r,d.valueOffset+6-a,a,Ue.a.GEO_KEYS,2,s);case 22:b=e.sent,d.data=b.ifd,d.data&&d.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[y]});case 24:return e.abrupt("return",l);case 25:if(!l.requiredBufferSize||l.requiredBufferSize===t.byteLength){e.next=30;break}return e.next=28,this.request(this.url,{range:{from:a,to:a+l.requiredBufferSize+4},responseType:"array-buffer",signal:s});case 28:return v=e.sent,e.abrupt("return",(t=v.data).byteLength<l.requiredBufferSize?null:this.readIFD(t,r,0,a,Ue.a.TIFF_TAGS,4,s));case 30:case"end":return e.stop()}}),e,this)}))),function(e,t,n,a){return r.apply(this,arguments)})},{key:"getTileLocation",value:function(e,t,r){var n=this.rasterInfo.storageInfo,a=n.firstPyramidLevel,i=n.blockBoundary,o=0===e?0:e-(a-1),s=this._headerInfo.ifds[o];if(!s)return null;var l=Ge(s,"TILEOFFSETS");if(void 0===l)return null;var u=Ge(s,"TILEBYTECOUNTS"),c=i[o],f=c.minRow,p=c.minCol,h=c.maxRow,d=c.maxCol;if(t>h||r>d||t<f||r<p)return null;var m=Ve(s,"IMAGEWIDTH"),y=Ve(s,"IMAGELENGTH"),b=Ve(s,"TILEWIDTH"),v=Ve(s,"TILELENGTH"),g=t*(d+1)+r,x=l[g],w=u[g];return null==x||null==w?null:{range:{from:x,to:x+w-1},ifd:s,actualTileWidth:r===d?m%b:b,actualTileHeight:t===h?y%v:v}}},{key:"_fetchAuxiliaryData",value:(t=s(regeneratorRuntime.mark((function e(t){var r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.request(this.url+".aux.xml",{responseType:"xml",signal:null==t?void 0:t.signal});case 3:return r=e.sent,n=r.data,e.abrupt("return",Me(n));case 8:return e.prev=8,e.t0=e.catch(0),e.abrupt("return",null);case 11:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(e){return t.apply(this,arguments)})}]),d}(oe);Object(o.a)([Object(y.b)()],Ye.prototype,"_files",void 0),Object(o.a)([Object(y.b)()],Ye.prototype,"_headerInfo",void 0),Object(o.a)([Object(y.b)()],Ye.prototype,"_bufferSize",void 0),Object(o.a)([Object(y.b)({type:String,json:{write:!0}})],Ye.prototype,"datasetFormat",void 0);var Xe=Ye=Object(o.a)([Object(x.a)("esri.layers.support.rasterDatasets.TIFFRaster")],Ye),Ke=new Map;Ke.set("CRF",{desc:"Cloud Raster Format",constructor:xe}),Ke.set("MRF",{desc:"Meta Raster Format",constructor:qe}),Ke.set("TIFF",{desc:"GeoTIFF",constructor:Xe}),Ke.set("RasterTileServer",{desc:"Raster Tile Server",constructor:He}),Ke.set("JPG",{desc:"JPG Raster Format",constructor:Fe}),Ke.set("PNG",{desc:"PNG Raster Format",constructor:Fe}),Ke.set("GIF",{desc:"GIF Raster Format",constructor:Fe}),Ke.set("BMP",{desc:"BMP Raster Format",constructor:Fe});var Ze=Object(b.b)()({RSP_NearestNeighbor:"nearest",RSP_BilinearInterpolation:"bilinear",RSP_CubicConvolution:"cubic",RSP_Majority:"majority"});function $e(){return{enabled:!this.loaded||"RasterTileServer"===this.raster.datasetFormat&&"Raster"===this.raster.tileType}}var Qe,et,tt=function(t){f(i,t);var r,n=h(i);function i(){var e;l(this,i);for(var t=arguments.length,r=new Array(t),a=0;a<t;a++)r[a]=arguments[a];return(e=n.call.apply(n,[this].concat(r))).bandIds=null,e.interpolation=null,e.legendEnabled=!0,e.isReference=null,e.listMode="show",e.sourceJSON=null,e.version=null,e.title=null,e.type="imagery-tile",e.operationalLayerType="ArcGISTiledImageServiceLayer",e.popupEnabled=!0,e.popupTemplate=null,e}return c(i,[{key:"normalizeCtorArgs",value:function(e,t){return"string"==typeof e?a({url:e},t):e}},{key:"load",value:function(e){var t=this,r=Object(u.k)(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).then((function(){return t._openRaster(r)}),(function(){return t._openRaster(r)}))),Promise.resolve(this)}},{key:"defaultPopupTemplate",get:function(){return this.createPopupTemplate()}},{key:"fields",get:function(){var e,t,r=[new C.a({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"})],n=null==(e=this.rasterInfo)||null==(t=e.attributeTable)?void 0:t.fields;if(n){var a=n.filter((function(e){return"oid"!==e.type&&"value"!==e.name.toLowerCase()})).map((function(e){var t=e.clone();return t.name="Raster."+e.name,t}));r=r.concat(a)}return r}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"readRenderer",value:function(e,t,r){var n=t&&t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.renderer,a=Object(T.b)(n,r)||void 0;if(null!=a)return a}},{key:"createPopupTemplate",value:function(e){return Object(D.a)(this,e)}},{key:"write",value:function(t,r){var n=this.raster;return(this.loaded?"RasterTileServer"===n.datasetFormat&&("Raster"===n.tileType||"Map"===n.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))?e(m(i.prototype),"write",this).call(this,t,r):(r&&r.messages&&r.messages.push(new w.a("layer:unsupported","Layers (".concat(this.title,", ").concat(this.id,") of type '").concat(this.declaredClass,"' are not supported in the context of '").concat(r.origin,"/").concat(r.layerContainerType||"operational-layers","'"),{layer:this})),null)}},{key:"_openRaster",value:(r=s(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.raster){e.next=8;break}if(e.t0=this.raster.rasterInfo,e.t0){e.next=5;break}return e.next=5,this.raster.open();case 5:this.url=this.raster.url,e.next=11;break;case 8:return e.next=10,function(){function e(){l(this,e)}var t;return c(e,null,[{key:"supportedFormats",get:function(){var e=new Set;return Ke.forEach((function(t,r){return e.add(r)})),e}},{key:"open",value:(t=s(regeneratorRuntime.mark((function e(t){var r,n,a,i,o,s,l,u,c,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.url,n=t.ioConfig,a=t.sourceJSON,null==(i=t.datasetFormat)&&r.lastIndexOf(".")&&(i=r.slice(r.lastIndexOf(".")+1).toUpperCase()),"OVR"===i||"TIF"===i?i="TIFF":"JPG"!==i&&"JPEG"!==i&&"JFIF"!==i||(i="JPG"),r.toLowerCase().indexOf("/imageserver")>-1&&-1===r.toLowerCase().indexOf("/wcsserver")&&(i="RasterTileServer"),o={url:r,sourceJSON:a,datasetFormat:i,ioConfig:n||{bandIds:null,sampling:null}},!this.supportedFormats.has(i)){e.next=10;break}return s=Ke.get(i).constructor,l=new s(o),e.next=9,l.open({signal:t.signal});case 9:return e.abrupt("return",l);case 10:if(!i){e.next=12;break}throw new w.a("rasterfactory:open","not a supported format "+i);case 12:return u=Array.from(Ke.keys()),c=0,f=function e(){return(i=u[c++])?(s=Ke.get(i).constructor,(l=new s(o)).open({signal:t.signal}).then((function(){return l})).catch((function(){return e()}))):null},e.abrupt("return",f());case 16:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"register",value:function(e,t,r){Ke.has(e.toUpperCase())||Ke.set(e.toUpperCase(),{desc:t,constructor:r})}}]),e}().open({url:this.url,sourceJSON:this.sourceJSON,ioConfig:this.ioConfig,signal:t});case 10:this.raster=e.sent;case 11:if(this.raster.rasterInfo){e.next=14;break}throw new w.a("imagery-tile-layer:load","cannot load resources on "+this.url);case 14:this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON&&(this._set("version",this.sourceJSON.currentVersion),this._set("copyright",this.sourceJSON.copyrightText)),null==this.title&&(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings();case 15:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})}]),i}(Object(_.a)(Object(F.a)(Object(P.a)(Object(S.a)(Object(M.a)((Qe=Object(j.a)(I.a),et=function(e){f(p,e);var t,r,n,i,o=h(p);function p(){var e;return l(this,p),(e=o.apply(this,arguments))._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},e.bandIds=null,e.copyright=null,e.fullExtent=null,e.interpolation="nearest",e.raster=null,e.rasterInfo=null,e.sourceJSON=null,e.spatialReference=null,e.tileInfo=null,e.symbolizer=null,e}return c(p,[{key:"multidimensionalDefinition",set:function(e){this.raster&&(this._sliceId=this.raster.getSliceIndex(e)),this._set("multidimensionalDefinition",e)}},{key:"url",set:function(e){this._set("url",Object(L.g)(e,G))}},{key:"renderer",set:function(e){this._set("renderer",e),this.updateRenderer()}},{key:"updateRenderer",value:(i=s(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.loaded){e.next=2;break}return e.abrupt("return");case 2:if(JSON.stringify(this._cachedRendererJson)!==JSON.stringify(this.renderer)){e.next=4;break}return e.abrupt("return");case 4:if(t=this._rasterJobHandler.instance,e.t0=t,!e.t0){e.next=12;break}return this.symbolizer.rendererJSON=Object(U.e)(this.renderer.toJSON()),this.symbolizer.bind(),e.next=11,t.updateSymbolizer(this.symbolizer);case 11:this._cachedRendererJson=this.renderer.toJSON();case 12:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"applyRenderer",value:(n=s(regeneratorRuntime.mark((function e(t,r){var n,i,o,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=t&&t.pixelBlock)&&n.pixels&&n.pixels.length>0){e.next=3;break}return e.abrupt("return",null);case 3:if(this.updateRenderer(),o=this._rasterJobHandler.instance,s=this.bandIds,!o){e.next=11;break}return e.next=8,o.symbolize(a(a({},t),{},{simpleStretchParams:r,bandIds:s}));case 8:e.t0=e.sent,e.next=12;break;case 11:e.t0=this.symbolizer.symbolize(a(a({},t),{},{simpleStretchParams:r,bandIds:s}));case 12:return i=e.t0,e.abrupt("return",i);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"getTileUrl",value:function(e,t,r){return"RasterTileServer"===this.raster.datasetFormat?"".concat(this.url,"/tile/").concat(e,"/").concat(t,"/").concat(r):""}},{key:"getCompatibleTileInfo",value:function(e,t){if(!this.loaded)return null;var r=Object(N.d)(e);return A.a.create({size:256,spatialReference:e,origin:r?{x:r.origin[0],y:r.origin[1]}:{x:t.xmin,y:t.ymax}})}},{key:"getCompatibleFullExtent",value:function(e){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}},{key:"fetchTile",value:(r=s(regeneratorRuntime.mark((function e(t,r,n){var i,o,s=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(i=s.length>3&&void 0!==s[3]?s[3]:{}).requestAsImageElement){e.next=4;break}return o=this.getTileUrl(t,r,n),e.abrupt("return",Object(z.default)(o,{responseType:"image",query:{sliceId:this._sliceId,_ts:i.timestamp},signal:i.signal}).then((function(e){return e.data})));case 4:return e.next=6,this._initJobHandler();case 6:return this.multidimensionalDefinition&&(i=a({multidimensionalDefinition:this.multidimensionalDefinition,sliceId:this._sliceId,buffer:"raster-shaded-relief"===this.renderer.type?{cols:1,rows:1}:null},i)),e.abrupt("return",this.raster.fetchTile(t,r,n,i));case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"fetchPixels",value:(t=s(regeneratorRuntime.mark((function e(t,r,n,i){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._initJobHandler();case 2:return this.multidimensionalDefinition&&(i=a({multidimensionalDefinition:this.multidimensionalDefinition,sliceId:this._sliceId},i)),e.abrupt("return",this.raster.fetchPixels(t,r,n,i));case 4:case"end":return e.stop()}}),e,this)}))),function(e,r,n,a){return t.apply(this,arguments)})},{key:"identify",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.multidimensionalDefinition&&!t.multidimensionalDefinition&&(t=a(a({},t),{},{multidimensionalDefinition:this.multidimensionalDefinition})),this.raster.identify(e,t)}},{key:"increaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount++}},{key:"decreaseRasterJobHandlerUsage",value:function(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}},{key:"_configDefaultSettings",value:function(){this._configDefaultInterpolation(),this._configDefaultSlice(),this._configDefaultRenderer()}},{key:"_initJobHandler",value:function(){var e=this;if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;var t=new q.a;return this._rasterJobHandler.connectionPromise=t.initialize().then((function(){e._rasterJobHandler.instance=t,e.raster.rasterJobHandler=t,e.renderer&&e.updateRenderer()})).catch((function(){return null})),this._rasterJobHandler.connectionPromise}},{key:"_shutdownJobHandler",value:function(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this.raster.rasterJobHandler=null}},{key:"_configDefaultInterpolation",value:function(){if(null==this.interpolation){var e,t=Object(U.c)(this.rasterInfo,this.raster.tileType,null==(e=this.sourceJSON)?void 0:e.defaultResamplingMethod);this._set("interpolation",t)}}},{key:"_configDefaultSlice",value:function(){var e=this.raster.rasterInfo.multidimensionalInfo;if(Object(u.k)(e)){if(!this.multidimensionalDefinition){var t=e.variables[0],r=[];t.dimensions.forEach((function(e){r.push(new J.a({variableName:t.name,dimensionName:e.name,values:e.hasRegularIntervals?e.extent[0]:e.values[0],isSlice:!0}))})),this.multidimensionalDefinition=r}this._sliceId=this.raster.getSliceIndex(this.multidimensionalDefinition)}}},{key:"_configDefaultRenderer",value:function(){var e,t,r=this.raster.rasterInfo;this.bandIds||(this.bandIds=Object(U.b)(r)),this.renderer||(this.renderer=Object(U.a)(r,{bandIds:this.bandIds,variableName:null==(e=this.multidimensionalDefinition)||null==(t=e[0])?void 0:t.variableName})),this.symbolizer?(this.symbolizer.rendererJSON=Object(U.e)(this.renderer.toJSON()),this.symbolizer.rasterInfo=r):this.symbolizer=new W.a({rendererJSON:this.renderer.toJSON(),rasterInfo:r}),this.symbolizer.bind()||G.warn("imagery-tile-mixin","The given renderer is not supported by the layer.")}}]),p}(Qe),Object(o.a)([Object(y.b)()],et.prototype,"_cachedRendererJson",void 0),Object(o.a)([Object(y.b)()],et.prototype,"_sliceId",void 0),Object(o.a)([Object(y.b)()],et.prototype,"_compatibleFullExtent",void 0),Object(o.a)([Object(y.b)()],et.prototype,"_rasterJobHandler",void 0),Object(o.a)([Object(y.b)()],et.prototype,"bandIds",void 0),Object(o.a)([Object(y.b)()],et.prototype,"copyright",void 0),Object(o.a)([Object(y.b)({type:E.a}),Object(B.a)("rasterInfo.extent")],et.prototype,"fullExtent",void 0),Object(o.a)([Object(y.b)()],et.prototype,"interpolation",void 0),Object(o.a)([Object(y.b)()],et.prototype,"ioConfig",void 0),Object(o.a)([Object(y.b)({type:[J.a]})],et.prototype,"multidimensionalDefinition",null),Object(o.a)([Object(y.b)()],et.prototype,"raster",void 0),Object(o.a)([Object(y.b)({readOnly:!0}),Object(B.a)("raster.rasterInfo")],et.prototype,"rasterInfo",void 0),Object(o.a)([Object(y.b)()],et.prototype,"sourceJSON",void 0),Object(o.a)([Object(y.b)({type:H.a}),Object(B.a)("rasterInfo.spatialReference")],et.prototype,"spatialReference",void 0),Object(o.a)([Object(y.b)({type:A.a}),Object(B.a)("rasterInfo.storageInfo.tileInfo")],et.prototype,"tileInfo",void 0),Object(o.a)([Object(y.b)(R.n)],et.prototype,"url",null),Object(o.a)([Object(y.b)({types:T.a})],et.prototype,"renderer",null),Object(o.a)([Object(y.b)()],et.prototype,"symbolizer",void 0),et=Object(o.a)([Object(x.a)("esri.layers.ImageryTileMixin")],et))))))));Object(o.a)([Object(y.b)({type:[d.a],json:{write:{overridePolicy:$e}}})],tt.prototype,"bandIds",void 0),Object(o.a)([Object(y.b)({json:{write:{overridePolicy:$e}}}),Object(v.a)(Ze)],tt.prototype,"interpolation",void 0),Object(o.a)([Object(y.b)({json:{write:!0}})],tt.prototype,"multidimensionalDefinition",void 0),Object(o.a)([Object(y.b)(R.e)],tt.prototype,"legendEnabled",void 0),Object(o.a)([Object(y.b)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],tt.prototype,"isReference",void 0),Object(o.a)([Object(y.b)({type:["show","hide"]})],tt.prototype,"listMode",void 0),Object(o.a)([Object(y.b)()],tt.prototype,"sourceJSON",void 0),Object(o.a)([Object(y.b)({readOnly:!0})],tt.prototype,"version",void 0),Object(o.a)([Object(y.b)()],tt.prototype,"title",void 0),Object(o.a)([Object(y.b)({readOnly:!0,json:{read:!1}})],tt.prototype,"type",void 0),Object(o.a)([Object(y.b)({type:["ArcGISTiledImageServiceLayer"]})],tt.prototype,"operationalLayerType",void 0),Object(o.a)([Object(y.b)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:function(e,t){return!t.disablePopup}},write:{target:"disablePopup",overridePolicy:$e,writer:function(e,t,r){t[r]=!e}}}})],tt.prototype,"popupEnabled",void 0),Object(o.a)([Object(y.b)({type:k.a,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:$e}}})],tt.prototype,"popupTemplate",void 0),Object(o.a)([Object(y.b)({readOnly:!0})],tt.prototype,"defaultPopupTemplate",null),Object(o.a)([Object(y.b)({readOnly:!0,type:[C.a]})],tt.prototype,"fields",null),Object(o.a)([Object(y.b)({types:T.a,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:$e},origins:{"web-scene":{types:T.c,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:function(e){return{enabled:e&&"vector-field"!==e.type}}}}}}})],tt.prototype,"renderer",null),Object(o.a)([Object(g.a)("renderer")],tt.prototype,"readRenderer",null),tt=Object(o.a)([Object(x.a)("esri.layers.ImageryTileLayer")],tt),n.default=tt}}])}();