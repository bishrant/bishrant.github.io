!function(){var e,t,n,r,i,a,o,s,l,c,u,d,h,f,p,v,g,m,y,b,_,w,x,O,R,j,S,C,T,E,M,k,I,D,P,A,H,L,N,z,F,U;function G(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=e&&("undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]);if(null==n)return;var r,i,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(r=n.next()).done)&&(a.push(r.value),!t||a.length!==t);o=!0);}catch(l){s=!0,i=l}finally{try{o||null==n.return||n.return()}finally{if(s)throw i}}return a}(e,t)||B(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function V(e){return function(e){if(Array.isArray(e))return Z(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||B(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function W(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=B(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return o=e.done,e},e:function(e){s=!0,a=e},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}function B(e,t){if(e){if("string"==typeof e)return Z(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Z(e,t):void 0}}function Z(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function q(e,t,n,r,i,a,o){try{var s=e[a](o),l=s.value}catch(c){return void n(c)}s.done?t(l):Promise.resolve(l).then(r,i)}function Y(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var a=e.apply(t,n);function o(e){q(a,r,i,o,s,"next",e)}function s(e){q(a,r,i,o,s,"throw",e)}o(void 0)}))}}function K(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function Q(e,t,n){return t&&K(e.prototype,t),n&&K(e,n),e}function X(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&J(e,t)}function J(e,t){return(J=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function $(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var n,r=te(e);if(t){var i=te(this).constructor;n=Reflect.construct(r,arguments,i)}else n=r.apply(this,arguments);return ee(this,n)}}function ee(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function te(e){return(te=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ne(e,t){return t||(t=e.slice(0)),Object.freeze(Object.defineProperties(e,{raw:{value:Object.freeze(t)}}))}function re(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{"+yyC":function(e,t,n){"use strict";function r(e,t,n){var r,a,s,l,c,u=t&&t.length,d=u?t[0]*n:e.length,f=i(e,0,d,n,!0),p=new Array;if(!f||f.next===f.prev)return p;if(u&&(f=h(e,t,f,n)),e.length>80*n){r=s=e[0],a=l=e[1];for(var v=n;v<d;v+=n){var g=e[v],m=e[v+1];r=Math.min(r,g),a=Math.min(a,m),s=Math.max(s,g),l=Math.max(l,m)}c=0!==(c=Math.max(s-r,l-a))?1/c:0}return o(f,p,n,r,a,c),p}function i(e,t,n,r,i){var a;if(i===m(e,t,n,r)>0)for(var o=t;o<n;o+=r)a=c(o,e[o],e[o+1],a);else for(var s=n-r;s>=t;s-=r)a=c(s,e[s],e[s+1],a);return a&&w(a,a.next)&&(u(a),a=a.next),a}function a(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e;if(!e)return e;var n,r=e;do{if(n=!1,r.steiner||!w(r,r.next)&&0!==v(r.prev,r,r.next))r=r.next;else{if(u(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function o(e,t,n,r,i,c){var d=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0;if(e){!d&&c&&(e=function e(t,n,r,i){for(var a;a!==t;a=a.next){if(null===(a=a||t).z&&(a.z=_(a.x,a.y,n,r,i)),a.prev.next!==a||a.next.prev!==a)return a.prev.next=a,a.next.prev=a,e(t,n,r,i);a.prevZ=a.prev,a.nextZ=a.next}return t.prevZ.nextZ=null,t.prevZ=null,function(e){for(var t,n=1;;){var r=void 0,i=e;e=null,t=null;for(var a=0;i;){a++,r=i;for(var o=0;o<n&&r;o++)r=r.nextZ;for(var s=n;o>0||s>0&&r;){var l=void 0;0===o?(l=r,r=r.nextZ,s--):0!==s&&r?i.z<=r.z?(l=i,i=i.nextZ,o--):(l=r,r=r.nextZ,s--):(l=i,i=i.nextZ,o--),t?t.nextZ=l:e=l,l.prevZ=t,t=l}i=r}if(t.nextZ=null,n*=2,a<2)return e}}(t)}(e,r,i,c));for(var h=e;e.prev!==e.next;){var f=e.prev,p=e.next;if(c?l(e,r,i,c):s(e))t.push(f.index/n),t.push(e.index/n),t.push(p.index/n),u(e),e=p.next,h=p.next;else if((e=p)===h){d?1===d?o(e=O(e,t,n),t,n,r,i,c,2):2===d&&R(e,t,n,r,i,c):o(a(e),t,n,r,i,c,1);break}}}}function s(e){var t=e.prev,n=e,r=e.next;if(v(t,n,r)>=0)return!1;for(var i=e.next.next,a=i,o=0;i!==e.prev&&(0===o||i!==a);){if(o++,y(t.x,t.y,n.x,n.y,r.x,r.y,i.x,i.y)&&v(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}function l(e,t,n,r){var i=e.prev,a=e,o=e.next;if(v(i,a,o)>=0)return!1;for(var s=i.x>a.x?i.x>o.x?i.x:o.x:a.x>o.x?a.x:o.x,l=i.y>a.y?i.y>o.y?i.y:o.y:a.y>o.y?a.y:o.y,c=_(i.x<a.x?i.x<o.x?i.x:o.x:a.x<o.x?a.x:o.x,i.y<a.y?i.y<o.y?i.y:o.y:a.y<o.y?a.y:o.y,t,n,r),u=_(s,l,t,n,r),d=e.prevZ,h=e.nextZ;d&&d.z>=c&&h&&h.z<=u;){if(d!==e.prev&&d!==e.next&&y(i.x,i.y,a.x,a.y,o.x,o.y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;if(d=d.prevZ,h!==e.prev&&h!==e.next&&y(i.x,i.y,a.x,a.y,o.x,o.y,h.x,h.y)&&v(h.prev,h,h.next)>=0)return!1;h=h.nextZ}for(;d&&d.z>=c;){if(d!==e.prev&&d!==e.next&&y(i.x,i.y,a.x,a.y,o.x,o.y,d.x,d.y)&&v(d.prev,d,d.next)>=0)return!1;d=d.prevZ}for(;h&&h.z<=u;){if(h!==e.prev&&h!==e.next&&y(i.x,i.y,a.x,a.y,o.x,o.y,h.x,h.y)&&v(h.prev,h,h.next)>=0)return!1;h=h.nextZ}return!0}function c(e,t,n,r){var i=new C(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function u(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function d(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function h(e,t,n,r){for(var o=new Array,s=0,l=t.length;s<l;s++){var c=i(e,t[s]*r,s<l-1?t[s+1]*r:e.length,r,!1);c===c.next&&(c.steiner=!0),o.push(d(c))}o.sort(x);for(var u=0,h=o;u<h.length;u++){f(h[u],n),n=a(n,n.next)}return n}function f(e,t){if(t=function(e,t){var n,r=t,i=e.x,a=e.y,o=-1/0;do{if(a<=r.y&&a>=r.next.y&&r.next.y!==r.y){var s=r.x+(a-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&s>o){if(o=s,s===i){if(a===r.y)return r;if(a===r.next.y)return r.next}n=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!n)return null;if(i===o)return n.prev;var l,c=n,u=n.x,d=n.y,h=1/0;for(r=n.next;r!==c;)i>=r.x&&r.x>=u&&i!==r.x&&y(a<d?i:o,a,u,d,a<d?o:i,a,r.x,r.y)&&(((l=Math.abs(a-r.y)/(i-r.x))<h||l===h&&r.x>n.x)&&b(r,e)&&(n=r,h=l)),r=r.next;return n}(e,t)){var n=S(t,e);a(n,n.next)}}function p(e,t,n,r){var i=t&&t.length,a=Math.abs(m(e,0,i?t[0]*n:e.length,n));if(i)for(var o=0,s=t.length;o<s;o++)a-=Math.abs(m(e,t[o]*n,o<s-1?t[o+1]*n:e.length,n));for(var l=0,c=0;c<r.length;c+=3){var u=r[c]*n,d=r[c+1]*n,h=r[c+2]*n;l+=Math.abs((e[u]-e[h])*(e[d+1]-e[u+1])-(e[u]-e[d])*(e[h+1]-e[u+1]))}return 0===a&&0===l?0:Math.abs((l-a)/a)}function v(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function g(e,t,n,r){return!!(w(e,t)&&w(n,r)||w(e,r)&&w(n,t))||v(e,t,n)>0!=v(e,t,r)>0&&v(n,r,e)>0!=v(n,r,t)>0}function m(e,t,n,r){for(var i=0,a=t,o=n-r;a<n;a+=r)i+=(e[o]-e[a])*(e[a+1]+e[o+1]),o=a;return i}function y(e,t,n,r,i,a,o,s){return(i-o)*(t-s)-(e-o)*(a-s)>=0&&(e-o)*(r-s)-(n-o)*(t-s)>=0&&(n-o)*(a-s)-(i-o)*(r-s)>=0}function b(e,t){return v(e.prev,e,e.next)<0?v(e,t,e.next)>=0&&v(e,e.prev,t)>=0:v(e,t,e.prev)<0||v(e,e.next,t)<0}function _(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function w(e,t){return e.x===t.x&&e.y===t.y}function x(e,t){return e.x-t.x}function O(e,t,n){var r=e;do{var i=r.prev,a=r.next.next;!w(i,a)&&g(i,r,r.next,a)&&b(i,a)&&b(a,i)&&(t.push(i.index/n),t.push(r.index/n),t.push(a.index/n),u(r),u(r.next),r=e=a),r=r.next}while(r!==e);return r}function R(e,t,n,r,i,s){var l=e;do{for(var c=l.next.next;c!==l.prev;){if(l.index!==c.index&&j(l,c)){var u=S(l,c);return l=a(l,l.next),u=a(u,u.next),o(l,t,n,r,i,s),void o(u,t,n,r,i,s)}c=c.next}l=l.next}while(l!==e)}function j(e,t){return e.next.index!==t.index&&e.prev.index!==t.index&&!function(e,t){var n=e;do{if(n.index!==e.index&&n.next.index!==e.index&&n.index!==t.index&&n.next.index!==t.index&&g(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&b(e,t)&&b(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,a=(e.y+t.y)/2;do{n.y>a!=n.next.y>a&&n.next.y!==n.y&&i<(n.next.x-n.x)*(a-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)}function S(e,t){var n=new C(e.index,e.x,e.y),r=new C(t.index,t.x,t.y),i=e.next,a=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,a.next=r,r.prev=a,r}n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return r}));var C=function e(t,n,r){re(this,e),this.index=t,this.x=n,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}},"0BfS":function(t,n,r){"use strict";r.d(n,"a",(function(){return s}));var i,a=r("OIYi"),o=r("UBvB");function s(t){t.fragment.include(o.a),t.fragment.uniforms.add("uShadowMapTex","sampler2D"),t.fragment.uniforms.add("uShadowMapNum","int"),t.fragment.uniforms.add("uShadowMapDistance","vec4"),t.fragment.uniforms.add("uShadowMapMatrix","mat4",4),t.fragment.uniforms.add("uDepthHalfPixelSz","float"),t.fragment.code.add(a.a(e||(e=ne(["\n    int chooseCascade(float _linearDepth, out mat4 mat) {\n      vec4 distance = uShadowMapDistance;\n      float depth = _linearDepth;\n\n      //choose correct cascade\n      int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;\n\n      mat = i == 0 ? uShadowMapMatrix[0] : i == 1 ? uShadowMapMatrix[1] : i == 2 ? uShadowMapMatrix[2] : uShadowMapMatrix[3];\n\n      return i;\n    }\n\n    vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {\n      vec4 lv = mat * vec4(_vpos, 1.0);\n      lv.xy /= lv.w;\n      return 0.5 * lv.xyz + vec3(0.5);\n    }\n\n    vec2 cascadeCoordinates(int i, vec3 lvpos) {\n      return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;\n    }\n\n    float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {\n      return rgba2float(texture2D(_depthTex, uv));\n    }\n\n    float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {\n      return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;\n    }\n\n    float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {\n      float texSize = 0.5 / halfPixelSize;\n\n      // filter, offset by half pixels\n      vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);\n\n      float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);\n      float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);\n      float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);\n      float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);\n\n      return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);\n    }\n\n    float readShadowMap(const in vec3 _vpos, float _linearDepth) {\n      mat4 mat;\n      int i = chooseCascade(_linearDepth, mat);\n\n      if (i >= uShadowMapNum) { return 0.0; }\n\n      vec3 lvpos = lightSpacePosition(_vpos, mat);\n\n      // vertex completely outside? -> no shadow\n      if (lvpos.z >= 1.0) { return 0.0; }\n      if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }\n\n      // calc coord in cascade texture\n      vec2 uv = cascadeCoordinates(i, lvpos);\n\n      return filterShadow(uv, lvpos, uDepthHalfPixelSz, uShadowMapTex);\n    }\n  "]))))}(i=s||(s={})).bindUniforms=function(e,t,n){t.shadowMappingEnabled&&(t.shadowMap.bind(e,n),t.shadowMap.bindView(e,t.origin))},i.bindViewCustomOrigin=function(e,t,n){t.shadowMappingEnabled&&t.shadowMap.bindView(e,n)},i.bindView=function(e,t){t.shadowMappingEnabled&&t.shadowMap.bindView(e,t.origin)}},"1AhW":function(e,t,n){"use strict";n.d(t,"a",(function(){return kt})),n.d(t,"b",(function(){return It})),n.d(t,"c",(function(){return Pt}));var r=n("ohva"),i=n("srIe"),a=n("OKTS"),o=n("Cy1f"),s=n("5DEt"),l=n("gYg2"),c=n("Mu3I");function u(e,t,n){for(var r=e.length,i=new Array(r),a=new Array(r),o=new Array(r),s=0,l=0,c=0,u=0,f=0;f<r;++f)u+=e[f].length;for(var p=new Float64Array(3*u),v=0,g=r-1;g>=0;g--){var m=e[g],y=1===n&&h(m);if(y&&1!==r)i[s++]=m;else{for(var b=m.length,_=0;_<s;++_)b+=i[_].length;var w={index:v,pathLengths:new Array(s+1),count:b,holeIndices:new Array(s)};w.pathLengths[0]=m.length,m.length>0&&(o[c++]={index:v,count:m.length}),v=y?d(m,m.length-1,-1,p,v,m.length,t):d(m,0,1,p,v,m.length,t);for(var x=0;x<s;++x){var O=i[x];w.holeIndices[x]=v,w.pathLengths[x+1]=O.length,O.length>0&&(o[c++]={index:v,count:O.length}),v=d(O,0,1,p,v,O.length,t)}s=0,w.count>0&&(a[l++]=w)}}for(var R=0;R<s;++R){var j=i[R];j.length>0&&(o[c++]={index:v,count:j.length}),v=d(j,0,1,p,v,j.length,t)}return l<r&&(a.length=l),c<r&&(o.length=c),{position:p,polygons:a,outlines:o}}function d(e,t,n,r,i,a,o){i*=3;for(var s=0;s<a;++s){var l=e[t];r[i++]=l[0],r[i++]=l[1],r[i++]=o?l[2]:0,t+=n}return i/3}function h(e){return!Object(c.g)(e,!1,!1)}n("+yyC"),n("jEtK");var f=n("Ango"),p=n("Lg+x"),v=n("pO5D"),g=(n("wSAH"),n("6S2I")),m=(n("zqDF"),n("WbKI")),y=n("04ZG"),b=(n("4EHJ"),n("ju1D"),n("9AIY"),n("ikTR")),_=n("/CmD"),w=n("8uAX"),x=n("r0DZ"),O=n("N5XI"),R=n("15Hh"),j=n("kwW8"),S=n("KOts"),C=n("AvGH"),T=n("of9L"),E=n("hTmG"),M=n("1ff1"),k=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(o.e)(),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(o.g)(.57735,.57735,.57735),r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];re(this,e),this.intensity=t,this.direction=n,this.castShadows=r},I=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(o.e)(),n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Object(o.g)(.57735,.57735,.57735);re(this,e),this.intensity=Object(o.e)(),this.direction=Object(o.e)(),this.intensity=t,this.direction=n},D=function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Object(o.e)();re(this,e),this.intensity=t},P=function e(){re(this,e),this.sh={r:[0],g:[0],b:[0]}},A=n("qXiY"),H=n("FxzD"),L=function(e){X(n,e);var t=$(n);function n(){var e;return re(this,n),(e=t.apply(this,arguments)).SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,e.SCENEVIEW_LOCKING_LOG=!1,e.HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED=!0,e.HIGHLIGHTS_PROFILE_TO_CONSOLE=!1,e.DECONFLICTOR_SHOW_VISIBLE=!1,e.DECONFLICTOR_SHOW_INVISIBLE=!1,e.DECONFLICTOR_SHOW_GRID=!1,e.LABELS_SHOW_BORDER=!1,e.OVERLAY_DRAW_DEBUG_TEXTURE=!1,e.OVERLAY_SHOW_CENTER=!1,e.SHOW_POI=!1,e.TESTS_DISABLE_UPDATE_THRESHOLDS=!1,e.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET=!1,e.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES=!1,e.DRAW_MESH_GEOMETRY_NORMALS=!1,e.FEATURE_TILE_FETCH_SHOW_TILES=!1,e.FEATURE_TILE_TREE_SHOW_TILES=!1,e.TERRAIN_TILE_TREE_SHOW_TILES=!1,e.I3S_TREE_SHOW_TILES=!1,e.I3S_SHOW_MODIFICATIONS=!1,e.ENABLE_PROFILE_DEPTH_RANGE=!1,e.DISABLE_FAST_UPDATES=!1,e.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,e.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,e.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,e}return n}(_.a);Object(v.a)([Object(m.b)()],L.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),Object(v.a)([Object(m.b)()],L.prototype,"SCENEVIEW_LOCKING_LOG",void 0),Object(v.a)([Object(m.b)()],L.prototype,"HIGHLIGHTS_GRID_OPTIMIZATION_ENABLED",void 0),Object(v.a)([Object(m.b)()],L.prototype,"HIGHLIGHTS_PROFILE_TO_CONSOLE",void 0),Object(v.a)([Object(m.b)()],L.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),Object(v.a)([Object(m.b)()],L.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),Object(v.a)([Object(m.b)()],L.prototype,"DECONFLICTOR_SHOW_GRID",void 0),Object(v.a)([Object(m.b)()],L.prototype,"LABELS_SHOW_BORDER",void 0),Object(v.a)([Object(m.b)()],L.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),Object(v.a)([Object(m.b)()],L.prototype,"OVERLAY_SHOW_CENTER",void 0),Object(v.a)([Object(m.b)()],L.prototype,"SHOW_POI",void 0),Object(v.a)([Object(m.b)()],L.prototype,"TESTS_DISABLE_UPDATE_THRESHOLDS",void 0),Object(v.a)([Object(m.b)()],L.prototype,"DISABLE_DECONFLICTOR_VISIBILITY_OFFSET",void 0),Object(v.a)([Object(m.b)()],L.prototype,"DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES",void 0),Object(v.a)([Object(m.b)()],L.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),Object(v.a)([Object(m.b)()],L.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),Object(v.a)([Object(m.b)()],L.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),Object(v.a)([Object(m.b)()],L.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),Object(v.a)([Object(m.b)()],L.prototype,"I3S_TREE_SHOW_TILES",void 0),Object(v.a)([Object(m.b)()],L.prototype,"I3S_SHOW_MODIFICATIONS",void 0),Object(v.a)([Object(m.b)()],L.prototype,"ENABLE_PROFILE_DEPTH_RANGE",void 0),Object(v.a)([Object(m.b)()],L.prototype,"DISABLE_FAST_UPDATES",void 0),Object(v.a)([Object(m.b)()],L.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),Object(v.a)([Object(m.b)()],L.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),Object(v.a)([Object(m.b)()],L.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0);var N=new(L=Object(v.a)([Object(y.a)("esri.views.3d.support.DebugFlags")],L)),z=n("cKKt"),F=(n("n4uK"),n("GVa1"),n("0meK")),U=function(){function e(t,n){re(this,e),this.id=Object(w.a)(),this._renderTarget=null,this._renderTarget=new F.a(t,{colorTarget:0,depthStencilTarget:0},{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,hasMipmap:n,maxAnisotropy:8,width:0,height:0})}return Q(e,[{key:"dispose",value:function(){this._renderTarget=Object(i.f)(this._renderTarget)}},{key:"getTexture",value:function(){return this._renderTarget?this._renderTarget.colorTexture:null}},{key:"isValid",value:function(){return null!==this._renderTarget}},{key:"resize",value:function(e,t){this._renderTarget.resize(e,t)}},{key:"bind",value:function(e){e.bindFramebuffer(this._renderTarget)}},{key:"generateMipMap",value:function(){this._renderTarget.colorTexture.descriptor.hasMipmap&&this._renderTarget.colorTexture.generateMipmap()}},{key:"disposeRenderTargetMemory",value:function(){this._renderTarget&&this._renderTarget.resize(0,0)}},{key:"getGpuMemoryUsage",value:function(){var e=0;return this._renderTarget&&(e+=Object(E.c)(this._renderTarget)),e}}]),e}(),B=n("kYAx"),Z=function e(t,n){re(this,e),this.vec3=t,this.id=n};function q(e,t,n,r){return new Z(Object(o.g)(e,t,n),r)}var K=function(){function e(t){re(this,e),this.extent=Object(B.g)(),this.resolution=0,this.renderLocalOrigin=q(0,0,0,"O"),this.pixelRatio=1,this.renderTargets={color:{fbo:new U(t,!0),valid:!1,lastUsed:1/0},colorWithoutRasterImage:{fbo:new U(t,!0),valid:!1,lastUsed:1/0},highlight:{fbo:new U(t,!1),valid:!1,lastUsed:1/0},water:{fbo:new U(t,!0),valid:!1,lastUsed:1/0},occluded:{fbo:new U(t,!0),valid:!1,lastUsed:1/0}}}return Q(e,[{key:"dispose",value:function(){this.renderTargets.color.fbo.dispose(),this.renderTargets.colorWithoutRasterImage.fbo.dispose(),this.renderTargets.highlight.fbo.dispose(),this.renderTargets.water.fbo.dispose(),this.renderTargets.occluded.fbo.dispose()}},{key:"drawRenderTargets",value:function(e,t,n){var r=this.renderTargets;r.color.valid=e.drawPass(0,r.color.fbo,t),r.highlight.valid=e.drawPass(5,r.highlight.fbo,t),r.water.valid=e.drawPass(3,r.water.fbo,t),r.occluded.valid=e.drawPass(0,r.occluded.fbo,t,1),r.colorWithoutRasterImage.valid=n&&e.drawPass(0,r.colorWithoutRasterImage.fbo,t,2)}},{key:"computeRenderTargetValidityBitfield",value:function(){var e=this.renderTargets;return+e.color.valid|+e.colorWithoutRasterImage.valid<<1|+e.highlight.valid<<2|+e.water.valid<<3|+e.occluded.valid<<4}},{key:"validateUsage",value:function(e,t){if(e.valid)e.lastUsed=t;else if(t-e.lastUsed>J)e.fbo.disposeRenderTargetMemory(),e.lastUsed=1/0;else if(e.lastUsed<1/0)return!0;return!1}},{key:"collectUnusedMemory",value:function(e){var t=!1;return t=this.validateUsage(this.renderTargets.color,e)||t,t=this.validateUsage(this.renderTargets.colorWithoutRasterImage,e)||t,t=this.validateUsage(this.renderTargets.highlight,e)||t,t=this.validateUsage(this.renderTargets.occluded,e)||t,t=this.validateUsage(this.renderTargets.water,e)||t}},{key:"getGpuMemoryUsage",value:function(){return this.renderTargets.color.fbo.getGpuMemoryUsage()+this.renderTargets.colorWithoutRasterImage.fbo.getGpuMemoryUsage()+this.renderTargets.highlight.fbo.getGpuMemoryUsage()+this.renderTargets.water.fbo.getGpuMemoryUsage()+this.renderTargets.occluded.fbo.getGpuMemoryUsage()}}]),e}(),J=1e3,ee=n("tQ+6"),te=function(){function e(){re(this,e),this._uniforms={proj:[],uShadowMapDistance:[],viewportPixelSz:[],lightingMainDirection:[]}}return Q(e,[{key:"dispose",value:function(){this._uniforms=null}},{key:"getPrograms",value:function(e){return this._uniforms[e]||[]}},{key:"subscribeProgram",value:function(e){for(var t in this._uniforms)e.hasUniform(t)&&this._uniforms[t].push(e)}},{key:"unsubscribeProgram",value:function(e){for(var t in this._uniforms)Object(ee.j)(this._uniforms[t],e)}}]),e}(),ne=function e(t){re(this,e),this.technique=t,this.refCount=0,this.refZeroFrame=0},ie=function(){function e(t){re(this,e),this._context=t,this._perConstructorInstances=new Map,this._frameCounter=0,this._keepAliveFrameCount=1200}var t;return Q(e,[{key:"viewingMode",get:function(){return this._context.viewingMode}},{key:"constructionContext",get:function(){return this._context}},{key:"dispose",value:function(){this._perConstructorInstances.forEach((function(e){return e.forEach((function(e){return e.technique.dispose()}))})),this._perConstructorInstances.clear()}},{key:"acquire",value:function(e,t){var n=t.key,r=this._perConstructorInstances.get(e);r||(r=new Map,this._perConstructorInstances.set(e,r));var i=r.get(n);return void 0===i&&(i=new ne(new e(this._context,t)),r.set(n,i)),++i.refCount,i.technique}},{key:"acquireAndReleaseExisting",value:function(e,t,n){return Object(i.j)(n)?this.acquire(e,t):t.key===n.key&&n instanceof e?n:(this.release(n),this.acquire(e,t))}},{key:"release",value:function(e){if(!Object(i.j)(e)){var t=this._perConstructorInstances.get(e.constructor).get(e.key);t.refCount-=1,0===t.refCount&&(t.refZeroFrame=this._frameCounter)}}},{key:"frameUpdate",value:function(){var e=this;this._frameCounter++,this._perConstructorInstances.forEach((function(t,n){t.forEach((function(n,r){0===n.refCount&&n.refZeroFrame+e._keepAliveFrameCount<e._frameCounter&&(n.technique.dispose(),t.delete(r))})),0===t.size&&e._perConstructorInstances.delete(n)}))}},{key:"getProgramsUsingUniform",value:function(e){return this._context.commonUniformStore.getPrograms(e)}},{key:"hotReload",value:(t=Y(regeneratorRuntime.mark((function e(){var t,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=new Array,this._perConstructorInstances.forEach((function(e,r){var i;t.push((i=Y(regeneratorRuntime.mark((function e(t,r){var i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.shader,e.t0=i,!e.t0){e.next=6;break}return e.next=5,i.reload();case 5:t.forEach((function(e){e.technique.reload(n._context)}));case 6:case"end":return e.stop()}}),e)}))),function(e,t){return i.apply(this,arguments)})(e,r))})),e.next=4,Promise.all(t);case 4:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}]),e}(),ae=n("EVMh"),oe=[{output:0,name:"color"},{output:1,name:"depth"},{output:2,name:"normal"},{output:3,name:"depthShadowMap"},{output:4,name:"highlight"},{output:5,name:"draped"},{output:6,name:"occlusion"},{output:7,name:"alpha"}];function se(e,t){return e+"_"+oe.find((function(e){return e.output===t})).name}var le=g.a.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRep"),ce=function(){function e(t){re(this,e),this.refCnt=0,this.glMaterial=t}return Q(e,[{key:"incRefCnt",value:function(){++this.refCnt}},{key:"decRefCnt",value:function(){--this.refCnt,Object(ae.a)(this.refCnt>=0)}},{key:"getRefCnt",value:function(){return this.refCnt}},{key:"getGLMaterial",value:function(){return this.glMaterial}}]),e}(),ue=n("WZb1"),de=n("r+FG"),he=n("WiJz"),fe=n("dI/Q"),pe=n("hrr/"),ve=0,ge=function(){function e(){re(this,e),this.ROOT_ORIGIN_ID="rg_root_"+ve++,this._origins=new Map,this._gridSize=42e5}return Q(e,[{key:"getOrigin",value:function(t){var n=this._origins.get(this.ROOT_ORIGIN_ID);if(null==n){if(Object(i.k)(e.testOrigin)){var r=e.testOrigin;return this._origins.set(this.ROOT_ORIGIN_ID,q(r[0],r[1],r[2],this.ROOT_ORIGIN_ID)),this.getOrigin(t)}var a=q(t[0]+Math.random()-.5,t[1]+Math.random()-.5,t[2]+Math.random()-.5,this.ROOT_ORIGIN_ID);return this._origins.set(this.ROOT_ORIGIN_ID,a),a}Object(s.i)(me,t,n.vec3),me[0]=Math.abs(me[0]),me[1]=Math.abs(me[1]),me[2]=Math.abs(me[2]);var o=this._gridSize;if(me[0]<o&&me[1]<o&&me[2]<o)return n;var l=Math.round(t[0]/o),c=Math.round(t[1]/o),u=Math.round(t[2]/o),d="rg_".concat(l,"/").concat(c,"/").concat(u),h=this._origins.get(d);return h||(h=q(l*o,c*o,u*o,d),this._origins.set(d,h)),h}},{key:"_drawOriginBox",value:function(e){var t=window.view,n=t._stage;if(null==this._object){this._material=new pe.a({width:2,color:[0,1,0,1]}),n.add(this._material);var r=new fe.a({isPickable:!1});this._object=new he.a({castShadow:!1}),n.add(this._object),r.add(this._object),n.add(r)}for(var i=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],a=i.length,o=new Array(3*a),s=new Uint16Array(2*(a-1)),c=.5*this._gridSize,u=0;u<a;u++)o[3*u+0]=e[0]+(1&i[u]?c:-c),o[3*u+1]=e[1]+(2&i[u]?c:-c),o[3*u+2]=e[2]+(4&i[u]?c:-c),u>0&&(s[2*u+0]=u-1,s[2*u+1]=u);Object(l.k)(o,ue.a.WebMercator,0,o,t.spatialReference,0,a);var d=new f.a([["position",{size:3,data:o,exclusive:!0}]],[["position",s]],2);n.add(d),this._object.addGeometry(d,this._material,de.a),console.log(this._origins.size,e)}}]),e}(),me=Object(o.e)();(ge||(ge={})).testOrigin=null;var ye=ge,be=n("NbNv"),_e=function(){function e(){re(this,e),this.adds=new b.a,this.removes=new b.a,this.updates=new b.a({allocator:function(e){return e||new we},deallocator:function(e){return e.renderGeometry=null,e}})}return Q(e,[{key:"clear",value:function(){this.adds.clear(),this.removes.clear(),this.updates.clear()}},{key:"prune",value:function(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}]),e}(),we=function e(){re(this,e)},xe=function e(){re(this,e),this.adds=new Array,this.removes=new Array,this.updates=new Array};function Oe(e){return e.data.indexCount>=1}var Re=n("Lrt+"),je=n("fOQB"),Se=n("D6bk"),Ce=n("tiP8"),Te=function(){function e(t){re(this,e),null==t?t=16:t<65536&&(t=Object(a.l)(t)),this._array=new Float32Array(t),this._size=0}return Q(e,[{key:"resize",value:function(e,t){if(this._size=e,this._size>this._array.length){for(var n=this._array.length||1;n<this._size;)n*=2;var r=new Float32Array(n);return t&&r.set(this._array),this._array=r,!0}var i=2*this._size;if(i<=this._array.length){for(var a=this._array.length;a>=i;)a=Math.floor(a/2);var o=new Float32Array(a);return t&&o.set(this._array.subarray(0,a)),this._array=o,!0}return!1}},{key:"append",value:function(e){var t=this._size;this.resize(this._size+e.length,!0),this._array.set(e,t)}},{key:"erase",value:function(e,t){for(var n=e;n<t;++n)this._array[n]=0}},{key:"array",get:function(){return this._array}},{key:"size",get:function(){return this._size}}]),e}(),Ee=n("1/dN"),Me=n("w6Td"),ke=n("ypgp"),Ie=n("2jVe"),De=n("+h6m"),Pe=n("jjdI"),Ae=n("GJyJ"),He=n("jpeq"),Le=n("jdNP"),Ne=n("0nJL"),ze=n("agdK"),Fe=n("dDjh"),Ue=n("xtdb"),Ge=n("0BfS"),Ve=n("33ep"),We=n("M+I8"),Be=n("6kRo"),Ze=function(e){X(n,e);var t=$(n);function n(e,r){var i;return re(this,n),(i=t.call(this,e,r)).waterTextureRepository=e.waterTextureRepository,i}return Q(n,[{key:"initializeProgram",value:function(e){var t=n.shader.get(),r=this.configuration,i=t.build({OITEnabled:0===r.transparencyPassType,output:r.output,viewingMode:e.viewingMode,slicePlaneEnabled:r.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,receiveShadows:r.receiveShadows,pbrMode:3,useCustomDTRExponentForWater:!0,ssrEnabled:r.useSSR,highStepCount:!0,multipassTerrainEnabled:r.multipassTerrainEnabled,cullAboveGround:r.cullAboveGround});return new Pe.a(e.rctx,i.generateSource("vertex"),i.generateSource("fragment"),De.a)}},{key:"ensureResource",value:function(e){return this.waterTextureRepository.ready||this.waterTextureRepository.updating||this.waterTextureRepository.loadTextures(e),this.waterTextureRepository.ready?2:1}},{key:"bindPass",value:function(e,t,n){He.a.bindProjectionMatrix(this.program,n.camera.projectionMatrix),n.multipassTerrainEnabled&&(this.program.setUniform2fv("cameraNearFar",n.camera.nearFar),this.program.setUniform2fv("inverseViewport",n.inverseViewport),Object(Ue.a)(this.program,e,n)),0===this.configuration.output&&(n.lighting.setUniforms(this.program,!1),Ve.a.bindUniforms(this.program,e,n)),0!==this.configuration.output&&2!==this.configuration.output||(We.a.bindUniforms(this.program,t),this.waterTextureRepository.bindRepo(e)),this.program.setUniform4fv("waterColor",t.color),4===this.configuration.output&&ze.a.bindOutputHighlight(e,this.program,n)}},{key:"bindDraw",value:function(e){He.a.bindView(this.program,e),0!==this.configuration.output&&7!==this.configuration.output||He.a.bindCamPosition(this.program,e.origin,e.camera.viewInverseTransposeMatrix),0===this.configuration.output&&Ge.a.bindUniforms(this.program,e,Le.a.SHADOW_MAP),0!==this.configuration.output&&7!==this.configuration.output&&4!==this.configuration.output||Ne.a.bindUniformsWithOrigin(this.program,this.configuration,e)}},{key:"setPipelineState",value:function(e){var t=this.configuration,n=3===e,r=2===e;return Object(Ae.d)({blending:2!==t.output&&4!==t.output&&t.transparent?n?Fe.f:Object(Fe.a)(e):null,depthTest:{func:Object(Fe.b)(e)},depthWrite:n?t.writeDepth&&Ae.c:Object(Fe.c)(e),colorWrite:Ae.b,polygonOffset:n||r?null:Object(Fe.g)(t.enableOffset)})}},{key:"initializePipeline",value:function(){return this.setPipelineState(this.configuration.transparencyPassType)}}]),n}(ke.a);Ze.shader=new Me.a(Be.a,(function(){return n.e(166).then(n.bind(null,"CODL"))}));var qe=function(e){X(n,e);var t=$(n);function n(){var e;return re(this,n),(e=t.apply(this,arguments)).output=0,e.receiveShadows=!1,e.slicePlaneEnabled=!1,e.transparent=!1,e.enableOffset=!0,e.writeDepth=!1,e.useSSR=!1,e.isDraped=!1,e.transparencyPassType=3,e.multipassTerrainEnabled=!1,e.cullAboveGround=!0,e}return n}(Ie.a);Object(v.a)([Object(Ie.b)({count:8})],qe.prototype,"output",void 0),Object(v.a)([Object(Ie.b)()],qe.prototype,"receiveShadows",void 0),Object(v.a)([Object(Ie.b)()],qe.prototype,"slicePlaneEnabled",void 0),Object(v.a)([Object(Ie.b)()],qe.prototype,"transparent",void 0),Object(v.a)([Object(Ie.b)()],qe.prototype,"enableOffset",void 0),Object(v.a)([Object(Ie.b)()],qe.prototype,"writeDepth",void 0),Object(v.a)([Object(Ie.b)()],qe.prototype,"useSSR",void 0),Object(v.a)([Object(Ie.b)()],qe.prototype,"isDraped",void 0),Object(v.a)([Object(Ie.b)({count:4})],qe.prototype,"transparencyPassType",void 0),Object(v.a)([Object(Ie.b)()],qe.prototype,"multipassTerrainEnabled",void 0),Object(v.a)([Object(Ie.b)()],qe.prototype,"cullAboveGround",void 0);var Ye=function(e){X(n,e);var t=$(n);function n(e){var r;return re(this,n),(r=t.call(this,e)).updateParameters(),r}return Q(n,[{key:"updateParameters",value:function(e){this.technique=this.techniqueRep.acquireAndReleaseExisting(Ze,this.material.getTechniqueConfig(this.output,e),this.technique)}},{key:"beginSlot",value:function(e){if(2===this.output)return 22===e;if(5===this.output)return null==e;if(4===this.output)return 3===e;var t=3;return this.material.params.transparent&&(t=this.material.params.writeDepth?5:8),e===t}},{key:"setElapsedTimeUniform",value:function(e){e.setUniform1f("timeElapsed",.001*this.material.animation.time*this.material.params.animationSpeed)}},{key:"_updateShadowState",value:function(e){e.shadowMappingEnabled!==this.material.params.receiveShadows&&this.material.setParameterValues({receiveShadows:e.shadowMappingEnabled})}},{key:"_updateSSRState",value:function(e){e.ssrEnabled!==this.material.params.ssrEnabled&&this.material.setParameterValues({ssrEnabled:e.ssrEnabled})}},{key:"ensureResources",value:function(e){return this.technique.ensureResource(e)}},{key:"ensureParameters",value:function(e){0===this.output&&(this._updateShadowState(e),this._updateSSRState(e)),this.updateParameters(e)}},{key:"bind",value:function(e,t){e.bindProgram(this.technique.program),this.technique.bindPass(e,this.material.params,t),2!==this.output&&0!==this.output||this.setElapsedTimeUniform(this.technique.program)}}]),n}(Ee.a),Ke=function e(t,n,r,i,a,o){re(this,e),this.from=t,this.to=n,this.isVisible=r,this.hasHighlights=i,this.hasOccludees=a,this.transformation=o,null!=o&&(this.transformationNormal=Object(de.c)(o),Object(R.a)(this.transformationNormal,this.transformationNormal),Object(R.b)(this.transformationNormal,this.transformationNormal))};function Qe(e,t){var n=function(e){return{first:e.from,count:e.to-e.from}};if(0!==e.length){var r=e[e.length-1];!function(e,t){return e.first+e.count>=t.from}(r,t)?e.push(n(t)):r.count=t.from-r.first+t.to-t.from}else e.push(n(t))}function Xe(e,t,n){Object(i.k)(n)&&(n.drawCalls+=e,n.triangles+=t)}function Je(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}n("TDcG"),n("L/MW");var $e={begin:0,end:0},et=Object(de.b)(),tt=Object(de.b)(),nt=Object(de.b)(),rt=function(e){X(n,e);var t=$(n);function n(){var e;return re(this,n),(e=t.apply(this,arguments))._pendingAddsRemoves=new Map,e._changes=new _e,e._materialRenderers=new Map,e._sortedMaterialRenderers=new b.a,e._hasHighlights=!1,e._hasWater=!1,e}return Q(n,[{key:"dispose",value:function(){this._changes.prune(),this._materialRenderers&&(this._materialRenderers.forEach((function(e){return e.dispose()})),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear())}},{key:"updating",get:function(){return this._pendingAddsRemoves.size>0||this._changes.updates.length>0}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return Object(S.a)(this._materialRenderers,(function(e){return e.rendersOccluded}))}},{key:"stopAnimationsAtTime",value:function(e){this._sortedMaterialRenderers.forAll((function(t){return Object(i.c)(t.material.animation,(function(t){return t.stopAtTime(e)}))}))}},{key:"isEmpty",get:function(){return!this.updating&&0===this._materialRenderers.size}},{key:"commitChanges",value:function(){var e=this,t=!1;if(!this.updating)return!1;this.updateAddsRemoves();var n=function(e){var t=new Map,n=function(e){var n=t.get(e);return n||(n=new xe,t.set(e,n)),n};return e.adds.forAll((function(e){Oe(e)&&n(e.material).adds.push(e)})),e.removes.forAll((function(e){Oe(e)&&n(e.material).removes.push(e)})),e.updates.forAll((function(e){Oe(e.renderGeometry)&&n(e.renderGeometry.material).updates.push(e)})),t}(this._changes),r=!1,a=!1;return n.forEach((function(n,o){var s=e._materialRenderers.get(o);if(!s&&n.adds.length>0&&(s=new(function(){function e(t,n,r){re(this,e),this.type="MergedRenderer",this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._rctx=t,this._material=r,this._materialRep=n,this._glMaterials=Object(Ce.a)(this._material,this._materialRep),this._bufferWriter=r.createBufferWriter()}return Q(e,[{key:"dispose",value:function(){Object(Ce.e)(this._material,this._materialRep),this._dataByOrigin&&(this._dataByOrigin.forEach((function(e){e.vao.dispose(!0),e.vao=null})),this._dataByOrigin.clear(),this._dataByOrigin=null),this._glMaterials&&(this._glMaterials.forEach((function(e){e&&e.dispose()})),this._glMaterials.clear(),this._glMaterials=null)}},{key:"isEmpty",get:function(){return 0===this._dataByOrigin.size}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasOccludees",get:function(){return this._hasOccludees}},{key:"hasWater",get:function(){return!this.isEmpty&&Object(S.a)(this._glMaterials,(function(e){return e instanceof Ye}))}},{key:"rendersOccluded",get:function(){return!this.isEmpty&&1!==this._material.renderOccluded}},{key:"modify",value:function(e){this.updateGeometries(e.updates),this.addAndRemoveGeometries(e.adds,e.removes),this.updateRenderCommands()}},{key:"addAndRemoveGeometries",value:function(e,t){var n=this,r=this._bufferWriter,i=r.vertexBufferLayout,a=i.stride/4,o=this._dataByOrigin,s=function(e,t,n,r){var i,a=new Map,o=t.vertexBufferLayout.stride/4,s=function(n,r){var i=n.origin,s=e.get(i.id),l=a.get(i.id);null==l&&(l={optimalCount:null==s?0:s.optimalCount,sparseCount:null==s?0:s.buffer.size,toAdd:[],toRemove:[],origin:i.vec3},a.set(i.id,l));var c=t.elementCount(n.data)*o;r?(l.optimalCount+=c,l.sparseCount+=c,l.toAdd.push(n)):(l.optimalCount-=c,l.toRemove.push(n))},l=W(n);try{for(l.s();!(i=l.n()).done;){s(i.value,!0)}}catch(d){l.e(d)}finally{l.f()}var c,u=W(r);try{for(u.s();!(c=u.n()).done;){s(c.value,!1)}}catch(d){u.e(d)}finally{u.f()}return a}(o,r,e,t);s.forEach((function(e,t){s.delete(t);var r=e.optimalCount,l=e.sparseCount,c=o.get(t);if(null==c)Object(ae.a)(r>0),c=n.createData(i,r,e.origin),o.set(t,c);else if(0===r)return c.vao.dispose(!0),c.vao=null,void o.delete(t);var u=r<e.sparseCount/2,d=$e,h=c.buffer.size,f=c.buffer.array,p=c.buffer.resize(u?r:l,!1);u||p?n.removeAndRebuild(c,e.toRemove,a,f,d):e.toRemove.length>0?(n.removeByErasing(c,e.toRemove,a,d),e.toAdd.length>0&&(d.end=h)):(d.begin=h,d.end=h);var v=et;Object(ae.j)(v,-e.origin[0],-e.origin[1],-e.origin[2]),n.append(c,e.toAdd,a,v,d);var g=c.vao.vertexBuffers.geometry;if(g.byteSize!==c.buffer.array.buffer.byteLength)g.setData(c.buffer.array);else{var m=d.begin,y=d.end;if(m<y){var b=4*m;g.setSubData(c.buffer.array,b,b,4*y)}}c.drawCommandsDirty=!0}))}},{key:"updateGeometries",value:function(e){var t,n=this._bufferWriter,r=n.vertexBufferLayout.stride/4,i=W(e);try{for(i.s();!(t=i.n()).done;){var a=t.value,o=a.updateType,s=a.renderGeometry,l=this._dataByOrigin.get(s.origin.id),c=l&&l.instances.get(s.id);if(!c)return;if(1&o&&(c.isVisible=s.instanceParameters.visible),9&o){var u=s.instanceParameters.visible;c.hasHighlights=!!s.instanceParameters.highlights&&u}if(16&o&&(c.hasOccludees=!!s.instanceParameters.occludees),6&o){var d=l.buffer.array,h=l.vao;Object(Ce.c)(s,tt,nt),n.write({transformation:tt,invTranspTransformation:nt},s.data,n.vertexBufferLayout.createView(d.buffer),c.from),Object(ae.a)(c.from+n.elementCount(s.data)===c.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(d,c.from*r*4,c.from*r*4,c.to*r*4)}l.drawCommandsDirty=!0}}catch(f){i.e(f)}finally{i.f()}}},{key:"updateRenderCommands",value:function(){var e=this;this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach((function(t){t.hasHiddenInstances=!1,t.hasHighlights=!1,t.hasOccludees=!1,Object(S.a)(t.instances,(function(n){return n.isVisible?(n.hasHighlights&&(e._hasHighlights=!0,t.hasHighlights=!0),n.hasOccludees&&(e._hasOccludees=!0,t.hasOccludees=!0)):t.hasHiddenInstances=!0,t.hasHiddenInstances&&t.hasHighlights&&t.hasOccludees}))})),this._dataByOrigin.forEach((function(e){e.drawCommandsDirty&&(function(e){if(e.drawCommandsDefault=null,e.drawCommandsHighlight=null,e.drawCommandsOccludees=null,e.drawCommandsShadowHighlightRest=null,e.stats={default:0,highlight:0,occludees:0,shadowHighlightRest:0},0!==e.instances.size){if(!Je(e)){var t=4*e.buffer.size/Object(E.d)(e.vao.layout.geometry);return e.drawCommandsDefault=[{first:0,count:t}],void(e.stats={default:t,highlight:0,occludees:0,shadowHighlightRest:0})}var n=function(e){return e.sort((function(e,t){return e.from===t.from?e.to>t.to?1:e.to<t.to?-1:0:e.from>t.from?1:e.from<t.from?-1:0}))}(V(e.instances.values()));e.drawCommandsDefault=[],e.drawCommandsHighlight=[],e.drawCommandsOccludees=[],e.drawCommandsShadowHighlightRest=[];var r,i=W(n);try{for(i.s();!(r=i.n()).done;){var a=r.value;a.isVisible&&(Qe(a.hasOccludees?e.drawCommandsOccludees:e.drawCommandsDefault,a),Qe(a.hasHighlights?e.drawCommandsHighlight:e.drawCommandsShadowHighlightRest,a))}}catch(s){i.e(s)}finally{i.f()}var o=function(e){var t,n=0,r=W(e);try{for(r.s();!(t=r.n()).done;){n+=t.value.count}}catch(s){r.e(s)}finally{r.f()}return n/3};e.stats={default:o(e.drawCommandsDefault),highlight:o(e.drawCommandsHighlight),occludees:o(e.drawCommandsOccludees),shadowHighlightRest:o(e.drawCommandsShadowHighlightRest)}}}(e),e.drawCommandsDirty=!1)}))}},{key:"updateLogic",value:function(e){return this._material.update(e)}},{key:"render",value:function(e,t,n,r){var a=this,o=this._rctx,s=this._glMaterials.get(t.pass),l=5===t.pass||7===t.pass,c=6===t.pass,u=!(l||c),d=e;if(3===t.pass&&null===d&&(d=22),!s||2!==s.ensureResources(o)||null!=d&&!s.beginSlot(d)||l&&!this._hasHighlights)return!1;s.ensureParameters(n);var h=s.getTechnique(),f=s.getPipelineState(d,!1);o.setPipelineState(f),s.bind(o,n);var p=!1;return this._dataByOrigin.forEach((function(e){if(!(Object(i.j)(e.drawCommandsDefault)&&Object(i.j)(e.drawCommandsHighlight)&&Object(i.j)(e.drawCommandsOccludees)&&Object(i.j)(e.drawCommandsShadowHighlightRest))&&(!l||e.hasHighlights)){n.origin=e.origin,h.bindDraw(n),h.ensureAttributeLocations(e.vao),o.bindVAO(e.vao);var t=h.primitiveType,v=l?e.drawCommandsHighlight:c&&Je(e)?e.drawCommandsShadowHighlightRest:e.drawCommandsDefault,g=l?e.stats.highlight:c&&Je(e)?e.stats.shadowHighlightRest:e.stats.default;if(Object(i.k)(v)&&(a.renderCommands(o,t,v),Xe(v.length,g,r),p=!0),u&&(v=e.drawCommandsOccludees,Object(i.k)(v))){var m=s.getPipelineState(d,!0);o.setPipelineState(m),a.renderCommands(o,t,v),o.setPipelineState(f),Xe(v.length,e.stats.occludees,r),p=!0}}})),p}},{key:"renderCommands",value:function(e,t,n){for(var r=0;r<n.length;r++)e.drawArrays(t,n[r].first,n[r].count)}},{key:"createData",value:function(e,t,n){return{instances:new Map,vao:new Se.a(this._rctx,this._material.vertexAttributeLocations,{geometry:Object(Re.a)(e)},{geometry:je.a.createVertex(this._rctx,35044)}),buffer:new Te(t),optimalCount:0,origin:n,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,drawCommandsShadowHighlightRest:null,stats:{default:0,highlight:0,occludees:0,shadowHighlightRest:0}}}},{key:"removeAndRebuild",value:function(e,t,n,r,i){var a,o=W(t);try{for(o.s();!(a=o.n()).done;){var s=a.value.id,l=e.instances.get(s);e.optimalCount-=(l.to-l.from)*n,e.instances.delete(s)}}catch(p){o.e(p)}finally{o.f()}var c=0,u=e.buffer.array;i.begin=0,i.end=0;var d=-1,h=-1,f=0;e.instances.forEach((function(e){var t=e.from*n,i=e.to*n,a=i-t;d!==h&&h!==t?(u.set(r.subarray(d,h),f),f+=h-d,d=t):-1===d&&(d=t),h=i,e.from=c/n,c+=a,e.to=c/n})),d!==h&&u.set(r.subarray(d,h),f),i.end=c}},{key:"removeByErasing",value:function(e,t,n,r){r.begin=1/0,r.end=-1/0;var i,a=-1,o=-1,s=W(t);try{for(s.s();!(i=s.n()).done;){var l=i.value.id,c=e.instances.get(l),u=c.from*n,d=c.to*n;a!==o&&o!==u?(e.buffer.erase(a,o),a=u):-1===a&&(a=u),o=d,e.instances.delete(l),e.optimalCount-=d-u,u<r.begin&&(r.begin=u),d>r.end&&(r.end=d)}}catch(h){s.e(h)}finally{s.f()}a!==o&&e.buffer.erase(a,o)}},{key:"append",value:function(e,t,n,r,a){var o,s=this._bufferWriter,l=W(t);try{for(l.s();!(o=l.n()).done;){var c=o.value,u=Object(i.k)(c.transformation)?Object(R.l)(tt,r,c.transformation):r;Object(R.a)(nt,u),Object(R.b)(nt,nt);var d=a.end;s.write({transformation:u,invTranspTransformation:nt},c.data,s.vertexBufferLayout.createView(e.buffer.array.buffer),a.end/n);var h=s.elementCount(c.data)*n,f=d+h;Object(ae.a)(null==e.instances.get(c.id));var p=c.instanceParameters.visible,v=new Ke(d/n,f/n,p,!!c.instanceParameters.highlights&&p,!!c.instanceParameters.occludees);e.instances.set(c.id,v),e.optimalCount+=h,a.end+=h}}catch(g){l.e(g)}finally{l.f()}}},{key:"test",get:function(){return{material:this._material,glMaterials:this._glMaterials}}}]),e}())(e.rctx,e.materialRepository,o),e._materialRenderers.set(o,s),t=!0,r=!0,a=!0),s){var l=r||s.hasHighlights,c=a||s.hasWater;s.modify(n),r=r||l!==s.hasHighlights,a=a||c!==s.hasWater,s.isEmpty&&(e._materialRenderers.delete(o),s.dispose(),t=!0)}})),this._changes.clear(),this._pendingAddsRemoves.clear(),t&&this.updateSortedMaterialRenderers(),r&&(this._hasHighlights=Object(S.a)(this._materialRenderers,(function(e){return e.hasHighlights}))),a&&(this._hasWater=Object(S.a)(this._materialRenderers,(function(e){return e.hasWater}))),this.notifyChange("updating"),!0}},{key:"add",value:function(e){if(0!==e.length){var t,n=0===this._pendingAddsRemoves.size,r=W(e);try{for(r.s();!(t=r.n()).done;){var i=t.value;this._pendingAddsRemoves.set(i,0)}}catch(a){r.e(a)}finally{r.f()}n&&this.notifyChange("updating")}}},{key:"remove",value:function(e){var t,n=0===this._pendingAddsRemoves.size,r=W(e);try{for(r.s();!(t=r.n()).done;){var i=t.value,a=this._pendingAddsRemoves.get(i);0===a?this._pendingAddsRemoves.set(i,2):2!==a&&this._pendingAddsRemoves.set(i,1)}}catch(o){r.e(o)}finally{r.f()}n&&this._pendingAddsRemoves.size>0&&this.notifyChange("updating")}},{key:"modify",value:function(e,t){var n,r=0===this._changes.updates.length,i=W(e);try{for(i.s();!(n=i.n()).done;){var a=n.value,o=this._changes.updates.pushNew();o.renderGeometry=a,o.updateType=t}}catch(s){i.e(s)}finally{i.f()}r&&this._changes.updates.length>0&&this.notifyChange("updating")}},{key:"updateLogic",value:function(e){var t=!1;return this._sortedMaterialRenderers.forAll((function(n){var r=n.materialRenderer;r.updateLogic&&r.updateLogic(e)&&(t=!0)})),t}},{key:"draw",value:function(e,t){for(var n=0;n<this._sortedMaterialRenderers.length;n++){var r=this._sortedMaterialRenderers.data[n];Object(be.c)(r.material,e)&&r.materialRenderer.render(null,e,t,null)}}},{key:"updateSortedMaterialRenderers",value:function(){var e=this;this._sortedMaterialRenderers.clear();var t=0;this._materialRenderers.forEach((function(n,r){r.insertOrder=t++,e._sortedMaterialRenderers.push({material:r,materialRenderer:n})})),this._sortedMaterialRenderers.sort((function(e,t){var n=t.material.renderPriority-e.material.renderPriority;return 0!==n?n:e.material.insertOrder-t.material.insertOrder}))}},{key:"updateAddsRemoves",value:function(){var e=this;this._changes.adds.clear(),this._changes.removes.clear(),this._pendingAddsRemoves.forEach((function(t,n){switch(t){case 0:e._changes.adds.push(n);break;case 1:e._changes.removes.push(n)}}));for(var t=0;t<this._changes.updates.length;)this._pendingAddsRemoves.has(this._changes.updates.data[t].renderGeometry)?this._changes.updates.removeUnorderedIndex(t):t++}},{key:"test",get:function(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}}]),n}(_.a);Object(v.a)([Object(m.b)()],rt.prototype,"rctx",void 0),Object(v.a)([Object(m.b)()],rt.prototype,"materialRepository",void 0),Object(v.a)([Object(m.b)()],rt.prototype,"updating",null),rt=Object(v.a)([Object(y.a)("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],rt);var it=n("PkRl"),at=function(e){X(n,e);var t=$(n);function n(){return re(this,n),t.apply(this,arguments)}return Q(n,[{key:"initializeProgram",value:function(e){var t=n.shader.get().build();return new Pe.a(e.rctx,t.generateSource("vertex"),t.generateSource("fragment"),De.a)}},{key:"initializePipeline",value:function(){return this.configuration.hasAlpha?Object(Ae.d)({blending:Object(Ae.e)(770,1,771,771),colorWrite:Ae.b}):Object(Ae.d)({colorWrite:Ae.b})}}]),n}(ke.a);at.shader=new Me.a(it.a,(function(){return n.e(112).then(n.bind(null,"J5od"))}));var ot=function(e){X(n,e);var t=$(n);function n(){var e;return re(this,n),(e=t.apply(this,arguments)).hasAlpha=!1,e}return n}(Ie.a);function st(e,t,n){(n=n||e).length=e.length;for(var r=0;r<e.length;r++)n[r]=e[r]*t[r];return n}function lt(e,t,n){(n=n||e).length=e.length;for(var r=0;r<e.length;r++)n[r]=e[r]*t;return n}function ct(e,t,n){(n=n||e).length=e.length;for(var r=0;r<e.length;r++)n[r]=e[r]+t[r];return n}function ut(e){return(e+1)*(e+1)}function dt(e,t,n){var r=e[0],i=e[1],a=e[2],o=n||[];return o.length=ut(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*a,o[3]=.4886025119*i),t>=2&&(o[4]=1.09254843059*r*i,o[5]=1.09254843059*i*a,o[6]=.31539156525*(3*a*a-1),o[7]=1.09254843059*r*a,o[8]=.54627421529*(r*r-i*i)),o}Object(v.a)([Object(Ie.b)()],ot.prototype,"hasAlpha",void 0);var ht=[],ft=[],pt=[],vt=[0],gt=[0],mt=Object(o.e)(),yt=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],bt=Object(o.e)(),_t=function(){function e(){re(this,e),this._renderLighting={main:{intensity:Object(o.e)(),direction:Object(o.g)(1,0,0),castShadows:!1},sphericalHarmonics:{sh:{r:[0],g:[0],b:[0]}}},this._shOrder=2,this._oldSunlight={direction:Object(o.e)(),ambient:{color:Object(o.e)(),intensity:0},diffuse:{color:Object(o.e)(),intensity:0}}}return Q(e,[{key:"setLightDirectionUniform",value:function(e){e.setUniform3fv("lightingMainDirection",this._renderLighting.main.direction)}},{key:"setUniforms",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];e.setUniform1f("lightingFixedFactor",t?(1-this._info.groundLightingFactor)*(1-this._info.globalFactor):0),e.setUniform1f("lightingGlobalFactor",this._info.globalFactor),this.setLightDirectionUniform(e),e.setUniform3fv("lightingMainIntensity",this._renderLighting.main.intensity),e.setUniform1f("ambientBoostFactor",.4);var n=this._renderLighting.sphericalHarmonics.sh;0===this._shOrder?e.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]):1===this._shOrder?(e.setUniform4f("lightingAmbientSH_R",n.r[0],n.r[1],n.r[2],n.r[3]),e.setUniform4f("lightingAmbientSH_G",n.g[0],n.g[1],n.g[2],n.g[3]),e.setUniform4f("lightingAmbientSH_B",n.b[0],n.b[1],n.b[2],n.b[3])):2===this._shOrder&&(e.setUniform3f("lightingAmbientSH0",n.r[0],n.g[0],n.b[0]),e.setUniform4f("lightingAmbientSH_R1",n.r[1],n.r[2],n.r[3],n.r[4]),e.setUniform4f("lightingAmbientSH_G1",n.g[1],n.g[2],n.g[3],n.g[4]),e.setUniform4f("lightingAmbientSH_B1",n.b[1],n.b[2],n.b[3],n.b[4]),e.setUniform4f("lightingAmbientSH_R2",n.r[5],n.r[6],n.r[7],n.r[8]),e.setUniform4f("lightingAmbientSH_G2",n.g[5],n.g[6],n.g[7],n.g[8]),e.setUniform4f("lightingAmbientSH_B2",n.b[5],n.b[6],n.b[7],n.b[8]))}},{key:"set",value:function(e){this._info=e,function(e,t,n){(function(e,t){var n=ut(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=n;for(var i=0;i<n;i++)r.r[i]=r.g[i]=r.b[i]=0})(t,n.sphericalHarmonics.sh),Object(s.v)(n.main.intensity,0,0,0);var r=!1,i=ht,o=ft,l=pt;i.length=0,o.length=0,l.length=0;var c,u=W(e);try{for(u.s();!(c=u.n()).done;){var d=c.value;d instanceof k&&!r?(Object(s.j)(n.main.direction,d.direction),n.main.intensity[0]=d.intensity[0],n.main.intensity[1]=d.intensity[1],n.main.intensity[2]=d.intensity[2],n.main.castShadows=d.castShadows,r=!0):d instanceof k||d instanceof I?i.push(d):d instanceof D?o.push(d):d instanceof P&&l.push(d)}}catch(v){u.e(v)}finally{u.f()}(function(e,t){var n,r=function(e){return Object(a.c)(Math.floor(Math.sqrt(e)-1),0,2)}(t.r.length),i=W(e);try{for(i.s();!(n=i.n()).done;){var o=n.value;Object(s.s)(mt,o.direction),dt(mt,r,vt),st(vt,yt),lt(vt,o.intensity[0],gt),ct(t.r,gt),lt(vt,o.intensity[1],gt),ct(t.g,gt),lt(vt,o.intensity[2],gt),ct(t.b,gt)}}catch(v){i.e(v)}finally{i.f()}})(i,n.sphericalHarmonics.sh),function(e,t){dt(mt,0,vt);var n,r=W(e);try{for(r.s();!(n=r.n()).done;){var i=n.value;t.r[0]+=vt[0]*yt[0]*i.intensity[0]*4*Math.PI,t.g[0]+=vt[0]*yt[0]*i.intensity[1]*4*Math.PI,t.b[0]+=vt[0]*yt[0]*i.intensity[2]*4*Math.PI}}catch(v){r.e(v)}finally{r.f()}}(o,n.sphericalHarmonics.sh);var h,f=W(l);try{for(f.s();!(h=f.n()).done;){var p=h.value;ct(n.sphericalHarmonics.sh.r,p.sh.r),ct(n.sphericalHarmonics.sh.g,p.sh.g),ct(n.sphericalHarmonics.sh.b,p.sh.b)}}catch(v){f.e(v)}finally{f.f()}}(e.lights,this._shOrder,this._renderLighting),Object(s.s)(this._oldSunlight.direction,this._renderLighting.main.direction);var t=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._renderLighting.sphericalHarmonics.sh.r[0]*t,this._oldSunlight.ambient.color[1]=.282095*this._renderLighting.sphericalHarmonics.sh.g[0]*t,this._oldSunlight.ambient.color[2]=.282095*this._renderLighting.sphericalHarmonics.sh.b[0]*t,this._oldSunlight.ambient.intensity=1,this._oldSunlight.diffuse.color[0]=this._renderLighting.main.intensity[0]*t,this._oldSunlight.diffuse.color[1]=this._renderLighting.main.intensity[1]*t,this._oldSunlight.diffuse.color[2]=this._renderLighting.main.intensity[2]*t,this._oldSunlight.diffuse.intensity=1;var n=Object(s.j)(bt,this._oldSunlight.diffuse.color);Object(s.d)(n,n,.4*this._info.globalFactor),Object(s.e)(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,n)}},{key:"globalFactor",get:function(){return this._info.globalFactor}},{key:"old",get:function(){return this._oldSunlight}}]),e}(),wt=n("NUQ5"),xt=g.a.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer"),Ot=function(e){X(r,e);var t,n=$(r);function r(e){var t;return re(this,r),(t=n.call(this,e))._overlays=null,t._hasHighlights=!1,t._rendersOccluded=!1,t._hasWater=!1,t._lighting=new _t,t._localOrigins=new ye,t._handles=new x.a,t._layerRenderers=new Map,t._sortedLayerRenderersDirty=!1,t._sortedLayerRenderers=new b.a,t._geometries=new Map,t.globalUnitScale=1,t.longitudeCyclical=null,t}return Q(r,[{key:"initialize",value:function(){var e=this;this._rctx=this.renderView.renderingContext,this._renderContext=new(function(){function e(t,n,r,i,a,o){re(this,e),this.rctx=t,this.offscreenRenderingHelper=n,this.scenelightingData=r,this.shadowMap=i,this.ssaoHelper=a,this.sliceHelper=o,this.camera=null,this.lastFrameCamera=new H.a,this.pass=0,this.slot=0,this.highlightDepthTexture=null,this.renderOccludedMask=13,this.hasOccludees=!1}return Q(e,[{key:"resetRenderOccludedMask",value:function(){this.renderOccludedMask=13}},{key:"isHighlightPass",get:function(){return 5===this.pass}}]),e}())(this._rctx,null,null,null,null,null),this._stippleTextureRepository=new wt.a,this.waterTextureRepository=this.renderView.waterTextureRepository,this._shaderTechniqueRepository=new ie({rctx:this._rctx,viewingMode:2,commonUniformStore:new te,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),Object(O.init)(this.waterTextureRepository,"loadingState",(function(){return e.emitContentChanged()})),this._materialRepository=new(function(){function e(t,n,r){re(this,e),this._textureRep=t,this._techniqueRep=n,this.onMaterialChanged=r,this._id2glMaterialRef=new Map}return Q(e,[{key:"dispose",value:function(){this._textureRep.dispose()}},{key:"acquire",value:function(e,t){this.ownMaterial(e);var n=se(e.id,t),r=this._id2glMaterialRef.get(n);if(null==r){var i=e.getGLMaterial({material:e,techniqueRep:this._techniqueRep,textureRep:this._textureRep,output:t});return(r=new ce(i)).incRefCnt(),this._id2glMaterialRef.set(n,r),i}return r.incRefCnt(),r.getGLMaterial()}},{key:"release",value:function(e,t){var n=se(e.id,t),r=this._id2glMaterialRef.get(n);if(r.decRefCnt(),0===r.getRefCnt()){var i=r.getGLMaterial();i&&i.dispose(),this._id2glMaterialRef.delete(n)}}},{key:"materialChanged",value:function(e){var t,n=W(oe);try{for(n.s();!(t=n.n()).done;){var r=t.value;if(5!==r.output&&6!==r.output){var i=this._id2glMaterialRef.get(se(e.id,r.output));if(i&&i.getGLMaterial()){var a=i.getGLMaterial();a.updateParameters&&a.updateParameters()}}}}catch(o){n.e(o)}finally{n.f()}this.onMaterialChanged&&this.onMaterialChanged(e)}},{key:"ownMaterial",value:function(e){Object(i.k)(e.materialRepository)&&e.materialRepository!==this&&le.error("Material is already owned by a different material repository"),e.materialRepository=this}}]),e}())(this.renderView.textureRepository,this._shaderTechniqueRepository),this._materialRepository.onMaterialChanged=function(t){(t.renderOccluded&Et)>0!==e._rendersOccluded&&e.updateRendersOccluded(),e.emitContentChanged(),e.notifyChange("updating")},this._compositingHelper=this.renderView.compositingHelper,this._lighting.set({lights:[new D(Object(o.g)(1,1,1))],groundLightingFactor:1,globalFactor:0}),this._bindParameters={slot:null,highlightDepthTexture:Object(M.a)(this._rctx),camera:St,inverseViewport:Object(C.a)(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureUnit:0,lastFrameColorTexture:null,lastFrameColorTextureUnit:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting,transparencyPassType:3,terrainLinearDepthTexture:null,geometryLinearDepthTexture:null,multipassTerrainEnabled:!1,cullAboveGround:!0,multipassGeometryEnabled:!1},this._handles.add(this.scheduler.registerTask(j.b.STAGE,(function(){return e.commitChanges()}),(function(){return e.updating})))}},{key:"dispose",value:function(){this._handles.destroy(),this._layerRenderers.forEach((function(e){return e.dispose()})),this._layerRenderers.clear(),this._bindParameters.highlightDepthTexture=Object(i.f)(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Object(i.f)(this._shaderTechniqueRepository),this._temporaryRenderTarget=Object(i.f)(this._temporaryRenderTarget),this._debugPatternTexture=Object(i.f)(this._debugPatternTexture),this._quadVAO=Object(i.f)(this._quadVAO)}},{key:"updating",get:function(){return this._sortedLayerRenderersDirty||Object(S.a)(this._layerRenderers,(function(e){return e.updating}))||this.waterTextureRepository.updating}},{key:"hasOverlays",get:function(){return Object(i.k)(this._overlays)}},{key:"gpuMemoryUsage",get:function(){return Object(i.k)(this._overlays)?this._overlays[0].getGpuMemoryUsage()+this._overlays[1].getGpuMemoryUsage():0}},{key:"overlays",get:function(){return this._overlays}},{key:"forEachOverlay",value:function(e){Object(i.k)(this._overlays)&&(e(this._overlays[0],0),e(this._overlays[1],1))}},{key:"ensureOverlays",value:function(){if(Object(i.j)(this._overlays)){var e=this.renderView.renderingContext;this._overlays=[new K(e),new K(e)]}}},{key:"disposeOverlays",value:function(){Object(i.k)(this._overlays)&&(this._overlays.forEach((function(e){return e.dispose()})),this._overlays=null)}},{key:"commitChanges",value:function(){var e=this,t=!1;this._layerRenderers.forEach((function(n,r){n.commitChanges()&&(t=!0),n.isEmpty&&(e._layerRenderers.delete(r),e._sortedLayerRenderersDirty=!0,e._handles.remove(r))})),this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),t=!0),t&&(this.notifyChange("updating"),this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())}},{key:"addGeometries",value:function(e,t,n){var r,a=W(e);try{for(a.s();!(r=a.n()).done;){var o=r.value;null==o.origin&&(o.origin=this._localOrigins.getOrigin(o.boundingSphere)),Object(i.j)(o.id)&&(o.id=Object(w.a)()),this._geometries.set(o.id,o)}}catch(s){a.e(s)}finally{a.f()}this.ensureLayerRenderer(t).add(e),2===n&&this.notifyGraphicGeometryChanged(e,t)}},{key:"removeGeometries",value:function(e,t,n){var r,a=W(e);try{for(a.s();!(r=a.n()).done;){var o=r.value;this._geometries.delete(Object(i.q)(o.id))}}catch(l){a.e(l)}finally{a.f()}var s=this._layerRenderers.get(t);s&&(s.remove(e),2===n&&this.notifyGraphicGeometryChanged(e,t))}},{key:"updateGeometries",value:function(e,t,n){var r=this._layerRenderers.get(t);if(r)switch(r.modify(e,n),n){case 4:case 2:return this.notifyGraphicGeometryChanged(e,t);case 1:return this.notifyGraphicVisibilityChanged(e,t)}else xt.warn("Attempted to update geometry for nonexistent layer")}},{key:"notifyGraphicGeometryChanged",value:function(e,t){if(!Object(i.j)(t.notifyGraphicGeometryChanged)){var n,r,a=W(e);try{for(a.s();!(r=a.n()).done;){var o=r.value.graphicUid;o!==n&&(t.notifyGraphicGeometryChanged(o),n=o)}}catch(s){a.e(s)}finally{a.f()}}}},{key:"notifyGraphicVisibilityChanged",value:function(e,t){if(!Object(i.j)(t.notifyGraphicVisibilityChanged)){var n,r,a=W(e);try{for(a.s();!(r=a.n()).done;){var o=r.value.graphicUid;o!==n&&(t.notifyGraphicVisibilityChanged(o),n=o)}}catch(s){a.e(s)}finally{a.f()}}}},{key:"updateHighlights",value:function(e,t){var n=this._layerRenderers.get(t);n?n.modify(e,8):xt.warn("Attempted to update highlights for nonexistent layer")}},{key:"isEmpty",value:function(){return 0===this._geometries.size&&!N.OVERLAY_DRAW_DEBUG_TEXTURE}},{key:"hasHighlights",get:function(){return this._hasHighlights}},{key:"hasWater",get:function(){return this._hasWater}},{key:"rendersOccluded",get:function(){return this._rendersOccluded}},{key:"updateLogic",value:function(e){var t=!1;return this._layerRenderers.forEach((function(n){n.updateLogic(e)&&(t=!0)})),t}},{key:"updateLayerOrder",value:function(){this._sortedLayerRenderersDirty=!0}},{key:"drawPass",value:function(e,t,n){var r=this,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(0===n.numViews)return!1;if(this._screenToWorldRatio=n.pixelRatio*Math.abs(n.views[0].extent[2]-n.views[0].extent[0])/Math.abs(n.views[0].viewport[2]-n.views[0].viewport[0]),this.isEmpty()||5===e&&!this.hasHighlights||3===e&&!this.hasWater)return!1;if(!this.hasNonZeroSizedView(n))return!1;var o=n.width,s=n.height;if(!t.isValid())return!1;t.resize(o,s);var l=this._rctx;if(St.pixelRatio=n.pixelRatio||1,this._renderContext.pass=e,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale,t.bind(l),l.setClearColor(0,0,0,0),l.clearSafe(16384),1===a&&(this._renderContext.renderOccludedMask=Et),N.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==a)for(var c=0;c<n.numViews;c++)this.setViewParameters(n.views[c],St),this.drawDebugTexture(o,s,jt[n.index%jt.length]);return this._layerRenderers.size>0&&this._sortedLayerRenderers.forAll((function(c){var u=c.layerView,d=c.renderer;if(2!==a||!Object(i.k)(u)||0!==u.drapeSourceType){var h=Object(i.k)(u)&&Object(i.k)(u.fullOpacity)&&u.fullOpacity<1&&0===e;h&&(r.bindTemporaryFramebuffer(r._rctx,o,s),l.clearSafe(16384));for(var f=0;f<n.numViews;f++)r.setViewParameters(n.views[f],St),d.draw(r._renderContext,r._bindParameters);h&&Object(i.k)(r._temporaryRenderTarget)&&(t.bind(l),r._compositingHelper.composite(r._temporaryRenderTarget.getTexture(),2,Object(i.q)(Object(i.q)(u).fullOpacity)))}})),l.bindFramebuffer(null),t.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}},{key:"bindTemporaryFramebuffer",value:function(e,t,n){Object(i.j)(this._temporaryRenderTarget)&&(this._temporaryRenderTarget=new U(e,!1)),this._temporaryRenderTarget.resize(t,n),this._temporaryRenderTarget.bind(e)}},{key:"reloadShaders",value:(t=Y(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._shaderTechniqueRepository.hotReload();case 2:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"intersect",value:function(e,t,n){var r=this,i=0;this._geometries.forEach((function(a){if(!n||n(a)){r.intersectRenderGeometry(a,t,0,e,i);var o=r.longitudeCyclical;o&&(a.boundingSphere[0]-a.boundingSphere[3]<o.min&&r.intersectRenderGeometry(a,t,o.range,e,i),a.boundingSphere[0]+a.boundingSphere[3]>o.max&&r.intersectRenderGeometry(a,t,-o.range,e,i)),i++}}))}},{key:"intersectRenderGeometry",value:function(e,t,n,r,a){var o=this;if(e.instanceParameters.visible){var s=0;Object(i.k)(e.transformation)&&(n+=e.transformation[12],s=e.transformation[13]),Ct[0]=t[0]-n,Ct[1]=t[1]-s,Ct[2]=1,Tt[0]=t[0]-n,Tt[1]=t[1]-s,Tt[2]=0,e.screenToWorldRatio=this._screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),r,Ct,Tt,(function(t,n,i){o.addIntersectionResult(i,e.material.renderPriority,a,r,e.layerUid,e.graphicUid)}),e.calculateShaderTransformation,!0)}}},{key:"addIntersectionResult",value:function(e,t,n,r,i,a){var o={type:"external",metadata:{layerUid:i,graphicUid:a}},s=function(i){i.set(o,null,r.results.ground.dist,r.results.ground.normal,r.results.ground.transformation,t,null,null,e,n),i.intersector="OverlayRenderer"};if((null==r.results.min.drapedLayerOrder||t>=r.results.min.drapedLayerOrder)&&(null==r.results.min.dist||r.results.ground.dist<=r.results.min.dist)&&s(r.results.min),0!==r.options.store&&(null==r.results.max.drapedLayerOrder||t<r.results.max.drapedLayerOrder)&&(null==r.results.max.dist||r.results.ground.dist>r.results.max.dist)&&s(r.results.max),2===r.options.store){var l=new A.b(r.ray);s(l),r.results.all.push(l)}}},{key:"stopAnimationsAtTime",value:function(e){this._sortedLayerRenderers.forAll((function(t){return t.renderer.stopAnimationsAtTime(e)}))}},{key:"ensureLayerRenderer",value:function(e){var t=this,n=this._layerRenderers.get(e);return n||(n=new rt({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(e,n),this._sortedLayerRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(e.watch("fullOpacity",(function(){return t.emitContentChanged()})),e),this._handles.add(Object(O.init)(n,"updating",(function(){return t.notifyChange("updating")})),e)),n}},{key:"updateSortedLayerRenderers",value:function(){var e=this;if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var t=G(this._layerRenderers.keys(),1)[0].view.allLayerViews,n=new Set(this._layerRenderers.values());t.forEach((function(t){var r=t,i=e._layerRenderers.get(r);i&&(e._sortedLayerRenderers.push(new Rt(r,i)),n.delete(i))})),n.forEach((function(t){e._sortedLayerRenderers.push(new Rt(null,t))}))}}},{key:"setViewParameters",value:function(e,t){t.viewport=e.viewport;var n=e.extent;Object(R.n)(t.projectionMatrix,0,n[2]-n[0],0,n[3]-n[1],t.near,t.far),Object(R.i)(t.viewMatrix),Object(R.s)(t.viewMatrix,t.viewMatrix,[-e.extent[0],-e.extent[1],0]),t.setGLViewport(this._rctx),this._renderContext.camera=t,this._bindParameters.camera=t,this._bindParameters.inverseViewport[0]=1/t.fullViewport[2],this._bindParameters.inverseViewport[1]=1/t.fullViewport[3]}},{key:"hasNonZeroSizedView",value:function(e){for(var t=0;t<e.numViews;t++){var n=e.views[t];if(n.extent[0]!==n.extent[2]&&n.extent[1]!==n.extent[3])return!0}return!1}},{key:"emitContentChanged",value:function(){this.onContentChanged&&this.onContentChanged()}},{key:"updateHasWater",value:function(){var e=Object(S.a)(this._layerRenderers,(function(e){return e.hasWater}));e!==this._hasWater&&(this._hasWater=e)}},{key:"updateHasHighlights",value:function(){var e=Object(S.a)(this._layerRenderers,(function(e){return e.hasHighlights}));e!==this._hasHighlights&&(this._hasHighlights=e,this.onHasHighlightsChanged&&this.onHasHighlightsChanged(this._hasHighlights))}},{key:"updateRendersOccluded",value:function(){var e=Object(S.a)(this._layerRenderers,(function(e){return e.rendersOccluded}));e!==this._rendersOccluded&&(this._rendersOccluded=e,this.onRendersOccludedChanged&&this.onRendersOccludedChanged(this.rendersOccluded))}},{key:"drawDebugTexture",value:function(e,t,n){var r=this._rctx;this.ensureDebugPatternResources(e,t);var i=this._debugTextureTechnique.program;r.bindProgram(i),r.setPipelineState(this._debugTextureTechnique.pipeline),i.setUniform4f("color",n[0],n[1],n[2],1),i.setUniform1i("tex",0),r.bindTexture(this._debugPatternTexture,0),r.bindVAO(this._quadVAO),r.drawArrays(5,0,Object(E.f)(this._quadVAO,"geometry"))}},{key:"ensureDebugPatternResources",value:function(e,t){if(!this._debugPatternTexture){for(var n=new Uint8Array(e*t*4),r=0,i=0;i<t;i++)for(var a=0;a<e;a++){var o=Math.floor(a/10),s=Math.floor(i/10);o<2||s<2||10*o>e-20||10*s>t-20?(n[r++]=255,n[r++]=255,n[r++]=255,n[r++]=255):(n[r++]=255,n[r++]=255,n[r++]=255,n[r++]=1&o&&1&s?1&a^1&i?0:255:1&o^1&s?0:128)}this._debugPatternTexture=new T.a(this._rctx,{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:e,height:t},n);var l=new ot;l.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(at,l,this._debugTextureTechnique),this._quadVAO=Object(M.b)(this._rctx)}}},{key:"test",get:function(){return{layerRenderers:this._layerRenderers}}}]),r}(Object(z.b)(_.a));Object(v.a)([Object(z.c)()],Ot.prototype,"_shaderTechniqueRepository",void 0),Object(v.a)([Object(z.c)()],Ot.prototype,"_stippleTextureRepository",void 0),Object(v.a)([Object(m.b)(),Object(z.c)()],Ot.prototype,"waterTextureRepository",void 0),Object(v.a)([Object(m.b)({constructOnly:!0})],Ot.prototype,"renderView",void 0),Object(v.a)([Object(m.b)({constructOnly:!0})],Ot.prototype,"scheduler",void 0),Object(v.a)([Object(m.b)()],Ot.prototype,"globalUnitScale",void 0),Object(v.a)([Object(m.b)({type:Boolean,readOnly:!0})],Ot.prototype,"updating",null),Ot=Object(v.a)([Object(y.a)("esri.views.3d.terrain.OverlayRenderer")],Ot);var Rt=function e(t,n){re(this,e),this.layerView=t,this.renderer=n},jt=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],St=new H.a;St.near=1,St.far=1e4,St.relativeElevation=null;var Ct=Object(o.e)(),Tt=Object(o.e)(),Et=4,Mt=n("D8Ta").a;function kt(e){var t=[],n=[];!function(e,t,n){for(var i=e.attributeData.position,a=e.removeDuplicateStartEnd,o=function(e){var t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}(i)&&1===a,s=i.length/3-(o?1:0),l=new Uint32Array(2*(s-1)),c=o?Object(r.m)(i,0,i.length-3):i,u=0,d=0;d<s-1;d++)l[u++]=d,l[u++]=d+1;t.push(["position",{size:3,data:c,exclusive:o}]),n.push(["position",l])}(e,n,t);var o=n[0][1].data,l=new Uint16Array(t[0][1].length);return function(e,t,n){var r=e.attributeData.mapPosition;Object(i.j)(r)||(n.push(["mapPos",n[0][1]]),t.push(["mapPos",{size:3,data:r}]))}(e,n,t),function(e,t,n,r){if(!Object(i.k)(e.attributeData.colorFeature)){var a=e.attributeData.color;t.push(["color",{size:4,data:Object(i.r)(a,Mt)}]),n.push(["color",r])}}(e,n,t,l),function(e,t,n,r){if(!Object(i.k)(e.attributeData.sizeFeature)){var a=e.attributeData.size;t.push(["size",{size:1,data:[Object(i.r)(a,1)]}]),n.push(["size",r])}}(e,n,t,l),function(e,t,n,r){var a=e.attributeData.colorFeature;Object(i.j)(a)||(t.push(["colorFeatureAttribute",{size:1,data:new Float32Array([a])}]),n.push(["color",r]))}(e,n,t,l),function(e,t,n,r){var a=e.attributeData.sizeFeature;Object(i.j)(a)||(t.push(["sizeFeatureAttribute",{size:1,data:new Float32Array([a])}]),n.push(["sizeFeatureAttribute",r]))}(e,n,t,l),function(e,t,n,r){var a=e.attributeData.opacityFeature;Object(i.j)(a)||(t.push(["opacityFeatureAttribute",{size:1,data:new Float32Array([a])}]),n.push(["opacityFeatureAttribute",r]))}(e,n,t,l),function(e,t,n,r){if("round"===e.join){var o=r.length/3,l=new Float32Array(o),c=Ht,u=Lt;Object(s.v)(c,0,0,0);for(var d=Object(i.r)(e.uniformSize,1),h=-1;h<o;++h){var f=h<0?o+h:h,p=(h+1)%o;if(Object(s.v)(u,r[3*p+0]-r[3*f+0],r[3*p+1]-r[3*f+1],r[3*p+2]-r[3*f+2]),Object(s.q)(u,u),h>=0){var v=(Math.PI-Object(a.a)(Object(s.g)(c,u)))*Nt*1*At(d);l[h]=Math.max(Math.floor(v),0)}Object(s.d)(c,u,-1)}t.push(["subdivisions",{size:1,data:l}]),n.push(["subdivisions",n[0][1]])}}(e,n,t,o),new f.a(n,t,2)}function It(e,t,n,r){var i="polygon"===e.type?1:0,a=u("polygon"===e.type?e.rings:e.paths,e.hasZ,i),o=a.position,s=a.outlines,l=new Float64Array(o.length),c=Object(p.b)(o,e.spatialReference,0,l,0,o,0,o.length/3,t,n,r),d=null!=c;return{lines:d?Dt(s,o,l):[],projectionSuccess:d,sampledElevation:c}}function Dt(e,t,n){var r,i=new Array,a=W(e);try{for(a.s();!(r=a.n()).done;){var o=r.value,s=o.index,l=o.count;if(!(l<=1)){var c=3*s,u=c+3*l;i.push({position:t.subarray(c,u),mapPosition:n?n.subarray(c,u):void 0})}}}catch(d){a.e(d)}finally{a.f()}return i}function Pt(e,t){for(var n="polygon"===e.type?1:0,r=u("polygon"===e.type?e.rings:e.paths,!1,n),i=r.position,a=r.outlines,o=Object(l.k)(i,e.spatialReference,0,i,t,0,i.length/3),s=2;s<i.length;s+=3)i[s]=-2;return{lines:o?Dt(a,i):[],projectionSuccess:o}}function At(e){return 1.863798+-2.0062872/Math.pow(1+e/18.2313,.8856294)}var Ht=Object(o.e)(),Lt=Object(o.e)(),Nt=4/Math.PI},"2YHA":function(e,r,i){"use strict";i.d(r,"a",(function(){return s})),i.d(r,"b",(function(){return o}));var a=i("OIYi");function o(e){e.fragment.code.add(a.a(t||(t=ne(["\n    float normals2FoamIntensity(vec3 n, float waveStrength){\n      float normalizationFactor =  max(0.015, waveStrength);\n      return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);\n    }\n  "]))))}function s(e){e.fragment.code.add(a.a(n||(n=ne(["\n    vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){\n      return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;\n    }\n  "]))))}},"33ep":function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var a=n("OIYi"),o=n("0Ect");function s(e){e.fragment.uniforms.add("lastFrameColorMap","sampler2D"),e.fragment.uniforms.add("reprojectionMat","mat4"),e.fragment.uniforms.add("rpProjectionMat","mat4"),e.fragment.code.add(a.a(r||(r=ne(["\n  vec2 reprojectionCoordinate(vec3 projectionCoordinate)\n  {\n    vec4 zw = rpProjectionMat * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);\n    vec4 reprojectedCoord = reprojectionMat * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);\n    reprojectedCoord.xy /= reprojectedCoord.w;\n    return reprojectedCoord.xy*0.5 + 0.5;\n  }\n  "]))))}function l(e,t){e.fragment.uniforms.add("nearFar","vec2"),e.fragment.uniforms.add("depthMapView","sampler2D"),e.fragment.uniforms.add("ssrViewMat","mat4"),e.fragment.uniforms.add("invResolutionHeight","float"),e.fragment.include(o.a),e.include(s),e.fragment.code.add(a.a(i||(i=ne(["\n  const int maxSteps = ","\n\n  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)\n  {\n    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);\n    projectedCoord.xy /= projectedCoord.w;\n    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;\n    return projectedCoord;\n  }\n\n  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)\n  {\n    vec3 viewPos = startPosition;\n    vec3 viewPosEnd = startPosition;\n\n    // Project the start position to the screen\n    vec4 projectedCoordStart = applyProjectionMat(rpProjectionMat, viewPos);\n    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space\n    float k0 = 1.0/ projectedCoordStart.w;\n\n    // advance the position in the direction of the reflection\n    viewPos += dir;\n\n    vec4 projectedCoordVanishingPoint = applyProjectionMat(rpProjectionMat, dir);\n\n    // Project the advanced position to the screen\n    vec4 projectedCoordEnd = applyProjectionMat(rpProjectionMat, viewPos);\n    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space\n    float k1 = 1.0/ projectedCoordEnd.w;\n\n    // calculate the reflection direction in the screen space\n    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);\n    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);\n\n    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);\n\n    float projectedCoordDirLength = length(projectedCoordDir);\n    float maxSt = float(maxSteps);\n\n    // normalize the projection direction depending on maximum steps\n    // this determines how blocky the reflection looks\n    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);\n\n    // Normalize the homogeneous camera space coordinates\n    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);\n    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);\n\n    // initialize the variables for ray marching\n    vec2 P = projectedCoordStart.xy;\n    vec3 Q = Q0;\n    float k = k0;\n    float rayStartZ = -startPosition.z; // estimated ray start depth value\n    float rayEndZ = -startPosition.z;   // estimated ray end depth value\n    float prevEstimateZ = -startPosition.z;\n    float rayDiffZ = 0.0;\n    float dDepth;\n    float depth;\n    float rayDiffZOld = 0.0;\n\n    // early outs\n    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)\n      return vec3(P, 0.0);\n\n    for(int i = 0; i < maxSteps-1; i++)\n    {\n      depth = -linearDepthFromTexture(depthMapView, P, nearFar); // get linear depth from the depth buffer\n\n      // estimate depth of the marching ray\n      rayStartZ = prevEstimateZ;\n      dDepth = -rayStartZ - depth;\n      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));\n      rayDiffZ = rayEndZ- rayStartZ;\n      prevEstimateZ = rayEndZ;\n\n      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )\n      {\n        return vec3(P, 0.);\n      }\n\n      // If we detect a hit - return the intersection point, two conditions:\n      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth\n      //  - if difference between dDepth and rayDiffZOld is not too large\n      //  - if difference between dDepth and 0.025/abs(k) is not too large\n      //  - if the sampled depth is not behind far plane or in front of near plane\n\n      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)\n      {\n          return vec3(P, depth);\n      }\n\n      // continue with ray marching\n      P += dP;\n      Q.z += dQ.z;\n      k += dk;\n      rayDiffZOld = rayDiffZ;\n    }\n    return vec3(P, 0.0);\n  }\n  "])),t.highStepCount?"150;":"75;"))}(s||(s={})).bindUniforms=function(e,t,n){e.setUniform1i("lastFrameColorMap",n.lastFrameColorTextureUnit),t.bindTexture(n.lastFrameColorTexture,n.lastFrameColorTextureUnit),e.setUniformMatrix4fv("reprojectionMat",n.reprojectionMat),e.setUniformMatrix4fv("rpProjectionMat",n.camera.projectionMatrix)},(l||(l={})).bindUniforms=function(e,t,n){n.ssrEnabled&&(e.setUniform1i("depthMapView",n.linearDepthTextureUnit),t.bindTexture(n.linearDepthTexture,n.linearDepthTextureUnit),e.setUniform2fv("nearFar",n.camera.nearFar),e.setUniformMatrix4fv("ssrViewMat",n.camera.viewMatrix),e.setUniform1f("invResolutionHeight",1/n.camera.height),s.bindUniforms(e,t,n))}},"5VCU":function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var r=n("OIYi"),i=n("33ep"),c=n("2YHA");function u(e){e.fragment.code.add(r.a(a||(a=ne(["\n    const float GAMMA = 2.2;\n    const float INV_GAMMA = 0.4545454545;\n\n    vec4 delinearizeGamma(vec4 color) {\n      return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);\n    }\n\n    vec3 linearizeGamma(vec3 color) {\n      return pow(color, vec3(GAMMA));\n    }\n  "]))))}var d=n("XV/G");function h(e,t){e.include(d.a,t),e.include(u),e.include(c.a),t.ssrEnabled&&e.include(i.a,t),e.fragment.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.775).add("waterSeeColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]),e.fragment.code.add(r.a(o||(o=ne(["\n    PBRShadingWater shadingInfo;\n\n    /*\n    *   This function is an approximation for the sky gradient reflected\n    *   the water surface and describes a combination of two fresnel terms.\n    *   @parameter: cosTheta = is the result of max(dot(n,v), 0.0)\n    *   @parameter: horizon = the dominant color of the sky horizon\n    *   @parameter: cosTheta = the dominant color of the sky zenit\n    */\n    vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {\n      float exponent = pow((1.0 - cosTheta), fresnelSky[2]);\n      return mix(zenit, horizon, exponent);\n    }\n\n    /*\n    *   This function determines the water color per pixel.\n    *   @parameter: n = normal facing away from the surface\n    *   @parameter: v = view direction facing away from the surface.\n    *   @parameter: l = light direction facing away from the surface\n    *   @parameter: lightIntensity = light intensity, currently between 0...PI\n    *   @parameter: localUp = a normal for the general direction of the surface\n    *   @parameter: shadow = the amount of shadow at this pixel (0 = no shadow)\n    */\n    vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 positionView) {\n\n      float reflectionHit = 0.;\n      vec3 seaWaterColor = linearizeGamma(color);\n      // using half vector to determine the specular light\n      vec3 h = normalize(l + v);\n      shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);\n      shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);\n      shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);\n      shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);\n      shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);\n      shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);\n\n      // angle between vertex normal and view direction\n      float upDotV = max(dot(localUp,v), 0.0);\n      // reflected sky color: the reflected sky color consists of two main colors, the\n      // reflected color at the horizon and the reflected color of the zenit.\n      // the reflected sky color is then an approximation based on the fresnel term.\n      vec3 skyHorizon = linearizeGamma(skyColor);\n      vec3 skyZenit = linearizeGamma(skyZenitColor);\n      vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );\n\n      // we use the upDotL to smoothen out the\n      // reflected color of the water\n      float upDotL = max(dot(localUp,l),0.0);\n\n      // The approximated sky color is adjusted according to the sun position.\n      // This is done as approximation for e.g. night views.\n      float daytimeMod = 0.1 + upDotL * 0.9;\n      skyColor *= daytimeMod;\n\n      // If a water surface is in shadow we just use a slight darkening of the\n      // water surface expressed with this shadowModifier.\n      float shadowModifier = clamp(shadow, 0.8, 1.0);\n\n      // The reflected sky color consists of the fresnel reflection multiplied with the approximated sky color.\n      // The shadow is influencing the frensel term to keep the shadow impression for really near views. As long\n      // as reflection are absent there is a need to have a slight shadow for depth perception.\n      vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);\n      vec3 reflSky = fresnelModifier * skyColor * shadowModifier;\n\n      // The reflected sea color is the input water color combined with the reflected sky color.\n      // The reflected sky color is modified by the incoming light.\n      vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;\n\n      vec3 specular = vec3(0.0);\n      // This prevents the specular light to be rendered when:\n      // - sun is behind a polygon (e.g. sundown for elevated polygons where nDotL might be still ok)\n      // - viewer is under water (for this localUp is better than n)\n      if(upDotV > 0.0 && upDotL > 0.0) {\n        // calculate the cook torrance BRDF but with simplified occlusion\n        vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);\n\n        // Normalize light intensity to be between 0...1. Shadow cancels out specular light here\n        vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;\n\n        specular = shadingInfo.NdotL * incidentLight * specularSun;\n      }\n\n      vec3 foam = vec3(0.0);\n      if(upDotV > 0.0) {\n        foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);\n      }\n      "])))),e.fragment.code.add(t.ssrEnabled?r.a(s||(s=ne(["\n      // Convert the world position to view position\n      vec4 viewPosition = vec4(positionView.xyz, 1.0);\n      vec3 viewDir = normalize(viewPosition.xyz);\n      vec4 viewNormalVectorCoordinate = ssrViewMat *vec4(n, 0.0);\n      vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);\n      vec4 viewUp = ssrViewMat *vec4(localUp, 0.0);\n\n      // at steeper viewing angles we use more of a vertex normal (in this case up) then the wave normal\n      // this removes some artifacts of normal mapping\n      float correctionViewingFactor = pow(max(dot(-viewDir, viewUp.xyz), 0.0), correctionViewingPowerFactor);\n      vec3 viewNormalCorrected = mix(viewUp.xyz, viewNormal, correctionViewingFactor);\n\n      vec3 reflected = normalize(reflect(viewDir, viewNormalCorrected));\n\n      // perform screen space reflection to detect hit\n      vec3 hitCoordinate = screenSpaceIntersection( normalize(reflected), viewPosition.xyz, viewDir, viewUp.xyz);\n      vec3 reflectedColor = vec3(0.0);\n\n      // if there is a hit with ssr find reflected color from the reprojeted frame\n      if (hitCoordinate.z > 0.0)\n      {\n        vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);\n\n        // fade out if there if the hit is near end of Y axis\n        vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));\n        float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -positionView.z);\n        reflectionHit = waterDiffusion * clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;\n\n        reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHit * fresnelModifier.y * ssrIntensity;\n      }\n      float seeColorMod =  mix(waterSeeColorMod, waterSeeColorMod*0.5, reflectionHit);\n      // combining reflected sky, reflected sea, specular highlight and SSR reflections.\n      return tonemapACES((1. - reflectionHit) * reflSky + reflectedColor + reflSea * seeColorMod + specular + foam);\n    }\n  "]))):r.a(l||(l=ne(["\n      // combining reflected sky, reflected sea, specular highlight and SSR reflections.\n      return tonemapACES(reflSky + reflSea * waterSeeColorMod + specular + foam);\n    }\n  "]))))}},"6kRo":function(e,t,n){"use strict";n.d(t,"a",(function(){return T})),n.d(t,"b",(function(){return C}));var r=n("OIYi"),i=n("Tbkp"),a=n("aQrP"),o=n("Q3fD"),s=n("0nJL"),l=n("0Ect"),b=n("agdK"),_=n("69UF"),w=n("xtdb"),x=n("0BfS"),O=n("M+I8"),R=n("vXUg"),j=n("BAva"),S=n("5VCU");function C(e){var t=new a.a;return t.include(i.a,{linearDepth:!1}),t.attributes.add("position","vec3"),t.attributes.add("uv0","vec2"),t.vertex.uniforms.add("proj","mat4").add("view","mat4").add("localOrigin","vec3"),t.vertex.uniforms.add("waterColor","vec4"),0!==e.output&&7!==e.output||(t.include(j.a,e),t.include(R.a,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),e.multipassTerrainEnabled&&t.varyings.add("depth","float"),t.vertex.code.add(r.a(c||(c=ne(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vuv = uv0;\n        vpos = position;\n\n        vnormal = getLocalUp(vpos, localOrigin);\n        vtbnMatrix = getTBNMatrix(vnormal);\n\n        ","\n\n        gl_Position = transformPosition(proj, view, vpos);\n        ","\n      }\n    "])),r.a.float(_.c),e.multipassTerrainEnabled?"depth = (view * vec4(vpos, 1.0)).z;":"",0===e.output?"forwardLinearDepth();":""))),e.multipassTerrainEnabled&&(t.fragment.include(l.a),t.include(w.b,e)),7===e.output&&(t.include(s.a,e),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(r.a(u||(u=ne(["\n        void main() {\n          discardBySlice(vpos);\n          ","\n\n          gl_FragColor = vec4(waterColor.a);\n        }\n      "])),e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":""))),0===e.output&&(t.include(O.a,e),t.include(s.a,e),e.receiveShadows&&t.include(x.a,e),t.include(S.a,e),t.fragment.uniforms.add("waterColor","vec4").add("lightingMainDirection","vec3").add("lightingMainIntensity","vec3").add("camPos","vec3").add("timeElapsed","float").add("view","mat4"),t.fragment.include(o.a),t.fragment.code.add(r.a(d||(d=ne(["\n      void main() {\n        discardBySlice(vpos);\n        ","\n        vec3 localUp = vnormal;\n        // the created normal is in tangent space\n        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n\n        // we rotate the normal according to the tangent-bitangent-normal-Matrix\n        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);\n        vec3 v = -normalize(vpos - camPos);\n        vec3 l = normalize(-lightingMainDirection);\n        float shadow = ",";\n        vec4 vPosView = view*vec4(vpos, 1.0);\n        vec4 final = vec4(getSeaColor(n, v, l, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz), waterColor.w);\n\n        // gamma correction\n        gl_FragColor = delinearizeGamma(final);\n        gl_FragColor = highlightSlice(gl_FragColor, vpos);\n        ","\n      }\n    "])),e.multipassTerrainEnabled?"terrainDepthTest(gl_FragCoord, depth);":"",e.receiveShadows?r.a(h||(h=ne(["1.0 - readShadowMap(vpos, linearDepth)"]))):"1.0",e.OITEnabled?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""))),2===e.output&&(t.include(j.a,e),t.include(O.a,e),t.include(s.a,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),t.vertex.code.add(r.a(f||(f=ne(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vuv = uv0;\n          vpos = position;\n\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),r.a.float(_.c))),t.fragment.uniforms.add("timeElapsed","float"),t.fragment.code.add(r.a(p||(p=ne(["\n        void main() {\n          discardBySlice(vpos);\n\n          // the created normal is in tangent space and foam\n          vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);\n          tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);\n\n          gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);\n        }\n    "]))))),5===e.output&&(t.varyings.add("vpos","vec3"),t.vertex.code.add(r.a(v||(v=ne(["\n        void main(void) {\n          if (waterColor.a < ",") {\n            // Discard this vertex\n            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n            return;\n          }\n\n          vpos = position;\n          gl_Position = transformPosition(proj, view, vpos);\n        }\n    "])),r.a.float(_.c))),t.fragment.uniforms.add("waterColor","vec4"),t.fragment.code.add(r.a(g||(g=ne(["\n        void main() {\n          gl_FragColor = waterColor;\n        }\n    "]))))),4===e.output&&(t.include(b.a),t.varyings.add("vpos","vec3"),t.vertex.code.add(r.a(m||(m=ne(["\n      void main(void) {\n        if (waterColor.a < ",") {\n          // Discard this vertex\n          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);\n          return;\n        }\n\n        vpos = position;\n        gl_Position = transformPosition(proj, view, vpos);\n      }\n    "])),r.a.float(_.c))),t.include(s.a,e),t.fragment.code.add(r.a(y||(y=ne(["\n      void main() {\n        discardBySlice(vpos);\n        outputHighlight();\n      }\n    "]))))),t}var T=Object.freeze({__proto__:null,build:C})},BAva:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n("OIYi");function i(e,t){e.vertex.code.add(1===t.viewingMode?r.a(b||(b=ne(["\n      vec3 getLocalUp(in vec3 pos, in vec3 origin) {\n          return normalize(pos + origin);\n      }\n    "]))):r.a(_||(_=ne(["\n      vec3 getLocalUp(in vec3 pos, in vec3 origin) {\n          return vec3(0.0, 0.0, 1.0); // WARNING: up-axis dependent code\n      }\n    "])))),e.vertex.code.add(1===t.viewingMode?r.a(w||(w=ne(["\n        mat3 getTBNMatrix(in vec3 n) {\n            vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));\n            vec3 b = normalize(cross(n, t));\n            return mat3(t, b, n);\n        }\n    "]))):r.a(x||(x=ne(["\n        mat3 getTBNMatrix(in vec3 n) {\n            vec3 t = vec3(1.0, 0.0, 0.0);\n            vec3 b = normalize(cross(n, t));\n            return mat3(t, b, n);\n        }\n    "]))))}},"M+I8":function(e,t,n){"use strict";n.d(t,"a",(function(){return a}));var r=n("OIYi"),i=n("2YHA");function a(e){e.fragment.uniforms.add("texWaveNormal","sampler2D"),e.fragment.uniforms.add("texWavePerturbation","sampler2D"),e.fragment.uniforms.add("waveParams","vec4"),e.fragment.uniforms.add("waveDirection","vec2"),e.include(i.b),e.fragment.code.add(r.a(O||(O=ne(["\n      const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);\n\n      vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {\n        return 2.0 * texture2D(_tex, _uv).rg - 1.0;\n      }\n\n      float sampleNoiseTexture(vec2 _uv) {\n        return texture2D(texWavePerturbation, _uv).b;\n      }\n\n      vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {\n        return 2.0 * texture2D(_tex, _uv).rgb - 1.0;\n      }\n\n      float computeProgress(vec2 uv, float time) {\n        return fract(time);\n      }\n\n      float computeWeight(vec2 uv, float time) {\n        float progress = computeProgress(uv, time);\n        return 1.0 - abs(1.0 - 2.0 * progress);\n      }\n\n      vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {\n        float flowStrength = waveParams[2];\n        float flowOffset = waveParams[3];\n\n        vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;\n\n        float progress = computeProgress(uv, time + phaseOffset);\n        float weight = computeWeight(uv, time + phaseOffset);\n\n        vec2 result = uv;\n        result -= flowVector * (progress + flowOffset);\n        result += phaseOffset;\n        result += (time - progress) * FLOW_JUMP;\n\n        return vec3(result, weight);\n      }\n\n      const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;\n      const float TIME_NOISE_STRENGTH = 7.77;\n\n      vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {\n        float waveStrength = waveParams[0];\n\n        // overall directional shift in uv's for directional wave movement for\n        // now we do a hard coded scale for wave speed such that a unit length\n        // direction is not too fast.\n        vec2 waveMovement = time * -_waveDir;\n\n        float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;\n\n        // compute two perturbed uvs and blend weights\n        // then sample the wave normals at the two positions and blend\n        vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);\n        vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);\n\n        vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;\n        vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;\n\n        // logic to flatten the wave pattern\n        // scale xy components of the normal, then adjust z (up) component\n        vec3 mixNormal = normalize(normal_A + normal_B);\n        mixNormal.xy *= waveStrength;\n        mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));\n\n        return mixNormal;\n      }\n\n      vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {\n        float waveTextureRepeat = waveParams[1];\n        vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);\n        float foam  = normals2FoamIntensity(normal, waveParams[0]);\n        return vec4(normal, foam);\n      }\n    "]))))}(a||(a={})).bindUniforms=function(e,t){e.setUniform1i("texWaveNormal",0),e.setUniform1i("texWavePerturbation",1),e.setUniform4f("waveParams",t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset),e.setUniform2f("waveDirection",t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity)}},NUQ5:function(e,t,n){"use strict";n.d(t,"a",(function(){return a})),n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return s})),n("wSAH");var r=n("srIe"),i=(n("n4uK"),n("GVa1"),n("of9L"));n("0meK");var a=function(){function e(){re(this,e),this.cache=new Map}return Q(e,[{key:"dispose",value:function(){this.cache.forEach((function(e){Object(r.k)(e.texture)&&(e.texture.dispose(),e.texture=null)})),this.cache.clear()}},{key:"acquire",value:function(e){if(Object(r.j)(e))return null;var t=this.patternId(e),n=this.cache.get(t);if(n)return n.refCount++,n.bind;var a=this.patternToTextureData(e,2),o=a.length/2,s={refCount:1,texture:null,bind:function(e,t){return Object(r.j)(s.texture)&&(s.texture=new i.a(e,{width:a.length,height:1,internalFormat:6406,pixelFormat:6406,dataType:5121,wrapMode:33071},a)),e.bindTexture(s.texture,t),o}};return this.cache.set(t,s),s.bind}},{key:"release",value:function(e){if(!Object(r.j)(e)){var t=this.patternId(e),n=this.cache.get(t);n&&(n.refCount--,0===n.refCount&&(Object(r.k)(n.texture)&&n.texture.dispose(),this.cache.delete(t)))}}},{key:"swap",value:function(e,t){var n=this.acquire(t);return this.release(e),n}},{key:"patternId",value:function(e){return e.join(",")}},{key:"patternToTextureData",value:function(e,t){var n,r=e.reduce((function(e,t){return e+t}))*t,i=new Uint8Array(r),a=!0,o=0,s=W(e);try{for(s.s();!(n=s.n()).done;){for(var l=n.value,c=0;c<l*t;c++)i[o++]=a?255:0;a=!a}}catch(u){s.e(u)}finally{s.f()}return i}}]),e}();function o(e){return Object(r.j)(e)?e:e.slice()}function s(e){return[e,e]}},PkRl:function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return o}));var r=n("OIYi"),i=n("aQrP"),a=n("Kq27");function o(){var e=new i.a;return e.include(a.a),e.fragment.uniforms.add("tex","sampler2D"),e.fragment.uniforms.add("color","vec4"),e.fragment.code.add(r.a(R||(R=ne(["\n    void main() {\n      vec4 texColor = texture2D(tex, uv);\n      gl_FragColor = texColor * color;\n    }\n  "])))),e}var s=Object.freeze({__proto__:null,build:o})},"XV/G":function(e,t,n){"use strict";n.d(t,"a",(function(){return o}));var r=n("OIYi"),i=n("xRv2");function a(e){var t=e.fragment.code;t.add(r.a(j||(j=ne(["\n    vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)\n    {\n      return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;\n    }\n    "])))),t.add(r.a(S||(S=ne(["\n    float integratedRadiance(float cosTheta2, float roughness)\n    {\n      return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);\n    }\n    "])))),t.add(r.a(C||(C=ne(["\n    vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)\n    {\n      float cosTheta2 = 1.0 - RdotNG * RdotNG;\n      float intRadTheta = integratedRadiance(cosTheta2, roughness);\n\n      // Calculate the integrated directional radiance of the ground and the sky\n      float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;\n      float sky = 2.0 - ground;\n      return (ground * ambientGround + sky * ambientSky) * 0.5;\n    }\n    "]))))}function o(e,t){var n=e.fragment.code;e.include(i.a),3===t.pbrMode||4===t.pbrMode?(n.add(r.a(T||(T=ne(["\n    struct PBRShadingWater\n    {\n        float NdotL;   // cos angle between normal and light direction\n        float NdotV;   // cos angle between normal and view direction\n        float NdotH;   // cos angle between normal and half vector\n        float VdotH;   // cos angle between view direction and half vector\n        float LdotH;   // cos angle between light direction and half vector\n        float VdotN;   // cos angle between view direction and normal vector\n    };\n\n    float dtrExponent = ",";\n    "])),t.useCustomDTRExponentForWater?"2.2":"2.0")),n.add(r.a(E||(E=ne(["\n    vec3 fresnelReflection(float angle, vec3 f0, float f90) {\n      return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);\n    }\n    "])))),n.add(r.a(M||(M=ne(["\n    float normalDistributionWater(float NdotH, float roughness)\n    {\n      float r2 = roughness * roughness;\n      float NdotH2 = NdotH * NdotH;\n      float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;\n      return r2 / denom;\n    }\n    "])))),n.add(r.a(k||(k=ne(["\n    float geometricOcclusionKelemen(float LoH)\n    {\n        return 0.25 / (LoH * LoH);\n    }\n    "])))),n.add(r.a(I||(I=ne(["\n    vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)\n    {\n      vec3  F = fresnelReflection(props.VdotH, F0, F0Max);\n      float dSun = normalDistributionWater(props.NdotH, roughness);\n      float V = geometricOcclusionKelemen(props.LdotH);\n\n      float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);\n      float strengthSunHaze  = 1.2;\n      float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;\n\n      return ((dSun + dSunHaze) * V) * F;\n    }\n\n    vec3 tonemapACES(const vec3 x) {\n      return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);\n    }\n    "]))))):1!==t.pbrMode&&2!==t.pbrMode||(e.include(a),n.add(r.a(D||(D=ne(["\n    struct PBRShadingInfo\n    {\n        float NdotL;                  // cos angle between normal and light direction\n        float NdotV;                  // cos angle between normal and view direction\n        float NdotH;                  // cos angle between normal and half vector\n        float VdotH;                  // cos angle between view direction and half vector\n        float LdotH;                  // cos angle between view light direction and half vector\n        float NdotNG;                 // cos angle between normal and normal of the ground\n        float RdotNG;                 // cos angle between view direction reflected of the normal and normal of the ground\n        float NdotAmbDir;             // cos angle between view direction and the fill light in ambient illumination\n        float NdotH_Horizon;          // cos angle between normal and half vector defined with horizon illumination\n        vec3 skyRadianceToSurface;         // integrated radiance of the sky based on the surface roughness (used for specular reflection)\n        vec3 groundRadianceToSurface;      // integrated radiance of the ground based on the surface roughness (used for specular reflection)\n        vec3 skyIrradianceToSurface;       // irradiance of the sky (used for diffuse reflection)\n        vec3 groundIrradianceToSurface;    // irradiance of the ground (used for diffuse reflection)\n\n        float averageAmbientRadiance;      // average ambient radiance used to deduce black level in gamut mapping\n        float ssao;                   // ssao coefficient\n        vec3 albedoLinear;            // linear color of the albedo\n        vec3 f0;                      // fresnel value at normal incident light\n        vec3 f90;                     // fresnel value at 90o of incident light\n\n        vec3 diffuseColor;            // diffuse color of the material used in environment illumination\n        float metalness;              // metalness of the material\n        float roughness;              // roughness of the material\n    };\n    "])))),n.add(r.a(P||(P=ne(["\n    float normalDistribution(float NdotH, float roughness)\n    {\n        float a = NdotH * roughness;\n        float b = roughness / (1.0 - NdotH * NdotH + a * a);\n        return b * b * INV_PI;\n    }\n    "])))),n.add(r.a(A||(A=ne(["\n    const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);\n    const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);\n    const vec2 c2 = vec2(-1.04, 1.04);\n\n    vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {\n        vec4 r = roughness * c0 + c1;\n        float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;\n        return c2 * a004 + r.zw;\n    }\n    "])))),n.add(r.a(H||(H=ne(["\n    vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {\n      vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);\n      vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);\n\n      // From diffuse illumination calculate reflected color\n      vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;\n\n      // From specular illumination calculate reflected color\n      vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);\n      vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;\n      vec3 specularComponent = specularColor * indirectSpecular;\n\n      return (diffuseComponent + specularComponent);\n    }\n    "])))),n.add(r.a(L||(L=ne(["\n    float gamutMapChanel(float x, vec2 p){\n      return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );\n    }"])))),n.add(r.a(N||(N=ne(["\n    vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){\n      vec3 outColor;\n      vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));\n      outColor.x = gamutMapChanel(inColor.x, p) ;\n      outColor.y = gamutMapChanel(inColor.y, p) ;\n      outColor.z = gamutMapChanel(inColor.z, p) ;\n      return outColor;\n    }\n    "])))))}},jEtK:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n("OKTS");function i(e,t,n){var i,c=e.byteLength/(4*t),u=new Uint32Array(e,0,c*t),d=new Uint32Array(c),h=null!=(i=null==n?void 0:n.minReduction)?i:0,f=(null==n?void 0:n.originalIndices)||null,p=f?f.length:0,v=(null==n?void 0:n.componentOffsets)||null,g=0;if(v)for(var m=0;m<v.length-1;m++){var y=v[m+1]-v[m];y>g&&(g=y)}else g=c;var b=Math.floor(1.1*g)+1;(null==l||l.length<2*b)&&(l=new Uint32Array(Object(r.l)(2*b)));for(var _=0;_<2*b;_++)l[_]=0;for(var w=0,x=!!v&&!!f,O=x?p:c,R=x?new Uint32Array(p):null,j=1.96,S=0!==h?Math.ceil(4*j*j/(h*h)*h*(1-h)):O,C=1,T=v?v[1]:O,E=0;E<O;E++){if(E===S){var M=1-w/E;if(M+j*Math.sqrt(M*(1-M)/E)<h)return null;S*=2}if(E===T){for(var k=0;k<2*b;k++)l[k]=0;if(f)for(var I=v[C-1];I<v[C];I++)R[I]=d[f[I]];T=v[++C]}for(var D=x?f[E]:E,P=D*t,A=s(u,P,t),H=A%b,L=w;0!==l[2*H+1];){if(l[2*H]===A){var N=l[2*H+1]-1;if(a(u,P,N*t,t)){L=d[N];break}}++H>=b&&(H-=b)}L===w&&(l[2*H]=A,l[2*H+1]=D+1,w++),d[D]=L}if(0!==h&&1-w/c<h)return null;if(x){for(var z=v[C-1];z<R.length;z++)R[z]=d[f[z]];d=R}var F=new Uint32Array(t*w);w=0;for(var U=0;U<O;U++)d[U]===w&&(o(u,(x?f[U]:U)*t,F,w*t,t),w++);if(f&&!x){for(var G=new Uint32Array(p),V=0;V<G.length;V++)G[V]=d[f[V]];d=G}return{buffer:F.buffer,indices:d,uniqueCount:w}}function a(e,t,n,r){for(var i=0;i<r;i++)if(e[t+i]!==e[n+i])return!1;return!0}function o(e,t,n,r,i){for(var a=0;a<i;a++)n[r+a]=e[t+a]}function s(e,t,n){for(var r=0,i=0;i<n;i++)r=(r=e[t+i]+r|0)+(r<<11)+(r>>>2)|0;return r>>>0}var l=null},lObl:function(e,t,n){"use strict";n.d(t,"a",(function(){return h}));var r=n("srIe"),i=n("Cy1f"),a=n("5DEt"),o=n("15Hh"),s=n("r+FG"),l=n("dXfX"),c=n("XvKw"),u=n("hrr/"),d=n("1AhW"),h=function(e){X(n,e);var t=$(n);function n(e){var r;return re(this,n),(r=t.call(this,e))._renderOccluded=4,r._width=1,r._color=Object(c.c)(1,0,1,1),r._innerWidth=1,r._innerColor=null,r._stipplePattern=null,r._stippleOffColor=null,r._stippleIntegerRepeats=!1,r._writeDepthEnabled=!0,r._falloff=0,r._polygonOffset=!1,r.applyProps(e),r}return Q(n,[{key:"setGeometryFromExtent",value:function(e){var t=this.view.spatialReference,n=Object(i.e)(),r=Object(i.e)(),o=100,s=[];Object(a.v)(n,e[0],e[1],o),this.view.renderCoordsHelper.toRenderCoords(n,t,r),s.push([r[0],r[1],r[2]]),Object(a.v)(n,e[2],e[1],o),this.view.renderCoordsHelper.toRenderCoords(n,t,r),s.push([r[0],r[1],r[2]]),Object(a.v)(n,e[2],e[3],o),this.view.renderCoordsHelper.toRenderCoords(n,t,r),s.push([r[0],r[1],r[2]]),Object(a.v)(n,e[0],e[3],o),this.view.renderCoordsHelper.toRenderCoords(n,t,r),s.push([r[0],r[1],r[2]]),Object(a.v)(n,e[0],e[1],o),this.view.renderCoordsHelper.toRenderCoords(n,t,r),s.push([r[0],r[1],r[2]]),Object(a.v)(n,e[0],e[1],o),this.view.renderCoordsHelper.toRenderCoords(n,t,r),s.push([r[0],r[1],r[2]]),this.geometry=[s]}},{key:"setGeometryFromFrustum",value:function(e){var t=[];e.lines.forEach((function(e){t.push([e.origin[0],e.origin[1],e.origin[2]]),t.push([e.endpoint[0],e.endpoint[1],e.endpoint[2]])})),this.geometry=[t]}},{key:"setGeometryFromSegment",value:function(e){var t=e.endRenderSpace;Object(o.i)(f),Object(o.s)(f,f,t),this.transform=f;var n=e.createRenderGeometry(t,this.view.renderCoordsHelper).points;this.geometry=[n]}},{key:"setGeometryFromSegments",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:i.b;Object(o.i)(f),Object(o.s)(f,f,n),this.transform=f,this.geometry=e.map((function(e){return e.createRenderGeometry(n,t.view.renderCoordsHelper).points}))}},{key:"renderOccluded",get:function(){return this._renderOccluded},set:function(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}},{key:"geometry",get:function(){return this._geometry},set:function(e){this._geometry=e,this.recreateGeometry()}},{key:"width",get:function(){return this._width},set:function(e){e!==this._width&&(this._width=e,this._updateMaterial())}},{key:"color",get:function(){return this._color},set:function(e){Object(l.g)(e,this._color)||(Object(l.c)(this._color,e),this._updateMaterial())}},{key:"innerWidth",get:function(){return this._innerWidth},set:function(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}},{key:"innerColor",get:function(){return this._innerColor},set:function(e){Object(r.k)(e)?!Object(r.j)(this._innerColor)&&Object(l.g)(e,this._innerColor)||(this._innerColor=Object(l.c)(Object(c.b)(),e),this._updateMaterial()):Object(r.k)(this._innerColor)&&(this._innerColor=null,this._updateMaterial())}},{key:"stipplePattern",get:function(){return this._stipplePattern},set:function(e){var t=Object(r.k)(e)!==Object(r.k)(this._stipplePattern);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}},{key:"stippleOffColor",get:function(){return this._stippleOffColor},set:function(e){(Object(r.j)(e)||Object(r.j)(this._stippleOffColor)||!Object(l.g)(e,this._stippleOffColor))&&(this._stippleOffColor=Object(r.k)(e)?Object(c.a)(e):null,this._updateMaterial())}},{key:"stippleIntegerRepeats",get:function(){return this._stippleIntegerRepeats},set:function(e){this._stippleIntegerRepeats!==e&&(this._stippleIntegerRepeats=e,this._updateMaterial())}},{key:"writeDepthEnabled",get:function(){return this._writeDepthEnabled},set:function(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}},{key:"falloff",get:function(){return this._falloff},set:function(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}},{key:"polygonOffset",get:function(){return this._polygonOffset},set:function(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}},{key:"createExternalResources",value:function(){this._material=new u.a(this.materialParameters)}},{key:"destroyExternalResources",value:function(){this._material=null}},{key:"createGeometries",value:function(e){var t=this._createLineGeometries();if(0!==t.length)for(var n=0;n<t.length;++n){var r=Object(d.a)(t[n]);e.addGeometry(r,this._material)}}},{key:"forEachExternalMaterial",value:function(e){e(this._material)}},{key:"materialParameters",get:function(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,isClosed:!1,falloff:this._falloff,innerColor:this._innerColor,innerWidth:this._innerWidth,stippleIntegerRepeats:this._stippleIntegerRepeats,polygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}},{key:"_updateMaterial",value:function(){this.attached&&this._material.setParameterValues(this.materialParameters)}},{key:"_createLineGeometries",value:function(){var e=this.geometry;if(Object(r.j)(e)||0===e.length)return[];var t=[];return e.forEach((function(e){var n=new Float64Array(3*e.length);e.forEach((function(e,t){n[3*t+0]=e[0],n[3*t+1]=e[1],n[3*t+2]=e[2]})),t.push({attributeData:{position:n},removeDuplicateStartEnd:0})})),t}}]),n}(n("X668").a),f=Object(s.b)()},vXUg:function(e,t,n){"use strict";n.d(t,"a",(function(){return i}));var r=n("OIYi");function i(e,t){0===t.output&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(r.a(z||(z=ne(["\n      void forwardLinearDepth() { linearDepth = gl_Position.w; }\n    "]))))):1===t.output||3===t.output?(e.varyings.add("linearDepth","float"),e.vertex.uniforms.add("cameraNearFar","vec2"),e.vertex.code.add(r.a(F||(F=ne(["\n      void forwardLinearDepth() {\n        linearDepth = (-position_view().z - cameraNearFar[0]) / (cameraNearFar[1] - cameraNearFar[0]);\n      }\n    "]))))):e.vertex.code.add(r.a(U||(U=ne(["\n      void forwardLinearDepth() {}\n    "]))))}}}])}();