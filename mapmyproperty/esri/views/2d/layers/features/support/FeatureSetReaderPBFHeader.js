define(["require","exports","../../../../../core/Error","../../../../../tasks/operations/pbfFeatureServiceParser"],(function(e,t,r,a){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.parseHeader=t.FeatureSetHeader=void 0;var s=function(){function e(){this.hasFeatures=!1,this.fieldIndexMap=new Map,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.dateFields=new Set,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}return e.prototype.hasFieldIndex=function(e){return this.fieldIndexMap.has(e)},e.prototype.isDateField=function(e){return this.dateFields.has(e)},e.prototype.getFieldIndex=function(e){return this.fieldIndexMap.get(e)},e}();function n(e){for(var t=e.getLength(),r=e.pos()+t,s={name:"",isDate:!1};e.pos()<r&&e.next();)switch(e.tag()){case 1:s.name=e.getString();break;case 2:"esriFieldTypeDate"===a.parseFieldType(e.getEnum())&&(s.isDate=!0);break;default:e.skip()}return s}t.FeatureSetHeader=s,t.parseHeader=function(e,t){for(var i=e.pos(),o=new s,d=0,f=0,u=null,p=null,c=null,g=!1;e.next();)switch(e.tag()){case 1:u=e.getString();break;case 3:p=e.getString();break;case 12:c=e.processMessage(a.parseTransform);break;case 9:o.exceededTransferLimit=e.getBool(),o.exceededTransferLimit&&(o.offsets.geometry=new Int32Array(8e3),o.centroid=new Int32Array(16e3));break;case 13:var l=n(e),h=l.name.toLowerCase().trim(),I=d++;o.fieldIndexMap.set(l.name,I),o.fieldIndexMap.set(h,I),l.isDate&&(o.dateFields.add(l.name),o.dateFields.add(h));break;case 15:var b=e.getLength(),k=e.pos()+b;if(!o.exceededTransferLimit){var x=o.centroid;o.offsets.geometry.push(0),x.push(268435455),x.push(268435455)}!g&&o.exceededTransferLimit&&(g=!0,o.offsets.attributes=new Uint32Array(8e3*d));for(var m=f*d;e.pos()<k&&e.next();)switch(e.tag()){case 1:g?o.offsets.attributes[m++]=e.pos():o.offsets.attributes.push(e.pos());var w=e.getLength();e.skipLen(w);break;case 2:if(t)for(var y=e.getLength(),F=e.pos()+y;e.pos()<F&&e.next();)switch(e.tag()){case 3:e.getUInt32();var v=e.getSInt32(),L=e.getSInt32();o.centroid[2*f]=v,o.centroid[2*f+1]=L;break;default:e.skip()}else{o.offsets.geometry[f]=e.pos();var S=e.getLength();e.skipLen(S)}break;case 4:for(var A=e.getLength(),M=e.pos()+A;e.pos()<M&&e.next();)switch(e.tag()){case 3:e.getUInt32(),v=e.getSInt32(),L=e.getSInt32(),o.centroid[2*f]=v,o.centroid[2*f+1]=L;break;default:e.skip()}break;default:e.skip()}f++,o.hasFeatures=!0;break;default:e.skip()}var C=u||p;if(!C)throw new r("FeatureSet has no objectId or globalId field name");return o.featureCount=f,o.fieldCount=d,o.objectIdFieldIndex=o.getFieldIndex(C),o.transform=c,o.displayIds=new Uint32Array(o.featureCount),o.groupIds=new Uint16Array(o.featureCount),e.move(i),o}}));