define(["require","exports","tslib","../../../../../../core/screenUtils","../../../../engine/webgl/color","../../../../engine/webgl/definitions","../../../../engine/webgl/enums","../../../../engine/webgl/visualVariablesUtils","../../../../../3d/layers/support/FastSymbolUpdates"],(function(e,t,i,a,s,l,n,r,o){"use strict";function u(e){return{value:e.value,size:a.toPt(e.size)}}function p(e){return e.map((function(e){return u(e)}))}function c(e){return"string"==typeof e||"number"==typeof e?a.toPt(e):{type:"size",expression:e.expression,stops:p(e.stops)}}Object.defineProperty(t,"__esModule",{value:!0}),t.convertVisualVariables=t.getVisualVariablesFields=t.normalizeSizeElement=t.normalizeSizeStops=t.stopToSizeStop=t.getVisualVariableSizeValueRepresentationRatio=void 0,t.getVisualVariableSizeValueRepresentationRatio=function(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e},t.stopToSizeStop=u,t.normalizeSizeStops=p,t.normalizeSizeElement=c,t.getVisualVariablesFields=function(e){var t=e&&e.length>0?{}:null;return t&&e.forEach((function(e){e.field&&(t[e.type]=e.field)})),t};var v=function(e){for(var t=[],i=[],s=p(e),n=s.length,r=0;r<6;r++){var o=s[Math.min(r,n-1)];t.push(o.value),i.push(null==o.size?l.NAN_MAGIC_NUMBER:a.pt2px(o.size))}return{values:new Float32Array(t),sizes:new Float32Array(i)}};function f(e){var t={values:[0,0,0,0,0,0,0,0],opacities:[0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;if(e.stops.length>8)return null;for(var i=e.stops,a=0;a<8;++a){var s=i[Math.min(a,i.length-1)];t.values[a]=s.value,t.opacities[a]=s.opacity}}else{if(!(e.stops&&e.stops.length>=0))return null;var l=e.stops&&e.stops.length>=0&&e.stops[0].opacity;for(a=0;a<8;a++)t.values[a]=1/0,t.opacities[a]=l}return t}t.convertVisualVariables=function(e){var t=e&&e.length>0?{}:null,a=t?{}:null;if(!t)return{vvFields:t,vvRanges:a};for(var l=0,u=e;l<u.length;l++){var V=u[l],z=V.type;if(V.field&&(t[z]=V.field),"size"===z){a.size||(a.size={});var S=V;switch(r.getTypeOfSizeVisualVariable(S)){case n.WGLVVFlag.SIZE_MINMAX_VALUE:a.size.minMaxValue={minDataValue:S.minDataValue,maxDataValue:S.maxDataValue,minSize:c(S.minSize),maxSize:c(S.maxSize)};break;case n.WGLVVFlag.SIZE_SCALE_STOPS:a.size.scaleStops={stops:p(S.stops)};break;case n.WGLVVFlag.SIZE_FIELD_STOPS:if(S.levels){var g={};for(var m in S.levels)g[m]=v(S.levels[m]);a.size.fieldStops={type:"level-dependent",levels:g}}else a.size.fieldStops=i.__assign({type:"static"},v(S.stops));break;case n.WGLVVFlag.SIZE_UNIT_VALUE:a.size.unitValue={unit:S.valueUnit,valueRepresentation:S.valueRepresentation}}}else if("color"===z){var d=o.convertVisualVariables([V],{modelSize:null,symbolSize:null,unitInMeters:1,transformation:null});if(!d)continue;a.color=d.color;for(var y=0;y<32;y+=4)s.premultiplyAlpha(a.color.colors,y,!0)}else"opacity"===z?a.opacity=f(V):"rotation"===z&&(a.rotation={type:V.rotationType})}return{vvFields:t,vvRanges:a}}}));