(function(){var e={"esri/arcade/featureset/support/OrderbyClause":"+nnH","esri/arcade/featureSetCollection":"1FvL","esri/arcade/featureset/actions/GroupBy":"25uz","esri/tasks/operations/pbfOptimizedFeatureSet":"6/KI","esri/arcade/featureset/support/StatsField":"8wKU","esri/core/MD5":"CaYo","esri/arcade/featureset/actions/OrderBy":"G0SM","esri/arcade/featureset/sources/FeatureLayerRelated":"PNLr","esri/arcade/featureset/sources/FeatureLayerDynamic":"QA8M","esri/arcade/featureset/sources/FeatureLayerMemory":"bBZx","esri/arcade/featureSetUtils":"eLe6","esri/arcade/featureset/actions/Adapted":"gub2","esri/arcade/featureset/actions/Top":"ijuC","esri/arcade/featureset/actions/AttributeFilter":"ufnL"},t=this||window,r=t.webpackJsonp=t.webpackJsonp||[];r.registerAbsMids?r.registerAbsMids(e):(r.absMidsWaiting=r.absMidsWaiting||[]).push(e)})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{"+nnH":function(e,t,r){var n,i;n=[r.dj.c(e.i),t],void 0===(i=(function(e,t){"use strict";function r(e,t){return e===t?0:null===e?-1:null===t?1:e<t?-1:1}return function(){function e(e){var t=e.split(",");this._fields=[],this._directions=[];for(var r=0;r<t.length;r++){var n=t[r].match(/\S+/g);this._fields.push(n[0]),2===n.length?"asc"===n[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}return e.prototype.constructClause=function(){for(var e="",t=0;t<this._fields.length;t++)0!==t&&(e+=","),e+=this._fields[t],e+=1===this._directions[t]?" ASC":" DESC";return e},e.prototype.order=function(e){var t=this;e.sort((function(e,n){for(var i=0;i<t._fields.length;i++){var a,s=t.featureValue(e.feature,t._fields[i],i),o=t.featureValue(n.feature,t._fields[i],i);if(0!==(a=1===t._directions[i]?r(s,o):-1*r(s,o)))return a}return 0}))},e.prototype.scanForField=function(e){for(var t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1},e.prototype.replaceFields=function(t){for(var r="",n=0;n<this._fields.length;n++){0!==n&&(r+=",");for(var i=this._fields[n],a=0,s=t;a<s.length;a++){var o=s[a];if(i.toLowerCase()===o.field.toLowerCase()){i=o.newfield;break}}r+=i,r+=1===this._directions[n]?" ASC":" DESC"}return new e(r)},e.prototype.featureValue=function(e,t,r){var n=e.attributes[t];if(void 0!==n)return n;for(var i in e.attributes)if(t.toLowerCase()===i.toLowerCase())return this._fields[r]=i,e.attributes[i];return null},e}()}).apply(null,n))||(e.exports=i)},"1FvL":function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("qMld")],void 0===(i=(function(e,t,r){"use strict";return function(){function e(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}return e.prototype.add=function(e,t,r){this._layerById[t]=r,this._layerByName[e]=r},e.prototype.featureSetByName=function(e,t,r){return void 0===t&&(t=!0),void 0===r&&(r=["*"]),this.resolvePromise(void 0===this._layerByName[e]?null:this._layerByName[e])},e.prototype.featureSetById=function(e,t,r){return void 0===t&&(t=!0),void 0===r&&(r=["*"]),this.resolvePromise(void 0===this._layerById[e]?null:this._layerById[e])},e.prototype.castToText=function(){return"object, FeatureSetCollection"},e.prototype.resolvePromise=function(e){return r.resolve(e)},e}()}).apply(null,n))||(e.exports=i)},"25uz":function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("zOht"),r("jZlN"),r("gfOZ"),r("gub2"),r("ufnL"),r("G0SM"),r("88sq"),r("Q4uJ"),r("+nnH"),r("tq6K"),r("SqzB"),r("SqzB"),r("PMeB"),r("8wKU"),r("CaYo"),r("qMld"),r("1eyA"),r("Z4y+"),r("KQcO"),r("I90O")],void 0===(i=(function(e,t,r,n,i,a,s,o,l,u,d,c,p,h,f,y,_,g,v,m,F,S){"use strict";function w(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}return function(e){function t(t){var r=e.call(this,t)||this;return r._decodedStatsfield=[],r._decodedGroupbyfield=[],r._candosimplegroupby=!0,r.phsyicalgroupbyfields=[],r.objectIdField="ROW__ID",r._internalObjectIdField="ROW__ID",r._adaptedFields=[],r.declaredClass="esri.arcade.featureset.actions.Aggregate",r._uniqueIds=1,r._maxQuery=10,r._maxProcessing=10,r._parent=t.parentfeatureset,r._config=t,r}return r.__extends(t,e),t.prototype.isTable=function(){return!0},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._getFilteredSet("",null,null,null,e).then((function(e){return t._wset=e,t._wset})):g.resolve(this._wset)},t.prototype._isInFeatureSet=function(){return c.IdState.InFeatureSet},t.prototype.nextUniqueName=function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t},t.prototype.convertToEsriFieldType=function(e){return e},t.prototype._initialiseFeatureSet=function(){var e={},t=!1,r=1,n=this._parent?this._parent.getFieldsIndex():new S([]);for(this.objectIdField="ROW__ID";!1===t;){for(var i=!1,s=0;s<this._config.groupbyfields.length;s++)if(this._config.groupbyfields[s].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}if(!1===i)for(s=0;s<this._config.statsfields.length;s++)if(this._config.statsfields[s].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}!1===i?t=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}for(var o=0,l=this._config.statsfields;o<l.length;o++){var u=l[o],d=new y;d.field=u.name,d.tofieldname=u.name,d.workingexpr=u.expression instanceof v.WhereClause?u.expression:v.WhereClause.create(u.expression,n),d.typeofstat=w(u.statistic),this._decodedStatsfield.push(d)}this._decodedGroupbyfield=[];for(var f=0,_=this._config.groupbyfields;f<_.length;f++){var g={name:(u=_[f]).name,singlefield:null,tofieldname:u.name,expression:u.expression instanceof v.WhereClause?u.expression:v.WhereClause.create(u.expression,n)};this._decodedGroupbyfield.push(g)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(var b=0,I=this._parent.fields;b<I.length;b++)e[(u=I[b]).name.toUpperCase()]=1;this.types=null}else this.geometryType=c.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null,this.spatialReference=new m({wkid:4326});this.fields=[];var C=new y;C.field=this.nextUniqueName(e),C.tofieldname=this.objectIdField,C.workingexpr=v.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),C.typeofstat="MIN",this._decodedStatsfield.push(C);for(var D=0,x=this._decodedGroupbyfield;D<x.length;D++){var T=x[D],R=new F;if(T.name=this.nextUniqueName(e),R.name=T.tofieldname,R.alias=R.name,p.isSingleField(T.expression)){if(!(A=this._parent.getField(h.toWhereClause(T.expression,c.FeatureServiceDatabaseType.Standardised))))throw new Error("Field is not present for Aggregation");T.name=A.name,T.singlefield=A.name,this.phsyicalgroupbyfields.push(A.name),R.type=A.type}else{R.type=this.convertToEsriFieldType(h.predictType(T.expression,this._parent.fields));var k=new F;k.name=T.name,k.alias=k.name,this.phsyicalgroupbyfields.push(T.name),this._adaptedFields.push(new a.SqlExpressionAdapted(k,T.expression)),this._candosimplegroupby=!1}this.fields.push(R)}if(this._adaptedFields.length>0)for(var N=0,P=this._parent.fields;N<P.length;N++)this._adaptedFields.push(new a.OriginalField(u=P[N]));for(s=0;s<this._decodedStatsfield.length;s++){R=new F;var A=null;(T=this._decodedStatsfield[s]).field=this.nextUniqueName(e),T.tofieldname===this.objectIdField&&(this._internalObjectIdField=T.field),R.name=T.tofieldname,R.alias=R.name;var E=null!==T.workingexpr&&p.isSingleField(T.workingexpr)?h.toWhereClause(T.workingexpr,c.FeatureServiceDatabaseType.Standardised):"";switch(this._decodedStatsfield[s].typeofstat){case"SUM":if(""!==E){if(!(A=this._parent.getField(E)))throw new Error("Field is not present for Aggregation");R.type=A.type}else R.type="double";break;case"MIN":case"MAX":if(""!==E){if(!(A=this._parent.getField(E)))throw new Error("Field is not present for Aggregation");R.type=A.type}else R.type="double";break;case"COUNT":R.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==E&&!(A=this._parent.getField(E)))throw new Error("Field is not present for Aggregation");R.type="double"}this.fields.push(R)}},t.prototype._canDoAggregates=function(){return g.resolve(!1)},t.prototype._getFeatures=function(e,t,r,n){var i=this;-1!==t&&void 0===this._featureCache[t]&&[].push(t);var a=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,a)?this._expandPagedSet(e,a,0,0,n).then((function(){return i._getFeatures(e,t,r,n)})):g.resolve("success")},t.prototype._getFilteredSet=function(e,t,r,n,i){var l=this;if(""!==e)return g.resolve(new u([],[],!0,null));var c=null,h={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((function(){if(null!==r)for(var e=0;e<l._decodedStatsfield.length;e++)if(!0===p.scanForField(r,l._decodedStatsfield[e].tofieldname)){h.nowhereclause=!0,r=null;break}if(null!==n){for(h.ordered=!0,e=0;e<l._decodedStatsfield.length;e++)if(!0===n.scanForField(l._decodedStatsfield[e].tofieldname)){n=null,h.ordered=!1;break}if(null!==n)for(var t=0,i=l._decodedGroupbyfield;t<i.length;t++){var a=i[t];if(null===a.singlefield&&!0===n.scanForField(a.tofieldname)){n=null,h.ordered=!1;break}}}return!1===l._candosimplegroupby?g.resolve(!1):l._parent._canDoAggregates(l.phsyicalgroupbyfields,l._decodedStatsfield,"",null,null)})).then((function(e){if(e){var t=null;r&&(t=l._reformulateWhereClauseWithoutGroupByFields(r));var p=null;return n&&(p=l._reformulateOrderClauseWithoutGroupByFields(n)),l._parent._getAggregatePagesDataSourceDefinition(l.phsyicalgroupbyfields,l._decodedStatsfield,"",null,t,p,l._internalObjectIdField).then((function(e){return l._checkCancelled(i),c=!0===h.nowhereclause?new u(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===h.ordered&&e._ordered,l._clonePageDefinition(e.pagesDefinition)):new u(e._candidates.slice(0),e._known.slice(0),!0===h.ordered&&e._ordered,l._clonePageDefinition(e.pagesDefinition))}))}var f=l._parent;if(l._adaptedFields.length>0&&(f=new a.AdaptedFeatureSet({parentfeatureset:l._parent,adaptedFields:l._adaptedFields,extraFilter:null})),!0===h.nowhereclause)c=new u(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:l._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new o({parentfeatureset:f,orderbyclause:new d(l.phsyicalgroupbyfields.join(",")+","+l._parent.objectIdField+" ASC")})}});else{var y=f;if(null!==r){var _=null;r&&(_=l._reformulateWhereClauseWithoutGroupByFields(r)),y=new s({parentfeatureset:y,whereclause:_})}c=new u(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:l._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new o({parentfeatureset:y,orderbyclause:new d(l.phsyicalgroupbyfields.join(",")+","+l._parent.objectIdField+" ASC")})}})}return c}))},t.prototype._reformulateWhereClauseWithoutStatsFields=function(e){for(var t=0,r=this._decodedStatsfield;t<r.length;t++){var n=r[t];e=h.reformulateWithoutField(e,n.tofieldname,h.toWhereClause(n.workingexpr,c.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex())}return e},t.prototype._reformulateWhereClauseWithoutGroupByFields=function(e){for(var t=0,r=this._decodedGroupbyfield;t<r.length;t++){var n=r[t];n.tofieldname!==n.name&&(e=h.reformulateWithoutField(e,n.tofieldname,h.toWhereClause(n.expression,c.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex()))}return e},t.prototype._reformulateOrderClauseWithoutGroupByFields=function(e){for(var t=[],r=0,n=this._decodedGroupbyfield;r<n.length;r++){var i=n[r];i.tofieldname!==i.name&&t.push({field:i.tofieldname,newfield:i.name})}return t.length>0?e.replaceFields(t):e},t.prototype._clonePageDefinition=function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)},t.prototype._refineSetBlock=function(e,t,r){var n=this;try{return!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery)?this._expandPagedSet(e,this._maxQuery,0,0,r).then((function(){return n._refineSetBlock(e,t,r)})):(this._checkCancelled(r),this._refineKnowns(e,t),g.resolve(e))}catch(e){return g.reject(e)}},t.prototype._expandPagedSet=function(e,t,r,n,i){return this._expandPagedSetFeatureSet(e,t,r,n,i)},t.prototype._getPhysicalPage=function(e,t,r){var i=this;return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?g.create((function(t,n){i._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r,[]).then((function(e){t(e)}),n)})):this._getAgregagtePhysicalPage(e,t,r).then((function(e){for(var t=0,r=e;t<r.length;t++){for(var a=r[t],s={geometry:a.geometry,attributes:{}},o=0,l=i._decodedGroupbyfield;o<l.length;o++){var u=l[o];s.attributes[u.tofieldname]=a.attributes[u.name]}for(var d=0,c=i._decodedStatsfield;d<c.length;d++)s.attributes[(u=c[d]).tofieldname]=a.attributes[u.field];i._featureCache[s.attributes[i.objectIdField]]=new n(s)}return e.length}))},t.prototype._sequentialGetPhysicalItem=function(e,t,r,n){var i=this;return g.create((function(a,s){null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(r)),!0===e.pagesDefinition.internal.fullyResolved||0===t?a(n.length):i._nextAggregateItem(e,t,r,n,(function(s){a(null===s?n.length:i._sequentialGetPhysicalItem(e,t-=1,r,n))}),s)}))},t.prototype._nextAggregateItem=function(e,t,r,n,a,s){var o=this;try{i.tick(e.pagesDefinition.internal.iterator.next()).then((function(i){if(null===i)if(null!==e.pagesDefinition.internal.workingItem){var l=o._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);n.push(l),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(l.attributes[o.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,a(null)}else e.pagesDefinition.internal.fullyResolved=!0,a(null);else{var u=o._generateAggregateHash(i);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[i],id:u};else{if(u!==e.pagesDefinition.internal.workingItem.id)return l=o._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem),n.push(l),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(l.attributes[o.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[i],id:u},void a(l);e.pagesDefinition.internal.workingItem.features.push(i)}o._nextAggregateItem(e,t,r,n,a,s)}}),s)}catch(e){s(e)}},t.prototype._calculateFieldStat=function(e,t,r){for(var n=[],i=0;i<e.features.length;i++)if(null!==t.workingexpr){var a=t.workingexpr.calculateValue(e.features[i]);null!==a&&n.push(a)}else n.push(null);switch(t.typeofstat){case"MIN":r.attributes[t.tofieldname]=f.calculateStat("min",n,-1);break;case"MAX":r.attributes[t.tofieldname]=f.calculateStat("max",n,-1);break;case"SUM":r.attributes[t.tofieldname]=f.calculateStat("sum",n,-1);break;case"COUNT":r.attributes[t.tofieldname]=n.length;break;case"VAR":r.attributes[t.tofieldname]=f.calculateStat("var",n,-1);break;case"STDDEV":r.attributes[t.tofieldname]=f.calculateStat("stddev",n,-1);break;case"AVG":r.attributes[t.tofieldname]=f.calculateStat("avg",n,-1)}return!0},t.prototype._calculateAndAppendAggregateItem=function(e){for(var t={attributes:{},geometry:null},r=0,i=this._decodedGroupbyfield;r<i.length;r++){var a=i[r],s=a.singlefield?e.features[0].attributes[a.singlefield]:a.expression.calculateValue(e.features[0]);t.attributes[a.tofieldname]=s}for(var o=0,l=this._decodedStatsfield;o<l.length;o++)this._calculateFieldStat(e,l[o],t);for(var u=[],d=0;d<this._decodedStatsfield.length;d++)u.push(this._calculateFieldStat(e,this._decodedStatsfield[d],t));return this._featureCache[t.attributes[this.objectIdField]]=new n({attributes:t.attributes,geometry:t.geometry}),t},t.prototype._generateAggregateHash=function(e){for(var t="",r=0,n=this._decodedGroupbyfield;r<n.length;r++){var i=n[r],a=i.singlefield?e.attributes[i.singlefield]:i.expression.calculateValue(e);t+=null==a?":":":"+a.toString()}return _.createMD5Hash(t,_.outputTypes.String)},t.prototype._stat=function(){return g.resolve({calculated:!1})},t.prototype.getFeatureByObjectId=function(){return g.resolve(null)},t.registerAction=function(){l._featuresetFunctions.groupby=function(e,r){return new t({parentfeatureset:this,groupbyfields:e,statsfields:r})}},t}(l)}).apply(null,n))||(e.exports=i)},"6/KI":function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("8uEs"),r("nrlZ"),r("/COu"),r("xJgq"),r("Jvs9")],void 0===(i=(function(e,t,r,n,i,a,s){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OptimizedFeatureSetParserContext=void 0;var o=function(){function e(e){this.options=e,this.geometryTypes=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"]}return e.prototype.createFeatureResult=function(){return new a.default},e.prototype.prepareFeatures=function(){},e.prototype.finishFeatureResult=function(e){if(e&&e.features&&e.hasZ&&this.options.sourceSpatialReference&&e.spatialReference&&!n.equals(e.spatialReference,this.options.sourceSpatialReference)&&!e.spatialReference.vcsWkid){var t=r.getMetersPerVerticalUnitForSR(this.options.sourceSpatialReference)/r.getMetersPerVerticalUnitForSR(e.spatialReference);if(1!==t)for(var i=0,a=e.features;i<a.length;i++){var s=a[i];if(s.geometry&&s.geometry.coords)for(var o=s.geometry.coords,l=2;l<o.length;l+=3)o[l]*=t}}},e.prototype.addFeature=function(e,t){e.features.push(t)},e.prototype.createFeature=function(){return new i.default},e.prototype.createSpatialReference=function(){return{wkid:0}},e.prototype.createGeometry=function(){return new s.default},e.prototype.addField=function(e,t){e.fields.push(t)},e.prototype.addCoordinate=function(e,t){e.coords.push(t)},e.prototype.addCoordinatePoint=function(e,t){e.coords.push(t)},e.prototype.addLength=function(e,t){e.lengths.push(t)},e.prototype.createPointGeometry=function(){return new s.default},e}();t.OptimizedFeatureSetParserContext=o}).apply(null,n))||(e.exports=i)},"8wKU":function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("tq6K"),r("SqzB"),r("1eyA")],void 0===(i=(function(e,t,r,n,i){"use strict";return function(){function e(){}return e.prototype.clone=function(){var t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t},e.parseStatField=function(t,a,s){var o=new e;o.field=t;var l=i.WhereClause.create(a,s),u=function(e){if("function"===e.parseTree.type){if(0===e.parseTree.args.value.length)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");var t=i.WhereClause.create(n.toWhereClauseFromTree(e.parseTree.args.value[0],r.FeatureServiceDatabaseType.Standardised,e.parameters),e.fieldsIndex);return{name:e.parseTree.name,expr:t}}return null}(l);if(null===u)throw new Error("Invalid Statistic Function");var d=u.name.toUpperCase().trim();if("MIN"===d){if(o.typeofstat="MIN",o.workingexpr=u.expr,null===l)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===d){if(o.typeofstat="MAX",o.workingexpr=u.expr,null===l)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===d)o.typeofstat="COUNT",o.workingexpr=u.expr;else if("STDEV"===d){if(o.typeofstat="STDDEV",o.workingexpr=u.expr,null===l)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===d){if(o.typeofstat="SUM",o.workingexpr=u.expr,null===l)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===d){if(o.typeofstat="AVG",o.workingexpr=u.expr,null===l)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===d){if(o.typeofstat="AVG",o.workingexpr=u.expr,null===l)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==d)throw new Error("Invalid Statistic Function");if(o.typeofstat="VAR",o.workingexpr=u.expr,null===l)throw new Error("Invalid Statistic Function Parameters")}return o},e.prototype.toStatisticsName=function(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg";default:return"count"}},e}()}).apply(null,n))||(e.exports=i)},CaYo:function(e,t,r){var n,i;n=[r.dj.c(e.i),t],void 0===(i=(function(e,t){"use strict";function r(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function n(e,t,n,i,a,s){return r((o=r(r(t,e),r(i,s)))<<(l=a)|o>>>32-l,n);var o,l}function i(e,t,r,i,a,s,o){return n(t&r|~t&i,e,t,a,s,o)}function a(e,t,r,i,a,s,o){return n(t&i|r&~i,e,t,a,s,o)}function s(e,t,r,i,a,s,o){return n(t^r^i,e,t,a,s,o)}function o(e,t,r,i,a,s,o){return n(r^(t|~i),e,t,a,s,o)}Object.defineProperty(t,"__esModule",{value:!0}),t.createMD5Hash=t.outputTypes=void 0,t.outputTypes={Base64:0,Hex:1,String:2,Raw:3},t.createMD5Hash=function(e,n){void 0===n&&(n=t.outputTypes.Hex);var l=n||t.outputTypes.Base64,u=function(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var n=1732584193,l=-271733879,u=-1732584194,d=271733878,c=0;c<e.length;c+=16){var p=n,h=l,f=u,y=d;n=i(n,l,u,d,e[c+0],7,-680876936),d=i(d,n,l,u,e[c+1],12,-389564586),u=i(u,d,n,l,e[c+2],17,606105819),l=i(l,u,d,n,e[c+3],22,-1044525330),n=i(n,l,u,d,e[c+4],7,-176418897),d=i(d,n,l,u,e[c+5],12,1200080426),u=i(u,d,n,l,e[c+6],17,-1473231341),l=i(l,u,d,n,e[c+7],22,-45705983),n=i(n,l,u,d,e[c+8],7,1770035416),d=i(d,n,l,u,e[c+9],12,-1958414417),u=i(u,d,n,l,e[c+10],17,-42063),l=i(l,u,d,n,e[c+11],22,-1990404162),n=i(n,l,u,d,e[c+12],7,1804603682),d=i(d,n,l,u,e[c+13],12,-40341101),u=i(u,d,n,l,e[c+14],17,-1502002290),n=a(n,l=i(l,u,d,n,e[c+15],22,1236535329),u,d,e[c+1],5,-165796510),d=a(d,n,l,u,e[c+6],9,-1069501632),u=a(u,d,n,l,e[c+11],14,643717713),l=a(l,u,d,n,e[c+0],20,-373897302),n=a(n,l,u,d,e[c+5],5,-701558691),d=a(d,n,l,u,e[c+10],9,38016083),u=a(u,d,n,l,e[c+15],14,-660478335),l=a(l,u,d,n,e[c+4],20,-405537848),n=a(n,l,u,d,e[c+9],5,568446438),d=a(d,n,l,u,e[c+14],9,-1019803690),u=a(u,d,n,l,e[c+3],14,-187363961),l=a(l,u,d,n,e[c+8],20,1163531501),n=a(n,l,u,d,e[c+13],5,-1444681467),d=a(d,n,l,u,e[c+2],9,-51403784),u=a(u,d,n,l,e[c+7],14,1735328473),n=s(n,l=a(l,u,d,n,e[c+12],20,-1926607734),u,d,e[c+5],4,-378558),d=s(d,n,l,u,e[c+8],11,-2022574463),u=s(u,d,n,l,e[c+11],16,1839030562),l=s(l,u,d,n,e[c+14],23,-35309556),n=s(n,l,u,d,e[c+1],4,-1530992060),d=s(d,n,l,u,e[c+4],11,1272893353),u=s(u,d,n,l,e[c+7],16,-155497632),l=s(l,u,d,n,e[c+10],23,-1094730640),n=s(n,l,u,d,e[c+13],4,681279174),d=s(d,n,l,u,e[c+0],11,-358537222),u=s(u,d,n,l,e[c+3],16,-722521979),l=s(l,u,d,n,e[c+6],23,76029189),n=s(n,l,u,d,e[c+9],4,-640364487),d=s(d,n,l,u,e[c+12],11,-421815835),u=s(u,d,n,l,e[c+15],16,530742520),n=o(n,l=s(l,u,d,n,e[c+2],23,-995338651),u,d,e[c+0],6,-198630844),d=o(d,n,l,u,e[c+7],10,1126891415),u=o(u,d,n,l,e[c+14],15,-1416354905),l=o(l,u,d,n,e[c+5],21,-57434055),n=o(n,l,u,d,e[c+12],6,1700485571),d=o(d,n,l,u,e[c+3],10,-1894986606),u=o(u,d,n,l,e[c+10],15,-1051523),l=o(l,u,d,n,e[c+1],21,-2054922799),n=o(n,l,u,d,e[c+8],6,1873313359),d=o(d,n,l,u,e[c+15],10,-30611744),u=o(u,d,n,l,e[c+6],15,-1560198380),l=o(l,u,d,n,e[c+13],21,1309151649),n=o(n,l,u,d,e[c+4],6,-145523070),d=o(d,n,l,u,e[c+11],10,-1120210379),u=o(u,d,n,l,e[c+2],15,718787259),l=o(l,u,d,n,e[c+9],21,-343485551),n=r(n,p),l=r(l,h),u=r(u,f),d=r(d,y)}return[n,l,u,d]}(function(e){for(var t=[],r=0,n=8*e.length;r<n;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<r%32;return t}(e),8*e.length);switch(l){case t.outputTypes.Raw:return u;case t.outputTypes.Hex:return function(e){for(var t="0123456789abcdef",r=[],n=0,i=4*e.length;n<i;n++)r.push(t.charAt(e[n>>2]>>n%4*8+4&15)+t.charAt(e[n>>2]>>n%4*8&15));return r.join("")}(u);case t.outputTypes.String:return function(e){for(var t=[],r=0,n=32*e.length;r<n;r+=8)t.push(String.fromCharCode(e[r>>5]>>>r%32&255));return t.join("")}(u);case t.outputTypes.Base64:return function(e){for(var t=[],r=0,n=4*e.length;r<n;r+=3)for(var i=(e[r>>2]>>r%4*8&255)<<16|(e[r+1>>2]>>(r+1)%4*8&255)<<8|e[r+2>>2]>>(r+2)%4*8&255,a=0;a<4;a++)t.push(8*r+6*a>32*e.length?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(i>>6*(3-a)&63));return t.join("")}(u)}}}).apply(null,n))||(e.exports=i)},G0SM:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("zOht"),r("gfOZ"),r("88sq"),r("Q4uJ"),r("+nnH"),r("qMld")],void 0===(i=(function(e,t,r,n,i,a,s,o){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r._orderbyclause=null,r.declaredClass="esri.arcade.featureset.actions.OrderBy",r._maxProcessing=100,r._orderbyclause=t.orderbyclause,r._parent=t.parentfeatureset,r}return r.__extends(t,e),t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,t._orderbyclause,e)})).then((function(r){return t._checkCancelled(e),t._wset=r,t._wset})):o.resolve(this._wset)},t.prototype.manualOrderSet=function(e,t){var r=this;return this.getIdColumnDictionary(e,[],-1,t).then((function(e){r._orderbyclause.order(e);for(var t=new a([],[],!0,null),n=0;n<e.length;n++)t._known.push(e[n].id);return t}))},t.prototype.getIdColumnDictionary=function(e,t,r,i){var a=this;if(r<e._known.length-1){var s=this._maxQueryRate();if("GETPAGES"===e._known[r+1])return n.tick(this._parent._expandPagedSet(e,s,0,0,i)).then((function(){return a.getIdColumnDictionary(e,t,r,i)}));for(var l=r+1,u=[];l<e._known.length&&"GETPAGES"!==e._known[l];)u.push(e._known[l]),l++;return r+=u.length,n.tick(this._parent._getFeatureBatch(u,i)).then((function(n){a._checkCancelled(i);for(var s=0,o=n;s<o.length;s++){var l=o[s];t.push({id:l.attributes[a.objectIdField],feature:l})}return a.getIdColumnDictionary(e,t,r,i)}))}return e._candidates.length>0?n.tick(this._refineSetBlock(e,this._maxProcessingRate(),i)).then((function(){return a._checkCancelled(i),a.getIdColumnDictionary(e,t,r,i)})):o.resolve(t)},t.prototype._isInFeatureSet=function(e){return this._parent._isInFeatureSet(e)},t.prototype._getFeatures=function(e,t,r,n){return this._parent._getFeatures(e,t,r,n)},t.prototype._featureFromCache=function(e){if(void 0===this._featureCache[e]){var t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]},t.prototype._fetchAndRefineFeatures=function(){return o.reject(new Error("Fetch and Refine should not be called in this featureset"))},t.prototype._getFilteredSet=function(e,t,r,n,i){var s=this;return this._ensureLoaded().then((function(){return s._parent._getFilteredSet(e,t,r,null===n?s._orderbyclause:n,i)})).then((function(e){var n;s._checkCancelled(i),n=new a(e._candidates.slice(0),e._known.slice(0),e._ordered,s._clonePageDefinition(e.pagesDefinition));var o=!0;return e._candidates.length>0&&(o=!1),!1===n._ordered?s.manualOrderSet(n,i).then((function(e){return!1===o&&(null===t&&null===r||(e=new a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,s._clonePageDefinition(e.pagesDefinition)))),e})):n}))},t.registerAction=function(){i._featuresetFunctions.orderBy=function(e){return""===e?this:new t({parentfeatureset:this,orderbyclause:new s(e)})}},t}(i)}).apply(null,n))||(e.exports=i)},PNLr:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("zOht"),r("jZlN"),r("88sq"),r("Q4uJ"),r("tq6K"),r("qMld"),r("531e")],void 0===(i=(function(e,t,r,n,i,a,s,o,l){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",r._findObjectId=-1,r._requestStandardised=!1,r._removeGeometry=!1,r._overrideFields=null,r.featureObjectId=null,r.relatedLayer=null,r.relationship=null,t.spatialReference&&(r.spatialReference=t.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=t.layer,r._wset=null,r._findObjectId=t.objectId,r.featureObjectId=t.objectId,r.relationship=t.relationship,r.relatedLayer=t.relatedLayer,void 0!==t.outFields&&(r._overrideFields=t.outFields),void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return r.__extends(t,e),t.prototype._maxQueryRate=function(){return s.defaultMaxRecords},t.prototype.end=function(){return this._layer},t.prototype.optimisePagingFeatureQueries=function(){},t.prototype.load=function(){var e=this;return null===this._loadPromise&&(this._loadPromise=o.create((function(t,r){o.all([e._layer.load(),e.relatedLayer.load()]).then((function(){e._initialiseFeatureSet(),t(e)}),r)}))),this._loadPromise},t.prototype.nativeCapabilities=function(){return this.relatedLayer.nativeCapabilities()},t.prototype._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{for(var e=[],t=[],r=0,n=this.fields;r<n.length;r++){var i=n[r];if("oid"===i.type)e.push(i),t.push(i.name);else for(var a=0,s=this._overrideFields;a<s.length;a++)if(s[a].toLowerCase()===i.name.toLowerCase()){e.push(i),t.push(i.name);break}}this.fields=e,this._overrideFields=t}var o=this._layer.nativeCapabilities();o&&(this._databaseType=o.databaseType,this._requestStandardised=o.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types},t.prototype.databaseType=function(){var e=this;return this.relatedLayer.databaseType().then((function(){return e._databaseType=e.relatedLayer._databaseType,e._databaseType}))},t.prototype.isTable=function(){return this.relatedLayer.isTable()},t.prototype._isInFeatureSet=function(){return s.IdState.InFeatureSet},t.prototype._candidateIdTransform=function(e){return e},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):o.resolve(this._wset)},t.prototype._changeFeature=function(e){for(var t={},r=0,i=this.fields;r<i.length;r++){var a=i[r];t[a.name]=e.attributes[a.name]}return new n({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})},t.prototype._getFilteredSet=function(e,t,r,n,i){var s=this;return this.databaseType().then((function(){if(s.isTable()&&t&&null!==e&&""!==e)return new a([],[],!0,null);var o=s._layer.nativeCapabilities();if(!1===o.canQueryRelated)return new a([],[],!0,null);if(o.capabilities.queryRelated&&o.capabilities.queryRelated.supportsPagination)return s._getFilteredSetUsingPaging(e,t,r,n,i);var u="",d=!1;null!==n&&o.capabilities&&o.capabilities.queryRelated&&!0===o.capabilities.queryRelated.supportsOrderBy&&(u=n.constructClause(),d=!0);var c=new l;c.objectIds=[s._findObjectId];var p=null!==s._overrideFields?s._overrideFields:s._fieldsIncludingObjectId(s.relatedLayer.fields?s.relatedLayer.fields.map((function(e){return e.name})):["*"]);c.outFields=p,c.relationshipId=s.relationship.id,c.where="1=1";var h=!0;return!0===s._removeGeometry&&(h=!1),c.returnGeometry=h,s._requestStandardised&&(c.sqlFormat="standard"),c.outSpatialReference=s.spatialReference,c.orderByFields=""!==u?u.split(","):null,o.source.queryRelatedFeatures(c).then((function(n){s._checkCancelled(i);for(var o=n[s._findObjectId]?n[s._findObjectId].features:[],l=[],u=0;u<o.length;u++)s._featureCache[o[u].attributes[s._layer.objectIdField]]=o[u],l.push(o[u].attributes[s._layer.objectIdField]);var c=t&&null!==e&&""!==e,p=null!=r;return new a(c||p?l:[],c||p?[]:l,d,null)}))}))},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var r=!1,n=0,i=t;n<i.length;n++)if(i[n].toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t},t.prototype._getFilteredSetUsingPaging=function(e,t,r,n,i){var s=this;try{var l="",u=!1,d=this._layer.nativeCapabilities();return null!==n&&d&&d.capabilities.queryRelated&&!0===d.capabilities.queryRelated.supportsOrderBy&&(l=n.constructClause(),u=!0),this.databaseType().then((function(){var n=s._maxQueryRate(),o=d.capabilities.query.maxRecordCount;void 0!==o&&o<n&&(n=o);var c,p=t&&null!==e&&""!==e,h=null!=r,f=!0;!0===s._removeGeometry&&(f=!1);var y=null!==s._overrideFields?s._overrideFields:s._fieldsIncludingObjectId(s.relatedLayer.fields?s.relatedLayer.fields.map((function(e){return e.name})):["*"]);return c=new a(p||h?["GETPAGES"]:[],p||h?[]:["GETPAGES"],u,{outFields:y.join(","),resultRecordCount:n,resultOffset:0,objectIds:[s._findObjectId],where:"1=1",orderByFields:l,returnGeometry:f,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),s._expandPagedSet(c,n,0,0,i).then((function(){return c}))}))}catch(e){return o.reject(e)}},t.prototype._expandPagedSet=function(e,t,r,n,i){return this._expandPagedSetFeatureSet(e,t,r,n,i)},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,r){var n=this;try{var i=e.pagesDefinition.internal.lastRetrieved,a=i,s=e.pagesDefinition.internal.lastPage,u=this._layer.nativeCapabilities(),d=new l;return!0===this._requestStandardised&&(d.sqlFormat="standard"),d.relationshipId=this.relationship.id,d.objectIds=e.pagesDefinition.objectIds,d.resultOffset=e.pagesDefinition.internal.lastPage,d.resultRecordCount=e.pagesDefinition.resultRecordCount,d.outFields=e.pagesDefinition.outFields.split(","),d.where=e.pagesDefinition.where,d.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,d.returnGeometry=e.pagesDefinition.returnGeometry,d.outSpatialReference=this.spatialReference,u.source.queryRelatedFeatures(d).then((function(t){if(n._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return 0;for(var o=t[n._findObjectId]?t[n._findObjectId].features:[],l=0;l<o.length;l++)e.pagesDefinition.internal.set[a+l]=o[l].attributes[n._layer.objectIdField];for(l=0;l<o.length;l++)n._featureCache[o[l].attributes[n._layer.objectIdField]]=o[l];return o.length!==e.pagesDefinition.resultRecordCount&&(!t[n._findObjectId]||!1===t[n._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+o.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,o.length}))}catch(e){return o.reject(e)}},t.prototype._getFeatures=function(e,t,r,n){var i=this,a=[];-1!==t&&void 0===this._featureCache[t]&&a.push(t);var s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,n).then((function(){return i._getFeatures(e,t,r,n)}));for(var l=0,u=e._lastFetchedIndex;u<e._known.length&&(++l<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[u]&&void 0===this._featureCache[e._known[u]]&&(e._known[u]!==t&&a.push(e._known[u]),a.length>r)))&&!(l>=r&&0===a.length);u++);return 0===a.length?o.resolve("success"):o.reject(new Error("Unaccounted for Features. Not in Feature Collection"))},t.prototype._refineSetBlock=function(e,t,r){return o.resolve(e)},t.prototype._stat=function(e,t,r,n,i,a,s){return o.resolve({calculated:!1})},t.prototype._canDoAggregates=function(e,t,r,n,i){return o.resolve(!1)},t.prototype.relationshipMetaData=function(){return this.relatedLayer.relationshipMetaData()},t.prototype.serviceUrl=function(){return this.relatedLayer.serviceUrl()},t.prototype.queryAttachments=function(e,t,r,n){return this.relatedLayer.queryAttachments(e,t,r,n)},t.prototype.getFeatureByObjectId=function(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)},t}(i)}).apply(null,n))||(e.exports=i)},QA8M:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("zOht"),r("jZlN"),r("zp6E"),r("HKXX"),r("88sq"),r("Q4uJ"),r("tq6K"),r("SqzB"),r("SqzB"),r("PMeB"),r("CaYo"),r("qMld"),r("Lzvl"),r("Zvuv"),r("+6sX"),r("uajq"),r("B16N"),r("w1v0"),r("IpeC"),r("aZmZ"),r("6/KI")],void 0===(i=(function(e,t,r,n,i,a,s,o,l,u,d,c,p,h,f,y,_,g,v,m,F,S,w){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",r._removeGeometry=!1,r._overrideFields=null,r.formulaCredential=null,r._pageJustIds=!1,r._requestStandardised=!1,t.spatialReference&&(r.spatialReference=t.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=t.layer,r._wset=null,void 0!==t.outFields&&(r._overrideFields=t.outFields),void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return r.__extends(t,e),t.prototype._maxQueryRate=function(){return l.defaultMaxRecords},t.prototype.end=function(){return this._layer},t.prototype.optimisePagingFeatureQueries=function(e){this._pageJustIds=e},t.prototype.convertQueryToLruCacheKey=function(e){var t=l.stableStringify(e.toJSON());return p.createMD5Hash(t,p.outputTypes.String)},t.prototype.load=function(){var e=this;return null===this._loadPromise&&(this._loadPromise=h.create((function(t,r){try{if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(e){r(e)}}),r),e._layer.load()}catch(e){r(e)}}))),this._loadPromise},t.prototype._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{for(var e=[],t=0,r=this.fields;t<r.length;t++)if("oid"===(u=r[t]).type)e.push(u);else for(var n=0,i=this._layer.outFields;n<i.length;n++)if(i[n].toLowerCase()===u.name.toLowerCase()){e.push(u);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{e=[];for(var a=[],s=0,o=this.fields;s<o.length;s++){var u;if("oid"===(u=o[s]).type)e.push(u),a.push(u.name);else for(var d=0,c=this._overrideFields;d<c.length;d++)if(c[d].toLowerCase()===u.name.toLowerCase()){e.push(u),a.push(u.name);break}}this.fields=e,this._overrideFields=a}if(this._layer.source&&this._layer.source.sourceJSON){var p=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=l.FeatureServiceDatabaseType.StandardisedNoInterval,null!=p&&p>=10.61&&(this._databaseType=l.FeatureServiceDatabaseType.Standardised)):null!=p&&(p>=10.5&&(this._databaseType=l.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),p>=10.61&&(this._databaseType=l.FeatureServiceDatabaseType.Standardised))}this.objectIdField=this._layer.objectIdField,this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},t.prototype._isInFeatureSet=function(){return l.IdState.InFeatureSet},t.prototype._refineSetBlock=function(e){return h.resolve(e)},t.prototype._candidateIdTransform=function(e){return e},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):h.resolve(this._wset)},t.prototype._runDatabaseProbe=function(e){var t=this;return h.create((function(r,n){try{t._ensureLoaded().then((function(){try{var i=new F;i.where=e.replace("OBJECTID",t._layer.objectIdField),t._layer.queryObjectIds(i).then((function(){r(!0)}),(function(){try{r(!1)}catch(e){n(e)}}))}catch(e){n(e)}}))}catch(e){n(e)}}))},t.prototype._canUsePagination=function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)},t.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url},t.prototype.pbfSupportedForQuery=function(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode},t.prototype.queryPBF=function(e){return e.quantizationParameters={mode:"edit"},v.executeQueryPBF(this._layer.parsedUrl,e,new w.OptimizedFeatureSetParserContext({})).then((function(e){return m.fromJSON(_.convertToFeatureSet(e.data)).unquantize()}))},t.prototype.nativeCapabilities=function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}},t.prototype.executeQuery=function(e,t){var r=this,n=new g({url:this._layer.parsedUrl.path}),i="execute"===t&&this.pbfSupportedForQuery(e),a=null;if(this.recentlyUsedQueries){var s=this.convertQueryToLruCacheKey(e);null===(a=this.recentlyUsedQueries.getFromCache(s))&&(a=!0!==i?n[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(s,a),a=a.catch((function(e){throw r.recentlyUsedQueries.removeFromCache(s),e})))}return null===a&&(a=!0!==i?n[t](e):this.queryPBF(e)),a},t.prototype._getFilteredSet=function(e,t,r,n,i){var a=this;return this.databaseType().then((function(s){if(a.isTable()&&t&&null!==e&&""!==e)return new o([],[],!0,null);if(a._canUsePagination())return a._getFilteredSetUsingPaging(e,t,r,n,i);var l="",d=!1;null!==n&&a._layer.capabilities&&a._layer.capabilities.query&&!0===a._layer.capabilities.query.supportsOrderBy&&(l=n.constructClause(),d=!0);var c=new F;return c.where=null===r?null===t?"1=1":"":u.toWhereClause(r,s),a._requestStandardised&&(c.sqlFormat="standard"),c.spatialRelationship=a._makeRelationshipEnum(e),c.outSpatialReference=a.spatialReference,c.orderByFields=""!==l?l.split(","):null,c.geometry=null===t?null:t,c.relationParameter=a._makeRelationshipParam(e),a.executeQuery(c,"executeForIds").then((function(e){return null===e&&(e=[]),a._checkCancelled(i),new o([],e,d,null)}))}))},t.prototype._expandPagedSet=function(e,t,r,n,i){return this._expandPagedSetFeatureSet(e,t,r,n,i)},t.prototype._getFilteredSetUsingPaging=function(e,t,r,n,i){var a=this;try{var s="",l=!1;return null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(s=n.constructClause(),l=!0),this.databaseType().then((function(n){var d=null===r?null===t?"1=1":"":u.toWhereClause(r,n);a._layer.definitionExpression&&(d=""!==d?"(("+a._layer.definitionExpression+") AND ("+d+"))":a._layer.definitionExpression);var c=a._maxQueryRate(),p=a._layer.capabilities.query.maxRecordCount;void 0!==p&&p<c&&(c=p);var h=null;if(!0===a._pageJustIds)h=new o([],["GETPAGES"],l,{spatialRel:a._makeRelationshipEnum(e),relationParam:a._makeRelationshipParam(e),outFields:a._layer.objectIdField,resultRecordCount:c,resultOffset:0,geometry:null===t?null:t,where:d,orderByFields:s,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{var f=!0;!0===a._removeGeometry&&(f=!1);var y=null!==a._overrideFields?a._overrideFields:a._fieldsIncludingObjectId(a._layer.outFields?a._layer.outFields:["*"]);h=new o([],["GETPAGES"],l,{spatialRel:a._makeRelationshipEnum(e),relationParam:a._makeRelationshipParam(e),outFields:y.join(","),resultRecordCount:c,resultOffset:0,geometry:null===t?null:t,where:d,orderByFields:s,returnGeometry:f,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return a._expandPagedSet(h,c,0,1,i).then((function(){return h}))}))}catch(e){return h.reject(e)}},t.prototype._clonePageDefinition=function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}},t.prototype._getPhysicalPage=function(e,t,r){var n=this;try{var i=e.pagesDefinition.internal.lastRetrieved,a=i,s=e.pagesDefinition.internal.lastPage,o=new F;return this._requestStandardised&&(o.sqlFormat="standard"),o.spatialRelationship=e.pagesDefinition.spatialRel,o.relationParameter=e.pagesDefinition.relationParam,o.outFields=e.pagesDefinition.outFields.split(","),o.num=e.pagesDefinition.resultRecordCount,o.start=e.pagesDefinition.internal.lastPage,o.geometry=e.pagesDefinition.geometry,o.where=e.pagesDefinition.where,o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,o.returnGeometry=e.pagesDefinition.returnGeometry,o.outSpatialReference=this.spatialReference,this.executeQuery(o,"execute").then((function(t){if(n._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return"done";for(var o=0;o<t.features.length;o++)e.pagesDefinition.internal.set[a+o]=t.features[o].attributes[n._layer.objectIdField];if(!1===n._pageJustIds)for(o=0;o<t.features.length;o++)n._featureCache[t.features[o].attributes[n._layer.objectIdField]]=t.features[o];return(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(e){return h.reject(e)}},t.prototype._fieldsIncludingObjectId=function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;for(var r=!1,n=0,i=t;n<i.length;n++)if(i[n].toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}return!1===r&&t.push(this.objectIdField),t},t.prototype._getFeatures=function(e,t,r,n){var i=this,a=[];try{if(-1!==t&&void 0===this._featureCache[t]&&a.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,n).then((function(){return i._getFeatures(e,t,r,n)}));for(var s=0,o=e._lastFetchedIndex;o<e._known.length;o++){if(e._lastFetchedIndex+=1,s++,void 0===this._featureCache[e._known[o]]){var l=!1;if(null!=this._layer._mode){var u=this._layer._mode;if(void 0!==u._featureMap[e._known[o]]){var d=u._featureMap[e._known[o]];null!==d&&(l=!0,this._featureCache[e._known[o]]=d)}}if(!1===l&&(e._known[o]!==t&&a.push(e._known[o]),a.length>=this._maxProcessingRate()-1))break}if(s>=r&&0===a.length)break}if(0===a.length)return h.resolve("success");try{var c=new F;return this._requestStandardised&&(c.sqlFormat="standard"),c.objectIds=a,c.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),c.returnGeometry=!0,!0===this._removeGeometry&&(c.returnGeometry=!1),c.outSpatialReference=this.spatialReference,this.executeQuery(c,"execute").then((function(e){if(i._checkCancelled(n),void 0!==e.error)return h.reject(new Error(e.error));for(var t=0;t<e.features.length;t++)i._featureCache[e.features[t].attributes[i._layer.objectIdField]]=e.features[t];return"success"}))}catch(e){return h.reject(e)}}catch(e){return h.reject(e)}},t.prototype._getDistinctPages=function(e,t,r,n,i,a,s,o,l){var d=this;return this._ensureLoaded().then((function(){return d.databaseType()})).then((function(c){for(var p=r.parseTree.column,f=0;f<d._layer.fields.length;f++)if(d._layer.fields[f].name.toLowerCase()===p.toLowerCase()){p=d._layer.fields[f].name;break}var y=new F;d._requestStandardised&&(y.sqlFormat="standard");var _=null===a?null===i?"1=1":"":u.toWhereClause(a,c);return d._layer.definitionExpression&&(_=""!==_?"(("+d._layer.definitionExpression+") AND ("+_+"))":d._layer.definitionExpression),y.where=_,y.spatialRelationship=d._makeRelationshipEnum(n),y.relationParameter=d._makeRelationshipParam(n),y.geometry=null===i?null:i,y.returnDistinctValues=!0,y.returnGeometry=!1,y.outFields=[p],d.executeQuery(y,"execute").then((function(u){if(d._checkCancelled(l),!u.hasOwnProperty("features"))return h.reject(new Error("Unnexected Result querying statistics from layer"));for(var c=!1,f=0;f<d._layer.fields.length;f++)if(d._layer.fields[f].name===p){"date"===d._layer.fields[f].type&&(c=!0);break}for(f=0;f<u.features.length;f++){if(c){var y=u.features[f].attributes[p];o.push(null!==y?new Date(y):y)}else o.push(u.features[f].attributes[p]);if(o.length>=s)break}return 0===u.features.length?o:u.features.length===d._layer.capabilities.query.maxRecordCount&&o.length<s?d._getDistinctPages(e+u.features.length,t,r,n,i,a,s,o,l).then((function(e){return{calculated:!0,result:e}})):o}))}))},t.prototype._distinctStat=function(e,t,r,n,i,a,s){return this._getDistinctPages(0,e,t,r,n,i,a,[],s).then((function(e){return{calculated:!0,result:e}}))},t.prototype.isTable=function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType},t.prototype._countstat=function(e,t,r,n){var i=this;return this.databaseType().then((function(e){var a=new F;if(i._requestStandardised&&(a.sqlFormat="standard"),i.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};var s=null===n?null===r?"1=1":"":u.toWhereClause(n,e);return i._layer.definitionExpression&&(s=""!==s?"(("+i._layer.definitionExpression+") AND ("+s+"))":i._layer.definitionExpression),a.where=s,a.where=s,a.spatialRelationship=i._makeRelationshipEnum(t),a.relationParameter=i._makeRelationshipParam(t),a.geometry=null===r?null:r,a.returnGeometry=!1,i.executeQuery(a,"executeForCount").then((function(e){return{calculated:!0,result:e}}))}))},t.prototype._stats=function(e,t,r,n,i,a,s){var o=this;return this._ensureLoaded().then((function(){var l=o._layer.capabilities&&o._layer.capabilities.query&&!0===o._layer.capabilities.query.supportsSqlExpression,p=o._layer.capabilities&&o._layer.capabilities.query&&!0===o._layer.capabilities.query.supportsStatistics,f=o._layer.capabilities&&o._layer.capabilities.query&&!0===o._layer.capabilities.query.supportsDistinct;return"count"===e?f?o._countstat(e,r,n,i):{calculated:!1}:!1===p||!1===d.isSingleField(t)&&!1===l||!1===t.isStandardized?""!==r||null!==i?{calculated:!1}:o._manualStat(e,t,a,s):"distinct"===e?!1===f?""!==r||null!==i?{calculated:!1}:o._manualStat(e,t,a,s):o._distinctStat(e,t,r,n,i,a,s):o.databaseType().then((function(a){if(o.isTable()&&n&&null!==r&&""!==r)return{calculated:!0,result:null};var s=new F;o._requestStandardised&&(s.sqlFormat="standard");var l=null===i?null===n?"1=1":"":u.toWhereClause(i,a);o._layer.definitionExpression&&(l=""!==l?"(("+o._layer.definitionExpression+") AND ("+l+"))":o._layer.definitionExpression),s.where=l,s.spatialRelationship=o._makeRelationshipEnum(r),s.relationParameter=o._makeRelationshipParam(r),s.geometry=null===n?null:n;var d=new S;d.statisticType=c.decodeStatType(e),d.onStatisticField=u.toWhereClause(t,a),d.outStatisticFieldName="ARCADE_STAT_RESULT",s.returnGeometry=!1;var p="ARCADE_STAT_RESULT";return s.outStatistics=[d],o.executeQuery(s,"execute").then((function(e){if(!e.hasOwnProperty("features")||0===e.features.length)return h.reject(new Error("Unnexected Result querying statistics from layer"));for(var t=!1,r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){p=e.fields[r].name,"date"===e.fields[r].type&&(t=!0);break}if(t){var n=e.features[0].attributes[p];return null!==n&&(n=new Date(e.features[0].attributes[p])),{calculated:!0,result:n}}return{calculated:!0,result:e.features[0].attributes[p]}}))}))}))},t.prototype._stat=function(e,t,r,n,i,a,s){return this._stats(e,t,r,n,i,a,s)},t.prototype._canDoAggregates=function(e,t){var r=this;return this._ensureLoaded().then((function(){var e=!1,n=r._layer.capabilities&&r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsSqlExpression;if(void 0!==r._layer.capabilities&&null!==r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsStatistics&&!0===r._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(var i=0;i<t.length-1;i++)null!==t[i].workingexpr&&(!1===t[i].workingexpr.isStandardized||!1===d.isSingleField(t[i].workingexpr)&&!1===n)&&(e=!1);return!1!==e}))},t.prototype._makeRelationshipEnum=function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e},t.prototype._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,r,n,i,a,s){var l=this;return this._ensureLoaded().then((function(){return l.databaseType()})).then((function(d){var c="",p=!1,h=!1;null!==a&&l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsOrderBy&&(c=a.constructClause(),h=!0),l._layer.capabilities&&l._layer.capabilities.query&&!1===l._layer.capabilities.query.supportsPagination&&(h=!1,p=!0,c=l._layer.objectIdField);for(var f=[],y=0;y<t.length;y++){var _=new S;_.onStatisticField=null!==t[y].workingexpr?u.toWhereClause(t[y].workingexpr,d):"",_.outStatisticFieldName=t[y].field,_.statisticType=t[y].toStatisticsName(),f.push(_)}""===c&&(c=e.join(","));var g=l._maxQueryRate(),v=l._layer.capabilities.query.maxRecordCount;void 0!==v&&v<g&&(g=v);var m=null===i?null===n?"1=1":"":u.toWhereClause(i,d);return l._layer.definitionExpression&&(m=""!==m?"(("+l._layer.definitionExpression+") AND ("+m+"))":l._layer.definitionExpression),new o([],["GETPAGES"],h,{groupbypage:!0,spatialRel:l._makeRelationshipEnum(r),relationParam:l._makeRelationshipParam(r),outFields:["*"],useOIDpagination:p,generatedOid:s,resultRecordCount:g,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:f,geometry:null===n?null:n,where:m,orderByFields:c,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))},t.prototype._getAgregagtePhysicalPage=function(e,t,r){var i=this;try{var a=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(a=""!==a?"("+a+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());var s=e.pagesDefinition.internal.lastRetrieved,o=s,l=e.pagesDefinition.internal.lastPage,u=new F;return this._requestStandardised&&(u.sqlFormat="standard"),u.where=a,u.spatialRelationship=e.pagesDefinition.spatialRel,u.relationParameter=e.pagesDefinition.relationParam,u.outFields=e.pagesDefinition.outFields,u.outStatistics=e.pagesDefinition.outStatistics,u.geometry=e.pagesDefinition.geometry,u.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,u.num=e.pagesDefinition.resultRecordCount,u.start=e.pagesDefinition.internal.lastPage,u.returnGeometry=e.pagesDefinition.returnGeometry,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&u.geometry&&u.spatialRelationship?h.resolve([]):this.executeQuery(u,"execute").then((function(t){if(i._checkCancelled(r),!t.hasOwnProperty("features"))return h.reject(new Error("Unnexected Result querying aggregates from layer"));var a=[];if(e.pagesDefinition.internal.lastPage!==l)return[];for(var u=0;u<t.features.length;u++)e.pagesDefinition.internal.set[o+u]=t.features[u].attributes[e.pagesDefinition.generatedOid];for(u=0;u<t.features.length;u++)a.push(new n({attributes:t.features[u].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=s+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,a}))}catch(e){return h.reject(e)}},t.create=function(e,r,n,i){return new t({layer:new y({url:e,outFields:null===r?["*"]:r}),spatialReference:n,lrucache:i})},t.prototype.relationshipMetaData=function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]},t.prototype.serviceUrl=function(){return l.extractServiceUrl(this._layer.parsedUrl.path)},t.prototype.queryAttachments=function(e,t,r,n){var i=this;if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){var s={objectIds:[e]};return(t&&t>0||r&&r>0)&&(s.size=[t&&t>0?t:0,r&&r>0?r:t+1]),n&&n.length>0&&(s.attachmentTypes=n),this._layer.queryAttachments(s).then((function(t){var r=[];return t&&t[e]&&t[e].forEach((function(t){var n=i._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();r.push(new a(t.id,t.name,t.contentType,t.size,n))})),r}))}return h.resolve([])},t.prototype.queryRelatedFeatures=function(e){var t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return null!=e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),i(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then((function(e){if(e.data){var t={},r=e.data;if(r&&r.relatedRecordGroups)for(var i=r.spatialReference,a=0,s=r.relatedRecordGroups;a<s.length;a++){for(var o=s[a],l=o.objectId,u=[],d=0,c=o.relatedRecords;d<c.length;d++){var p=c[d];p.geometry&&(p.geometry.spatialReference=i);var y=new n({geometry:p.geometry?f.fromJSON(p.geometry):null,attributes:p.attributes});u.push(y)}t[l]={features:u,exceededTransferLimit:!0===r.exceededTransferLimit}}return t}return h.reject("Invalid Request")}))},t.prototype.getFeatureByObjectId=function(e,t){var r=new g({url:this._layer.parsedUrl.path}),n=new F;return n.outFields=t,n.returnGeometry=!1,n.outSpatialReference=this.spatialReference,n.where=this.objectIdField+"="+e.toString(),r.execute(n).then((function(e){return 1===e.features.length?e.features[0]:null}))},t}(s)}).apply(null,n))||(e.exports=i)},bBZx:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("zOht"),r("jZlN"),r("88sq"),r("Q4uJ"),r("tq6K"),r("SqzB"),r("qMld"),r("YADd"),r("Zvuv"),r("V+oH"),r("KQcO"),r("IpeC")],void 0===(i=(function(e,t,r,n,i,a,s,o,l,u,d,c,p,h){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",r._removeGeometry=!1,r._overrideFields=null,r._forceIsTable=!1,t.spatialReference&&(r.spatialReference=t.spatialReference),r._transparent=!0,r._maxProcessing=1e3,r._layer=t.layer,r._wset=null,!0===t.isTable&&(r._forceIsTable=!0),void 0!==t.outFields&&(r._overrideFields=t.outFields),void 0!==t.includeGeometry&&(r._removeGeometry=!1===t.includeGeometry),r}return r.__extends(t,e),t.prototype._maxQueryRate=function(){return s.defaultMaxRecords},t.prototype.end=function(){return this._layer},t.prototype.optimisePagingFeatureQueries=function(){},t.prototype.load=function(){var e=this;return null===this._loadPromise&&(this._loadPromise=l.create((function(t,r){if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(e){r(e)}}),r),e._layer.load()}))),this._loadPromise},t.prototype._initialiseFeatureSet=function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{for(var e=[],t=0,r=this.fields;t<r.length;t++)if("oid"===(u=r[t]).type)e.push(u);else for(var n=0,i=this._layer.outFields;n<i.length;n++)if(i[n].toLowerCase()===u.name.toLowerCase()){e.push(u);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{e=[];for(var a=[],o=0,l=this.fields;o<l.length;o++){var u;if("oid"===(u=l[o]).type)e.push(u),a.push(u.name);else for(var d=0,c=this._overrideFields;d<c.length;d++)if(c[d].toLowerCase()===u.name.toLowerCase()){e.push(u),a.push(u.name);break}}this.fields=e,this._overrideFields=a}this.objectIdField=this._layer.objectIdField,this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=s.FeatureServiceDatabaseType.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types},t.prototype.isTable=function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType},t.prototype._isInFeatureSet=function(){return s.IdState.InFeatureSet},t.prototype._candidateIdTransform=function(e){return e},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):l.resolve(this._wset)},t.prototype._changeFeature=function(e){for(var t={},r=0,i=this.fields;r<i.length;r++){var a=i[r];t[a.name]=e.attributes[a.name]}return new n({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})},t.prototype._getFilteredSet=function(e,t,r,n,i){var u=this,d="",c=!1;if(null!==n&&(d=n.constructClause(),c=!0),this.isTable()&&t&&null!==e&&""!==e){var p=new a([],[],!0,null);return l.resolve(p)}var f=new h;return f.where=null===r?null===t?"1=1":"":o.toWhereClause(r,s.FeatureServiceDatabaseType.Standardised),f.spatialRelationship=this._makeRelationshipEnum(e),f.outSpatialReference=this.spatialReference,f.orderByFields=""!==d?d.split(","):null,f.geometry=null===t?null:t,f.returnGeometry=!0,f.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(f).then((function(e){if(null===e)return new a([],[],c,null);u._checkCancelled(i);var t=[];return e.features.forEach((function(e){var r=e.attributes[u._layer.objectIdField];t.push(r),u._featureCache[r]=u._changeFeature(e)})),new a([],t,c,null)}))},t.prototype._makeRelationshipEnum=function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e},t.prototype._makeRelationshipParam=function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""},t.prototype._queryAllFeatures=function(){var e=this;if(this._wset)return l.resolve(this._wset);var t=new h;return t.where="1=1",this._ensureLoaded().then((function(){if(e._layer.source&&e._layer.source.items){var r=[];return e._layer.source.items.forEach((function(t){var n=t.attributes[e._layer.objectIdField];r.push(n),e._featureCache[n]=e._changeFeature(t)})),e._wset=new a([],r,!1,null),e._wset}return e._layer.queryFeatures(t).then((function(t){var r=[];return t.features.forEach((function(t){var n=t.attributes[e._layer.objectIdField];r.push(n),e._featureCache[n]=e._changeFeature(t)})),e._wset=new a([],r,!1,null),e._wset}))}))},t.prototype._getFeatures=function(e,t,r){var n=[];-1!==t&&void 0===this._featureCache[t]&&n.push(t);for(var i=e._lastFetchedIndex;i<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[i]]&&(e._known[i]!==t&&n.push(e._known[i]),n.length>r)));i++);return 0===n.length?l.resolve("success"):l.reject(new Error("Unaccounted for Features. Not in Feature Collection"))},t.prototype._refineSetBlock=function(e){return l.resolve(e)},t.prototype._stat=function(){return l.resolve({calculated:!1})},t.prototype._canDoAggregates=function(){return l.resolve(!1)},t.prototype.relationshipMetaData=function(){return[]},t._cloneAttr=function(e){var t={};for(var r in e)t[r]=e[r];return t},t.prototype.nativeCapabilities=function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}},t.create=function(e,r){var n=e.layerDefinition.objectIdField,i=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",a=[];if(e.layerDefinition.types)for(var s=0,o=e.layerDefinition.types;s<o.length;s++)a.push(c.fromJSON(o[s]));var l=e.layerDefinition.geometryType;void 0===l&&(l=e.featureSet.geometryType||"");var h=e.featureSet.features,f=r.toJSON();if(""===n||void 0===n){for(var y=!1,_=0,g=e.layerDefinition.fields;_<g.length;_++)if("oid"===(P=g[_]).type||"esriFieldTypeOID"===P.type){n=P.name,y=!0;break}if(!1===y){for(var v="FID",m=!0,F=0;m;){for(var S=!0,w=0,b=e.layerDefinition.fields;w<b.length;w++)if((P=b[w]).name===v){S=!1;break}!0===S?m=!1:v="FID"+(++F).toString()}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:v,alias:v});for(var I=[],C=0;C<h.length;C++)I.push({geometry:e.featureSet.features[C].geometry,attributes:e.featureSet.features[C].attributes?this._cloneAttr(e.featureSet.features[C].attributes):{}}),I[C].attributes[v]=C;h=I,n=v}}for(var D=[],x=0,T=e.layerDefinition.fields;x<T.length;x++)(P=T[x])instanceof p?D.push(P):D.push(p.fromJSON(P));var R=l;switch(R){case"esriGeometryPoint":R="point";break;case"esriGeometryPolyline":R="polyline";break;case"esriGeometryPolygon":R="polygon";break;case"esriGeometryExtent":R="extent";break;case"esriGeometryMultipoint":R="multipoint"}for(var k=0,N=h;k<N.length;k++){var P;(P=N[k]).geometry&&P.geometry instanceof u==0&&(P.geometry.type=R,void 0===P.geometry.spatialReference&&(P.geometry.spatialReference=f))}var A={outFields:["*"],source:h,fields:D,types:a,typeIdField:i,objectIdField:n,spatialReference:r};return A.geometryType=R||"point",new t({layer:new d(A),spatialReference:r,isTable:null===R||""===R})},t.prototype.queryAttachments=function(){return l.resolve([])},t.prototype.getFeatureByObjectId=function(e){var t=new h;return t.where=this.objectIdField+"="+e.toString(),this._layer.queryFeatures(t).then((function(e){return 1===e.features.length?e.features[0]:null}))},t}(i)}).apply(null,n))||(e.exports=i)},eLe6:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("zOht"),r("zp6E"),r("1FvL"),r("ufnL"),r("25uz"),r("G0SM"),r("VM5u"),r("ijuC"),r("QA8M"),r("bBZx"),r("PNLr"),r("x/o6"),r("tq6K"),r("qMld"),r("1eyA"),r("Zvuv"),r("Qwus"),r("QmTF")],void 0===(i=(function(e,t,r,n,i,a,s,o,l,u,d,c,p,h,f,y,_,g,v,m){"use strict";function F(e,t){if(h.applicationCache){var r=h.applicationCache.getLayerInfo(e);if(r)return r.then((function(r){return y.resolve(new g({url:e,outFields:t,sourceJSON:r}))}));var n=new g({url:e,outFields:t}),i=y.create((function(e,t){n.load().then((function(){e(n.sourceJSON)}),(function(e){t(e)}))}));return h.applicationCache&&(h.applicationCache.setLayerInfo(e,i),i=i.catch((function(t){throw h.applicationCache.clearLayerInfo(e),t}))),i.then((function(){return y.resolve(n)}))}return y.resolve(new g({url:e,outFields:t}))}function S(e,t,r,n,i){return F(e,["*"]).then((function(e){return y.resolve(w(e,t,r,n,i))}))}function w(e,t,r,n,i){return void 0===t&&(t=null),void 0===r&&(r=null),void 0===n&&(n=!0),void 0===i&&(i=null),!0===e._hasMemorySource()?new c({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:i}):new d({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:i})}function b(e){if(null!==h.applicationCache){var t=h.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),y.resolve(t)}return y.resolve({layers:[],tables:[]})}));return null!==h.applicationCache&&(h.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw h.applicationCache.clearLayerInfo(e),t}))),r}Object.defineProperty(t,"__esModule",{value:!0}),t.constructFeatureSetFromPortalItem=t.getPortal=t.createFeatureSetCollectionFromService=t.createFeatureSetCollectionFromMap=t.constructFeatureSetFromRelationship=t.constructAssociationMetaDataFeatureSetFromUrl=t.constructFeatureSet=t.constructFeatureSetFromUrl=t.initialiseMetaDataCache=void 0,a.registerAction(),s.registerAction(),o.registerAction(),l.registerAction(),u.registerAction(),t.initialiseMetaDataCache=function(){null===h.applicationCache&&(h.applicationCache=new h)},t.constructFeatureSetFromUrl=S,t.constructFeatureSet=w,t.constructAssociationMetaDataFeatureSetFromUrl=function(e,t){var i={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return b(e).then((function(a){if(i.metadata=a,a.controllerDatasetLayers&&null!=a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers)for(var s=0,o=a.layers;s<o.length;s++){var l=o[s];i.layerNameLkp[l.id]=l.name}if(a.tables)for(var u=0,d=a.tables;u<d.length;u++)i.layerNameLkp[(l=d[u]).id]=l.name;var c=a.controllerDatasetLayers.utilityNetworkLayerId;return i.networkId=c,function(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==h.applicationCache){var i=h.applicationCache.getLayerInfo(r);if(null!==i)return i}var a=n(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==h.applicationCache&&(h.applicationCache.setLayerInfo(r,a),a=a.catch((function(e){throw h.applicationCache.clearLayerInfo(r),e}))),a}(e,c).then((function(a){if(a){i.queryelem=a,i.queryelem&&i.queryelem.dataElement&&void 0!==i.queryelem.dataElement.schemaGeneration&&(i.unVersion=i.queryelem.dataElement.schemaGeneration),i.lkp={},i.queryelem.dataElement.domainNetworks||(i.queryelem.dataElement.domainNetworks=[]);for(var s=0,o=i.queryelem.dataElement.domainNetworks;s<o.length;s++){for(var l=o[s],u=0,d=l.edgeSources?l.edgeSources:[];u<d.length;u++)(v={layerId:(g=d[u]).layerId,sourceId:g.sourceId,className:i.layerNameLkp[g.layerId]?i.layerNameLkp[g.layerId]:null}).className&&(i.lkp[v.className]=v);for(var p=0,f=l.junctionSources?l.junctionSources:[];p<f.length;p++){var g,v;(v={layerId:(g=f[p]).layerId,sourceId:g.sourceId,className:i.layerNameLkp[g.layerId]?i.layerNameLkp[g.layerId]:null}).className&&(i.lkp[v.className]=v)}}if(i.queryelem.dataElement.terminalConfigurations)for(var m=0,F=i.queryelem.dataElement.terminalConfigurations;m<F.length;m++)for(var w=0,b=F[m].terminals;w<b.length;w++){var I=b[w];i.terminals.push({terminalId:I.terminalId,terminalName:I.terminalName})}return function(e){if(null!==h.applicationCache){var t=h.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=n(e,{responseType:"json",query:{f:"json"}}).then((function(e){return y.resolve(e.data?e.data:null)}));return null!==h.applicationCache&&(h.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw h.applicationCache.clearLayerInfo(e),t}))),r}(e+"/"+c).then((function(n){if(n.systemLayers&&null!=n.systemLayers.associationsTableId){var a=[];return i.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),S(e+"/"+n.systemLayers.associationsTableId.toString(),t,r.__spreadArrays(["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"],a),!1,null).then((function(e){return e.load()})).then((function(e){return i.unVersion>=4?(e=e.filter(_.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e})).then((function(e){return{lkp:i.lkp,associations:e,unVersion:i.unVersion,terminals:i.terminals}}))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:i.unVersion,lkp:null,terminals:[]}}))},t.constructFeatureSetFromRelationship=function(e,t,r,n,i,a,s){void 0===n&&(n=null),void 0===i&&(i=null),void 0===a&&(a=!0),void 0===s&&(s=null);var o=e.serviceUrl();return o?S(o="/"===o.charAt(o.length-1)?o+t.relatedTableId.toString():o+"/"+t.relatedTableId.toString(),n,i,a,s).then((function(o){return new p({layer:e,relatedLayer:o,relationship:t,objectId:r,spatialReference:n,outFields:i,includeGeometry:a,lrucache:s})})):null};var I=function(e){function t(t,r,n){void 0===r&&(r=null),void 0===n&&(n=null);var i=e.call(this)||this;return i._map=t,i._overridespref=r,i.lrucache=n,i._instantLayers=[],i}return r.__extends(t,e),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var n=w(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},t.prototype.featureSetByName=function(e,t,n){var i=this;if(void 0===t&&(t=!0),void 0===n&&(n=null),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return i.featureSetByName(e,t,n)}catch(e){return y.reject(e)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();for(var a=JSON.stringify(n),s=0;s<this._instantLayers.length;s++){var o=this._instantLayers[s];if(o.opitem.title===e&&o.includeGeometry===t&&o.outFields===a)return this.resolvePromise(this._instantLayers[s].featureset)}var l=this._map.layers.find((function(t){return t instanceof g&&t.title===e}));if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,n));if(this._map.tables){var u=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(u){if(u instanceof g)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,n));if(u._materializedTable);else{var d=u.outFields?u:r.__assign(r.__assign({},u),{outFields:["*"]});u._materializedTable=new g(d)}return u._materializedTable.load().then((function(){return i.resolvePromise(i.makeAndAddFeatureSet(u._materializedTable,t,n))}))}}return this.resolvePromise(null)},t.prototype.featureSetById=function(e,t,n){var i=this;if(void 0===t&&(t=!0),void 0===n&&(n=["*"]),void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return i.featureSetById(e,t,n)}catch(e){return y.reject(e)}}));null===n&&(n=["*"]),n=(n=n.slice(0)).sort();for(var a=JSON.stringify(n),s=0;s<this._instantLayers.length;s++){var o=this._instantLayers[s];if(o.opitem.id===e&&o.includeGeometry===t&&o.outFields===a)return this.resolvePromise(this._instantLayers[s].featureset)}var l=this._map.layers.find((function(t){return t instanceof g&&t.id===e}));if(l)return this.resolvePromise(this.makeAndAddFeatureSet(l,t,n));if(this._map.tables){var u=this._map.tables.find((function(t){return t.id===e}));if(u){if(u instanceof g)return this.resolvePromise(this.makeAndAddFeatureSet(u,t,n));if(u._materializedTable);else{var d=r.__assign(r.__assign({},u),{outFields:["*"]});u._materializedTable=new g(d)}return u._materializedTable.load().then((function(){return i.resolvePromise(i.makeAndAddFeatureSet(u._materializedTable,t,n))}))}}return this.resolvePromise(null)},t}(i),C=function(e){function t(t,r,n){void 0===r&&(r=null),void 0===n&&(n=null);var i=e.call(this)||this;return i._url=t,i._overridespref=r,i.lrucache=n,i.metadata=null,i._instantLayers=[],i}return r.__extends(t,e),Object.defineProperty(t.prototype,"url",{get:function(){return this._url},enumerable:!1,configurable:!0}),t.prototype.makeAndAddFeatureSet=function(e,t,r){void 0===t&&(t=!0),void 0===r&&(r=null);var n=w(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n},t.prototype._loadMetaData=function(){var e=this;return b(this._url).then((function(t){return e.metadata=t,t}))},t.prototype.load=function(){return this._loadMetaData()},t.prototype.clone=function(){return new t(this._url,this._overridespref,this.lrucache)},t.prototype.featureSetByName=function(e,t,r){var n=this;void 0===t&&(t=!0),void 0===r&&(r=null),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();for(var i=JSON.stringify(r),a=0;a<this._instantLayers.length;a++){var s=this._instantLayers[a];if(s.opitem.title===e&&s.includeGeometry===t&&s.outFields===i)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then((function(i){for(var a=null,s=0,o=i.layers?i.layers:[];s<o.length;s++)(d=o[s]).name===e&&(a=d);if(!a)for(var l=0,u=i.tables?i.tables:[];l<u.length;l++){var d;(d=u[l]).name===e&&(a=d)}return a?F(n._url+"/"+a.id,["*"]).then((function(e){return n.makeAndAddFeatureSet(e,t,r)})):n.resolvePromise(null)}))},t.prototype.featureSetById=function(e,t,r){var n=this;void 0===t&&(t=!0),void 0===r&&(r=["*"]),null===r&&(r=["*"]),r=(r=r.slice(0)).sort();var i=JSON.stringify(r);e=null!=e?e.toString():"";for(var a=0;a<this._instantLayers.length;a++){var s=this._instantLayers[a];if(s.opitem.id===e&&s.includeGeometry===t&&s.outFields===i)return this.resolvePromise(this._instantLayers[a].featureset)}return this._loadMetaData().then((function(i){for(var a=null,s=0,o=i.layers?i.layers:[];s<o.length;s++)null!==(d=o[s]).id&&void 0!==d.id&&d.id.toString()===e&&(a=d);if(!a)for(var l=0,u=i.tables?i.tables:[];l<u.length;l++){var d;null!==(d=u[l]).id&&void 0!==d.id&&d.id.toString()===e&&(a=d)}return a?F(n._url+"/"+a.id,["*"]).then((function(e){return n.makeAndAddFeatureSet(e,t,r)})):n.resolvePromise(null)}))},t}(i);t.createFeatureSetCollectionFromMap=function(e,t,r){return void 0===r&&(r=null),new I(e,t,r)},t.createFeatureSetCollectionFromService=function(e,t,r){return void 0===r&&(r=null),new C(e,t,r)},t.getPortal=function(e,t){return null===e?t:new v({url:e.field("url")})},t.constructFeatureSetFromPortalItem=function(e,t,r,n,i,a,s){if(h.applicationCache){var o=h.applicationCache.getLayerInfo(e+":"+a.url);if(o)return o.then((function(e){try{var a=new g({url:f.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});return y.resolve(w(a,r,n,i,s))}catch(e){return y.reject(e)}}),(function(e){return y.reject(e)}))}return y.create((function(o,l){var u=new m({id:e,portal:a}).load();h.applicationCache&&h.applicationCache.setLayerInfo(e+":"+a.url,u),u.then((function(e){try{var a=new g({url:f.extractServiceUrl(e.url)+"/"+t,outFields:["*"]});o(w(a,r,n,i,s))}catch(e){l(e)}}),(function(t){h.applicationCache&&h.applicationCache.clearLayerInfo(e+":"+a.url),l(t)}))}))}}).apply(null,n))||(e.exports=i)},gub2:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("zOht"),r("jZlN"),r("WoOE"),r("88sq"),r("Q4uJ"),r("tq6K"),r("SqzB"),r("qMld"),r("1eyA"),r("Z4y+")],void 0===(i=(function(e,t,r,n,i,a,s,o,l,u,d,c){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AdaptedFeatureSet=t.SqlExpressionAdapted=t.StringToCodeAdapted=t.FieldRename=t.OriginalField=t.AdaptedField=void 0;var p=function(){function e(){this.sqlRewritable=!1}return e.prototype.postInitialization=function(e,t){},e}();t.AdaptedField=p;var h=function(e){function t(t){var r=e.call(this)||this;return r.field=t,r.sqlRewritable=!0,r}return r.__extends(t,e),t.prototype.extractValue=function(e){return e.attributes[this.field.name]},t.prototype.rewriteSql=function(e){return{rewritten:this.sqlRewritable,where:e}},t}(p);t.OriginalField=h;var f=function(e){function t(t,r,n){var i=e.call(this)||this;return i.originalField=t,i.sqlRewritable=!0,i.field=o.cloneField(t),i.field.name=r,i.field.alias=n,i}return r.__extends(t,e),t.prototype.rewriteSql=function(e,t){return{rewritten:this.sqlRewritable,where:l.reformulateWithoutField(e,this.field.name,this.originalField.name,t.getFieldsIndex())}},t.prototype.extractValue=function(e){return e.attributes[this.originalField.name]},t}(p);t.FieldRename=f;var y=function(e){function t(t,r,n){var i=e.call(this)||this;for(var a in i.field=t,i.codefield=r,i.lkp=n,i.reverseLkp={},n)i.reverseLkp[n[a]]=a;return i.sqlRewritable=!0,i}return r.__extends(t,e),t.prototype.rewriteSql=function(e,r){var n=this.evaluateNodeToWhereClause(e.parseTree,o.FeatureServiceDatabaseType.Standardised,this.field.name,this.codefield instanceof d.WhereClause?l.toWhereClause(this.codefield,o.FeatureServiceDatabaseType.Standardised):this.codefield,e.parameters);return n.indexOf(t.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:d.WhereClause.create(n,r._parent.getFieldsIndex())}},t.prototype.evaluateNodeToWhereClause=function(e,r,n,i,a){var s,o,u,d;switch(void 0===n&&(n=null),void 0===i&&(i=null),e.type){case"interval":return l.convertIntervalToSql(this.evaluateNodeToWhereClause(e.value,r,n,i,a),e.qualifier,e.op);case"case_expression":var c=" CASE ";"simple"===e.format&&(c+=this.evaluateNodeToWhereClause(e.operand,r,n,t.BADNESS,a));for(var p=0;p<e.clauses.length;p++)c+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[p].operand,r,n,t.BADNESS,a)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[p].value,r,n,t.BADNESS,a);return null!==e.else&&(c+=" ELSE "+this.evaluateNodeToWhereClause(e.else,r,n,t.BADNESS,a)),c+" END ";case"param":var h=a[e.value.toLowerCase()];if("string"==typeof h)return"'"+a[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(h instanceof Date)return l.makeDateString(h,r);if(h instanceof Array){var f=[];for(p=0;p<h.length;p++)"string"==typeof h[p]?f.push("'"+h[p].toString().replace(/'/g,"''")+"'"):h[p]instanceof Date?f.push(l.makeDateString(h[p],r)):f.push(h[p].toString());return f}return h.toString();case"expr_list":o=[];for(var y=0,_=e.value;y<_.length;y++)o.push(this.evaluateNodeToWhereClause(_[y],r,n,i,a));return o;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,r,n,t.BADNESS,a)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" AND "+this.evaluateNodeToWhereClause(e.right,r,n,i,a)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" OR "+this.evaluateNodeToWhereClause(e.right,r,n,i,a)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" IS NOT NULL )";case"IN":if(s=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){for(var g=[],v=!0,m=0,F=e.right.value;m<F.length;m++){if("string"!==(b=F[m]).type){v=!1;break}if(void 0===this.lkp[b.value]){v=!1;break}g.push(this.lkp[b.value].toString())}if(v)return" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" IN ("+g.join(",")+")) "}return s=this.evaluateNodeToWhereClause(e.right,r,n,i,a)," ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" IN ("+s.join(",")+")) "}return(d=this.evaluateNodeToWhereClause(e.right,r,n,i,a))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" IN ("+d.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" IN ("+d+")) ";case"NOT IN":if(s=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){g=[],v=!0;for(var S=0,w=e.right.value;S<w.length;S++){var b;if("string"!==(b=w[S]).type){v=!1;break}if(void 0===this.lkp[b.value]){v=!1;break}g.push(this.lkp[b.value].toString())}if(v)return" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" NOT IN ("+g.join(",")+")) "}return s=this.evaluateNodeToWhereClause(e.right,r,n,i,a)," ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" NOT IN ("+s.join(",")+")) "}return(d=this.evaluateNodeToWhereClause(e.right,r,n,i,a))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" NOT IN ("+d.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,r,n,i,a)+" NOT IN ("+d+")) ";case"BETWEEN":return u=this.evaluateNodeToWhereClause(e.right,r,n,t.BADNESS,a)," ("+this.evaluateNodeToWhereClause(e.left,r,n,t.BADNESS,a)+" BETWEEN "+u[0]+" AND "+u[1]+" ) ";case"NOTBETWEEN":return u=this.evaluateNodeToWhereClause(e.right,r,n,t.BADNESS,a)," ("+this.evaluateNodeToWhereClause(e.left,r,n,t.BADNESS,a)+" NOT BETWEEN "+u[0]+" AND "+u[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,r,n,t.BADNESS,a)+" LIKE "+this.evaluateNodeToWhereClause(e.right,r,n,t.BADNESS,a)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,r,n,t.BADNESS,a)+" LIKE "+this.evaluateNodeToWhereClause(e.right,r,n,t.BADNESS,a)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,r,n,t.BADNESS,a)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,r,n,t.BADNESS,a)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,r,n,t.BADNESS,a)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,r,n,t.BADNESS,a)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+i+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+i+") ";return" ("+this.evaluateNodeToWhereClause(e.left,r,n,t.BADNESS,a)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,r,n,t.BADNESS,a)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,r,n,t.BADNESS,a)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,r,n,t.BADNESS,a)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return l.makeDateString(e.value,r);case"number":return e.value.toString();case"current_time":return l.makeToday("date"===e.mode,r);case"column_ref":return n&&n.toLowerCase()===e.column.toLowerCase()?"("+i+")":e.column;case"function":var I=this.evaluateNodeToWhereClause(e.args,r,n,t.BADNESS,a);return l.translateFunctionToDatabaseSpecific(e.name,I,r)}throw new Error("Unsupported sql syntax "+e.type)},t.prototype.extractValue=function(e){return this.codefield instanceof d.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]},t.BADNESS="_!!!_BAD_LKP_!!!!",t}(p);t.StringToCodeAdapted=y;var _=function(e){function t(t,r){var n=e.call(this)||this;return n.field=t,n.sql=r,n}return r.__extends(t,e),t.prototype.rewriteSql=function(e,t){return{rewritten:!0,where:l.reformulateWithoutField(e,this.field.name,l.toWhereClause(this.sql,o.FeatureServiceDatabaseType.Standardised),t.getFieldsIndex())}},t.prototype.extractValue=function(e){return this.sql.calculateValueCompiled(e)},t}(p);t.SqlExpressionAdapted=_;var g=function(e){function t(t){var r=e.call(this,t)||this;return r._calcFunc=null,r.declaredClass="esri.arcade.featureset.actions.Adapted",r.adaptedFields=null,r._extraFilter=null,r._extraFilter=t.extraFilter,r._parent=t.parentfeatureset,r._maxProcessing=30,r.adaptedFields=t.adaptedFields,r}return r.__extends(t,e),t.findField=function(e,t){for(var r=0,n=e;r<n.length;r++){var i=n[r];if(i.name.toLowerCase()===t.toString().toLowerCase())return i}return null},t.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new c({wkid:4326}),this.objectIdField="",this.geometryType=o.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null),this.fields=[];for(var e=0,t=this.adaptedFields;e<t.length;e++){var r=t[e];r.postInitialization(this,this._parent),this.fields.push(r.field)}},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._extraFilter?t._getFilteredSet("",null,null,null,e):t._parent._getSet(e)})).then((function(r){return t._checkCancelled(e),t._wset=new s(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):u.resolve(this._wset)},t.prototype._isInFeatureSet=function(e){return this._parent._isInFeatureSet(e)},t.prototype._getFeatures=function(e,t,r,a){var o=this,l=[];-1!==t&&void 0===this._featureCache[t]&&l.push(t);var d=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,d))return this._expandPagedSet(e,d,0,0,a).then((function(){return o._getFeatures(e,t,r,a)}));for(var c=0,p=e._lastFetchedIndex;p<e._known.length&&(++c<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[p]]&&(e._known[p]!==t&&l.push(e._known[p]),l.length>=d-1)));p++);if(0===l.length)return u.resolve("success");e=new s([],l,e._ordered,null);var h=Math.min(l.length,r);return this._parent._getFeatures(e,-1,h,a).then((function(){o._checkCancelled(a);for(var e=[],t=0;t<h;t++){var r=o._parent._featureFromCache(l[t]);void 0!==r&&e.push({geometry:r.geometry,attributes:r.attributes,id:l[t]})}for(var s=0,u=e;s<u.length;s++){for(var d=u[s],c=[],p=0,f=o.adaptedFields;p<f.length;p++){var y=f[p];c[y.field.name]=y.extractValue(d)}o._featureCache[d.id]=new n({attributes:c,geometry:i.cloneGeometry(d.geometry)})}return"success"}))},t.prototype._fetchAndRefineFeatures=function(){return u.reject(new Error("Fetch and Refine should not be called in this featureset"))},t.prototype._getFilteredSet=function(e,t,r,n,i){var a,o=this,u=this.reformulateWithoutAdaptions(r);a=u.cannot,r=u.where;var d=!1;if(null!==n){d=!0;for(var c=[],p=0,y=this.adaptedFields;p<y.length;p++){var _=y[p];if(!(_ instanceof h)&&!0===n.scanForField(_.field.name)){if(!(_ instanceof f)){n=null,d=!1;break}c.push({field:_.field.name,newfield:_.originalField.name})}}n&&c.length>0&&(n=n.replaceFields(c))}return null!==r?null!==this._extraFilter&&(r=l.combine(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then((function(){return o._parent._getFilteredSet(e,t,r,n,i)})).then((function(e){return o._checkCancelled(i),!0===a?new s(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===d&&e._ordered,o._clonePageDefinition(e.pagesDefinition)):new s(e._candidates.slice(0),e._known.slice(0),!0===d&&e._ordered,o._clonePageDefinition(e.pagesDefinition))}))},t.prototype.reformulateWithoutAdaptions=function(e){var t={cannot:!1,where:e};if(null!==e)for(var r=0,n=this.adaptedFields;r<n.length;r++){var i=n[r];if(!0===l.scanForField(e,i.field.name)){var a=i.rewriteSql(e,this);if(!0!==a.rewritten){t.cannot=!0,t.where=null;break}t.where=a.where}}return t},t.prototype._stat=function(e,t,r,n,i,a,s){var o=this,d=!1,c=this.reformulateWithoutAdaptions(t);return d=c.cannot,t=c.where,c=this.reformulateWithoutAdaptions(i),d=d||c.cannot,null!==(i=c.where)?null!==this._extraFilter&&(i=l.combine(this._extraFilter,i)):i=this._extraFilter,!0===d?null===i&&""===r&&null===n?this._manualStat(e,t,a,s):u.resolve({calculated:!1}):this._parent._stat(e,t,r,n,i,a,s).then((function(l){return!1===l.calculated?null===i&&""===r&&null===n?o._manualStat(e,t,a,s):{calculated:!1}:l}))},t.prototype._canDoAggregates=function(e,t,r,n,i){if(null===this._parent)return u.resolve(!1);for(var a=0;a<e.length;a++)for(var s=0,o=this.adaptedFields;s<o.length;s++){var d=o[s];if(e[a].toLowerCase()===d.field.name.toLowerCase()&&!(d instanceof h))return u.resolve(!1)}var c=[];for(a=0;a<t.length;a++){var p=t[a];if(null!==p.workingexpr){var f=this.reformulateWithoutAdaptions(p.workingexpr);if(f.cannot)return u.resolve(!1);var y=p.clone();y.workingexpr=f.where,c.push(y)}else c.push(p)}var _=this.reformulateWithoutAdaptions(i);return _.cannot?u.resolve(!1):(null!==(i=_.where)?null!==this._extraFilter&&(i=l.combine(this._extraFilter,i)):i=this._extraFilter,this._parent._canDoAggregates(e,c,r,n,i))},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,r,n,i,a,s){if(null===this._parent)return u.reject(new Error("Should never be called"));for(var o=[],d=0;d<t.length;d++){var c=t[d];if(null!==c.workingexpr){var p=this.reformulateWithoutAdaptions(c.workingexpr);if(p.cannot)return u.reject(new Error("Should never be called"));var h=c.clone();h.workingexpr=p.where,o.push(h)}else o.push(c)}var f=this.reformulateWithoutAdaptions(i);return f.cannot?u.reject(new Error("Should never be called")):(null!==(i=f.where)?null!==this._extraFilter&&(i=l.combine(this._extraFilter,i)):i=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,o,r,n,i,a,s))},t}(a);t.AdaptedFeatureSet=g}).apply(null,n))||(e.exports=i)},ijuC:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("zOht"),r("88sq"),r("Q4uJ"),r("tq6K"),r("qMld")],void 0===(i=(function(e,t,r,n,i,a,s){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r._topnum=0,r.declaredClass="esri.arcade.featureset.actions.Top",r._countedin=0,r._maxProcessing=100,r._topnum=t.topnum,r._parent=t.parentfeatureset,r}return r.__extends(t,e),t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getSet(e)})).then((function(e){return t._wset=new i(e._candidates.slice(0),e._known.slice(0),!1,t._clonePageDefinition(e.pagesDefinition)),t._setKnownLength(t._wset)>t._topnum&&(t._wset._known=t._wset._known.slice(0,t._topnum)),t._setKnownLength(t._wset)>=t._topnum&&(t._wset._candidates=[]),t._wset})):s.resolve(this._wset)},t.prototype._setKnownLength=function(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length},t.prototype._isInFeatureSet=function(e){var t=this._parent._isInFeatureSet(e);if(t===a.IdState.NotInFeatureSet)return t;var r=this._idstates[e];return r===a.IdState.InFeatureSet||r===a.IdState.NotInFeatureSet?r:t===a.IdState.InFeatureSet&&void 0===r?this._countedin<this._topnum?(this._idstates[e]=a.IdState.InFeatureSet,this._countedin++,a.IdState.InFeatureSet):(this._idstates[e]=a.IdState.NotInFeatureSet,a.IdState.NotInFeatureSet):a.IdState.Unknown},t.prototype._expandPagedSet=function(e,t,r,n,i){var a=this;if(null===this._parent)return s.reject(new Error("Parent Paging not implemented"));if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){var o=e._known.length;return o>0&&"GETPAGES"===e._known[o-1]&&(e._known.length=o-1),(o=e._candidates.length)>0&&"GETPAGES"===e._candidates[o-1]&&(e._candidates.length=o-1),s.resolve("success")}return this._parent._expandPagedSet(e,t,r,n,i).then((function(t){return a._setKnownLength(e)>a._topnum&&(e._known.length=a._topnum),a._setKnownLength(e)>=a._topnum&&(e._candidates.length=0),t}))},t.prototype._getFeatures=function(e,t,r,n){var a=this,o=[],l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,n).then((function(){return a._getFeatures(e,t,r,n)}));-1!==t&&void 0===this._featureCache[t]&&o.push(t);for(var u=0,d=e._lastFetchedIndex;d<e._known.length&&(++u<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[d]]&&(e._known[d]!==t&&o.push(e._known[d]),o.length>l-1)));d++);if(0===o.length)return s.resolve("success");var c=new i([],o,!1,null),p=Math.min(o.length,r);return this._parent._getFeatures(c,-1,p,n).then((function(){for(var e=0;e<p;e++){var t=a._parent._featureFromCache(o[e]);void 0!==t&&(a._featureCache[o[e]]=t)}return"success"}))},t.prototype._getFilteredSet=function(e,t,r,n,a){var s=this;return this._ensureLoaded().then((function(){return s._getSet(a)})).then((function(e){return new i(e._candidates.slice(0).concat(e._known.slice(0)),[],!1,s._clonePageDefinition(e.pagesDefinition))}))},t.prototype._refineKnowns=function(e,t){for(var r=0,n=null,i=[],s=0;s<e._candidates.length;s++){var o=this._isInFeatureSet(e._candidates[s]);if(o===a.IdState.InFeatureSet){if(e._known.push(e._candidates[s]),r+=1,null===n?n={start:s,end:s}:n.end===s-1?n.end=s:(i.push(n),n={start:s,end:s}),e._known.length>=this._topnum)break}else if(o===a.IdState.NotInFeatureSet)null===n?n={start:s,end:s}:n.end===s-1?n.end=s:(i.push(n),n={start:s,end:s}),r+=1;else if(o===a.IdState.Unknown)break;if(r>=t)break}null!==n&&i.push(n);for(var l=i.length-1;l>=0;l--)e._candidates.splice(i[l].start,i[l].end-i[l].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])},t.prototype._stat=function(){return s.resolve({calculated:!1})},t.prototype._canDoAggregates=function(){return s.resolve(!1)},t.registerAction=function(){n._featuresetFunctions.top=function(e){return new t({parentfeatureset:this,topnum:e})}},t}(n)}).apply(null,n))||(e.exports=i)},ufnL:function(e,t,r){var n,i;n=[r.dj.c(e.i),t,r("zOht"),r("88sq"),r("Q4uJ"),r("tq6K"),r("SqzB"),r("qMld"),r("1eyA"),r("Z4y+")],void 0===(i=(function(e,t,r,n,i,a,s,o,l,u){"use strict";return function(e){function t(t){var r=e.call(this,t)||this;return r.declaredClass="esri.arcade.featureset.actions.AttributeFilter",r._maxProcessing=1e3,r._parent=t.parentfeatureset,t.whereclause instanceof l.WhereClause?(r._whereclause=t.whereclause,r._whereClauseFunction=null):(r._whereClauseFunction=t.whereclause,r._whereclause=null),r}return r.__extends(t,e),t.prototype._initialiseFeatureSet=function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.spatialReference=new u({wkid:4326}),this.geometryType=a.layerGeometryEsriConstants.point)},t.prototype._getSet=function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getFilteredSet("",null,t._whereclause,null,e)})).then((function(r){return t._checkCancelled(e),t._wset=null!==t._whereClauseFunction?new i(r._candidates.slice(0).concat(r._known.slice(0)),[],r._ordered,t._clonePageDefinition(r.pagesDefinition)):new i(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):o.resolve(this._wset)},t.prototype._isInFeatureSet=function(e){var t=this._parent._isInFeatureSet(e);return t===a.IdState.NotInFeatureSet?t:void 0===(t=this._idstates[e])?a.IdState.Unknown:t},t.prototype._getFeature=function(e,t,r){return this._parent._getFeature(e,t,r)},t.prototype._getFeatures=function(e,t,r,n){return this._parent._getFeatures(e,t,r,n)},t.prototype._featureFromCache=function(e){return this._parent._featureFromCache(e)},t.prototype.executeWhereClause=function(e){return this._whereclause.testFeature(e)},t.prototype.executeWhereClauseDeferred=function(e){if(null!==this._whereClauseFunction)try{var t=this._whereClauseFunction(e);return o.isPromiseLike(t)?t:o.resolve(t)}catch(e){return o.reject(e)}return o.resolve(this.executeWhereClause(e))},t.prototype._fetchAndRefineFeatures=function(e,t,r){var n=this,s=new i([],e,!1,null),l=Math.min(t,e.length);return this._parent._getFeatures(s,-1,l,r).then((function(){if(n._checkCancelled(r),null==n._whereClauseFunction){for(var i=0;i<l;i++){var s=n._parent._featureFromCache(e[i]);n._idstates[e[i]]=!0===n.executeWhereClause(s)?a.IdState.InFeatureSet:a.IdState.NotInFeatureSet}return"success"}var u=[];for(i=0;i<l;i++)s=n._parent._featureFromCache(e[i]),u.push(n.executeWhereClauseDeferred(s));return o.all(u).then((function(r){for(var i=0;i<t;i++)n._idstates[e[i]]=!0===r[i]?a.IdState.InFeatureSet:a.IdState.NotInFeatureSet;return"success"}))}))},t.prototype._getFilteredSet=function(e,t,r,n,a){var o=this;return null!==this._whereClauseFunction||(null!==r?null!==this._whereclause&&(r=s.combine(this._whereclause,r)):r=this._whereclause),this._ensureLoaded().then((function(){return o._parent._getFilteredSet(e,t,r,n,a)})).then((function(e){return o._checkCancelled(a),null!==o._whereClauseFunction?new i(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,o._clonePageDefinition(e.pagesDefinition)):new i(e._candidates.slice(0),e._known.slice(0),e._ordered,o._clonePageDefinition(e.pagesDefinition))}))},t.prototype._stat=function(e,t,r,n,i,a,l){var u=this;if(null!==this._whereClauseFunction)return null===i&&""===r&&null===n?this._manualStat(e,t,a,l):o.resolve({calculated:!1});var d=this._whereclause;return null!==i&&null!==this._whereclause&&(d=s.combine(this._whereclause,i)),this._parent._stat(e,t,r,n,d,a,l).then((function(s){return!1===s.calculated?null===i&&""===r&&null===n?u._manualStat(e,t,a,l):{calculated:!1}:s}))},t.prototype._canDoAggregates=function(e,t,r,n,i){return null!==this._whereClauseFunction?o.resolve(!1):(null!==i?null!==this._whereclause&&(i=s.combine(this._whereclause,i)):i=this._whereclause,null===this._parent?o.resolve(!1):this._parent._canDoAggregates(e,t,r,n,i))},t.prototype._getAggregatePagesDataSourceDefinition=function(e,t,r,n,i,a,l){return null===this._parent?o.reject(new Error("Should never be called")):(null!==i?null!==this._whereclause&&(i=s.combine(this._whereclause,i)):i=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,r,n,i,a,l))},t.registerAction=function(){n._featuresetFunctions.filter=function(e){if("function"==typeof e)return new t({parentfeatureset:this,whereclause:e});var r=null;return e instanceof l.WhereClause&&(r=e),new t({parentfeatureset:this,whereclause:r})}},t}(n)}).apply(null,n))||(e.exports=i)}}]);