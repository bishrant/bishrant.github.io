!function(){function e(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function t(t){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?e(Object(n),!0).forEach((function(e){i(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):e(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function i(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function r(e,t,i){return(r="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,i){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=c(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(i):n.value}})(e,t,i||e)}function n(e,t,i,r,n,a,s){try{var o=e[a](s),u=o.value}catch(l){return void i(l)}o.done?t(u):Promise.resolve(u).then(r,n)}function a(e){return function(){var t=this,i=arguments;return new Promise((function(r,a){var s=e.apply(t,i);function o(e){n(s,r,a,o,u,"next",e)}function u(e){n(s,r,a,o,u,"throw",e)}o(void 0)}))}}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}function o(e,t){return(o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,r=c(e);if(t){var n=c(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return l(this,i)}}function l(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?h(e):t}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function d(e){return function(e){if(Array.isArray(e))return y(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||_(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function p(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function m(e,t,i){return t&&p(e.prototype,t),i&&p(e,i),e}function v(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0,n=function(){};return{s:n,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return s=e.done,e},e:function(e){o=!0,a=e},f:function(){try{s||null==i.return||i.return()}finally{if(o)throw a}}}}function g(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var i=e&&("undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"]);if(null==i)return;var r,n,a=[],s=!0,o=!1;try{for(i=i.call(e);!(s=(r=i.next()).done)&&(a.push(r.value),!t||a.length!==t);s=!0);}catch(u){o=!0,n=u}finally{try{s||null==i.return||i.return()}finally{if(o)throw n}}return a}(e,t)||_(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _(e,t){if(e){if("string"==typeof e)return y(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?y(e,t):void 0}}function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{tGAV:function(e,n,o){"use strict";o.r(n),o.d(n,"LabelManager",(function(){return X})),o.d(n,"Stage",(function(){return ji})),o.d(n,"GraphicsView2D",(function(){return Ii.a})),o.d(n,"GraphicContainer",(function(){return Di.a})),o.d(n,"MapViewNavigation",(function(){return or})),o.d(n,"MagnifierView2D",(function(){return dr}));var l=o("pO5D"),p=o("wSAH"),_=o("6S2I"),y=(o("zqDF"),o("WbKI")),b=o("04ZG"),w=o("zlDU"),x=o("4EHJ"),k=(o("ju1D"),o("9AIY"),o("/CmD")),O=o("kJYu"),C=o("5C/r"),T=o("srIe"),M=o("jIHu"),S=o("1agI"),R=o("OKTS"),P=o("qRWG"),F=o("m0D6"),j=Math.PI;function I(e,t){switch(t.transformationType){case"additive":return function(e,t){return e+(D(t.minSize,e)||t.minDataValue)}(e,t);case"constant":return function(e,t){var i=e.stops,r=i&&i.length&&i[0].size;return null==r&&(r=e.minSize),D(r,t)}(t,e);case"clamped-linear":return function(e,t){var i=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),r=D(t.minSize,e),n=D(t.maxSize,e);return e<=t.minDataValue?r:e>=t.maxDataValue?n:r+i*(n-r)}(e,t);case"proportional":return function(e,t){var i,r=e/t.minDataValue,n=D(t.minSize,e),a=D(t.maxSize,e);return i=r*n,Object(R.c)(i,n,a)}(e,t);case"stops":return function(e,t){var i=g(function(e,t){if(t){var i=0,r=t.length-1;return t.some((function(t,n){return e<t?(r=n,!0):(i=n,!1)})),[i,r,(e-t[i])/(t[r]-t[i])]}}(e,t.cache.ipData),3),r=i[0],n=i[1],a=i[2];if(r===n)return D(t.stops[r].size,e);var s=D(t.stops[r].size,e);return s+(D(t.stops[n].size,e)-s)*a}(e,t);case"real-world-size":return i=e,r=t,a=F.a[r.valueUnit],s=D(r.minSize,i),o=D(r.maxSize,i),u=r.valueRepresentation,n="area"===u?2*Math.sqrt(i/j)/a:"radius"===u||"distance"===u?2*i/a:i/a,Object(R.c)(n,s,o);case"identity":return e;case"unknown":return null}var i,r,n,a,s,o,u}function D(e,t){return"number"==typeof e?e:I(t,e)}var z=function(e,t){return e.order-t.order},B=function(e,t){return e.index-t.index},E=_.a.getLogger("esri/views/2d/engine/webgl/collisions/CollisionEngine");function A(e,t){var i=!!e.maxScale,r=!!e.minScale&&t.scaleToZoom(e.minScale)||0,n=i&&t.scaleToZoom(e.maxScale)||255;return{deconflictionStrategy:e.deconflictionStrategy,minZoom:Object(R.c)(Math.floor(10*r),0,255),maxZoom:Object(R.c)(Math.floor(10*n),0,255)}}function V(e){return function(t){return Object(P.h)(I(t,e))}}function L(e){if(!e)return null;var t,i=v(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;if("size"===r.type)return V(r)}}catch(n){i.e(n)}finally{i.f()}return null}var U=function(){function e(t,i,r,n){var a=this;f(this,e),this._vvHandle=null;var s=t.layer,o=s.geometryType,u=s.labelingInfo,l=s.renderer;l&&(this.vvEval=L("visualVariables"in l&&l.visualVariables)),this._vvHandle=s.watch("renderer",(function(e){e&&(a.vvEval=L("visualVariables"in e&&e.visualVariables))}));var h=s.featureReduction,c=h&&"cluster"===h.type&&h.labelingInfo,p=(u||[]).map((function(e){return A(e,n)})),m=(c||[]).map((function(e){return A(e,n)}));this.layerView=t,this.geometryType=o,this.index=i,this.order=r,this.zoomRanges=[].concat(d(p),d(m)),this.layerView=t}return m(e,[{key:"hasVV",value:function(){return!!this.vvEval}},{key:"allOrNothing",value:function(){return!("polyline"===this.geometryType)}},{key:"destroy",value:function(){this._vvHandle.remove()}}],[{key:"create",value:function(t,i,r,n){var a,s=r.sort(z),o=!1,u=-1,l=v(s);try{for(l.s();!(a=l.n()).done;){var h=a.value;!o&&h.order>i&&(u=h.index,o=!0),o&&h.index++}}catch(c){l.e(c)}finally{l.f()}return o||(u=s.length),new e(t,u,i,n)}},{key:"delete",value:function(e,t){for(var i=t.sort(B),r=e+1;r<i.length;r++)t[r].index--;t[e].destroy(),t.splice(e,1)}},{key:"find",value:function(e,t){var i,r=v(t);try{for(r.s();!(i=r.n()).done;){var n=i.value;if(n.index===e)return n}}catch(a){r.e(a)}finally{r.f()}return E.error("Tried to get a LayerCollisionInfo for an index that doesn't exist!"),null}}]),e}();function N(e,t){var i=[];e.forEachTile((function(e){return i.push(e)})),i.sort((function(e,t){return e.instanceId-t.instanceId})),i.forEach((function(e){Object(T.k)(e.labelMetrics)&&e.isReady&&t(e,e.labelMetrics.getCursor())}))}var q=function(){function e(t){f(this,e),this._layers=new Map,this._tilingScheme=t}return m(e,[{key:"collisionInfos",get:function(){return Array.from(this._layers.values())}},{key:"registerLayerView",value:function(e,t){if(!this._layers.has(e)){var i=U.create(e,t,this.collisionInfos,this._tilingScheme);this._layers.set(e,i)}}},{key:"unregisterLayerView",value:function(e){if(this._layers.has(e)){var t=this._layers.get(e);U.delete(t.index,this.collisionInfos),this._layers.delete(e)}}},{key:"run",value:function(e,t){this._transformMetrics(e),this._runCollision(e,t)}},{key:"_runCollision",value:function(e,t){var i=this,r=g(e.state.size,2),n=r[0],a=r[1],s=new S.a(n,a);this._forEachLayer((function(e,r){var n=e.zoomRanges.some((function(e){return"none"===e.deconflictionStrategy})),a=r.featuresView.attributeView;n?N(r,(function(e,t){for(;t.nextId();)a.setLabelMinZoom(t.id,0)})):(i._prepare(r),i._collideVisible(s,r,t),i._collideInvisible(s,r))}))}},{key:"_isFiltered",value:function(e,t,i){var r=t.getFilterFlags(e);return!((!i.hasFilter||r&M.i)&&(!i.effect||i.effect.excludedLabelsVisible||r&M.h))}},{key:"_prepare",value:function(e){var t=this,i=e.featuresView.attributeView,r=new Set;N(e,(function(n,a){for(;a.nextId();)r.has(a.id)||(r.add(a.id),t._isFiltered(a.id,i,e.layerView)?i.setLabelMinZoom(a.id,254):0!==i.getLabelMinZoom(a.id)?i.setLabelMinZoom(a.id,255):i.setLabelMinZoom(a.id,0))}))}},{key:"_collideVisible",value:function(e,t,i){var r=t.featuresView.attributeView,n=new Set;N(t,(function(t,a){for(;a.nextId();)if(!n.has(a.id))if(t.key.level===i){if(0===r.getLabelMinZoom(a.id))switch(e.insertMetrics(a)){case S.e:break;case S.c:r.setLabelMinZoom(a.id,254),n.add(a.id);break;case S.d:r.setLabelMinZoom(a.id,0),n.add(a.id)}}else r.setLabelMinZoom(a.id,254)}))}},{key:"_collideInvisible",value:function(e,t){var i=t.featuresView.attributeView,r=new Set;N(t,(function(t,n){for(;n.nextId();)if(!r.has(n.id)&&255===i.getLabelMinZoom(n.id))switch(e.insertMetrics(n)){case S.e:break;case S.c:i.setLabelMinZoom(n.id,255),r.add(n.id);break;case S.d:i.setLabelMinZoom(n.id,0),r.add(n.id)}}))}},{key:"_transformMetrics",value:function(e){this._forEachLayer((function(t,i){N(i,(function(r,n){var a=i.featuresView.attributeView,s=r.transforms.labelMat2d;s[4]=Math.round(s[4]),s[5]=Math.round(s[5]);for(var o=s[4],u=s[5],l="polyline"===t.geometryType;n.next();){var h=n.boundsCount,c=n.anchorX,d=n.anchorY,f=0,p=0;if(t.hasVV()){var m=a.getVVSize(n.id),v=t.vvEval(m),g=isNaN(v)||null==v||v===1/0?n.size:v;f=n.directionX*(g/2),p=n.directionY*(g/2)}for(var _=0;_<h;_++){var y=c,b=n.anchorY;if(l){var w=y+n.boundsCenterX(_)+f,x=b+n.boundsCenterY(_)+p;e.state.rotation?(w=s[0]*w+s[2]*x+s[4],x=s[1]*w+s[3]*x+s[5]):(w+=o,x+=u),n.setBoundsComputedAnchorX(_,Math.floor(w)),n.setBoundsComputedAnchorY(_,Math.floor(x))}else{e.state.rotation?(y=s[0]*c+s[2]*d+s[4],b=s[1]*c+s[3]*d+s[5]):(y+=o,b+=u);var k=y+n.boundsCenterX(_)+f,O=b+n.boundsCenterY(_)+p;n.setBoundsComputedAnchorX(_,k),n.setBoundsComputedAnchorY(_,O)}}}}))}))}},{key:"_forEachLayer",value:function(e){var t=[];this._layers.forEach((function(e){return t.push(e)})),t.sort((function(e,t){return e.order-t.order})),t.forEach((function(t){var i,r=null==(i=t.layerView)?void 0:i.tileRenderer;r&&e(t,r)}))}}]),e}(),H=_.a.getLogger("esri.views.2d.engine.collisions.LayerViewSorter");function G(e){return"esri.views.2d.layers.FeatureLayerView2D"===e.declaredClass||"esri.views.2d.layers.StreamLayerView2D"===e.declaredClass}function W(e){if(!e.layer||!e.layer.renderer)return!1;switch(e.layer.renderer.type){case"class-breaks":case"simple":case"unique-value":case"dictionary":case"dot-density":return!0;default:return H.error(new w.a("mapview-labeling","Renderer of type ".concat(e.layer.renderer.type," does not currently support labeling"))),!1}}var Z=function(){function e(t,i){f(this,e),this.registerLayer=t,this.unregisterLayer=i,this._layerViewState=new Map}return m(e,[{key:"findIndex",value:function(e){return e.view.allLayerViews.findIndex((function(t){return t.uid===e.uid}))}},{key:"update",value:function(e){var t,i=e.added,r=v(e.removed);try{for(r.s();!(t=r.n()).done;){var n=t.value;G(n)&&this._layerViewState.has(n)&&this._deleteState(n)}}catch(u){r.e(u)}finally{r.f()}var a,s=v(i);try{for(s.s();!(a=s.n()).done;){var o=a.value;G(o)&&W(o)&&!this._layerViewState.has(o)&&this._createState(o)}}catch(u){s.e(u)}finally{s.f()}this._recomputeOrder()}},{key:"destroy",value:function(){this._layerViewState.forEach((function(e){return e.handles.forEach((function(e){return e.remove()}))}))}},{key:"_createState",value:function(e){var t={priority:-1,handles:null};return t.handles=[e.layer.watch("visible",this._recomputeOrder.bind(this)),e.layer.watch("labelsVisible",this._recomputeOrder.bind(this)),e.layer.watch("labelingInfo",this._recomputeOrder.bind(this)),e.layer.watch("featureReduction",this._recomputeOrder.bind(this))],this._layerViewState.set(e,t),t}},{key:"_deleteState",value:function(e){if(this._layerViewState.has(e)){var t=this._layerViewState.get(e);t.handles.forEach((function(e){return e.remove()})),-1!==t.priority&&this.unregisterLayer(e),this._layerViewState.delete(e)}}},{key:"_recomputeOrder",value:function(){var e=this;this._layerViewState.forEach((function(t,i){var r=i.view.map.allLayers.findIndex((function(e){return e.uid===i.layer.uid})),n=i.layer,a=n.featureReduction,s=n.visible&&(n.labelsVisible&&n.labelingInfo&&n.labelingInfo.length||a&&"cluster"===a.type&&a.labelsVisible&&a.labelingInfo&&a.labelingInfo.length)?4294967295-r:-1;s!==t.priority&&(t.priority=s,e.unregisterLayer(i),-1!==s&&e.registerLayer(i,s))}))}}]),e}(),K=_.a.getLogger("esri.views.2d.layers.labels.LabelManager"),Y=function(e){s(i,e);var t=u(i);function i(e){var r;return f(this,i),(r=t.call(this,e))._applyVisibilityPassThrottled=Object(C.a)(r._applyVisibilityPass,32,h(r)),r.lastUpdateId=-1,r.updateRequested=!1,r.view=null,r}return m(i,[{key:"initialize",value:function(){var e=this;this.collisionEngine=new q(this.view.featuresTilingScheme),this._layerViewSorter=new Z((function(t,i){e.collisionEngine.registerLayerView(t,i),e.requestUpdate()}),(function(t){e.collisionEngine.unregisterLayerView(t),e.requestUpdate()})),this.handles.add(this.view.allLayerViews.on("change",(function(t){e._layerViewSorter.update(t)})))}},{key:"destroy",value:function(){this._layerViewSorter.destroy(),this._layerViewSorter=null,this.collisionEngine=null,this._applyVisibilityPassThrottled.remove(),this._applyVisibilityPassThrottled=null}},{key:"updating",get:function(){return this.updateRequested}},{key:"update",value:function(e){this._applyVisibilityPassThrottled(e)}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"requestUpdate",value:function(){this.updateRequested||(this.updateRequested=!0,this.view.requestUpdate())}},{key:"processUpdate",value:function(e){this._set("updateParameters",e),this.updateRequested&&(this.updateRequested=!1,this.update(e))}},{key:"_applyVisibilityPass",value:function(e){try{var t=this.view.featuresTilingScheme.getClosestInfoForScale(e.state.scale).level;this.collisionEngine.run(e,t)}catch(t){K.error(new w.a("mapview-labeling","Encountered an error during label decluttering",t))}}}]),i}(Object(O.b)(k.a));Object(l.a)([Object(y.b)()],Y.prototype,"updateRequested",void 0),Object(l.a)([Object(y.b)({readOnly:!0})],Y.prototype,"updateParameters",void 0),Object(l.a)([Object(y.b)()],Y.prototype,"updating",null),Object(l.a)([Object(y.b)()],Y.prototype,"view",void 0);var X=Y=Object(l.a)([Object(b.a)("esri.views.2d.layers.labels.LabelManager")],Y),Q=o("nYOO"),J=o("WBXD"),$=o("QhKk"),ee=o("N5XI"),te=o("AvGH"),ie=o("TcGo"),re=o("M0lq"),ne=o("zBXm"),ae=o("opr1"),se=o("9+ss"),oe=o("Snp0"),ue=(o("n4uK"),o("fOQB")),le=o("D6bk"),he=o("0meK"),ce=o("1F90"),de=o("bfJE"),fe=o("yE7X"),pe=o("AMBt"),me=(o("GVa1"),o("kbDN")),ve=o("Oxob"),ge=o("jjdI"),_e=o("SfCL"),ye={background:{"background.frag":"#ifdef PATTERN\nuniform lowp float u_opacity;\nuniform mediump vec2 u_pattern_tl;\nuniform mediump vec2 u_pattern_br;\nuniform sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\n#else\nuniform lowp vec4 u_color;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main() {\n#ifdef PATTERN\n  mediump vec2 normalizedTextureCoord = mod(v_tileTextureCoord, 1.0);\n  mediump vec2 samplePos = mix(u_pattern_tl, u_pattern_br, normalizedTextureCoord);\n  lowp vec4 color = texture2D(u_texture, samplePos);\n  gl_FragColor = u_opacity * color;\n#else\n  gl_FragColor = u_color;\n#endif\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","background.vert":"precision mediump float;\nattribute vec2 a_pos;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform mediump float u_coord_range;\nuniform mediump float u_depth;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\n#endif\nvoid main() {\n  gl_Position = vec4((u_dvsMat3 * vec3(u_coord_range * a_pos, 1.0)).xy, u_depth, 1.0);\n#ifdef PATTERN\n  v_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\n#endif\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n}"},circle:{"circle.frag":"precision lowp float;\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\n  mediump float dist = length(v_offset);\n  mediump float alpha = smoothstep(0.0, -v_blur, dist - 1.0);\n  lowp float color_mix_ratio = v_stroke_width < 0.01 ? 0.0 : smoothstep(-v_blur, 0.0, dist - v_radius / (v_radius + v_stroke_width));\n  gl_FragColor = alpha * mix(v_color, v_stroke_color, color_mix_ratio);\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","circle.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nvarying lowp vec4 v_color;\nvarying lowp vec4 v_stroke_color;\nvarying mediump float v_blur;\nvarying mediump float v_stroke_width;\nvarying mediump float v_radius;\nvarying mediump vec2 v_offset;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_circleTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_antialiasingWidth;\nvoid main()\n{\n#pragma main\n  v_color = color * opacity;\n  v_stroke_color = stroke_color * stroke_opacity;\n  v_stroke_width = stroke_width;\n  v_radius = radius;\n  v_blur = max(blur, u_antialiasingWidth / (radius + stroke_width));\n  mediump vec2 offset = vec2(mod(a_pos, 2.0) * 2.0 - 1.0);\n  v_offset = offset;\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos * 0.5, 1.0) + u_displayMat3 * vec3((v_radius + v_stroke_width) * offset + u_circleTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},fill:{"fill.frag":"precision lowp float;\n#ifdef PATTERN\nuniform mediump vec2 u_pattern_tl;\nuniform mediump vec2 u_pattern_br;\nuniform lowp sampler2D u_texture;\nvarying mediump vec2 v_tileTextureCoord;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvec4 mixColors(vec4 color1, vec4 color2) {\n  float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\n  vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\n  return vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef PATTERN\n  mediump vec2 normalizedTextureCoord = fract(v_tileTextureCoord);\n  mediump vec2 samplePos = mix(u_pattern_tl, u_pattern_br, normalizedTextureCoord);\n  lowp vec4 color = texture2D(u_texture, samplePos);\n  gl_FragColor = v_color[3] * color;\n#else\n  gl_FragColor = v_color;\n#endif\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","fill.vert":"precision mediump float;\nattribute vec2 a_pos;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump float u_depth;\nuniform mediump vec2 u_fillTranslation;\n#ifdef PATTERN\nuniform mediump mat3 u_pattern_matrix;\nvarying mediump vec2 v_tileTextureCoord;\n#endif\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvoid main()\n{\n#pragma main\n  v_color = color * opacity;\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n#ifdef PATTERN\n  v_tileTextureCoord = (u_pattern_matrix * vec3(a_pos, 1.0)).xy;\n#endif\n  vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(u_fillTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},icon:{"icon.frag":"precision mediump float;\nuniform lowp sampler2D u_texture;\n#ifdef SDF\nuniform lowp vec4 u_color;\nuniform lowp vec4 u_outlineColor;\n#endif\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump flaot v_halo_width;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\n#include <util/encoding.glsl>\nvec4 mixColors(vec4 color1, vec4 color2) {\n  float compositeAlpha = color2.a + color1.a * (1.0 - color2.a);\n  vec3 compositeColor = color2.rgb + color1.rgb * (1.0 - color2.a);\n  return vec4(compositeColor, compositeAlpha);\n}\nvoid main()\n{\n#ifdef SDF\n  lowp vec4 fillPixelColor = v_color;\n  float d = rgba2float(texture2D(u_texture, v_tex)) - 0.5;\n  const float softEdgeRatio = 0.248062016;\n  float size = max(v_size.x, v_size.y);\n  float dist = d * softEdgeRatio * size;\n  fillPixelColor *= clamp(0.5 - dist, 0.0, 1.0);\n  if (v_halo_width > 0.25) {\n    lowp vec4 outlinePixelColor = u_outlineColor;\n    const float outlineLimitRatio = (16.0 / 86.0);\n    float clampedOutlineSize = softEdgeRatio * min(v_halo_width, outlineLimitRatio * max(v_size.x, v_size.y));\n    outlinePixelColor *= clamp(0.5 - (abs(dist) - clampedOutlineSize), 0.0, 1.0);\n    gl_FragColor = v_opacity * mixColors(fillPixelColor, outlinePixelColor);\n  }\n  else {\n    gl_FragColor = v_opacity * fillPixelColor;\n  }\n#else\n  lowp vec4 texColor = texture2D(u_texture, v_tex);\n  gl_FragColor = v_opacity * texColor;\n#endif\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","icon.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\n#ifdef SDF\nvarying mediump float v_halo_width;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_iconTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying mediump vec2 v_tex;\nvarying lowp float v_opacity;\nvarying mediump vec2 v_size;\nconst float C_OFFSET_PRECISION = 1.0 / 8.0;\nconst float C_256_TO_RAD = 3.14159265359 / 128.0;\nconst float C_DEG_TO_RAD = 3.14159265359 / 180.0;\nconst float tileCoordRatio = 1.0 / 8.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\n  v_color = color;\n  v_opacity = opacity;\n#ifdef SDF\n  v_halo_width = halo_width;\n#endif\n  float modded = mod(a_opacityInfo, 128.0);\n  float targetOpacity = (a_opacityInfo - modded) / 128.0;\n  float startOpacity = modded / 127.0;\n  float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\n  v_opacity *= interpolatedOpacity;\n  mediump float a_angle         = a_levelInfo[1];\n  mediump float a_minLevel      = a_levelInfo[2];\n  mediump float a_maxLevel      = a_levelInfo[3];\n  mediump vec2 a_tex            = a_texAngleRange.xy;\n  mediump float delta_z = 0.0;\n  mediump float rotated = mod(a_angle + u_mapRotation, 256.0);\n  delta_z += (1.0 - step(u_keepUpright, 0.0)) * step(64.0, rotated) * (1.0 - step(192.0, rotated));\n  delta_z += 1.0 - step(a_minLevel, u_level);\n  delta_z += step(a_maxLevel, u_level);\n  delta_z += step(v_opacity, 0.0);\n  vec2 offset = C_OFFSET_PRECISION * a_vertexOffset;\n  v_size = abs(offset);\n#ifdef SDF\n  offset = (120.0 / 86.0) * offset;\n#endif\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayViewMat3 * vec3(size * offset, 0.0) + u_displayMat3 * vec3(u_iconTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n  v_tex = a_tex.xy / u_mosaicSize;\n}"},line:{"line.frag":"varying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nvarying mediump float v_lineHalfWidth;\nvarying lowp vec4 v_color;\nvarying mediump float v_blur;\n#ifdef PATTERN\nuniform mediump vec2 u_pattern_tl;\nuniform mediump vec2 u_pattern_br;\nuniform mediump vec2 u_spriteSize;\nuniform sampler2D u_texture;\nconst mediump float tileCoordRatio = 8.0;\n#else\nvarying mediump vec2 v_dasharray;\n#endif\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\n  mediump float fragDist = length(v_normal) * v_lineHalfWidth;\n  lowp float alpha = clamp((v_lineHalfWidth - fragDist) / v_blur, 0.0, 1.0);\n#ifdef PATTERN\n  mediump float relativeTexX = mod((v_accumulatedDistance + v_normal.x * v_lineHalfWidth * tileCoordRatio) / u_spriteSize.x, 1.0);\n  mediump float relativeTexY = 0.5 + (v_normal.y * v_lineHalfWidth / u_spriteSize.y);\n  mediump vec2 texCoord = mix(u_pattern_tl, u_pattern_br, vec2(relativeTexX, relativeTexY));\n  lowp vec4 color = texture2D(u_texture, texCoord);\n  gl_FragColor = alpha * v_color[3] * color;\n#else\n  lowp float dashPos =  mod(v_accumulatedDistance, v_dasharray.x + v_dasharray.y);\n  lowp float dashAlpha = clamp(min(dashPos, v_dasharray.x - dashPos) + 0.5, 0.0, 1.0);\n  dashAlpha = max(sign(-v_dasharray.y), dashAlpha);\n  alpha *= dashAlpha;\n  gl_FragColor = alpha * v_color;\n#endif\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","line.vert":"attribute vec2 a_pos;\nattribute vec4 a_offsetAndNormal;\nattribute vec2 a_accumulatedDistance;\n#pragma header\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_lineTranslation;\nuniform mediump float u_antialiasing;\nuniform mediump float u_depth;\nvarying mediump vec2 v_normal;\nvarying highp float v_accumulatedDistance;\nconst float scale = 1.0 / 31.0;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nvarying lowp vec4 v_color;\nvarying mediump float v_lineHalfWidth;\nvarying mediump float v_blur;\n#ifndef PATTERN\nuniform mediump vec2 u_dasharray;\nvarying mediump vec2 v_dasharray;\n#endif\nvoid main()\n{\n#pragma main\n  v_color = color * opacity;\n  v_blur = blur + u_antialiasing;\n  v_normal = a_offsetAndNormal.zw * scale;\n  v_lineHalfWidth += (width + u_antialiasing) * 0.5;\n#ifndef PATTERN\n  v_dasharray = u_dasharray * width;\n#endif\n  mediump vec2 dist = v_lineHalfWidth * scale * a_offsetAndNormal.xy;\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) +  u_displayViewMat3 * vec3(dist, 0.0) + u_displayMat3 * vec3(u_lineTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth, 1.0);\n  v_accumulatedDistance = a_accumulatedDistance.x;\n  #ifdef ID\n    v_id = u_id / 255.0;\n  #endif\n}"},outline:{"outline.frag":"varying lowp vec4 v_color;\nvarying mediump vec2 v_normal;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\n  lowp float dist = abs(v_normal.y);\n  lowp float alpha = smoothstep(1.0, 0.0, dist);\n  gl_FragColor = alpha * v_color;\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","outline.vert":"attribute vec2 a_pos;\nattribute vec2 a_offset;\nattribute vec2 a_xnormal;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform mediump vec2 u_fillTranslation;\nuniform mediump float u_depth;\nuniform mediump float u_outline_width;\nvarying lowp vec2 v_normal;\nconst float scale = 1.0 / 15.0;\nvoid main()\n{\n#pragma main\n  v_color = color * opacity;\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n  v_normal = a_xnormal;\n  mediump vec2 dist = u_outline_width * scale * a_offset;\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + u_displayMat3 * vec3(dist + u_fillTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth, 1.0);\n}"},text:{"text.frag":"uniform lowp sampler2D u_texture;\nvarying lowp vec2 v_tex;\nvarying lowp vec4 v_color;\nvarying mediump float v_edgeWidth;\nvarying mediump float v_edgeDistance;\n#ifdef ID\nvarying mediump vec4 v_id;\n#endif\nvoid main()\n{\n  lowp float dist = texture2D(u_texture, v_tex).a;\n  mediump float alpha = smoothstep(v_edgeDistance - v_edgeWidth, v_edgeDistance + v_edgeWidth, dist);\n  gl_FragColor = alpha * v_color;\n#ifdef ID\n  if (gl_FragColor.a < 1.0 / 255.0) {\n    discard;\n  }\n  gl_FragColor = v_id;\n#endif\n}","text.vert":"attribute vec2 a_pos;\nattribute vec2 a_vertexOffset;\nattribute vec4 a_texAngleRange;\nattribute vec4 a_levelInfo;\nattribute float a_opacityInfo;\n#pragma header\nvarying lowp vec4 v_color;\n#ifdef ID\nuniform mediump vec4 u_id;\nvarying mediump vec4 v_id;\n#endif\nuniform highp mat3 u_dvsMat3;\nuniform highp mat3 u_displayMat3;\nuniform highp mat3 u_displayViewMat3;\nuniform mediump vec2 u_textTranslation;\nuniform vec2 u_mosaicSize;\nuniform mediump float u_depth;\nuniform mediump float u_mapRotation;\nuniform mediump float u_level;\nuniform lowp float u_keepUpright;\nuniform mediump float u_fadeDuration;\nvarying lowp vec2 v_tex;\nconst float offsetPrecision = 1.0 / 8.0;\nconst mediump float edgePos = 0.75;\nuniform mediump float u_antialiasingWidth;\nvarying mediump float v_edgeDistance;\nvarying mediump float v_edgeWidth;\nuniform lowp float u_halo;\nconst float sdfFontScale = 1.0 / 24.0;\nconst float sdfPixel = 3.0;\nuniform highp float u_time;\nvoid main()\n{\n#pragma main\n  if (u_halo > 0.5)\n  {\n    v_color = halo_color * opacity;\n    halo_width *= sdfPixel;\n    halo_blur *= sdfPixel;\n  }\n  else\n  {\n    v_color = color * opacity;\n    halo_width = 0.0;\n    halo_blur = 0.0;\n  }\n  float modded = mod(a_opacityInfo, 128.0);\n  float targetOpacity = (a_opacityInfo - modded) / 128.0;\n  float startOpacity = modded / 127.0;\n  float interpolatedOpacity = clamp(startOpacity + 2.0 * (targetOpacity - 0.5) * u_time / u_fadeDuration, 0.0, 1.0);\n  v_color *= interpolatedOpacity;\n  mediump float a_angle       = a_levelInfo[1];\n  mediump float a_minLevel    = a_levelInfo[2];\n  mediump float a_maxLevel    = a_levelInfo[3];\n  mediump vec2 a_tex          = a_texAngleRange.xy;\n  mediump float a_visMinAngle    = a_texAngleRange.z;\n  mediump float a_visMaxAngle    = a_texAngleRange.w;\n  mediump float delta_z = 0.0;\n  mediump float angle = mod(a_angle + u_mapRotation, 256.0);\n  if (a_visMinAngle < a_visMaxAngle)\n  {\n    delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) + (1.0 - step(a_visMinAngle, angle)));\n  }\n  else\n  {\n    delta_z += (1.0 - step(u_keepUpright, 0.0)) * (step(a_visMaxAngle, angle) * (1.0 - step(a_visMinAngle, angle)));\n  }\n  delta_z += 1.0 - step(a_minLevel, u_level);\n  delta_z += step(a_maxLevel, u_level);\n  delta_z += step(v_color[3], 0.0);\n  v_tex = a_tex.xy / u_mosaicSize;\n#ifdef ID\n  v_id = u_id / 255.0;\n#endif\n  v_edgeDistance = edgePos - halo_width / size;\n  v_edgeWidth = (u_antialiasingWidth + halo_blur) / size;\n  mediump vec3 pos = u_dvsMat3 * vec3(a_pos, 1.0) + sdfFontScale * u_displayViewMat3 * vec3(offsetPrecision * size * a_vertexOffset, 0.0) + u_displayMat3 * vec3(u_textTranslation, 0.0);\n  gl_Position = vec4(pos.xy, u_depth + delta_z, 1.0);\n}"},util:{"encoding.glsl":"const vec4 rgba2float_factors = vec4(\n    255.0 / (256.0),\n    255.0 / (256.0 * 256.0),\n    255.0 / (256.0 * 256.0 * 256.0),\n    255.0 / (256.0 * 256.0 * 256.0 * 256.0)\n  );\nfloat rgba2float(vec4 rgba) {\n  return dot(rgba, rgba2float_factors);\n}"}},be=new _e.a((function(e){var t=ye;return e.split("/").forEach((function(e){t&&(t=t[e])})),t}));function we(e){return be.resolveIncludes(e)}var xe=function(e){return Object(ce.b)({ID:e.id,PATTERN:e.pattern})},ke={shaders:function(e){return{vertexShader:xe(e)+we("background/background.vert"),fragmentShader:xe(e)+we("background/background.frag")}}},Oe=function(e){return Object(ce.b)({ID:e.id})},Ce={shaders:function(e){return{vertexShader:Oe(e)+we("circle/circle.vert"),fragmentShader:Oe(e)+we("circle/circle.frag")}}},Te=function(e){return Object(ce.b)({ID:e.id,PATTERN:e.pattern})},Me={shaders:function(e){return{vertexShader:Te(e)+we("fill/fill.vert"),fragmentShader:Te(e)+we("fill/fill.frag")}}},Se=function(e){return Object(ce.b)({ID:e.id})},Re={shaders:function(e){return{vertexShader:Se(e)+we("outline/outline.vert"),fragmentShader:Se(e)+we("outline/outline.frag")}}},Pe=function(e){return Object(ce.b)({ID:e.id,SDF:e.sdf})},Fe={shaders:function(e){return{vertexShader:Pe(e)+we("icon/icon.vert"),fragmentShader:Pe(e)+we("icon/icon.frag")}}},je=function(e){return Object(ce.b)({ID:e.id,PATTERN:e.pattern})},Ie={shaders:function(e){return{vertexShader:je(e)+we("line/line.vert"),fragmentShader:je(e)+we("line/line.frag")}}},De=function(e){return Object(ce.b)({ID:e.id})},ze={shaders:function(e){return{vertexShader:De(e)+we("text/text.vert"),fragmentShader:De(e)+we("text/text.frag")}}},Be=o("vpBa"),Ee={shaders:{vertexShader:Object(Be.a)("bitBlit/bitBlit.vert"),fragmentShader:Object(Be.a)("bitBlit/bitBlit.frag")},attributes:{a_pos:0,a_tex:1}},Ae=function(){function e(){f(this,e),this._initialized=!1}return m(e,[{key:"dispose",value:function(){this._program&&(this._program.dispose(),this._program=null),this._vertexArrayObject&&(this._vertexArrayObject.dispose(),this._vertexArrayObject=null)}},{key:"render",value:function(e,t,i,r){e&&(this._initialized||this._initialize(e),e.setBlendFunctionSeparate(1,771,1,771),e.bindVAO(this._vertexArrayObject),e.bindProgram(this._program),t.setSamplingMode(i),e.bindTexture(t,0),this._program.setUniform1i("u_tex",0),this._program.setUniform1f("u_opacity",r),e.drawArrays(5,0,4),e.bindTexture(null,0),e.bindVAO())}},{key:"_initialize",value:function(e){if(this._initialized)return!0;var t=Ee.attributes,i=Object(ce.a)(e,Ee);if(!i)return!1;var r=new Int8Array(16);r[0]=-1,r[1]=-1,r[2]=0,r[3]=0,r[4]=1,r[5]=-1,r[6]=1,r[7]=0,r[8]=-1,r[9]=1,r[10]=0,r[11]=1,r[12]=1,r[13]=1,r[14]=1,r[15]=1;var n=new le.a(e,t,{geometry:[{name:"a_pos",count:2,type:5120,offset:0,stride:4,normalized:!1,divisor:0},{name:"a_tex",count:2,type:5120,offset:2,stride:4,normalized:!1,divisor:0}]},{geometry:ue.a.createVertex(e,35044,r)});return this._program=i,this._vertexArrayObject=n,this._initialized=!0,!0}}]),e}(),Ve=o("kGdt"),Le=function(e){var t="";t+=e[0].toUpperCase();for(var i=1;i<e.length;i++){var r=e[i];r===r.toUpperCase()?(t+="_",t+=r):t+=r.toUpperCase()}return t},Ue=function(e){var t={};for(var i in e)t[Le(i)]=e[i];return Object(ce.b)(t)},Ne=function(e,t,i){var r=e+e.substring(e.lastIndexOf("/")),n=t+t.substring(t.lastIndexOf("/"));return{attributes:i,shaders:function(e){return{vertexShader:Ue(e)+Object(Be.a)(r+".vert"),fragmentShader:Ue(e)+Object(Be.a)(n+".frag")}}}},qe=function(e){return e===fe.c.HITTEST||e===fe.c.LABEL_ALPHA},He=o("EyXx"),Ge=o("9MzC"),We=o("Lqtk"),Ze=o("c46T"),Ke=o("tUFA"),Ye=o("t7mB"),Xe=o("e4KH"),Qe=o("of9L"),Je=o("qcDN"),$e=function(){function e(t,i){f(this,e),this._width=0,this._height=0,this._free=[],this._width=t,this._height=i,this._free.push(new Je.a(0,0,t,i))}return m(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"allocate",value:function(e,t){if(e>this._width||t>this._height)return new Je.a;for(var i=null,r=-1,n=0;n<this._free.length;++n){var a=this._free[n];e<=a.width&&t<=a.height&&(null===i||a.y<=i.y&&a.x<=i.x)&&(i=a,r=n)}return null===i?new Je.a:(this._free.splice(r,1),i.width<i.height?(i.width>e&&this._free.push(new Je.a(i.x+e,i.y,i.width-e,t)),i.height>t&&this._free.push(new Je.a(i.x,i.y+t,i.width,i.height-t))):(i.width>e&&this._free.push(new Je.a(i.x+e,i.y,i.width-e,i.height)),i.height>t&&this._free.push(new Je.a(i.x,i.y+t,e,i.height-t))),new Je.a(i.x,i.y,e,t))}},{key:"release",value:function(e){for(var t=0;t<this._free.length;++t){var i=this._free[t];if(i.y===e.y&&i.height===e.height&&i.x+i.width===e.x)i.width+=e.width;else if(i.x===e.x&&i.width===e.width&&i.y+i.height===e.y)i.height+=e.height;else if(e.y===i.y&&e.height===i.height&&e.x+e.width===i.x)i.x=e.x,i.width+=e.width;else{if(e.x!==i.x||e.width!==i.width||e.y+e.height!==i.y)continue;i.y=e.y,i.height+=e.height}this._free.splice(t,1),this.release(e)}this._free.push(e)}}]),e}(),et=function(e){return Math.floor(e/256)},tt=o("ATu9"),it=function(){function e(t){for(f(this,e),this._metrics=[],this._bitmaps=[];t.next();)switch(t.tag()){case 1:for(var i=t.getMessage();i.next();)switch(i.tag()){case 3:for(var r=i.getMessage(),n=void 0,a=void 0,s=void 0,o=void 0,u=void 0,l=void 0,h=void 0;r.next();)switch(r.tag()){case 1:n=r.getUInt32();break;case 2:a=r.getBytes();break;case 3:s=r.getUInt32();break;case 4:o=r.getUInt32();break;case 5:u=r.getSInt32();break;case 6:l=r.getSInt32();break;case 7:h=r.getUInt32();break;default:r.skip()}r.release(),n&&(this._metrics[n]={width:s,height:o,left:u,top:l,advance:h},this._bitmaps[n]=a);break;default:i.skip()}i.release();break;default:t.skip()}}return m(e,[{key:"getMetrics",value:function(e){return this._metrics[e]}},{key:"getBitmap",value:function(e){return this._bitmaps[e]}}]),e}(),rt=function(){function e(){f(this,e),this._ranges=[]}return m(e,[{key:"getRange",value:function(e){return this._ranges[e]}},{key:"addRange",value:function(e,t){this._ranges[e]=t}}]),e}(),nt=[1,256,65536,16777216],at=[1/256,1/65536,1/16777216,1/4294967296],st=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=0,r=0;r<4;r++)i+=e[t+r]*at[r];return i}(new Uint8ClampedArray([255,255,255,255]));function ot(e,t){for(var i,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=function(e,t,i){return e<0?0:e>i?i:e}(e,0,st),a=0;a<4;a++)t[r+a]=Math.floor(256*((i=n*nt[a])-Math.floor(i)))}var ut=o("HQFP");function lt(e){return e&&"static"===e.type}for(var ht=function(){function e(t,i,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;f(this,e),this._mosaicPages=[],this._maxItemSize=0,this._currentPage=0,this._pageWidth=0,this._pageHeight=0,this._mosaicRects=new Map,this._spriteCopyQueue=[],this.pixelRatio=1,(i<=0||r<=0)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!"),this._pageWidth=i,this._pageHeight=r,this._requestRender=t,n>0&&(this._maxItemSize=n),this.pixelRatio=window.devicePixelRatio||1,this._binPack=new $e(this._pageWidth,this._pageHeight);var a=Math.floor(this._pageWidth),s=Math.floor(this._pageHeight);this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(a*s)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0})}return m(e,[{key:"getWidth",value:function(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[0]}},{key:"getHeight",value:function(e){return e>=this._mosaicPages.length?-1:this._mosaicPages[e].size[1]}},{key:"getPageTexture",value:function(e){return e<this._mosaicPages.length?this._mosaicPages[e].texture:null}},{key:"has",value:function(e){return this._mosaicRects.has(e)}},{key:"itemCount",get:function(){return this._mosaicRects.size}},{key:"getSpriteItem",value:function(e){return this._mosaicRects.get(e)}},{key:"addSpriteItem",value:function(e,t,i,r,n,a){var s,o,u,l;if(this._mosaicRects.has(e))return this._mosaicRects.get(e);if(lt(i)?(o=(s=g(this._allocateImage(t[0],t[1]),3))[0],u=s[1],l=s[2]):(o=new Je.a(0,0,t[0],t[1]),u=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:i,size:t,dirty:!0,texture:void 0})),o.width<=0||o.height<=0)return null;var h={rect:o,width:t[0],height:t[1],sdf:n,simplePattern:a,pixelRatio:1,page:u};return this._mosaicRects.set(e,h),lt(i)&&this._copy({rect:o,spriteSize:t,spriteData:i.data,page:u,pageSize:l,repeat:r,sdf:n}),h}},{key:"hasItemsToProcess",value:function(){return 0!==this._spriteCopyQueue.length}},{key:"processNextItem",value:function(){var e=this._spriteCopyQueue.pop();e&&this._copy(e)}},{key:"getSpriteItems",value:function(e){var t,i={},r=v(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;i[n]=this.getSpriteItem(n)}}catch(a){r.e(a)}finally{r.f()}return i}},{key:"getMosaicItemPosition",value:function(e){var t=this.getSpriteItem(e),i=t&&t.rect;if(!i)return null;i.width=t.width,i.height=t.height;var r=M.q,n=this._mosaicPages[t.page];return{size:[t.width,t.height],tl:[(i.x+r)/n[0],(i.y+r)/n[1]],br:[(i.x+r+t.width)/n[0],(i.y+r+t.height)/n[1]],page:t.page}}},{key:"bind",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,n=this._mosaicPages[i],a=n.mosaicsData,s=n.texture;if(s||(s=function(e,t,i){return lt(t)?new Qe.a(e,{pixelFormat:6408,dataType:5121,width:i[0],height:i[1]},new Uint8Array(t.data.buffer)):new Qe.a(e,{pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:i[0],height:i[1]},null)}(e,a,n.size),n.texture=s),s.setSamplingMode(t),lt(a))e.bindTexture(s,r),n.dirty&&(s.setData(new Uint8Array(a.data.buffer)),s.generateMipmap());else{var o=a.data,u=o.bindFrame(e,s,r);Object(T.k)(this._requestRender)&&u&&o.frameCount>0&&this._requestRender.requestRender(),o.bindFrame(e,s,r)}n.dirty=!1}},{key:"_copy",value:function(t){if(!(t.page>=this._mosaicPages.length)){var i=this._mosaicPages[t.page],r=i.mosaicsData;if(!lt(i.mosaicsData))throw new w.a("mapview-invalid-resource","unsuitable data type!");var n=t.spriteData,a=r.data;a&&n||console.error("Source or target images are uninitialized!"),e._copyBits(n,t.spriteSize[0],0,0,a,t.pageSize[0],t.rect.x+M.q,t.rect.y+M.q,t.spriteSize[0],t.spriteSize[1],t.repeat),i.dirty=!0}}},{key:"_allocateImage",value:function(e,t){e+=2*M.q,t+=2*M.q;var i=Math.max(e,t);if(this._maxItemSize&&this._maxItemSize<i){var r=Math.pow(2,Math.ceil(Object(ut.c)(e))),n=Math.pow(2,Math.ceil(Object(ut.c)(t))),a=new Je.a(0,0,e,t);return this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(r*n)},size:[r,n],dirty:!0,texture:void 0}),[a,this._mosaicPages.length-1,[r,n]]}var s=this._binPack.allocate(e,t);if(s.width<=0){var o=this._mosaicPages[this._currentPage];return!o.dirty&&lt(o.mosaicsData)&&(o.mosaicsData.data=null),this._currentPage=this._mosaicPages.length,this._mosaicPages.push({mosaicsData:{type:"static",data:new Uint32Array(this._pageWidth*this._pageHeight)},size:[this._pageWidth,this._pageHeight],dirty:!0,texture:void 0}),this._binPack=new $e(this._pageWidth,this._pageHeight),this._allocateImage(e,t)}return[s,this._currentPage,[this._pageWidth,this._pageHeight]]}},{key:"dispose",value:function(){this._binPack=null;var e,t=v(this._mosaicPages);try{for(t.s();!(e=t.n()).done;){var i=e.value,r=i.texture;r&&r.dispose();var n=i.mosaicsData;lt(n)||n.data.pause()}}catch(a){t.e(a)}finally{t.f()}this._mosaicPages=null,this._mosaicRects.clear()}}],[{key:"_copyBits",value:function(e,t,i,r,n,a,s,o,u,l,h){var c=r*t+i,d=o*a+s;if(h){d-=a;for(var f=-1;f<=l;c=((++f+l)%l+r)*t+i,d+=a)for(var p=-1;p<=u;p++)n[d+p]=e[c+(p+u)%u]}else for(var m=0;m<l;m++){for(var v=0;v<u;v++)n[d+v]=e[c+v];c+=t,d+=a}}}]),e}(),ct=new Uint32Array(256),dt=0;dt<256;dt++){for(var ft=dt,pt=0;pt<8;pt++)ft=0!=(1&ft)?3988292384^ft>>>1:ft>>>1;ct[dt]=ft}var mt=new w.a("Not a PNG"),vt=new w.a("Not an animated PNG"),gt=new Uint8Array([137,80,78,71,13,10,26,10]);function _t(e){var t=e.constructor===Uint8Array?e:new Uint8Array(e);return!gt.some((function(e,i){return e!==t[i]}))}var yt=function(){function e(){f(this,e),this.width=0,this.height=0,this.numPlays=0,this.playTime=0,this.frames=[],this.paused=!1,this.playing=!1,this.playSpeed=1,this.currentFrameNumber=0,this._lastUsedFrame=-1}var t,i;return m(e,[{key:"play",value:function(){this.playing||(this.paused=!1,this.playing=!0,this._play())}},{key:"pause",value:function(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}},{key:"togglePlay",value:function(){this.paused||!this.playing?this.play():this.pause()}},{key:"bindFrame",value:function(e,t,i){e.bindTexture(t,i);var r=this.frameChanged();if(!r)return!1;var n=this.currentFrame,a=n.frameData,s=t.descriptor;return(n.left||n.top||n.width!==s.width||n.height!==s.height)&&t.setData(null),t.updateData(0,n.left,n.top,n.width,n.height,a),this.updateUsedFrame(),r}},{key:"frameChanged",value:function(){return this._lastUsedFrame!==this.currentFrameNumber}},{key:"updateUsedFrame",value:function(){this._lastUsedFrame=this.currentFrameNumber}},{key:"_load",value:(i=a(regeneratorRuntime.mark((function e(t,i){var r,n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(r=function(e,t){var i=new Uint8Array(t);if(gt.some((function(e,t){return e!==i[t]})))return mt;var r=!1;if(wt(i,(function(e){return!(r="acTL"===e)})),!r)return vt;var n=[],a=[],s=null,o=null,u=0;if(wt(i,(function(t,i,r,l){var h=new DataView(i.buffer);switch(t){case"IHDR":s=i.subarray(r+8,r+8+l),e.width=h.getUint32(r+8),e.height=h.getUint32(r+12);break;case"acTL":e.numPlays=h.getUint32(r+8+4);break;case"fcTL":o&&(e.frames.push(o),u++),(o=new bt).width=h.getUint32(r+8+4),o.height=h.getUint32(r+8+8),o.left=h.getUint32(r+8+12),o.top=h.getUint32(r+8+16);var c=h.getUint16(r+8+20),d=h.getUint16(r+8+22);0===d&&(d=100),o.delay=1e3*c/d,o.delay<=10&&(o.delay=100),e.playTime+=o.delay,o.disposeOp=h.getUint8(r+8+24),o.blendOp=h.getUint8(r+8+25),o.dataParts=[],0===u&&2===o.disposeOp&&(o.disposeOp=1);break;case"fdAT":o&&o.dataParts.push(i.subarray(r+8+4,r+8+l));break;case"IDAT":o&&o.dataParts.push(i.subarray(r+8,r+8+l));break;case"IEND":a.push(kt(i,r,12+l));break;default:n.push(kt(i,r,12+l))}})),0===e.frames.length)return vt;e.frameCount=e.frames.length;var l=new Blob(n),h=new Blob(a);return e.frames.forEach((function(e){var t=[];t.push(gt),s.set(Ct(e.width),0),s.set(Ct(e.height),4),t.push(Ot("IHDR",s)),t.push(l),e.dataParts.forEach((function(e){return t.push(Ot("IDAT",e))})),t.push(h),e.data=new Blob(t,{type:"image/png"}),delete e.dataParts,t=null})),e}(this,t))===this){e.next=4;break}return e.abrupt("return",r);case 4:return this._resizeCanvas=document.createElement("canvas"),this._resizeCanvas.width=this.width,this._resizeCanvas.height=this.height,e.next=9,Promise.all(this.frames.map((function(e){return e.createImage(n._resizeCanvas)})));case 9:e.next=15;break;case 11:if(e.prev=11,e.t0=e.catch(0),Object(Ge.m)(e.t0)){e.next=15;break}return e.abrupt("return",new w.a("invalid-resource","Could not parse PNG"));case 15:this.play();case 16:case"end":return e.stop()}}),e,this,[[0,11]])}))),function(e,t){return i.apply(this,arguments)})},{key:"_play",value:function(){var e,t,i=this;if(0!==this.playSpeed){this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,(t-=1)<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed);var r=this.frames[this.currentFrameNumber];this.currentFrame={frameData:r.imageData,top:r.top,left:r.left,width:r.width,height:r.height},this.timerID=window.setTimeout((function(){return i._play()}),e)}else this.pause()}}],[{key:"create",value:(t=a(regeneratorRuntime.mark((function t(i,r){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=new e,t.prev=1,t.next=4,n._load(i,r);case 4:t.next=10;break;case 6:if(t.prev=6,t.t0=t.catch(1),Object(Ge.m)(t.t0)){t.next=10;break}return t.abrupt("return",new w.a("invalid-resource","Could not load PNG: "+t.t0.message));case 10:return t.abrupt("return",n);case 11:case"end":return t.stop()}}),t,null,[[1,6]])}))),function(e,i){return t.apply(this,arguments)})}]),e}(),bt=function(){function e(){f(this,e),this.left=0,this.top=0,this.width=0,this.height=0,this.delay=0,this.disposeOp=0,this.blendOp=0,this.data=null,this.imageData=null}var t;return m(e,[{key:"createImage",value:(t=a(regeneratorRuntime.mark((function e(t){var i=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==this.imageData){e.next=2;break}return e.abrupt("return",new Promise((function(e,r){var n=URL.createObjectURL(i.data),a=document.createElement("img");a.onload=function(){URL.revokeObjectURL(n),i.imageData=function(e,t){t.width=e.width,t.height=e.height;var i=t.getContext("2d");i.drawImage(e,0,0,e.width,e.height);for(var r,n=i.getImageData(0,0,e.width,e.height),a=new Uint8Array(n.data),s=0;s<a.length;s+=4)r=a[s+3]/255,a[s]=a[s]*r,a[s+1]=a[s+1]*r,a[s+2]=a[s+2]*r;return new ImageData(new Uint8ClampedArray(a.buffer),e.width,e.height)}(a,t),e()},a.onerror=function(){URL.revokeObjectURL(n),i.imageData=null,r(new Error("Image creation error"))},a.src=n})));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}();function wt(e,t){var i,r,n,a=new DataView(e.buffer),s=8;do{r=a.getUint32(s),n=t(i=xt(e,s+4,4),e,s,r),s+=12+r}while(!1!==n&&"IEND"!==i&&s<e.length)}function xt(e,t,i){var r=Array.prototype.slice.call(e.subarray(t,t+i));return String.fromCharCode.apply(String,r)}function kt(e,t,i){var r=new Uint8Array(i);return r.set(e.subarray(t,t+i)),r}function Ot(e,t){var i=e.length+t.length,r=new Uint8Array(i+8),n=new DataView(r.buffer);n.setUint32(0,t.length),r.set(function(e){for(var t=new Uint8Array(e.length),i=0;i<e.length;i++)t[i]=e.charCodeAt(i);return t}(e),4),r.set(t,8);var a=function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:e.length-t,r=-1,n=t,a=t+i;n<a;n++)r=r>>>8^ct[255&(r^e[n])];return-1^r}(r,4,i);return n.setUint32(i+4,a),r}function Ct(e){return new Uint8Array([e>>>24&255,e>>>16&255,e>>>8&255,255&e])}var Tt=yt;function Mt(e){if(!e||0===e.byteLength)return!1;var t=e.constructor===Uint8Array?e:new Uint8Array(e);return 71===t[0]&&73===t[1]&&70===t[2]&&56===t[3]}var St=function(){function e(){f(this,e),this.paused=!1,this.playing=!1,this.waitTillDone=!0,this.loading=!1,this.firstFrameOnly=!1,this.frames=[],this.comment="",this.length=0,this.currentFrameNumber=0,this.frameCount=0,this.playSpeed=1,this.lastFrame=null,this.playOnLoad=!0,this.complete=!1,this.interlaceOffsets=[0,4,2,1],this.interlaceSteps=[8,8,4,2],this._lastUsedFrame=-1}var t,i,r;return m(e,[{key:"play",value:function(){this.playing||(this.paused=!1,this.playing=!0,this._play())}},{key:"pause",value:function(){this.paused=!0,this.playing=!1,clearTimeout(this.timerID)}},{key:"togglePlay",value:function(){this.paused||!this.playing?this.play():this.pause()}},{key:"bindFrame",value:function(e,t,i){e.bindTexture(t,i);var r=this.frameChanged();if(r){var n=this.currentFrame;t.updateData(0,0,0,n.width,n.height,n.frameData),this.updateUsedFrame()}return r}},{key:"seekFrame",value:function(e){clearTimeout(this.timerID),this.currentFrameNumber=e%this.frames.length,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}},{key:"seek",value:function(e){clearTimeout(this.timerID),e<0&&(e=0),e*=1e3,e%=this.length;for(var t=0;e>this.frames[t].time+this.frames[t].delay&&t<this.frames.length;)t+=1;this.currentFrameNumber=t,this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)}},{key:"frameChanged",value:function(){return this._lastUsedFrame!==this.currentFrameNumber}},{key:"updateUsedFrame",value:function(){this._lastUsedFrame=this.currentFrameNumber}},{key:"_load",value:(r=a(regeneratorRuntime.mark((function e(t,i){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,this.loading=!0,e.next=4,this._parse(t,i);case 4:this.loading=!1,this.play(),e.next=12;break;case 8:if(e.prev=8,e.t0=e.catch(0),Object(Ge.m)(e.t0)){e.next=12;break}return e.abrupt("return",new w.a("invalid-resource","Could not parse gif!"));case 12:case"end":return e.stop()}}),e,this,[[0,8]])}))),function(e,t){return r.apply(this,arguments)})},{key:"_parse",value:function(e,t){var i=this,r=new Rt(e);r.pos+=6,this.width=r.data[r.pos++]+(r.data[r.pos++]<<8),this.height=r.data[r.pos++]+(r.data[r.pos++]<<8);var n=r.data[r.pos++];return this.globalColourCount=1<<1+(7&n),r.pos++,r.pos++,128&n&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,r)),new Promise((function(e,n){setTimeout((function(){return i._parseBlock(r,e,n,t)}),0)}))}},{key:"_parseBlock",value:(i=a(regeneratorRuntime.mark((function e(t,i,r,n){var a,s=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(n&&n.signal&&Object(Ge.n)(n.signal))){e.next=2;break}return e.abrupt("return",void r(Object(Ge.e)()));case 2:if(44!==(a=t.data[t.pos++])){e.next=8;break}if(this._parseImg(t),!this.firstFrameOnly){e.next=6;break}return e.abrupt("return",(this._finishedLoading(),void i()));case 6:e.next=11;break;case 8:if(59!==a){e.next=10;break}return e.abrupt("return",(this._finishedLoading(),void i()));case 10:this._parseExt(t);case 11:"function"==typeof this.onprogress&&this.onprogress({bytesRead:t.pos,totalBytes:t.data.length,frame:this.frames.length}),setTimeout((function(){return s._parseBlock(t,i,r,n)}),0);case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return i.apply(this,arguments)})},{key:"_parseColourTable",value:function(e,t){for(var i=[],r=0;r<e;r++)i.push([t.data[t.pos++],t.data[t.pos++],t.data[t.pos++]]);return i}},{key:"_parseImg",value:function(e){var t=this,i={};this.frames.push(i),i.disposalMethod=this.disposalMethod,i.time=this.length,i.delay=10*this.delayTime,this.length+=i.delay,i.transparencyIndex=this.transparencyGiven?this.transparencyIndex:void 0,i.leftPos=e.data[e.pos++]+(e.data[e.pos++]<<8),i.topPos=e.data[e.pos++]+(e.data[e.pos++]<<8),i.width=e.data[e.pos++]+(e.data[e.pos++]<<8),i.height=e.data[e.pos++]+(e.data[e.pos++]<<8);var r=e.data[e.pos++];i.localColourTableFlag=!!(128&r),i.localColourTableFlag&&(i.localColourTable=this._parseColourTable(1<<1+(7&r),e)),this.pixelBufSize!==i.width*i.height&&(this.pixelBuf=new Uint8Array(i.width*i.height),this.pixelBufSize=i.width*i.height),this._lzwDecode(e.data[e.pos++],e.readSubBlocksB()),64&r?(i.interlaced=!0,function(e){var i=t.pixelBufSize/e;t.interlacedBufSize!==t.pixelBufSize&&(t.deinterlaceBuf=new Uint8Array(t.pixelBufSize),t.interlacedBufSize=t.pixelBufSize);for(var r=0,n=0;n<4;n++)for(var a=t.interlaceOffsets[n];a<i;a+=t.interlaceSteps[n])t.deinterlaceBuf.set(t.pixelBuf.subarray(r,r+e),a*e),r+=e}(i.width)):i.interlaced=!1,this._processFrame(i)}},{key:"_lzwDecode",value:function(e,t){var i,r,n,a,s,o,u,l,h;n=r=0;var c=[],d=1<<e,f=d+1;for(a=e+1,h=!1;!h;){for(o=s,s=0,i=0;i<a;i++)t[n>>3]&1<<(7&n)&&(s|=1<<i),n++;if(s===d){for(c=[],a=e+1,i=0;i<d;i++)c[i]=[i];c[d]=[],c[f]=null}else{if(s===f)return void(h=!0);for(s>=c.length?c.push(c[o].concat(c[o][0])):o!==d&&c.push(c[o].concat(c[s][0])),l=(u=c[s]).length,i=0;i<l;i++)this.pixelBuf[r++]=u[i];c.length===1<<a&&a<12&&a++}}}},{key:"_processFrame",value:function(e){e.image=document.createElement("canvas"),e.image.width=this.width,e.image.height=this.height,e.ctx=e.image.getContext("2d");var t=e.localColourTableFlag?e.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=e);var i=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod;i||e.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);for(var r,n,a=e.ctx.getImageData(e.leftPos,e.topPos,e.width,e.height),s=e.transparencyIndex,o=a.data,u=e.interlaced?this.deinterlaceBuf:this.pixelBuf,l=u.length,h=0,c=0;c<l;c++)n=t[r=u[c]],s!==r?(o[h++]=n[0],o[h++]=n[1],o[h++]=n[2],o[h++]=255):i?(o[h+3]=0,h+=4):h+=4;e.ctx.putImageData(a,e.leftPos,e.topPos),this.lastFrame=e}},{key:"_parseExt",value:function(e){var t=e.data[e.pos++];249===t?this._parseGCExt(e):254===t?this.comment+=e.readSubBlocks():255===t?this._parseAppExt(e):(1===t&&(e.pos+=13),e.readSubBlocks())}},{key:"_parseAppExt",value:function(e){e.pos+=1,"NETSCAPE"===e.getString(8)?e.pos+=8:(e.pos+=3,e.readSubBlocks())}},{key:"_parseGCExt",value:function(e){e.pos++;var t=e.data[e.pos++];this.disposalMethod=(28&t)>>2,this.transparencyGiven=!!(1&t),this.delayTime=e.data[e.pos++]+(e.data[e.pos++]<<8),this.transparencyIndex=e.data[e.pos++],e.pos++}},{key:"_finishedLoading",value:function(){this.loading=!1,this.frameCount=this.frames.length,this.lastFrame=null,this.complete=!0,this.disposalMethod=void 0,this.transparencyGiven=void 0,this.delayTime=void 0,this.transparencyIndex=void 0,this.waitTillDone=void 0,this.pixelBuf=void 0,this.deinterlaceBuf=void 0,this.pixelBufSize=void 0,this.deinterlaceBuf=void 0,this.currentFrameNumber=0,this.frames.length>0&&this._setCurrentFrame(0),this.playOnLoad&&this.play()}},{key:"_play",value:function(){var e,t,i=this;0!==this.playSpeed?(this.playSpeed<0?(this.currentFrameNumber-=1,this.currentFrameNumber<0&&(this.currentFrameNumber=this.frames.length-1),t=this.currentFrameNumber,(t-=1)<0&&(t=this.frames.length-1),e=1*-this.frames[t].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,e=1*this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout((function(){return i._play()}),e)):this.pause()}},{key:"_setCurrentFrame",value:function(e){this.currentFrame={frameData:this.frames[e].image,top:0,left:0,width:this.width,height:this.height}}}],[{key:"create",value:(t=a(regeneratorRuntime.mark((function t(i,r){var n;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=new e,t.prev=1,t.next=4,n._load(i,r);case 4:t.next=10;break;case 6:if(t.prev=6,t.t0=t.catch(1),Object(Ge.m)(t.t0)){t.next=10;break}return t.abrupt("return",new w.a("invalid-resource","Could not load PNG: "+t.t0.message));case 10:return t.abrupt("return",n);case 11:case"end":return t.stop()}}),t,null,[[1,6]])}))),function(e,i){return t.apply(this,arguments)})}]),e}(),Rt=function(){function e(t){f(this,e),this.pos=0,this.data=new Uint8ClampedArray(t),this.len=this.data.length}return m(e,[{key:"getString",value:function(e){for(var t="";e--;)t+=String.fromCharCode(this.data[this.pos++]);return t}},{key:"readSubBlocks",value:function(){var e,t,i="";do{for(t=e=this.data[this.pos++];t--;)i+=String.fromCharCode(this.data[this.pos++])}while(0!==e&&this.pos<this.len);return i}},{key:"readSubBlocksB",value:function(){var e,t,i=[];do{for(t=e=this.data[this.pos++];t--;)i.push(this.data[this.pos++])}while(0!==e&&this.pos<this.len);return i}}]),e}(),Pt=St,Ft=o("GqaZ"),jt=Object(Ze.a)(),It=_.a.getLogger("esri.views.2d.engine.webgl.TextureManager"),Dt=function(e){return"esriSMS"===e.type&&e.path};function zt(e){switch(e.type){case"esriSMS":case"esriPMS":case"CIMPointSymbol":case"CIMVectorMarker":case"CIMPictureMarker":case"CIMCharacterMarker":return!1;default:return!0}}function Bt(e,t){var i=Math.round(Object(P.h)(t)*window.devicePixelRatio);return Math.min(e,i*(i>=128?2:4))}var Et=function(e,t,i){return It.error(new w.a(e,t,i))},At=function(){function e(t,i,r){f(this,e),this.mosaicType=t,this.page=i,this.sdf=r}return m(e,null,[{key:"fromMosaic",value:function(t,i){return new e(t,i.page,i.sdf)}}]),e}(),Vt=o("gjrC"),Lt=function e(){f(this,e),this.name=this.constructor.name},Ut=function(e){s(i,e);var t=u(i);function i(){var e;return f(this,i),(e=t.apply(this,arguments)).defines=[],e._desc={vsPath:"fx/integrate",fsPath:"fx/integrate",attributes:{a_position:0}},e}return m(i,[{key:"dispose",value:function(){this._quad&&this._quad.dispose()}},{key:"bind",value:function(){}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){if(t.size){var i=e.context,r=e.renderingOptions;this._quad||(this._quad=new Vt.a(i,[0,0,1,0,0,1,1,1]));var n=i.getBoundFramebufferObject(),a=i.getViewport(),s=a.x,o=a.y,u=a.width,l=a.height;t.bindTextures(i);var h=t.getBlock(M.a);if(!Object(T.j)(h)){var c=h.getFBO(i),d=h.getFBO(i,1);i.setViewport(0,0,t.size,t.size),this._computeDelta(e,d,r.labelsAnimationTime),this._updateAnimationState(e,d,c),i.bindFramebuffer(n),i.setViewport(s,o,u,l)}}}},{key:"_computeDelta",value:function(e,t,i){var r=e.context,n=e.painter,a=e.displayLevel,s=n.materialManager.getProgram(e,this._desc,["delta"]);r.bindFramebuffer(t),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),r.bindProgram(s),s.setUniform1i("u_maskTexture",M.r),s.setUniform1i("u_sourceTexture",M.s),s.setUniform1f("u_timeDelta",e.deltaTime),s.setUniform1f("u_animationTime",i),s.setUniform1f("u_zoomLevel",Math.round(10*a)),this._quad.draw()}},{key:"_updateAnimationState",value:function(e,t,i){var r=e.context,n=e.painter.materialManager.getProgram(e,this._desc,["update"]);r.bindTexture(t.colorTexture,1),r.bindProgram(n),n.setUniform1i("u_sourceTexture",1),r.bindFramebuffer(i),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT),this._quad.draw()}}]),i}(Lt),Nt=function(e){return"#define ".concat(function(e){return e.replace("-","_").toUpperCase()}(e),"\n")},qt={attributes:{a_pos:0,a_tex:1},shaders:function(e){return{vertexShader:Nt(e)+Object(Be.a)("blend/blend.vert"),fragmentShader:Nt(e)+Object(Be.a)("blend/blend.frag")}}},Ht=_.a.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect"),Gt=function(){function e(){f(this,e),this._size=[0,0]}return m(e,[{key:"dispose",value:function(e){this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=null),this._programCache&&(this._programCache.dispose(),this._programCache=null),this._quad&&(this._quad.dispose(),this._quad=null)}},{key:"draw",value:function(e,t,i,r,n){var a=e.context,s=e.drawPhase;if(this._setupShader(a),r&&"normal"!==r&&s!==fe.c.LABEL)this._drawBlended(e,t,i,r,n);else{var o=this._programCache.getProgram(qt,"normal");if(o){a.bindProgram(o),t.setSamplingMode(i),a.bindTexture(t,0),o.setUniform1i("u_layerTexture",0),o.setUniform1f("u_opacity",n),a.setBlendingEnabled(!0),a.setBlendFunction(1,771);var u=this._quad;u.draw(),u.unbind()}else Ht.error(new w.a("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'))}}},{key:"_drawBlended",value:function(e,t,i,r,n){var a,s,o=e.context,u=e.state,l=e.pixelRatio,h=e.inFadeTransition,c=u.size,d=o.getBoundFramebufferObject();if(Object(T.k)(d)){var f=d.descriptor;a=f.width,s=f.height}else a=Math.round(l*c[0]),s=Math.round(l*c[1]);this._createOrResizeTexture(e,a,s);var p=this._backBufferTexture;d.copyToTexture(0,0,a,s,0,0,p),o.setStencilTestEnabled(!1),o.setStencilWriteMask(0),o.setBlendingEnabled(!0),o.setDepthTestEnabled(!1),o.setDepthWriteEnabled(!1);var m=this._programCache.getProgram(qt,r);if(m){o.bindProgram(m),p.setSamplingMode(i),o.bindTexture(p,0),m.setUniform1i("u_backbufferTexture",0),t.setSamplingMode(i),o.bindTexture(t,1),m.setUniform1i("u_layerTexture",1),m.setUniform1f("u_opacity",n),m.setUniform1f("u_inFadeOpacity",h?1:0),o.setBlendFunction(1,0);var v=this._quad;v.draw(),v.unbind(),o.setBlendFunction(1,771)}else Ht.error(new w.a("mapview-BlendEffect","Error creating shader program for blend mode "+r))}},{key:"_setupShader",value:function(e){this._programCache||(this._programCache=new Ve.a(e),this._quad||(this._quad=new Vt.a(e,[-1,-1,1,-1,-1,1,1,1])))}},{key:"_createOrResizeTexture",value:function(e,t,i){var r=e.context;null!==this._backBufferTexture&&t===this._size[0]&&i===this._size[1]||(this._backBufferTexture?this._backBufferTexture.resize(t,i):this._backBufferTexture=new Qe.a(r,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:t,height:i}),this._size[0]=t,this._size[1]=i)}}]),e}(),Wt=function(e){s(i,e);var t=u(i);function i(e){var r;return f(this,i),(r=t.call(this)).name=r.constructor.name,r.defines=[e],r}return m(i,[{key:"dispose",value:function(){}},{key:"bind",value:function(e){var t=e.context,i=e.painter;this._prev=t.getBoundFramebufferObject();var r=t.getViewport(),n=r.width,a=r.height,s=i.getFbos(n,a).effect0;t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){var i=e.context,r=e.painter,n=e.state,a=e.deltaTime,s=r.getPostProcessingEffects(t.effects),o=i.getBoundFramebufferObject();s.length&&t.transitionStep(a,n.scale);var u,l=v(s);try{for(l.s();!(u=l.n()).done;){var h=u.value,c=h.postProcessingEffect,d=h.effect;c.draw(e,o,d)}}catch(f){l.e(f)}finally{l.f()}i.bindFramebuffer(this._prev),i.setStencilTestEnabled(!1),r.blitTexture(i,o.colorTexture,9728),i.setStencilTestEnabled(!0)}}]),i}(Lt),Zt=[void 0,void 0,void 0,1],Kt=[0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1],Yt=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Xt=_.a.getLogger("esri.views.2d.engine.webgl.painter.highlight.HighlightGradient"),Qt=[0,0,0,0],Jt={shaders:{vertexShader:Object(Be.a)("highlight/textured.vert"),fragmentShader:Object(Be.a)("highlight/highlight.frag")},attributes:{a_position:0,a_texcoord:1}},$t={shaders:{vertexShader:Object(Be.a)("highlight/textured.vert"),fragmentShader:Object(Be.a)("highlight/blur.frag")},attributes:{a_position:0,a_texcoord:1}};function ei(e,t,i){var r=new Qe.a(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:t,height:i,samplingMode:9729});return[r,new he.a(e,{colorTarget:0,depthStencilTarget:2},r)]}var ti=function(e){s(i,e);var t=u(i);function i(){var e;return f(this,i),(e=t.apply(this,arguments)).defines=["highlight"],e._hlRenderer=new(function(){function e(){f(this,e),this._width=void 0,this._height=void 0,this._resources=null}return m(e,[{key:"dispose",value:function(){this._resources&&(this._resources.quadGeometry.dispose(),this._resources.quadVAO.dispose(),this._resources.highlightProgram.dispose(),this._resources.blurProgram.dispose(),this._resources=null)}},{key:"preBlur",value:function(e,t){e.bindTexture(t,M.x),e.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[1,0,1/this._width,0]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Kt),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}},{key:"finalBlur",value:function(e,t){e.bindTexture(t,M.x),e.bindProgram(this._resources.blurProgram),this._resources.blurProgram.setUniform4fv("u_direction",[0,1,0,1/this._height]),this._resources.blurProgram.setUniformMatrix4fv("u_channelSelector",Yt),e.bindVAO(this._resources.quadVAO),e.drawArrays(5,0,4),e.bindVAO()}},{key:"renderHighlight",value:function(e,t,i){e.bindTexture(t,M.x),e.bindProgram(this._resources.highlightProgram),i.applyHighlightOptions(e,this._resources.highlightProgram),e.bindVAO(this._resources.quadVAO),e.setBlendingEnabled(!0),e.setBlendFunction(1,771),e.drawArrays(5,0,4),e.bindVAO()}},{key:"_initialize",value:function(e,t,i){this._width=t,this._height=i;var r=ue.a.createVertex(e,35044,new Int8Array([-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1]).buffer),n=new le.a(e,{a_position:0,a_texcoord:1},{geometry:[{name:"a_position",count:2,type:5120,offset:0,stride:4,normalized:!1},{name:"a_texcoord",count:2,type:5121,offset:2,stride:4,normalized:!1}]},{geometry:r}),a=Object(ce.a)(e,Jt),s=Object(ce.a)(e,$t);a.setUniform1i("u_texture",M.x),a.setUniform1i("u_shade",M.y),a.setUniform4fv("u_sigmas",Zt),s.setUniform1i("u_texture",M.x),s.setUniform4fv("u_sigmas",Zt),this._resources={quadGeometry:r,quadVAO:n,highlightProgram:a,blurProgram:s}}},{key:"setup",value:function(e,t,i){this._resources?(this._width=t,this._height=i):this._initialize(e,t,i)}}]),e}()),e._hlGradient=new(function(){function e(){f(this,e),this._convertedHighlightOptions={fillColor:[.2*.75,.6*.75,.675,.75],outlineColor:[.2*.9,.54,.81,.9],outlinePosition:0,outlineWidth:.7,innerHaloWidth:.7,outerHaloWidth:.7},this.shadeTexChanged=!0,this.texelData=new Uint8Array(1024),this.minMaxDistance=[0,0]}return m(e,[{key:"setHighlightOptions",value:function(e){var t=this._convertedHighlightOptions;!function(e,t){t.fillColor[0]=e.color.r/255,t.fillColor[1]=e.color.g/255,t.fillColor[2]=e.color.b/255,t.fillColor[3]=e.color.a,e.haloColor?(t.outlineColor[0]=e.haloColor.r/255,t.outlineColor[1]=e.haloColor.g/255,t.outlineColor[2]=e.haloColor.b/255,t.outlineColor[3]=e.haloColor.a):(t.outlineColor[0]=t.fillColor[0],t.outlineColor[1]=t.fillColor[1],t.outlineColor[2]=t.fillColor[2],t.outlineColor[3]=t.fillColor[3]),t.fillColor[3]*=e.fillOpacity,t.outlineColor[3]*=e.haloOpacity,t.fillColor[0]*=t.fillColor[3],t.fillColor[1]*=t.fillColor[3],t.fillColor[2]*=t.fillColor[3],t.outlineColor[0]*=t.outlineColor[3],t.outlineColor[1]*=t.outlineColor[3],t.outlineColor[2]*=t.outlineColor[3],t.outlineWidth=.7,t.outerHaloWidth=.7,t.innerHaloWidth=.7,t.outlinePosition=0}(e,t);var i,r=t.outlinePosition-t.outlineWidth/2-t.outerHaloWidth,n=t.outlinePosition-t.outlineWidth/2,a=t.outlinePosition+t.outlineWidth/2,s=t.outlinePosition+t.outlineWidth/2+t.innerHaloWidth,o=Math.sqrt(Math.PI/2)*Zt[3],u=Math.abs(r)>o?Math.round(10*(Math.abs(r)-o))/10:0,l=Math.abs(s)>o?Math.round(10*(Math.abs(s)-o))/10:0;u&&!l?Xt.error("The outer rim of the highlight is "+u+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards positive values (inwards)."):!u&&l?Xt.error("The inner rim of the highlight is "+l+"px away from the edge of the feature; consider reducing some width values or shifting the outline position towards negative values (outwards)."):u&&l&&Xt.error("The highlight is "+Math.max(u,l)+"px away from the edge of the feature; consider reducing some width values.");var h=[void 0,void 0,void 0,void 0];function c(e,t,i){h[0]=(1-i)*e[0]+i*t[0],h[1]=(1-i)*e[1]+i*t[1],h[2]=(1-i)*e[2]+i*t[2],h[3]=(1-i)*e[3]+i*t[3]}for(var d=this.texelData,f=0;f<256;++f){var p,m;(i=r+f/255*(s-r))<r?(h[4*f+0]=0,h[4*f+1]=0,h[4*f+2]=0,h[4*f+3]=0):i<n?c(Qt,t.outlineColor,(i-r)/(n-r)):i<a?(p=g(t.outlineColor,4),h[0]=p[0],h[1]=p[1],h[2]=p[2],h[3]=p[3]):i<s?c(t.outlineColor,t.fillColor,(i-a)/(s-a)):(m=g(t.fillColor,4),h[4*f+0]=m[0],h[4*f+1]=m[1],h[4*f+2]=m[2],h[4*f+3]=m[3]),d[4*f+0]=255*h[0],d[4*f+1]=255*h[1],d[4*f+2]=255*h[2],d[4*f+3]=255*h[3]}this.minMaxDistance[0]=r,this.minMaxDistance[1]=s,this.shadeTexChanged=!0}},{key:"applyHighlightOptions",value:function(e,t){this.shadeTex||(this.shadeTex=new Qe.a(e,{target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,width:256,height:1,samplingMode:9729})),this.shadeTexChanged&&(this.shadeTex.updateData(0,0,0,256,1,this.texelData),this.shadeTexChanged=!1),e.bindTexture(this.shadeTex,M.y),t.setUniform2fv("u_minMaxDistance",this.minMaxDistance)}},{key:"destroy",value:function(){this.shadeTex&&(this.shadeTex.dispose(),this.shadeTex=null)}}]),e}()),e._width=void 0,e._height=void 0,e._hlSurfaces=new(function(){function e(){f(this,e),this._width=void 0,this._height=void 0,this._resources=null}return m(e,[{key:"dispose",value:function(){this._resources&&(this._resources.sharedBlur1Tex.dispose(),this._resources.sharedBlur1Fbo.dispose(),this._resources.sharedBlur2Tex.dispose(),this._resources.sharedBlur2Fbo.dispose(),this._resources=null)}},{key:"_initialize",value:function(e,t,i){this._width=t,this._height=i;var r=g(ei(e,t,i),2),n=r[0],a=r[1],s=g(ei(e,t,i),2),o=s[0],u=s[1];this._resources={sharedBlur1Tex:n,sharedBlur1Fbo:a,sharedBlur2Tex:o,sharedBlur2Fbo:u}}},{key:"setup",value:function(e,t,i){!this._resources||this._width===t&&this._height===i||this.dispose(),this._resources||this._initialize(e,t,i)}},{key:"sharedBlur1Tex",get:function(){return this._resources.sharedBlur1Tex}},{key:"sharedBlur1Fbo",get:function(){return this._resources.sharedBlur1Fbo}},{key:"sharedBlur2Tex",get:function(){return this._resources.sharedBlur2Tex}},{key:"sharedBlur2Fbo",get:function(){return this._resources.sharedBlur2Fbo}}]),e}()),e._adjustedWidth=void 0,e._adjustedHeight=void 0,e._blitRenderer=new Ae,e}return m(i,[{key:"dispose",value:function(){this._hlSurfaces&&this._hlSurfaces.dispose(),this._hlRenderer&&this._hlRenderer.dispose(),this._hlGradient&&this._hlGradient.destroy(),this._boundFBO=null}},{key:"bind",value:function(e){var t=e.context,i=e.painter,r=t.getViewport(),n=r.width,a=r.height,s=i.getFbos(n,a).effect0;this.setup(e,n,a),t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"setup",value:function(e,t,i){var r=e.context;this._width=t,this._height=i;var n=t%4,a=i%4;i+=a<2?-a:4-a,this._adjustedWidth=t+=n<2?-n:4-n,this._adjustedHeight=i,this._boundFBO=r.getBoundFramebufferObject();var s=Math.round(.75*t),o=Math.round(.75*i);this._hlRenderer.setup(r,s,o),this._hlSurfaces.setup(r,s,o)}},{key:"draw",value:function(e){var t=e.context,i=t.getBoundFramebufferObject();t.setViewport(0,0,.75*this._adjustedWidth,.75*this._adjustedHeight),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setStencilTestEnabled(!1),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._blitRenderer.render(t,i.colorTexture,9728,1),t.setStencilTestEnabled(!1),t.setBlendingEnabled(!1),t.bindFramebuffer(this._hlSurfaces.sharedBlur2Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.preBlur(t,this._hlSurfaces.sharedBlur1Tex),t.bindFramebuffer(this._hlSurfaces.sharedBlur1Fbo),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT),this._hlRenderer.finalBlur(t,this._hlSurfaces.sharedBlur2Tex),t.bindFramebuffer(this._boundFBO),t.setBlendingEnabled(!0),t.setViewport(0,0,this._width,this._height),this._hlRenderer.renderHighlight(t,this._hlSurfaces.sharedBlur1Tex,this._hlGradient),this._boundFBO=null}},{key:"setHighlightOptions",value:function(e){this._hlGradient.setHighlightOptions(e)}}]),i}(Lt),ii=function(e){s(i,e);var t=u(i);function i(){var e;return f(this,i),(e=t.apply(this,arguments)).name=e.constructor.name,e.defines=["id"],e._lastSize=0,e}return m(i,[{key:"dispose",value:function(){Object(T.k)(this._fbo)&&this._fbo.dispose()}},{key:"bind",value:function(e){var t=e.context,i=e.painter,r=t.getViewport(),n=r.width,a=r.height,s=i.getFbos(n,a).effect0;t.bindFramebuffer(s),t.setColorMask(!0,!0,!0,!0),t.setClearColor(0,0,0,0),t.clear(t.gl.COLOR_BUFFER_BIT)}},{key:"unbind",value:function(){}},{key:"draw",value:function(e,t){var i=this,r=e.context,n=e.state,a=e.pixelRatio,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:M.k,o=r.getBoundFramebufferObject(),u=n.size[1]*a,l=Math.round(s*a),h=l/2,c=l/2;this._ensureBuffer(l),t.forEach((function(e,r){var n=new Map,s=Math.floor(r[0]*a-l/2),d=Math.floor(u-r[1]*a-l/2);o.readPixels(s,d,l,l,6408,5121,i._buf);for(var f=0;f<i._buf32.length;f++){var p=i._buf32[f];if(4294967295!==p&&0!==p){var m=f%l,v=l-Math.floor(f/l),g=(h-m)*(h-m)+(c-v)*(c-v),_=n.has(p)?n.get(p):4294967295;n.set(p,Math.min(g,_))}}var y=Array.from(n).sort((function(e,t){return e[1]-t[1]})).map((function(e){return e[0]}));e.resolve(y),t.delete(r)}))}},{key:"_ensureBuffer",value:function(e){this._lastSize!==e&&(this._lastSize=e,this._buf=new Uint8Array(4*e*e),this._buf32=new Uint32Array(this._buf.buffer))}}]),i}(Lt);function ri(e){switch(e){case"bloom":case"blur":case"opacity":case"drop-shadow":return e;default:return"colorize"}}var ni,ai,si,oi,ui,li={colorize:(ui=a(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.e(32).then(o.bind(null,"P3Vg"));case 2:return e.t0=e.sent.Colorize,e.abrupt("return",new e.t0);case 4:case"end":return e.stop()}}),e)}))),function(){return ui.apply(this,arguments)}),blur:(oi=a(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.e(27).then(o.bind(null,"B2cn"));case 2:return e.t0=e.sent.Blur,e.abrupt("return",new e.t0);case 4:case"end":return e.stop()}}),e)}))),function(){return oi.apply(this,arguments)}),bloom:(si=a(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.e(26).then(o.bind(null,"mxcV"));case 2:return e.t0=e.sent.Bloom,e.abrupt("return",new e.t0);case 4:case"end":return e.stop()}}),e)}))),function(){return si.apply(this,arguments)}),opacity:(ai=a(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.e(50).then(o.bind(null,"T/wP"));case 2:return e.t0=e.sent.Opacity,e.abrupt("return",new e.t0);case 4:case"end":return e.stop()}}),e)}))),function(){return ai.apply(this,arguments)}),"drop-shadow":(ni=a(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.e(38).then(o.bind(null,"eylR"));case 2:return e.t0=e.sent.DropShadow,e.abrupt("return",new e.t0);case 4:case"end":return e.stop()}}),e)}))),function(){return ni.apply(this,arguments)})},hi=function(){function e(t){f(this,e),this._requestRender=t,this._effectMap=new Map,this._effectPromiseMap=new Map}var t,i;return m(e,[{key:"dispose",value:function(){this._requestRender&&(this._requestRender=null),this._effectMap.forEach((function(e){return e.dispose()})),this._effectMap.clear(),this._effectPromiseMap.clear()}},{key:"getPostProcessingEffects",value:function(e){if(!e||0===e.length)return[];var t,i=[],r=v(e);try{for(r.s();!(t=r.n()).done;){var n=t.value,a=ri(n.type),s=this._effectMap.get(a);s?i.push({postProcessingEffect:s,effect:n}):this._enablePostProcessingEffect(a)}}catch(o){r.e(o)}finally{r.f()}return i}},{key:"_enablePostProcessingEffect",value:(i=a(regeneratorRuntime.mark((function e(t){var i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._loadPostProcessingEffect(t);case 2:i=e.sent,this._requestRender&&(this._effectMap.set(t,i),this._requestRender.requestRender());case 4:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"_loadPostProcessingEffect",value:(t=a(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(this._effectPromiseMap.has(t)||this._effectPromiseMap.set(t,li[t]()),this._effectPromiseMap.get(t)));case 1:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}(),ci=o("tQ+6");function di(e,t,i){return 1!==i||Object(T.k)(e)&&"normal"!==e||Object(T.k)(t)&&t.length>0}var fi=o("zm0L"),pi=o("lx5q"),mi=o("GprA"),vi=Object(p.a)("esri-2d-profiler"),gi=function(){function e(t,i){var r=this;if(f(this,e),this._events=new fi.a,this._entries=new Map,this._timings=new pi.a(10),vi){this._ext=Object(mi.a)(t.gl,{}),this._debugOutput=i;var n=t.gl;if(this.enableCommandLogging){var a=function(e){if("function"==typeof n[e]){var t=n[e],i=-1!==e.indexOf("draw");n[e]=function(){for(var a=arguments.length,s=new Array(a),o=0;o<a;o++)s[o]=arguments[o];return r._events.emit("command",{container:r._currentContainer,pass:r._currentPass,brush:r._currentBrush,method:e,args:s,isDrawCommand:i}),r._currentSummary&&(r._currentSummary.commands++,i&&r._currentSummary.drawCommands++),t.apply(n,s)}}};for(var s in n)a(s)}}}return m(e,[{key:"enableCommandLogging",get:function(){return!("object"==typeof vi&&vi.disableCommands)}},{key:"recordContainerStart",value:function(e){vi&&(this._currentContainer=e)}},{key:"recordContainerEnd",value:function(){vi&&(this._currentContainer=null)}},{key:"recordPassStart",value:function(e){vi&&(this._currentPass=e,this._initSummary())}},{key:"recordPassEnd",value:function(){vi&&(this._currentPass=null,this._emitSummary())}},{key:"recordBrushStart",value:function(e){vi&&(this._currentBrush=e)}},{key:"recordBrushEnd",value:function(){vi&&(this._currentBrush=null)}},{key:"recordStart",value:function(e){if(vi&&Object(T.k)(this._ext)){if(this._entries.has(e)){var t=this._entries.get(e),i=this._ext.resultAvailable(t.query),r=this._ext.disjoint();if(i&&!r){var n=this._ext.getResult(t.query)/1e6,a=0;if(Object(T.k)(this._timings.enqueue(n))){var s,o=this._timings.entries,u=o.length,l=0,h=v(o);try{for(h.s();!(s=h.n()).done;){l+=s.value}}catch(g){h.e(g)}finally{h.f()}a=l/u}var c=n.toFixed(2),d=a?a.toFixed(2):"--";this.enableCommandLogging?(console.groupCollapsed("Frame report for ".concat(e,", ").concat(c," ms (").concat(d," last 10 avg)\n").concat(t.commandsLen," Commands (").concat(t.drawCommands," draw)")),console.log("RenderPass breakdown: "),console.table(t.summaries),console.log("Commands: ",t.commands),console.groupEnd()):console.log("Frame report for ".concat(e,", ").concat(c," ms (").concat(d," last 10 avg)")),this._debugOutput.innerHTML="".concat(c," (").concat(d,")")}var f,p=v(t.handles);try{for(p.s();!(f=p.n()).done;){f.value.remove()}}catch(g){p.e(g)}finally{p.f()}this._entries.delete(e)}var m={name:e,query:this._ext.createQuery(),commands:[],commandsLen:0,drawCommands:0,summaries:[],handles:[]};this.enableCommandLogging&&(m.handles.push(this._events.on("command",(function(e){m.commandsLen++,m.commands.push(e),e.isDrawCommand&&m.drawCommands++}))),m.handles.push(this._events.on("summary",(function(e){m.summaries.push(e)})))),this._ext.beginTimeElapsed(m.query),this._entries.set(e,m)}}},{key:"recordEnd",value:function(e){vi&&Object(T.k)(this._ext)&&this._entries.has(e)&&this._ext.endTimeElapsed()}},{key:"_initSummary",value:function(){this.enableCommandLogging&&(this._currentSummary={container:this._currentContainer,pass:this._currentPass,drawCommands:0,commands:0})}},{key:"_emitSummary",value:function(){this.enableCommandLogging&&this._events.emit("summary",this._currentSummary)}}]),e}(),_i=o("N3sV"),yi=_.a.getLogger("esri.views.2d.engine.webgl.WebGLDriverTest"),bi=function(){function e(t){var i=this;f(this,e),this.svgAlwaysPremultipliesAlpha=!1,this._ignoresSamplerPrecision=null,this._context=t,Object(_i.a)(t).then((function(e){i.svgAlwaysPremultipliesAlpha=!e}))}return m(e,[{key:"ignoresSamplerPrecision",get:function(){return Object(T.j)(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=wi(this._context)),this._ignoresSamplerPrecision}}]),e}(),wi=function(e){var t=new he.a(e,{colorTarget:0,depthStencilTarget:0},{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1}),i=new Uint8Array(4),r=new Vt.a(e,[0,0,1,0,0,1,1,1]),n=new ge.a(e,"\nprecision highp float;\n\nattribute vec2 a_pos;\n\nuniform highp sampler2D u_texture;\nvarying vec4 v_color;\n\nfloat getBit(in float bitset, in int bitIndex) {\n  float offset = pow(2.0, float(bitIndex));\n\n  return mod(floor(bitset / offset), 2.0);\n}\n\nvoid main() {\n  vec4 value = texture2D(u_texture, vec2(0.0));\n\n  float bit = getBit(value.x * 255.0, 1);\n\n  v_color = bit * vec4(1.0);\n\n  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);\n}\n","\nprecision highp float;\n\nvarying vec4 v_color;\n\nvoid main() {\n  gl_FragColor = v_color;\n}\n",{a_pos:0}),a=new Qe.a(e,{target:3553,wrapMode:33071,pixelFormat:6408,dataType:5121,samplingMode:9728,width:1,height:1},new Uint8Array([2,255,0,0]));n.setUniform1i("u_texture",0),e.bindTexture(a,0);var s=e.getBoundFramebufferObject();e.bindFramebuffer(t),e.bindProgram(n);var o=e.getViewport(),u=o.x,l=o.y,h=o.width,c=o.height;e.setViewport(0,0,1,1),r.draw(),e.setViewport(u,l,h,c),t.readPixels(0,0,1,1,6408,5121,i),n.dispose(),r.dispose(),t.dispose();var d=255!==i[0]||255!==i[1]||255!==i[2]||255!==i[3];return d&&yi.warn("A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [".concat(i[0],".").concat(i[1],".").concat(i[2],".").concat(i[3],"]")),e.bindFramebuffer(s),d},xi=o("n21L"),ki=function(){function e(t,i,r,n,a){f(this,e),this.target=t,this.geometryType=i,this.materialKey=r,this.indexFrom=n,this.indexCount=a}return m(e,[{key:"indexEnd",get:function(){return this.indexFrom+this.indexCount}},{key:"extend",value:function(e){this.indexCount+=e}},{key:"draw",value:function(e,t,i){this.target.draw(e,t,i,this.indexFrom,this.indexCount)}}]),e}(),Oi=function(){function e(t){f(this,e),this._infos=new Array,this._target=t}return m(e,[{key:"_last",get:function(){return this._infos[this._infos.length-1]}},{key:"add",value:function(e){var t=e.materialKey,i=e.indexFrom,r=e.indexCount;if(this._infos.length&&e.materialKey===this._last.materialKey&&e.indexFrom===this._last.indexEnd)this._last.extend(r);else{var n=new ki(this._target,this.geometryType,t,i,r);this._infos.push(n)}}},{key:"forEach",value:function(e){var t,i=v(this._infos);try{for(i.s();!(t=i.n()).done;){e(t.value)}}catch(r){i.e(r)}finally{i.f()}}}],[{key:"from",value:function(t,i){for(var r=new e(t);i.next();)r.add(i);return r}}]),e}(),Ci=function(){function e(t){if(f(this,e),Array.isArray(t)){this.data=t[0];for(var i=this,r=1;r<t.length;r++)i.next=new e([t[r]]),i=i.next}else this.data=t}return m(e,[{key:"find",value:function(e){var t;return e(this.data)?this:null==(t=this.next)?void 0:t.find(e)}},{key:"max",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this,i=e(this.data)>e(t.data)?this:t;return this.next?this.next.max(e,i):i}},{key:"remove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return this===e?t?(t.next=this.next,t):this.next:this.next.remove(e,this)}},{key:"last",get:function(){return this.next?this.next.last:this}}]),e}(),Ti=function(){function e(t){f(this,e),this._head=null,Object(T.j)(t)||(this._head=new Ci(t))}return m(e,[{key:"head",get:function(){return this._head}},{key:"maxAvailableSpace",value:function(){if(Object(T.j)(this._head))return 0;var e=this._head.max((function(e){return e.end-e.start}));return e.data.end-e.data.start}},{key:"firstFit",value:function(e){if(Object(T.j)(this._head))return null;for(var t=null,i=this._head;i;){var r=i.data.end-i.data.start;if(r===e)return t?t.next=i.next:this._head=i.next,i.data.start;if(r>e){var n=i.data.start;return i.data.start+=e,n}t=i,i=i.next}return null}},{key:"free",value:function(e,t){var i=e+t;if(Object(T.j)(this._head)){var r=new Ci({start:e,end:i});this._head=r}else{if(i<=this._head.data.start){if(i===this._head.data.start)return void(this._head.data.start-=t);var n=new Ci({start:e,end:i});return n.next=this._head,void(this._head=n)}for(var a=this._head,s=a.next;s;){if(s.data.start>=i){if(a.data.end===e)return void(a.data.end+=t);if(s.data.start===i)return void(s.data.start-=t);var o=new Ci({start:e,end:i});return o.next=a.next,void(a.next=o)}a=s,s=s.next}if(e!==a.data.end){var u=new Ci({start:e,end:i});a.next=u}else a.data.end+=t}}}]),e}(),Mi=function(){function e(t,i,r){f(this,e);var n=new Uint32Array(i*r);this.strideInt=r,this.bufferType=t,this.dirty={start:1/0,end:0},this.cpu=n,this.gpu=null,this.clear()}return m(e,[{key:"destroy",value:function(){Object(T.b)(this.gpu,(function(e){return e.dispose()}))}},{key:"clear",value:function(){this.dirty.start=1/0,this.dirty.end=0,this.freeList=new Ti({start:0,end:this.cpu.length/this.strideInt}),this.fillPointer=0}},{key:"bufferSize",get:function(){return this.cpu.length/this.strideInt}},{key:"maxAvailableSpace",value:function(){return this.freeList.maxAvailableSpace()}},{key:"insert",value:function(e,t,i,r){var n=i*this.strideInt,a=t*this.strideInt*Uint32Array.BYTES_PER_ELEMENT,s=new Uint32Array(e,a,n),o=Object(T.s)(this.freeList.firstFit(i),"First fit region must be defined"),u=o*this.strideInt,l=n*this.strideInt,h=o-t;if(0!==r)for(var c=0;c<s.length;c++)s[c]+=r;return this.cpu.set(s,u),this.dirty.start=Math.min(this.dirty.start,u),this.dirty.end=Math.max(this.dirty.end,u+l),this.fillPointer=Math.max(this.fillPointer,u+l),h}},{key:"free",value:function(e,t,i){var r=e*this.strideInt,n=(e+t)*this.strideInt;if(!0===i)for(var a=e;a!==e+t;a++)this.cpu[a*this.strideInt]=2147450879;this.dirty.start=Math.min(this.dirty.start,r),this.dirty.end=Math.max(this.dirty.end,n),this.freeList.free(e,t)}},{key:"upload",value:function(e){if(this.dirty.end){if(Object(T.j)(this.gpu))return this.gpu=this._createBuffer(e),this.dirty.start=1/0,void(this.dirty.end=0);this.gpu.setSubData(this.cpu,this.dirty.start,this.dirty.start,this.dirty.end),this.dirty.start=1/0,this.dirty.end=0}}},{key:"_createBuffer",value:function(e){return"index"===this.bufferType?ue.a.createIndex(e,35048,this.cpu):ue.a.createVertex(e,35048,this.cpu)}}]),e}(),Si=o("VIer"),Ri=function(){function e(t,i,r,n,a){f(this,e),this._vaoInvalidated=!0;var s=Object(Si.a)(i),o=Math.max(s.indicesPerRecord*s.multiplier*r,a+1),u=Math.max(s.verticesPerRecord*s.multiplier*r,n+1),l=t/Uint32Array.BYTES_PER_ELEMENT,h=new Mi("index",o,1),c={geometry:new Mi("vertex",u,l)};this.stride=t,this.strideInt=l,this.geometryType=i,this._buffers={index:h,vertex:c}}return m(e,[{key:"release",value:function(){this.isReleased||(this._pool.release(this),this._released=!0)}},{key:"destroy",value:function(){this._buffers.index.destroy(),this._buffers.vertex.geometry.destroy(),Object(T.b)(this._vao,(function(e){return e.dispose(!1)}))}},{key:"isReleased",get:function(){return this._released}},{key:"indexBufferSize",get:function(){return this._buffers.index.bufferSize}},{key:"vertexBufferSize",get:function(){return this._buffers.vertex.geometry.bufferSize}},{key:"displayList",get:function(){return Object(T.j)(this._displayList)&&(this._displayList=Oi.from(this,this._records.getCursor())),this._displayList}},{key:"draw",value:function(e,t,i,r,n){this.upload(e);var a=this._getVAO(e,t,i),s=Uint32Array.BYTES_PER_ELEMENT*r;e.bindVAO(a),e.drawElements(4,n,5125,s),e.bindVAO(null)}},{key:"insert",value:function(e){if(!e.done){var t=e.vertexData,i=e.offset,r=t.records,n=t.indices,a=t.vertices,s=this._getInsertionInfo(xi.a.from(r,i)),o=s.vertFrom,u=s.vertCount,l=s.indexFrom,h=s.indexCount,c=s.recordCount,d=s.done;if(e.done=d,e.offset=c+i,0!==c){var f=this._buffers,p=f.index,m=f.vertex.geometry.insert(a,o,u,0),v=p.insert(n,l,h,m);this._addRecords(xi.a.from(r,i,c),v,m)}}}},{key:"free",value:function(e){for(var t=xi.a.from(e.records).getCursor();t.next();)this._freeId(t.id)}},{key:"freeIds",value:function(e){var t,i=v(e);try{for(i.s();!(t=i.n()).done;){var r=t.value;this._freeId(r)}}catch(n){i.e(n)}finally{i.f()}}},{key:"upload",value:function(e){var t=this._buffers,i=t.index,r=t.vertex;i.upload(e),r.geometry.upload(e)}},{key:"has",value:function(e){if(!this._records)return!1;for(var t=this._records.getCursor();t.next();)if(t.id===e)return!0;return!1}},{key:"getViewOf",value:function(e){if(!this._records)return null;for(var t=this._records.getCursor();t.next();)if(t.id===e)return t;return null}},{key:"_getInsertionInfo",value:function(e){for(var t=e.getCursor(),i=this._buffers,r=i.index,n=i.vertex,a=r.maxAvailableSpace(),s=n.geometry.maxAvailableSpace(),o=0,u=null,l=0,h=null,c=0,d=!0;t.next();){null===h&&(h=t.vertexFrom,u=t.indexFrom);var f=c+t.vertexCount,p=l+t.indexCount;if(f>=s||p>=a){d=!1;break}o+=1,l=p,c=f}return{done:d,vertFrom:h,vertCount:c,indexFrom:u,indexCount:l,recordCount:o}}},{key:"_addRecords",value:function(e,t,i){for(var r=e.getCursor();r.next();)r.indexFrom+=t,r.vertexFrom+=i;this._records?(this._records.link(e),this._displayList=null):this._records=e}},{key:"_freeId",value:function(e){var t=this._records.getCursor(),i=this._buffers.index,r=this._buffers.vertex.geometry;if(t.lookup(e)){for(var n=t.indexFrom,a=t.indexCount,s=t.vertexFrom,o=t.vertexCount;t.next()&&t.id===e;)a+=t.indexCount,o+=t.vertexCount;i.free(n,a),r.free(s,o,!0),this._records.delete(e)}}},{key:"_getVAO",value:function(e,t,i){if(this._vaoInvalidated){var r=JSON.stringify(t)+JSON.stringify(i);r!==this._vaoHash&&(Object(T.b)(this._vao,(function(e){e.dispose(!1)})),this._vao=null,this._vaoHash=r),this._vaoInvalidated=!1}if(Object(T.j)(this._vao)){var n=this._buffers,a=n.index,s=n.vertex;if(Object(T.j)(s.geometry.gpu)||Object(T.j)(a.gpu))throw new Error("bad news");this._vao=new le.a(e,i,t,{geometry:s.geometry.gpu},a.gpu)}return this._vao}}],[{key:"createPooled",value:function(t,i,r,n,a,s,o){var u=Math.max(M.d,Math.round(1.5*s)),l=Object(T.r)(t,(function(){return new e(i.stride,r,u,n,a)}));return l._buffers.index.clear(),l._buffers.vertex.geometry.clear(),l._records=null,l._displayList=null,l._vaoInvalidated=!0,l._pool=o,l._released=!1,l}}]),e}(),Pi=function(){function e(){f(this,e),this._pools=new Map}return m(e,[{key:"acquire",value:function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=xi.a.from(e.records,i),n=r.size();r.next();var a=r.vertexCount,s=r.indexCount,o=this._tryAcquire(e.stride,t,a,s);return Ri.createPooled(o,e,t,a,s,n,this)}},{key:"release",value:function(e){e.isReleased||e.destroy()}},{key:"destroy",value:function(){this._pools.forEach((function(e){Object(T.k)(e)&&e.clear((function(e){return e.destroy()}))}))}},{key:"_tryAcquire",value:function(e,t,i,r){var n=this._pools.get(e<<3|t);if(Object(T.j)(n))return null;var a=n.dequeue();return Object(T.k)(a)&&a.vertexBufferSize>=i&&a.indexBufferSize>=r?a:null}}]),e}(),Fi={shaders:{vertexShader:Object(Be.a)("stencil/stencil.vert"),fragmentShader:Object(Be.a)("stencil/stencil.frag")},attributes:{a_pos:0}},ji=function(e){s(l,e);var n,o=u(l);function l(e,r){var n;f(this,l),(n=o.call(this))._trash=new Set,n._clipData=new Float32Array(8),n._upperLeft=Object(te.a)(),n._upperRight=Object(te.a)(),n._lowerLeft=Object(te.a)(),n._lowerRight=Object(te.a)(),n._mat2=Object(se.b)(),n._clipRendererInitialized=!1,n._supersampleScreenshots=!0,n._pools={bufferData:new Pi},n.renderRequested=!1,n.stage=h(n),n._stationary=!0;var s=r.canvas,u=void 0===s?document.createElement("canvas"):s,c=r.alpha,d=void 0===c||c,g=r.stencil,_=void 0===g||g,y=r.renderContext,b=void 0===y?"webgl":y,x=r.supersampleScreenshots,k=void 0===x||x,O=r.contextOptions,C=void 0===O?{}:O;n._canvas=u;var S,R=Object(ne.b)(u,{alpha:d,antialias:!1,depth:!0,stencil:_},b);return n.context=new de.a(R,C),n.painter=new(function(){function e(r,n){f(this,e),this.context=r,this._blitRenderer=new Ae,this._brushCache=new Map,this._vtlMaterialManager=new(function(){function e(){f(this,e),this._programByKey=new Map}return m(e,[{key:"dispose",value:function(){this._programByKey.forEach((function(e){return e.dispose()})),this._programByKey.clear()}},{key:"getMaterialProgram",value:function(e,t,i){var r=t.key<<2|this._getMaterialOptionsValue(t.type,i);if(this._programByKey.has(r))return this._programByKey.get(r);var n=(0,this._getProgramTemplate(t.type).shaders)(i),a=n.vertexShader,s=n.fragmentShader,o=t.getShaderHeader(),u=t.getShaderMain(),l=a.replace("#pragma header",o).replace("#pragma main",u),h=new ge.a(e,l,s,t.getAttributeLocations());return this._programByKey.set(r,h),h}},{key:"_getMaterialOptionsValue",value:function(e,t){switch(e){case 0:case 1:return(t.pattern?1:0)<<1|(t.id?1:0);case 2:return t.id?1:0;case 3:return(t.pattern?1:0)<<1|(t.id?1:0);case 4:return(t.sdf?1:0)<<1|(t.id?1:0);case 5:case 6:return t.id?1:0;default:return 0}}},{key:"_getProgramTemplate",value:function(e){switch(e){case 0:return ke;case 5:return Ce;case 1:return Me;case 4:return Fe;case 3:return Ie;case 2:return Re;case 6:return ze;default:return null}}}]),e}()),this._blendEffect=new Gt,this.effects={highlight:new ti,hittest:new ii,integrate:new Ut,insideEffect:new Wt("inside"),outsideEffect:new Wt("outside")},this.materialManager=new(function(){function e(t){f(this,e),this._programByKey=new Map,this._programCache=new Ve.a(t)}return m(e,[{key:"dispose",value:function(){this._programCache&&this._programCache.dispose()}},{key:"getProgram",value:function(e,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],s=r.vsPath+"."+r.fsPath+JSON.stringify(n)+a.join(".");if(this._programByKey.has(s))return this._programByKey.get(s);var o=a.reduce((function(r,n){return t(t({},r),{},i({},n,e.driverTestResult[n]))}),{}),u=t(t({},n.map((function(e){return"string"==typeof e?{name:e,value:!0}:e})).reduce((function(e,r){return t(t({},e),{},i({},r.name,r.value))}),{})),o),l=r.vsPath,h=r.fsPath,c=r.attributes,d=this._programCache.getProgram(Ne(l,h,c),u);if(!d)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(s,d),d}},{key:"getMaterialProgram",value:function(e,r,n,a,s){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:["ignoresSamplerPrecision"],u=function(e,t,i,r){var n,a=e.rendererInfo,s=e.drawPhase;return"".concat(t.getVariationHash(),"-").concat(r.join("."),"-").concat((n=s,(qe(n)?1:0)|(n===fe.c.HIGHLIGHT?2:0)),"-").concat(a.getVariationHash(),"-").concat(Object(T.k)(i)&&i.join("."))}(e,r,s,o);if(this._programByKey.has(u))return this._programByKey.get(u);var l=function(e,r,n,a){var s=a.reduce((function(r,n){return t(t({},r),{},i({},n,e.driverTestResult[n]))}),{}),o=t(t(t({},r.getVariation()),e.rendererInfo.getVariation()),{},{highlight:e.drawPhase===fe.c.HIGHLIGHT,id:qe(e.drawPhase)},s);if(Object(T.k)(n)){var u,l=v(n);try{for(l.s();!(u=l.n()).done;){o[u.value]=!0}}catch(h){l.e(h)}finally{l.f()}}return o}(e,r,s,o),h=this._programCache.getProgram(Ne(n,n,a),l);if(!h)throw new Error("Unable to get program for key: ${key}");return this._programByKey.set(u,h),h}}]),e}())(r),this.textureManager=new(function(){function e(i){var r;f(this,e),this._invalidFontsMap=new Map,this._sdfConverter=new(function(){function e(t){f(this,e),this.size=t;var i=document.createElement("canvas");i.width=i.height=t,this._context=i.getContext("2d"),this._gridOuter=new Float64Array(t*t),this._gridInner=new Float64Array(t*t),this._f=new Float64Array(t),this._d=new Float64Array(t),this._z=new Float64Array(t+1),this._v=new Int16Array(t)}return m(e,[{key:"dispose",value:function(){this._context=this._gridOuter=this._gridInner=this._f=this._d=this._z=this._v=null,this._svg&&(document.body.removeChild(this._svg),this._svg=null)}},{key:"draw",value:function(e,t){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:31;this._initSVG();var n=this._createSVGString(e);return new Promise((function(e,a){var s=new Image;s.src="data:image/svg+xml; charset=utf8, "+encodeURIComponent(n),s.onload=function(){s.onload=null,i._context.clearRect(0,0,i.size,i.size),i._context.drawImage(s,0,0,i.size,i.size);for(var t=i._context.getImageData(0,0,i.size,i.size),n=new Uint8Array(i.size*i.size*4),a=0;a<i.size*i.size;a++){var o=t.data[4*a+3]/255;i._gridOuter[a]=1===o?0:0===o?1e20:Math.pow(Math.max(0,.5-o),2),i._gridInner[a]=1===o?1e20:0===o?0:Math.pow(Math.max(0,o-.5),2)}i._edt(i._gridOuter,i.size,i.size),i._edt(i._gridInner,i.size,i.size);for(var u=0;u<i.size*i.size;u++)ot(.5-(i._gridOuter[u]-i._gridInner[u])/(2*r),n,4*u);e(n)};var o=t&&t.signal;o&&Object(Ge.p)(o,(function(){return a(Object(Ge.e)())}))}))}},{key:"_initSVG",value:function(){if(!this._svg){var e=document.createElementNS("http://www.w3.org/2000/svg","svg");e.setAttribute("style","position: absolute;"),e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttribute("aria-hidden","true"),e.setAttribute("role","presentation"),document.body.appendChild(e),this._svg=e}}},{key:"_createSVGString",value:function(e){var t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",e),this._svg.appendChild(t);var i,r,n,a,s=t.getBBox(),o=s.width/s.height,u=this.size/2;o>1?(r=i=u/s.width,n=this.size/4,a=u-u*(1/o)/2):(i=r=u/s.height,n=u-u*o/2,a=this.size/4),t.setAttribute("style","transform: matrix(".concat(i,", 0, 0, ").concat(r,", ").concat(-s.x*i+n,", ").concat(-s.y*r+a,")"));var l='<svg style="fill:red;" height="'.concat(this.size,'" width="').concat(this.size,'" xmlns="http://www.w3.org/2000/svg">').concat(this._svg.innerHTML,"</svg>");return this._svg.removeChild(t),l}},{key:"_edt",value:function(e,t,i){for(var r=this._f,n=this._d,a=this._v,s=this._z,o=0;o<t;o++){for(var u=0;u<i;u++)r[u]=e[u*t+o];this._edt1d(r,n,a,s,i);for(var l=0;l<i;l++)e[l*t+o]=n[l]}for(var h=0;h<i;h++){for(var c=0;c<t;c++)r[c]=e[h*t+c];this._edt1d(r,n,a,s,t);for(var d=0;d<t;d++)e[h*t+d]=Math.sqrt(n[d])}}},{key:"_edt1d",value:function(e,t,i,r,n){i[0]=0,r[0]=-1e20,r[1]=1e20;for(var a=1,s=0;a<n;a++){for(var o=(e[a]+a*a-(e[i[s]]+i[s]*i[s]))/(2*a-2*i[s]);o<=r[s];)s--,o=(e[a]+a*a-(e[i[s]]+i[s]*i[s]))/(2*a-2*i[s]);i[++s]=a,r[s]=o,r[s+1]=1e20}for(var u=0,l=0;u<n;u++){for(;r[l+1]<u;)l++;t[u]=(u-i[l])*(u-i[l])+e[i[l]]}}}]),e}())(126),this._bindingInfos=new Array,this._hashToBindingIndex=new Map,this._rasterizer=new Xe.a,this._ongoingRasterizations=new Map,this._imageRequestQueue=new Ke.a({concurrency:10,process:(r=a(regeneratorRuntime.mark((function e(t,i){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Object(Ge.u)(i),e.prev=1,e.next=4,Object(We.default)(t,{responseType:"image",signal:i});case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(1),Object(Ge.m)(e.t0)){e.next=11;break}throw new w.a("mapview-invalid-resource","Could not fetch requested resource at "+t,e.t0);case 11:throw e.t0;case 12:case"end":return e.stop()}}),e,null,[[1,7]])}))),function(e,t){return r.apply(this,arguments)})}),this._spriteMosaic=new ht(i,2048,2048,500),this._glyphSource=new(function(){function e(t){f(this,e),this._glyphInfo={},this._baseURL=t}return m(e,[{key:"getRange",value:function(e,i,r){var n=this._getFontStack(e);if(n.getRange(i))return Promise.resolve();var a=256*i,s=a+255,o=this._baseURL.replace("{fontstack}",e).replace("{range}",a+"-"+s);return Object(We.default)(o,t({responseType:"array-buffer"},r)).then((function(e){n.addRange(i,new it(new tt.a(new Uint8Array(e.data),new DataView(e.data))))}))}},{key:"getGlyph",value:function(e,t){var i=this._getFontStack(e);if(i){var r=Math.floor(t/256);if(!(r>256)){var n=i.getRange(r);return n?{metrics:n.getMetrics(t),bitmap:n.getBitmap(t)}:void 0}}}},{key:"_getFontStack",value:function(e){var t=this._glyphInfo[e];return t||(t=this._glyphInfo[e]=new rt),t}}]),e}())(He.a.fontsUrl+"/{fontstack}/{range}.pbf"),this._glyphMosaic=new(function(){function e(t,i,r){f(this,e),this.width=0,this.height=0,this._dirties=[],this._glyphData=[],this._currentPage=0,this._glyphCache={},this._textures=[],this._rangePromises=new Map,this.width=t,this.height=i,this._glyphSource=r,this._binPack=new $e(t-4,i-4),this._glyphData.push(new Uint8Array(t*i)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph()}var t,i,r;return m(e,[{key:"dispose",value:function(){this._binPack=null;var e,t=v(this._textures);try{for(t.s();!(e=t.n()).done;){var i=e.value;i&&i.dispose()}}catch(r){t.e(r)}finally{t.f()}this._textures.length=0,this._glyphData.length=0}},{key:"_initDecorationGlyph",value:function(){for(var e=[117,149,181,207,207,181,149,117],t=[],i=0;i<e.length;i++)for(var r=e[i],n=0;n<11;n++)t.push(r);var a={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(t)};this._recordGlyph(a)}},{key:"getGlyphItems",value:(r=a(regeneratorRuntime.mark((function e(t,i,r){var n,a=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._getGlyphCache(t),e.next=3,this._fetchRanges(t,i,r);case 3:return e.abrupt("return",i.map((function(e){return a._getMosaicItem(n,t,e)})));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,i){return r.apply(this,arguments)})},{key:"bind",value:function(e,t,i,r){var n=this._getTexture(e,i);n.setSamplingMode(t),this._dirties[i]&&(n.setData(this._glyphData[i]),this._dirties[i]=!1),e.bindTexture(n,r)}},{key:"_getGlyphCache",value:function(e){return this._glyphCache[e]||(this._glyphCache[e]={}),this._glyphCache[e]}},{key:"_getTexture",value:function(e,t){return this._textures[t]||(this._textures[t]=new Qe.a(e,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height))),this._textures[t]}},{key:"_invalidate",value:function(){this._dirties[this._currentPage]=!0}},{key:"_fetchRanges",value:(i=a(regeneratorRuntime.mark((function e(t,i,r){var n,a,s=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=function(e){var t,i=new Set,r=v(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;i.add(et(n))}}catch(a){r.e(a)}finally{r.f()}return i}(i),a=[],n.forEach((function(e){a.push(s._fetchRange(t,e,r))})),e.next=4,Promise.all(a);case 4:case"end":return e.stop()}}),e)}))),function(e,t,r){return i.apply(this,arguments)})},{key:"_fetchRange",value:(t=a(regeneratorRuntime.mark((function e(t,i,r){var n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",i>256?null:function(e,t,i){return e.has(t)||e.set(t,i().then((function(){e.delete(t)})).catch((function(i){e.delete(t),Object(Ge.v)(i)}))),e.get(t)}(this._rangePromises,t+i,(function(){return n._glyphSource.getRange(t,i,r)})));case 1:case"end":return e.stop()}}),e,this)}))),function(e,i,r){return t.apply(this,arguments)})},{key:"_getMosaicItem",value:function(e,t,i){if(!e[i]){var r=this._glyphSource.getGlyph(t,i);if(!r||!r.metrics)return function(e){return{rect:new Je.a(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:e,sdf:!0}}(i);var n=this._recordGlyph(r);e[i]={rect:n,page:this._currentPage,metrics:r.metrics,code:i,sdf:!0},this._invalidate()}return e[i]}},{key:"_recordGlyph",value:function(e){var t,i=e.metrics;if(0===i.width)t=new Je.a(0,0,0,0);else{var r=i.width+6,n=i.height+6;(t=this._binPack.allocate(r,n)).isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new $e(this.width-4,this.height-4),t=this._binPack.allocate(r,n));var a,s,o=this._glyphData[this._currentPage],u=e.bitmap;if(u)for(var l=0;l<n;l++){a=r*l,s=this.width*(t.y+l)+t.x;for(var h=0;h<r;h++)o[s+h]=u[a+h]}Object(p.a)("esri-glyph-debug")&&this._showDebugPage(o)}return t}},{key:"_showDebugPage",value:function(e){var t=document.createElement("canvas"),i=t.getContext("2d"),r=new ImageData(this.width,this.height),n=r.data;t.width=this.width,t.height=this.height,t.style.border="1px solid black";for(var a=0;a<e.length;++a)n[4*a+0]=e[a],n[4*a+1]=0,n[4*a+2]=0,n[4*a+3]=255;i.putImageData(r,0,0),document.body.appendChild(t)}}]),e}())(1024,1024,this._glyphSource)}var i,r,n,s,o,u,l,h;return m(e,[{key:"dispose",value:function(){this._spriteMosaic.dispose(),this._glyphMosaic.dispose(),this._rasterizer.dispose(),this._sdfConverter.dispose(),this._spriteMosaic=null,this._glyphMosaic=null,this._rasterizer=null,this._sdfConverter=null,this._hashToBindingIndex.clear(),this._hashToBindingIndex=null,this._bindingInfos=null,this._ongoingRasterizations.clear(),this._ongoingRasterizations=null,this._imageRequestQueue.clear(),this._imageRequestQueue=null}},{key:"sprites",get:function(){return this._spriteMosaic}},{key:"glyphs",get:function(){return this._glyphMosaic}},{key:"rasterizeItem",value:(h=a(regeneratorRuntime.mark((function e(t,i,r,n){var a,s,o=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Object(T.j)(t)){e.next=2;break}return e.abrupt("return",(Et("mapview-null-resource","Unable to rasterize null resource"),null));case 2:e.t0=t.type,e.next="CIMTextSymbol"===e.t0||"esriTS"===e.t0?5:("esriSMS"===e.t0||"esriPMS"===e.t0||"esriSFS"===e.t0||"esriPFS"===e.t0||e.t0,9);break;case 5:return e.next=7,this._rasterizeText(t,r,n);case 7:return a=e.sent,e.abrupt("return",(a.forEach((function(e){return o._setTextureBinding(fe.a.GLYPH,e)})),{glyphMosaicItems:a}));case 9:if(!function(e){return e.type&&-1!==e.type.toLowerCase().indexOf("3d")}(t)){e.next=11;break}return e.abrupt("return",(Et("mapview-invalid-type","MapView does not support symbol type: "+t.type,t),null));case 11:return e.next=13,this._rasterizeSpriteSymbol(t,i,n);case 13:return s=e.sent,e.abrupt("return",(Object(Ft.a)(s)&&s&&this._setTextureBinding(fe.a.SPRITE,s),{spriteMosaicItem:s}));case 15:case"end":return e.stop()}}),e,this)}))),function(e,t,i,r){return h.apply(this,arguments)})},{key:"bindTextures",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]&&arguments[3];if(0!==i.textureBinding){var n=this._bindingInfos[i.textureBinding-1],a=n.page,s=r?9987:9729;switch(n.mosaicType){case fe.a.SPRITE:var o=this.sprites.getWidth(a),u=this.sprites.getHeight(a),l=Object(re.r)(jt,o,u);return this._spriteMosaic.bind(e,s,a,M.B),t.setUniform1i("u_texture",M.B),void t.setUniform2fv("u_mosaicSize",l);case fe.a.GLYPH:var h=this.glyphs.width,c=this.glyphs.height,d=Object(re.r)(jt,h,c);return this._glyphMosaic.bind(e,s,a,M.w),t.setUniform1i("u_texture",M.w),void t.setUniform2fv("u_mosaicSize",d);default:It.error("mapview-texture-manager","Cannot handle unknown type "+n.mosaicType)}}}},{key:"_hashMosaic",value:function(e,t){return 1|e<<1|(t.sdf?1:0)<<2|t.page<<3}},{key:"_setTextureBinding",value:function(e,t){var i=this._hashMosaic(e,t);if(!this._hashToBindingIndex.has(i)){var r=At.fromMosaic(e,t);this._hashToBindingIndex.set(i,this._bindingInfos.length+1),this._bindingInfos.push(r)}t.textureBinding=this._hashToBindingIndex.get(i)}},{key:"_rasterizeText",value:(l=a(regeneratorRuntime.mark((function e(t,i,r){var n,a,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=function(e){var t=function(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}(e)+function(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblic":return"-italic"}return""}(e);return function(e){var t=e.toLowerCase().split(" ").join("-");switch(t){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return t}}(e.family)+(t.length>0?t:"-regular")}(t.font),a=this._invalidFontsMap.has(n),s=i||function(e){for(var t=[],i=0;i<e.length;i++)t.push(e.charCodeAt(i));return t}(Object(Ye.a)(t.text)[0]),e.prev=1,e.next=4,this._glyphMosaic.getGlyphItems(a?"arial-unicode-ms-regular":n,s,r);case 4:return e.abrupt("return",e.sent);case 7:return e.prev=7,e.t0=e.catch(1),e.abrupt("return",(Et("mapview-invalid-resource","Couldn't find font ".concat(n,". Falling back to Arial Unicode MS Regular")),this._invalidFontsMap.set(n,!0),this._glyphMosaic.getGlyphItems("arial-unicode-ms-regular",s,r)));case 10:case"end":return e.stop()}}),e,this,[[1,7]])}))),function(e,t,i){return l.apply(this,arguments)})},{key:"_rasterizeSpriteSymbol",value:(u=a(regeneratorRuntime.mark((function e(t,i,r){var n,a,s,o,u,l;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!function(e){switch(e.type){case"CIMSolidStroke":case"CIMSolidFill":return!0;case"esriSFS":return"esriSFSSolid"===e.style||"esriSFSNull"===e.style;case"esriSLS":return"esriSLSSolid"===e.style||"esriSLSNull"===e.style;default:return!1}}(t)){e.next=2;break}return e.abrupt("return",null);case 2:if(n=function(e){switch(e.type){case"esriSMS":return"".concat(e.style,".").concat(e.path);case"esriSLS":return"".concat(e.style,".").concat(e.cap);case"esriSFS":return""+e.style;case"esriPFS":case"esriPMS":return e.imageData?"".concat(e.imageData).concat(e.width).concat(e.height):"".concat(e.url).concat(e.width).concat(e.height);default:return e.mosaicHash?e.mosaicHash:JSON.stringify(e)}}(t),!this._spriteMosaic.has(n)){e.next=5;break}return e.abrupt("return",this._spriteMosaic.getSpriteItem(n));case 5:if(!Dt(t)&&!function(e){return e.url||e.imageData}(t)){e.next=7;break}return e.abrupt("return",this._handleAsyncResource(n,t,r));case 7:if(!(a=this._rasterizer.rasterizeJSONResource(t,i))){e.next=11;break}return s=a.size,o=a.image,u=a.sdf,l=a.simplePattern,e.abrupt("return",this._addItemToMosaic(n,s,{type:"static",data:o},zt(t),u,l));case 11:return e.abrupt("return",new w.a("TextureManager","unrecognized or null rasterized image"));case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,i){return u.apply(this,arguments)})},{key:"_handleAsyncResource",value:(o=a(regeneratorRuntime.mark((function e(t,i,r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._ongoingRasterizations.has(t)){e.next=2;break}return e.abrupt("return",this._ongoingRasterizations.get(t));case 2:return n=Dt(i)?this._handleSVG(i,t,r):this._handleImage(i,t,r),this._ongoingRasterizations.set(t,n),e.prev=3,e.next=6,n;case 6:this._ongoingRasterizations.delete(t),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),this._ongoingRasterizations.delete(t);case 12:return e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this,[[3,9]])}))),function(e,t,i){return o.apply(this,arguments)})},{key:"_handleSVG",value:(s=a(regeneratorRuntime.mark((function e(t,i,r){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._sdfConverter.draw(t.path,r);case 2:return n=e.sent,e.abrupt("return",this._addItemToMosaic(i,[126,126],{type:"static",data:new Uint32Array(n.buffer)},!1,!0,!0));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,i){return s.apply(this,arguments)})},{key:"_handleGIFOrPNG",value:(n=a(regeneratorRuntime.mark((function e(i,r,n){var s,o,u,l,h,c,d,f,p,m,v,g;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,function(){var e=a(regeneratorRuntime.mark((function e(i,r){var n,a,s,o,u,l,h,c,d,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=i.imageData?"data:".concat(i.contentType,";base64,").concat(i.imageData):i.url,s=";base64,",-1===n.indexOf(s)){e.next=8;break}for(o=n.indexOf(s)+s.length,u=n.substring(o),l=atob(u),h=new Uint8Array(l.length),c=0;c<l.length;c++)h[c]=l.charCodeAt(c);a=h.buffer,e.next=20;break;case 8:return e.prev=8,e.next=11,Object(We.default)(n,t({responseType:"array-buffer"},r));case 11:d=e.sent,f=d.data,a=f,e.next=20;break;case 16:if(e.prev=16,e.t0=e.catch(8),Object(Ge.m)(e.t0)){e.next=20;break}return e.abrupt("return",new w.a("mapview-invalid-resource","Could not fetch requested resource at "+n));case 20:return e.abrupt("return",a);case 21:case"end":return e.stop()}}),e,null,[[8,16]])})));return function(t,i){return e.apply(this,arguments)}}()(i,n);case 2:if(s=e.sent,!Object(Ft.a)(s)){e.next=36;break}if(o=Mt(s),u=_t(s),o||u){e.next=7;break}return e.abrupt("return",new w.a("mapview-invalid-resource","Image data is neither GIF nor PNG!"));case 7:if(e.prev=7,!o||!function(e){if(!e||0===e.byteLength)return!1;var t=new Uint8Array(e);if(!Mt(t))return!1;for(var i=0,r=0,n=t.length-9;r<n&&(0!==t[r]||33!==t[r+1]||249!==t[r+2]||4!==t[r+3]||0!==t[r+8]||44!==t[r+9]&&33!==t[r+9]||!(++i>1));++r);return i>1}(s)){e.next=14;break}return e.next=11,Pt.create(s,n);case 11:l=e.sent,e.next=19;break;case 14:if(e.t0=u&&function(e){var t=new Uint8Array(e);if(!_t(t))return!1;var i=!1;return wt(t,(function(e){return!(i="acTL"===e)})),i}(s),!e.t0){e.next=19;break}return e.next=18,Tt.create(s,n);case 18:l=e.sent;case 19:e.next=25;break;case 21:if(e.prev=21,e.t1=e.catch(7),Object(Ge.m)(e.t1)){e.next=25;break}return e.abrupt("return",new w.a("mapview-invalid-resource","Could not fetch requested resource!"));case 25:if(!l||!Object(Ft.a)(l)){e.next=27;break}return e.abrupt("return",this._addItemToMosaic(r,[l.width,l.height],{type:"animated",data:l},zt(i),!1,!1));case 27:return h=new Blob([s],{type:o?"image/gif":"image/png"}),e.next=30,this._imageFromBlob(h);case 30:if(!((c=e.sent)&&c instanceof HTMLImageElement)){e.next=36;break}return d=c.width,f=c.height,"esriPMS"===i.type&&(d=Math.round(Bt(c.width,i.width)),f=Math.round(c.height*(d/c.width))),p=this._rasterizer.rasterizeImageResource(d,f,c,i.colorSubstitutions),m=p.size,v=p.sdf,g=p.image,e.abrupt("return",this._addItemToMosaic(r,m,{type:"static",data:g},zt(i),v,!1));case 36:return e.abrupt("return",new w.a("mapview-invalid-resource","Could not handle resource!"));case 37:case"end":return e.stop()}}),e,this,[[7,21]])}))),function(e,t,i){return n.apply(this,arguments)})},{key:"_handleImage",value:(r=a(regeneratorRuntime.mark((function e(i,r,n){var a,s,o,u,l,h,c,d,f;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!function(e){return e.url&&-1!==e.url.indexOf(".gif")||e.contentType&&"image/gif"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/gif")}(i)&&!function(e){return e.url&&-1!==e.url.indexOf(".png")||e.contentType&&"image/png"===e.contentType||e.imageData&&-1!==e.imageData.indexOf("data:image/png")}(i)){e.next=2;break}return e.abrupt("return",this._handleGIFOrPNG(i,r,n));case 2:return a=i.imageData?"data:".concat(i.contentType,";base64,").concat(i.imageData):i.url,e.prev=3,e.next=6,this._imageRequestQueue.push(a,t({},n));case 6:return s=e.sent,o=s.data,function(e){return-1!==e.indexOf("data:image/svg+xml")}(a)&&(o.width=Object(P.h)(i.width),o.height=Object(P.h)(i.height)),u=o.width,l=o.height,"esriPMS"===i.type&&(u=Math.round(Bt(o.width,i.width)),l=Math.round(o.height*(u/o.width))),h=this._rasterizer.rasterizeImageResource(u,l,o,i.colorSubstitutions),c=h.size,d=h.sdf,f=h.image,e.abrupt("return",this._addItemToMosaic(r,c,{type:"static",data:f},zt(i),d,!1));case 15:if(e.prev=15,e.t0=e.catch(3),Object(Ge.m)(e.t0)){e.next=19;break}return e.abrupt("return",new w.a("mapview-invalid-resource","Could not fetch requested resource at ".concat(a,". ").concat(e.t0.message)));case 19:case"end":return e.stop()}}),e,this,[[3,15]])}))),function(e,t,i){return r.apply(this,arguments)})},{key:"_imageFromBlob",value:(i=a(regeneratorRuntime.mark((function e(t){var i,r,n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=window.URL.createObjectURL(t),e.prev=1,e.next=4,this._imageRequestQueue.push(i);case 4:return r=e.sent,n=r.data,e.abrupt("return",(window.URL.revokeObjectURL(i),n));case 9:if(e.prev=9,e.t0=e.catch(1),window.URL.revokeObjectURL(i),Object(Ge.m)(e.t0)){e.next=13;break}return e.abrupt("return",new w.a("mapview-invalid-resource","Could not fetch requested resource at "+i));case 13:throw e.t0;case 14:case"end":return e.stop()}}),e,this,[[1,9]])}))),function(e){return i.apply(this,arguments)})},{key:"_addItemToMosaic",value:function(e,t,i,r,n,a){return this._spriteMosaic.addSpriteItem(e,t,i,r,n,a)}}]),e}())(n),this._effectsManager=new hi(n)}return m(e,[{key:"vectorTilesMaterialManager",get:function(){return this._vtlMaterialManager}},{key:"getRenderTarget",value:function(){return this._renderTarget}},{key:"setRenderTarget",value:function(e){this._renderTarget=e}},{key:"getFbos",value:function(e,t){if(e!==this._lastWidth||t!==this._lastHeight){if(this._lastWidth=e,this._lastHeight=t,this._fbos){for(var i in this._fbos)this._fbos[i].resize(e,t);return this._fbos}var r={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:e,height:t},n={colorTarget:0,depthStencilTarget:3},a=new me.a(this.context,{width:e,height:t,internalFormat:34041});this._stencilBuf=a,this._fbos={output:new he.a(this.context,n,r,a),blend:new he.a(this.context,n,r,a),effect0:new he.a(this.context,n,r,a)}}return this._fbos}},{key:"getSharedStencilBuffer",value:function(){return this._stencilBuf}},{key:"beforeRenderLayers",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=e.getViewport(),r=i.width,n=i.height;this._prevFBO=e.getBoundFramebufferObject();var a=this.getFbos(r,n);if(e.bindFramebuffer(a.output),e.setColorMask(!0,!0,!0,!0),e.setDepthWriteEnabled(!0),Object(T.k)(t)){var s=t.color,o=s.r,u=s.g,l=s.b,h=s.a;e.setClearColor(h*o/255,h*u/255,h*l/255,h)}else e.setClearColor(0,0,0,0);e.setClearDepth(1),e.clear(e.gl.COLOR_BUFFER_BIT|e.gl.DEPTH_BUFFER_BIT),e.setDepthWriteEnabled(!1)}},{key:"beforeRenderLayer",value:function(e,t,i){var r=e.context,n=e.blendMode,a=e.effects;if(e.requireFBO||di(n,a,i))r.bindFramebuffer(this._fbos.blend),r.setColorMask(!0,!0,!0,!0),r.setClearColor(0,0,0,0),r.clear(r.gl.COLOR_BUFFER_BIT);else{var s=this._getOutputFBO();r.bindFramebuffer(s)}r.setDepthWriteEnabled(!1),r.setDepthTestEnabled(!1),r.setStencilTestEnabled(!0),r.setClearStencil(t),r.setStencilWriteMask(255),r.clear(r.gl.STENCIL_BUFFER_BIT)}},{key:"compositeLayer",value:function(e,t){var i=e.context,r=e.blendMode,n=e.effects;if(e.requireFBO||di(r,n,t)){Object(T.k)(n)&&n.length>0&&e.drawPhase===fe.c.MAP&&this._applyEffects(e,n);var a=this._getOutputFBO();i.bindFramebuffer(a),i.setStencilTestEnabled(!1),i.setStencilWriteMask(0),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(1,771,1,771),i.setColorMask(!0,!0,!0,!0);var s=Object(T.k)(r)?r:"normal";this._blendEffect.draw(e,this._fbos.blend.colorTexture,9728,s,t)}}},{key:"renderLayers",value:function(e){if(e.bindFramebuffer(this._prevFBO),this._fbos){var t=this._getOutputFBO();e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),this.blitTexture(e,t.colorTexture,9728)}}},{key:"dispose",value:function(){if(this.materialManager.dispose(),this.textureManager.dispose(),this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null),this._brushCache&&(this._brushCache.forEach((function(e){return e.dispose()})),this._brushCache.clear(),this._brushCache=null),this._fbos)for(var e in this._fbos)this._fbos[e]&&this._fbos[e].dispose();if(this.effects)for(var t in this.effects)this.effects[t]&&this.effects[t].dispose();this._vtlMaterialManager&&(this._vtlMaterialManager.dispose(),this._vtlMaterialManager=null),this._prevFBO=null}},{key:"getGeometryBrush",value:function(e){var t,r=(t={},i(t,fe.d.FILL,ve.a.fill),i(t,fe.d.LINE,ve.a.line),i(t,fe.d.MARKER,ve.a.marker),i(t,fe.d.TEXT,ve.a.text),t)[e],n=this._brushCache.get(r);return void 0===n&&(n=new r,this._brushCache.set(r,n)),this._brushCache.get(r)}},{key:"renderObject",value:function(e,t,i,r){var n=ve.a[i];if(!n)return null;var a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.prepareState(e,t,r),a.draw(e,t,r)}},{key:"renderObjects",value:function(e,t,i,r){var n=ve.a[i];if(!n)return null;var a=this._brushCache.get(n);void 0===a&&(a=new n,this._brushCache.set(n,a)),a.drawMany(e,t,r)}},{key:"registerRenderPass",value:function(e){var t=this,i=e.brushes.map((function(e){return t._brushCache.has(e)||t._brushCache.set(e,new e),t._brushCache.get(e)}));return new(function(){function e(t,i){var r;f(this,e),this.brushes=t,this.name=i.name,this.drawPhase=i.drawPhase||fe.c.MAP,this._targetFn=i.target,this.effects=i.effects||[],this.enableDefaultDraw=null!=(r=i.enableDefaultDraw)?r:function(){return!0},this.has=i.has}return m(e,[{key:"render",value:function(e){var t=e.context,i=e.profiler,r=this._targetFn(),n=this.drawPhase&e.drawPhase;if(i.recordPassStart(this.name),n&&(!this.has||Object(p.a)(this.has))){this.enableDefaultDraw()&&this._doRender(e,r),i.recordPassEnd();var a,s=v(this.effects);try{for(s.s();!(a=s.n()).done;){var o=a.value;if(o.enable()){var u=o.apply;i.recordPassStart(this.name+"."+u.name),i.recordBrushStart(u.name);var l=o.args&&o.args(),h=t.getViewport(),c=h.x,d=h.y,f=h.width,m=h.height,g=t.getBoundFramebufferObject();u.bind(e,l),this._doRender(e,r,u.defines),u.draw(e,l),u.unbind(e,l),t.bindFramebuffer(g),t.setViewport(c,d,f,m),i.recordBrushEnd(),i.recordPassEnd()}}}catch(_){s.e(_)}finally{s.f()}}}},{key:"_doRender",value:function(e,t,i){if(!Object(T.j)(t))if(Object(ci.g)(t)){var r,n=v(t);try{for(n.s();!(r=n.n()).done;){var a=r.value;if(a.visible){var s,o=v(this.brushes);try{for(o.s();!(s=o.n()).done;){var u=s.value;e.profiler.recordBrushStart(u.name),u.prepareState(e,a,i),u.draw(e,a,i),e.profiler.recordBrushEnd()}}catch(d){o.e(d)}finally{o.f()}}}}catch(d){n.e(d)}finally{n.f()}}else{var l,h=v(this.brushes);try{for(h.s();!(l=h.n()).done;){var c=l.value;e.profiler.recordBrushStart(c.name),c.prepareState(e,t,i),c.draw(e,t,i),e.profiler.recordBrushEnd()}}catch(d){h.e(d)}finally{h.f()}}}}]),e}())(i,e)}},{key:"setHighlightOptions",value:function(e){this.effects.highlight.setHighlightOptions(e)}},{key:"blitTexture",value:function(e,t,i){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1;e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),this._blitRenderer.render(e,t,i,r)}},{key:"getPostProcessingEffects",value:function(e){return this._effectsManager.getPostProcessingEffects(e)}},{key:"_getOutputFBO",value:function(){return null!=this._renderTarget?this._renderTarget:this._fbos.output}},{key:"_applyEffects",value:function(e,t){var i,r=e.context,n=v(this._effectsManager.getPostProcessingEffects(t));try{for(n.s();!(i=n.n()).done;){var a=i.value,s=a.postProcessingEffect,o=a.effect;r.bindFramebuffer(this._fbos.blend),s.draw(e,this._fbos.blend,o)}}catch(u){n.e(u)}finally{n.f()}}}]),e}())(n.context,h(n)),Object(p.a)("esri-2d-profiler")&&(n._debugOutput=document.createElement("div"),n._debugOutput.setAttribute("style","margin: 24px 64px; position: absolute; color: red;"),e.appendChild(n._debugOutput)),n._renderParameters={drawPhase:0,state:n.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:n.context,painter:n.painter,timeline:r.timeline||new oe.a,renderingOptions:r.renderingOptions,requireFBO:!1,driverTestResult:(S=n.context,new bi(S)),profiler:new gi(n.context,n._debugOutput),dataUploadCounter:0},n._taskHandle=Object(J.a)({render:function(e){return n.renderFrame(e)}}),n._taskHandle.pause(),n._supersampleScreenshots=k,n._lostWebGLContextHandle=Object(Q.c)(u,"webglcontextlost",(function(){n.emit("webgl-error",{error:new w.a("webgl-context-lost")})})),u.setAttribute("style","width: 100%; height:100%; display:block;"),e.appendChild(u),n}return m(l,[{key:"destroy",value:function(){this.removeAllChildren(),this._emptyTrash(),this._taskHandle.remove(),this._taskHandle=null,this._boundFBO=null,this._clipFBO&&(this._clipFBO.dispose(),this._clipFBO=null),this._clipVAO&&(this._clipVAO.dispose(),this._clipVAO=null,this._clipVBO=null),this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null),this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null),this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas),this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput),this.highlightOptions=null,this._pools.bufferData.destroy(),this.painter.dispose(),this.context.dispose(),this._canvas=null}},{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"highlightOptions",get:function(){return this._highlightOptions},set:function(e){var t=this;this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null),this._highlightOptions=e,this._highlightOptions&&(this._highlightOptionsHandle=Object(ee.init)(this._highlightOptions,"version",(function(){t.painter.setHighlightOptions(e),t.requestRender()})))}},{key:"pools",get:function(){return this._pools}},{key:"renderingOptions",get:function(){return this._renderingOptions},set:function(e){this._renderingOptions=e,this.requestRender()}},{key:"state",get:function(){return this._state},set:function(e){this._state=e,this.requestRender()}},{key:"stationary",get:function(){return this._stationary},set:function(e){this._stationary!==e&&(this._stationary=e,this.requestRender())}},{key:"trashDisplayObject",value:function(e){this._trash.add(e),this.requestRender()}},{key:"untrashDisplayObject",value:function(e){return this._trash.delete(e)}},{key:"requestRender",value:function(){this._lastRenderRequestTime=performance.now(),this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())}},{key:"renderFrame",value:function(e){e.time-this._lastRenderRequestTime>=2e3&&this._taskHandle.pause(),this.renderRequested=!1,this._renderParameters.state=this._state,this._renderParameters.stationary=this.stationary,this._renderParameters.pixelRatio=window.devicePixelRatio,this._renderParameters.globalOpacity=1,this._renderParameters.time=e.time,this._renderParameters.deltaTime=e.deltaTime,this._renderParameters.effects=null,this.processRender(this._renderParameters),this._emptyTrash(),this.emit("post-render")}},{key:"renderChildren",value:function(e){var t,i=v(this.children);try{for(i.s();!(t=i.n()).done;){t.value.beforeRender(e)}}catch(a){i.e(a)}finally{i.f()}this._renderChildren(this.children,e);var r,n=v(this.children);try{for(n.s();!(r=n.n()).done;){r.value.afterRender(e)}}catch(a){n.e(a)}finally{n.f()}}},{key:"_renderChildren",value:function(e,t){var i=this.context;t.profiler.recordStart("drawLayers"),t.dataUploadCounter=0,this._beforeRenderChildren(t),t.drawPhase=fe.c.MAP,this.painter.beforeRenderLayers(i,this.background);var r,n=v(e);try{for(n.s();!(r=n.n()).done;){r.value.processRender(t)}}catch(c){n.e(c)}finally{n.f()}this.painter.renderLayers(i),t.drawPhase=fe.c.HIGHLIGHT,this.painter.beforeRenderLayers(i);var a,s=v(e);try{for(s.s();!(a=s.n()).done;){a.value.processRender(t)}}catch(c){s.e(c)}finally{s.f()}if(this.painter.renderLayers(i),this._isLabelDrawPhaseRequired(e)){t.drawPhase=fe.c.LABEL,this.painter.beforeRenderLayers(i);var o,u=v(e);try{for(u.s();!(o=u.n()).done;){o.value.processRender(t)}}catch(c){u.e(c)}finally{u.f()}this.painter.renderLayers(i)}if(Object(p.a)("esri-tiles-debug")){t.drawPhase=fe.c.DEBUG,this.painter.beforeRenderLayers(i);var l,h=v(e);try{for(h.s();!(l=h.n()).done;){l.value.processRender(t)}}catch(c){h.e(c)}finally{h.f()}this.painter.renderLayers(i)}t.profiler.recordEnd("drawLayers"),this._afterRenderChildren()}},{key:"_beforeRenderChildren",value:function(e){var t=this.context,i=e.state,r=e.pixelRatio;t.enforceState();var n=i.size,a=i.rotation,s=Math.round(n[0]*r),o=Math.round(n[1]*r);if(this._boundFBO=t.getBoundFramebufferObject(),i.spatialReference&&(i.spatialReference._isWrappable?i.spatialReference._isWrappable():i.spatialReference.isWrappable)){var u=Object($.d)(a),l=Math.abs(Math.cos(u)),h=Math.abs(Math.sin(u)),c=Math.round(s*l+o*h),d=Math.round(i.worldScreenWidth);if(c<=d)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===s&&this._clipFBO.height===o||(this._clipFBO=new he.a(t,{colorTarget:0,depthStencilTarget:3,width:s,height:o}));var f=(this.state.padding.left-this.state.padding.right)/2,p=(this.state.padding.bottom-this.state.padding.top)/2,m=.5*s,v=.5*o,g=1/s,_=1/o,y=d*r*.5,b=.5*(s*h+o*l),w=this._upperLeft,x=this._upperRight,k=this._lowerLeft,O=this._lowerRight;Object(re.r)(w,-y,-b),Object(re.r)(x,y,-b),Object(re.r)(k,-y,b),Object(re.r)(O,y,b),Object(ae.d)(this._mat2),Object(ae.h)(this._mat2,this._mat2,[m+f,v+p]),0!==a&&Object(ae.f)(this._mat2,this._mat2,u),Object(re.s)(w,w,this._mat2),Object(re.s)(x,x,this._mat2),Object(re.s)(k,k,this._mat2),Object(re.s)(O,O,this._mat2);var C=this._clipData;C.set([2*k[0]*g-1,2*(o-k[1])*_-1,2*O[0]*g-1,2*(o-O[1])*_-1,2*w[0]*g-1,2*(o-w[1])*_-1,2*x[0]*g-1,2*(o-x[1])*_-1]),this._clipRendererInitialized||this._initializeClipRenderer(t),this._clipVBO.setData(C),this._boundFBO=t.getBoundFramebufferObject(),t.bindFramebuffer(this._clipFBO),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),t.setClearColor(0,0,0,0),t.setClearDepth(1),t.setClearStencil(0),t.clear(t.gl.COLOR_BUFFER_BIT|t.gl.DEPTH_BUFFER_BIT|t.gl.STENCIL_BUFFER_BIT),t.setDepthWriteEnabled(!1),this._clipFrame=!0}}else this._clipFrame=!1}},{key:"_afterRenderChildren",value:function(){var e=this.context;if(e.logIno(),this._clipFrame&&this._clipRendererInitialized){if(e.bindFramebuffer(this._boundFBO),this._boundFBO=null,e.bindVAO(this._clipVAO),e.bindProgram(this._clipStencilProgram),e.setDepthWriteEnabled(!1),e.setDepthTestEnabled(!1),e.setStencilTestEnabled(!0),e.setBlendingEnabled(!1),e.setColorMask(!1,!1,!1,!1),e.setStencilOp(7680,7680,7681),e.setStencilWriteMask(255),e.setStencilFunction(519,1,255),e.drawElements(4,6,5123,0),e.bindVAO(),e.setColorMask(!0,!0,!0,!0),null!=this.background){var t=this.background.color,i=t.r,r=t.g,n=t.b,a=t.a;e.setClearColor(a*i/255,a*r/255,a*n/255,a)}else e.setClearColor(0,0,0,0);e.clear(e.gl.COLOR_BUFFER_BIT),e.setBlendingEnabled(!0),e.setStencilFunction(514,1,255),this.painter.blitTexture(e,this._clipFBO.colorTexture,9728,1),e.setStencilTestEnabled(!1)}}},{key:"doRender",value:function(e){var t=this.context,i=e.state,n=e.pixelRatio;this._resizeCanvas(e),this.context.enforceState(),t.setViewport(0,0,n*i.size[0],n*i.size[1]),t.setDepthWriteEnabled(!0),t.setStencilWriteMask(255),r(c(l.prototype),"doRender",this).call(this,e)}},{key:"takeScreenshot",value:(n=a(regeneratorRuntime.mark((function e(i,r){var n,a,s,o,u,l,h,c,d,f,p,m,v;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Object(ie.d)(i,this._supersampleScreenshots,this._state.padding),a=n.framebufferWidth,s=n.framebufferHeight,o=this.context,u=i.layers,l=this.children,h=t(t({},this._renderParameters),{},{drawPhase:null,globalOpacity:1,stationary:!0,state:this._renderParameters.state.clone(),pixelRatio:n.pixelRatio,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1}),null!=i.rotation&&((c=h.state.viewpoint).rotation=i.rotation,h.state.viewpoint=c),u.length>0&&(l=[],u.forEach((function(e){var t=r.find((function(t){return t.layer.id===e.id}));t&&"container"in t&&t.container&&l.push(t.container)}))),d=new he.a(o,{colorTarget:0,depthStencilTarget:3,width:a,height:s}),f=o.getBoundFramebufferObject(),p=o.getViewport(),o.bindFramebuffer(d),o.setViewport(0,0,a,s),this._renderChildren(l,h),m=this._readbackScreenshot(n),o.bindFramebuffer(f),o.setViewport(p.x,p.y,p.width,p.height),this.requestRender(),v=this._ensureScreenshotEncodeCanvas(),e.abrupt("return",Object(ie.b)(m,i,v,{flipY:!0,premultipliedAlpha:!0}));case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"_ensureScreenshotEncodeCanvas",value:function(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}},{key:"_readbackScreenshot",value:function(e){var t=e.framebufferWidth,i=e.framebufferHeight,r=e.region,n=e.resample,a=this.context.gl;if(n){var s=Object(ie.a)(t,i,this._ensureScreenshotEncodeCanvas());a.readPixels(0,0,t,i,6408,5121,new Uint8Array(s.data.buffer));var o=Object(ie.a)(r.width,r.height,this._ensureScreenshotEncodeCanvas());return Object(ie.c)(s,o,!0,n.region.x,i-(n.region.y+n.region.height),n.region.width,n.region.height)}var u=Object(ie.a)(r.width,r.height,this._ensureScreenshotEncodeCanvas());return a.readPixels(r.x,i-(r.y+r.height),r.width,r.height,6408,5121,new Uint8Array(u.data.buffer)),u}},{key:"_resizeCanvas",value:function(e){var t=this._canvas,i=t.style,r=e.state.size,n=e.pixelRatio,a=r[0],s=r[1],o=Math.round(a*n),u=Math.round(s*n);t.width===o&&t.height===u||(t.width=o,t.height=u),i.width=a+"px",i.height=s+"px"}},{key:"_initializeClipRenderer",value:function(e){if(this._clipRendererInitialized)return!0;var t=Fi.attributes,i=Object(ce.a)(e,Fi);if(!i)return!1;var r=ue.a.createVertex(e,35040,32),n=new Uint16Array([0,1,2,2,1,3]),a=ue.a.createIndex(e,35044,n),s=new le.a(e,t,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:r},a);return this._clipStencilProgram=i,this._clipVBO=r,this._clipVAO=s,this._clipRendererInitialized=!0,!0}},{key:"_emptyTrash",value:function(){for(;this._trash.size>0;){var e=Array.from(this._trash);this._trash.clear();for(var t=0,i=e;t<i.length;t++){i[t].processDetach()}}}},{key:"_isLabelDrawPhaseRequired",value:function(e){var t,i=!1,r=v(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(!(n instanceof pe.a)){i=i||!1;break}if(n.hasLabels)return!0;i=i||this._isLabelDrawPhaseRequired(n.children)}}catch(a){r.e(a)}finally{r.f()}return i}}]),l}(pe.a),Ii=o("Vh9r"),Di=o("q03O"),zi=o("SuVq"),Bi=o("y3LX"),Ei=o("qYtE"),Ai=function(e){s(i,e);var t=u(i);function i(e){var r;return f(this,i),(r=t.call(this,e))._container=null,r._overlay=null,r._backgroundShape=null,r._boxShape=null,r._box={x:0,y:0,width:0,height:0},r._redraw=r._redraw.bind(h(r)),r}return m(i,[{key:"destroy",value:function(){this.view=null}},{key:"view",set:function(e){var t=this;this._handles&&this._handles.forEach((function(e){e.remove()})),this._handles=null,this._destroyOverlay(),this._set("view",e),e&&(e.on("drag",["Shift"],(function(e){return t._handleDrag(e,1)})),e.on("drag",["Shift","Ctrl"],(function(e){return t._handleDrag(e,-1)})))}},{key:"_start",value:function(){this._createContainer(),this._createOverlay(),this.navigation.begin()}},{key:"_update",value:function(e,t,i,r){this._box.x=e,this._box.y=t,this._box.width=i,this._box.height=r,this._rafId||(this._rafId=requestAnimationFrame(this._redraw))}},{key:"_end",value:function(e,t,i,r,n){var a=this.view,s=a.toMap(Object(P.f)(e+.5*i,t+.5*r)),o=Math.max(i/a.width,r/a.height);-1===n&&(o=1/o),this._destroyOverlay(),this.navigation.end(),a.goTo({center:s,scale:a.scale*o})}},{key:"_updateBox",value:function(e,t,i,r){var n=this._boxShape;n.setAttributeNS(null,"x",""+e),n.setAttributeNS(null,"y",""+t),n.setAttributeNS(null,"width",""+i),n.setAttributeNS(null,"height",""+r),n.setAttributeNS(null,"class","esri-zoom-box__outline")}},{key:"_updateBackground",value:function(e,t,i,r){this._backgroundShape.setAttributeNS(null,"d",this._toSVGPath(e,t,i,r,this.view.width,this.view.height))}},{key:"_createContainer",value:function(){var e=document.createElement("div");e.className="esri-zoom-box__container",this.view.root.appendChild(e),this._container=e}},{key:"_createOverlay",value:function(){var e=this.view.width,t=this.view.height,i=document.createElementNS("http://www.w3.org/2000/svg","path");i.setAttributeNS(null,"d","M 0 0 L "+e+" 0 L "+e+" "+t+" L 0 "+t+" Z"),i.setAttributeNS(null,"class","esri-zoom-box__overlay-background");var r=document.createElementNS("http://www.w3.org/2000/svg","rect"),n=document.createElementNS("http://www.w3.org/2000/svg","svg");n.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink"),n.setAttributeNS(null,"class","esri-zoom-box__overlay"),n.appendChild(i),n.appendChild(r),this._container.appendChild(n),this._backgroundShape=i,this._boxShape=r,this._overlay=n}},{key:"_destroyOverlay",value:function(){this._container&&this._container.parentNode&&this._container.parentNode.removeChild(this._container),this._container=this._backgroundShape=this._boxShape=this._overlay=null}},{key:"_toSVGPath",value:function(e,t,i,r,n,a){var s=e+i,o=t+r;return"M 0 0 L "+n+" 0 L "+n+" "+a+" L 0 "+a+" ZM "+e+" "+t+" L "+e+" "+o+" L "+s+" "+o+" L "+s+" "+t+" Z"}},{key:"_handleDrag",value:function(e,t){var i,r,n,a,s=e.x,o=e.y,u=e.origin.x,l=e.origin.y;switch(s>u?(i=u,n=s-u):(i=s,n=u-s),o>l?(r=l,a=o-l):(r=o,a=l-o),e.action){case"start":this._start();break;case"update":this._update(i,r,n,a);break;case"end":this._end(i,r,n,a,t)}e.stopPropagation()}},{key:"_redraw",value:function(){if(this._rafId&&(this._rafId=null,this._overlay)){var e=this._box,t=e.x,i=e.y,r=e.width,n=e.height;this._updateBox(t,i,r,n),this._updateBackground(t,i,r,n),this._rafId=requestAnimationFrame(this._redraw)}}}]),i}(k.a);Object(l.a)([Object(y.b)()],Ai.prototype,"navigation",void 0),Object(l.a)([Object(y.b)()],Ai.prototype,"view",null);var Vi=Ai=Object(l.a)([Object(b.a)("esri.views.2d.navigation.ZoomBox")],Ai),Li=(o("4GrV"),o("Cy1f")),Ui=o("5DEt"),Ni=function(){function e(t){f(this,e),this.gain=t}return m(e,[{key:"update",value:function(e){if(this.hasLastValue){var t=this.computeDelta(e);this.updateDelta(t)}this.lastValue=e}},{key:"reset",value:function(){this.lastValue=void 0,this.filteredDelta=void 0}},{key:"hasLastValue",get:function(){return void 0!==this.lastValue}},{key:"hasFilteredDelta",get:function(){return void 0!==this.filteredDelta}},{key:"computeDelta",value:function(e){return e-this.lastValue}},{key:"updateDelta",value:function(e){this.filteredDelta=this.hasFilteredDelta?(1-this.gain)*this.filteredDelta+this.gain*e:e}}]),e}(),qi=function(){function e(t,i,r){f(this,e),this._initialVelocity=t,this._stopVelocity=i,this._friction=r,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}return m(e,[{key:"duration",get:function(){return this._duration}},{key:"isFinished",value:function(e){return e>this.duration}},{key:"friction",get:function(){return this._friction}},{key:"value",value:function(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}},{key:"valueDelta",value:function(e,t){var i=this.value(e);return this.value(e+t)-i}},{key:"valueFromInitialVelocity",value:function(e,t){t=Math.min(t,this.duration);var i=1-this.friction;return e*(Math.pow(i,t)-1)/Math.log(i)}}]),e}(),Hi=function(e){s(i,e);var t=u(i);function i(e,r,n,a,s){var o;return f(this,i),(o=t.call(this,e,r,n)).sceneVelocity=a,o.direction=s,o}return m(i,[{key:"value",value:function(e){return r(c(i.prototype),"valueFromInitialVelocity",this).call(this,this.sceneVelocity,e)}}]),i}(qi),Gi=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:300,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:12,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.84;f(this,e),this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.enabled=!0,this.time=new Ni(.6),this.screen=[new Ni(.4),new Ni(.4)],this.scene=[new Ni(.6),new Ni(.6),new Ni(.6)],this.tmpDirection=Object(Li.e)()}return m(e,[{key:"add",value:function(e,t,i){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(i)<.015)return;this.screen[0].update(e[0]),this.screen[1].update(e[1]),this.scene[0].update(t[0]),this.scene[1].update(t[1]),this.scene[2].update(t[2]),this.time.update(i)}}},{key:"reset",value:function(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;var e=this.screen[0].filteredDelta,t=this.screen[1].filteredDelta,i=Math.sqrt(e*e+t*t)/this.time.filteredDelta;return Math.abs(i)<this.minimumInitialVelocity?null:this.createMomentum(i,this.stopVelocity,this.friction)}},{key:"createMomentum",value:function(e,t,i){Object(Ui.v)(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);var r=Object(Ui.o)(this.tmpDirection);return r>0&&Object(Ui.d)(this.tmpDirection,this.tmpDirection,1/r),new Hi(e,t,i,r/this.time.filteredDelta,this.tmpDirection)}}]),e}(),Wi=function(e){s(i,e);var t=u(i);function i(e){var r;return f(this,i),(r=t.call(this,e)).animationTime=0,r.momentumEstimator=new Gi(500,6,.92),r.momentum=null,r.tmpMomentum=Object(Li.e)(),r.momentumFinished=!1,r.viewpoint=new Bi.a({targetGeometry:new zi.a,scale:0,rotation:0}),r.watch("momentumFinished",(function(e){e&&r.navigation.stop()})),r}return m(i,[{key:"begin",value:function(e,t){this.navigation.begin(),this.momentumEstimator.reset(),this.addToEstimator(t),this.previousDrag=t}},{key:"update",value:function(e,t){this.addToEstimator(t);var i=t.center.x,r=t.center.y,n=this.previousDrag;i=n?n.center.x-i:-i,r=n?r-n.center.y:r,e.viewpoint=Object(Ei.w)(this.viewpoint,e.viewpoint,[i||0,r||0]),this.previousDrag=t}},{key:"end",value:function(e,t){this.addToEstimator(t),this.momentum=e.navigation.momentumEnabled?this.momentumEstimator.evaluateMomentum():null,this.animationTime=0,this.momentum&&this.onAnimationUpdate(e),this.previousDrag=null,this.navigation.end()}},{key:"addToEstimator",value:function(e){var t=e.center.x,i=e.center.y,r=Object(P.g)(-t,i),n=Object(Li.g)(-t,i,0);this.momentumEstimator.add(r,n,.001*e.timestamp)}},{key:"onAnimationUpdate",value:function(e){var t=this;this.navigation.animationManager.animateContinous(e.viewpoint,(function(i,r){t.momentumFinished=!t.momentum||t.momentum.isFinished(t.animationTime);var n=.001*r;if(!t.momentumFinished){var a=t.momentum.valueDelta(t.animationTime,n);Object(Ui.d)(t.tmpMomentum,t.momentum.direction,a),Object(Ei.w)(i,i,t.tmpMomentum),e.constraints.constrainByGeometry(i)}t.animationTime+=n}))}},{key:"stopMomentumNavigation",value:function(){this.momentum&&(this.momentumEstimator.reset(),this.momentum=null,this.navigation.stop())}}]),i}(k.a);Object(l.a)([Object(y.b)()],Wi.prototype,"momentumFinished",void 0),Object(l.a)([Object(y.b)()],Wi.prototype,"viewpoint",void 0),Object(l.a)([Object(y.b)()],Wi.prototype,"navigation",void 0);var Zi=Wi=Object(l.a)([Object(b.a)("esri.views.2d.navigation.actions.Pan")],Wi),Ki=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;f(this,e),this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.maxVelocity=n,this.enabled=!0,this.value=new Ni(.8),this.time=new Ni(.3)}return m(e,[{key:"add",value:function(e,t){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(t)<.01)return;if(this.value.hasFilteredDelta){var i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(t),this.value.update(e)}}},{key:"reset",value:function(){this.value.reset(),this.time.reset()}},{key:"evaluateMomentum",value:function(){if(!this.enabled||!this.value.hasFilteredDelta)return null;var e=this.value.filteredDelta/this.time.filteredDelta;return e=Object(R.c)(e,-this.maxVelocity,this.maxVelocity),Math.abs(e)<this.minimumInitialVelocity?null:this.createMomentum(e,this.stopVelocity,this.friction)}},{key:"createMomentum",value:function(e,t,i){return new qi(e,t,i)}}]),e}(),Yi=function(e){s(i,e);var t=u(i);function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:3,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return f(this,i),t.call(this,e,r,n,a)}return m(i,[{key:"add",value:function(e,t){if(this.value.hasLastValue){for(var n=this.value.lastValue,a=e-n;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;e=n+a}r(c(i.prototype),"add",this).call(this,e,t)}}]),i}(Ki),Xi=function(e){s(i,e);var t=u(i);function i(e,r,n){return f(this,i),t.call(this,e,r,n)}return m(i,[{key:"value",value:function(e){var t=r(c(i.prototype),"value",this).call(this,e);return Math.exp(t)}},{key:"valueDelta",value:function(e,t){var n=r(c(i.prototype),"value",this).call(this,e),a=r(c(i.prototype),"value",this).call(this,e+t)-n;return Math.exp(a)}}]),i}(qi),Qi=function(e){s(i,e);var t=u(i);function i(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2.5,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.01,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:.95,a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:12;return f(this,i),t.call(this,e,r,n,a)}return m(i,[{key:"add",value:function(e,t){r(c(i.prototype),"add",this).call(this,Math.log(e),t)}},{key:"createMomentum",value:function(e,t,i){return new Xi(e,t,i)}}]),i}(Ki),Ji=function(e){s(i,e);var t=u(i);function i(e){var r;return f(this,i),(r=t.call(this,e))._animationTime=0,r._momentumFinished=!1,r._rotationMomentumEstimator=new Yi(.6,.15,.95),r._rotationDirection=1,r._zoomDirection=1,r._zoomMomentumEstimator=new Qi,r._zoomOnly=null,r.zoomMomentum=null,r.rotateMomentum=null,r.viewpoint=new Bi.a({targetGeometry:new zi.a,scale:0,rotation:0}),r.watch("_momentumFinished",(function(e){e&&r.navigation.stop()})),r}return m(i,[{key:"begin",value:function(e,t){this.navigation.begin(),this._rotationMomentumEstimator.reset(),this._zoomMomentumEstimator.reset(),this._zoomOnly=null,this._previousAngle=this._startAngle=t.angle,this._previousRadius=this._startRadius=t.radius,this._previousCenter=t.center,this._updateTimestamp=null,e.constraints.rotationEnabled&&this.addToRotateEstimator(0,t.timestamp),this.addToZoomEstimator(t,1)}},{key:"update",value:function(e,t){null===this._updateTimestamp&&(this._updateTimestamp=t.timestamp);var i=t.angle,r=t.radius,n=t.center,a=Math.abs(180*(i-this._startAngle)/Math.PI),s=Math.abs(r-this._startRadius),o=this._startRadius/r;if(this._previousRadius){var u=r/this._previousRadius,l=180*(i-this._previousAngle)/Math.PI;this._rotationDirection=l>=0?1:-1,this._zoomDirection=u>=1?1:-1,e.constraints.rotationEnabled?(null===this._zoomOnly&&t.timestamp-this._updateTimestamp>200&&(this._zoomOnly=s-a>0),null===this._zoomOnly||this._zoomOnly?l=0:this.addToRotateEstimator(i-this._startAngle,t.timestamp)):l=0,this.addToZoomEstimator(t,o),this.navigation.setViewpoint([n.x,n.y],1/u,l,[this._previousCenter.x-n.x,n.y-this._previousCenter.y])}this._previousAngle=i,this._previousRadius=r,this._previousCenter=n}},{key:"end",value:function(e){this.rotateMomentum=this._rotationMomentumEstimator.evaluateMomentum(),this.zoomMomentum=this._zoomMomentumEstimator.evaluateMomentum(),this._animationTime=0,(this.rotateMomentum||this.zoomMomentum)&&this.onAnimationUpdate(e),this.navigation.end()}},{key:"addToRotateEstimator",value:function(e,t){this._rotationMomentumEstimator.add(e,.001*t)}},{key:"addToZoomEstimator",value:function(e,t){this._zoomMomentumEstimator.add(t,.001*e.timestamp)}},{key:"canZoomIn",value:function(e){var t=e.constraints.effectiveMaxScale;return 0===t||e.scale>t}},{key:"canZoomOut",value:function(e){var t=e.constraints.effectiveMinScale;return 0===t||e.scale<t}},{key:"onAnimationUpdate",value:function(e){var t=this;this.navigation.animationManager.animateContinous(e.viewpoint,(function(i,r){var n=!t.canZoomIn(e)&&t._zoomDirection>1||!t.canZoomOut(e)&&t._zoomDirection<1,a=!t.rotateMomentum||t.rotateMomentum.isFinished(t._animationTime),s=n||!t.zoomMomentum||t.zoomMomentum.isFinished(t._animationTime),o=.001*r;if(t._momentumFinished=a&&s,!t._momentumFinished){var u=t.rotateMomentum?Math.abs(t.rotateMomentum.valueDelta(t._animationTime,o))*t._rotationDirection*180/Math.PI:0,l=t.zoomMomentum?Math.abs(t.zoomMomentum.valueDelta(t._animationTime,o)):1,h=Object(te.a)(),c=Object(te.a)();if(t._previousCenter){Object(re.r)(h,t._previousCenter.x,t._previousCenter.y),Object(Ei.j)(c,e.size,e.padding),Object(re.h)(h,h,c);var d=e.constraints,f=e.scale,p=f*l;l<1&&!d.canZoomInTo(p)?(l=f/d.effectiveMaxScale,t.zoomMomentum=null,t.rotateMomentum=null):l>1&&!d.canZoomOutTo(p)&&(l=f/d.effectiveMinScale,t.zoomMomentum=null,t.rotateMomentum=null),Object(Ei.t)(i,e.viewpoint,l,u,h,e.size),e.constraints.constrainByGeometry(i)}}t._animationTime+=o}))}},{key:"stopMomentumNavigation",value:function(){(this.rotateMomentum||this.zoomMomentum)&&(this.rotateMomentum&&(this._rotationMomentumEstimator.reset(),this.rotateMomentum=null),this.zoomMomentum&&(this._zoomMomentumEstimator.reset(),this.zoomMomentum=null),this.navigation.stop())}}]),i}(k.a);Object(l.a)([Object(y.b)()],Ji.prototype,"_momentumFinished",void 0),Object(l.a)([Object(y.b)()],Ji.prototype,"viewpoint",void 0),Object(l.a)([Object(y.b)()],Ji.prototype,"navigation",void 0);var $i=Ji=Object(l.a)([Object(b.a)("esri.views.2d.navigation.actions.Pinch")],Ji),er=Object(te.a)(),tr=Object(te.a)(),ir=function(e){s(i,e);var t=u(i);function i(e){var r;return f(this,i),(r=t.call(this,e))._previousCenter=Object(te.a)(),r.viewpoint=new Bi.a({targetGeometry:new zi.a,scale:0,rotation:0}),r}return m(i,[{key:"begin",value:function(e,t){this.navigation.begin(),Object(re.r)(this._previousCenter,t.center.x,t.center.y)}},{key:"update",value:function(e,t){var i=e.state,r=i.size,n=i.padding;Object(re.r)(er,t.center.x,t.center.y),Object(Ei.g)(tr,r,n),e.viewpoint=Object(Ei.r)(this.viewpoint,e.state.paddedViewState.viewpoint,Object(Ei.b)(tr,this._previousCenter,er)),Object(re.c)(this._previousCenter,er)}},{key:"end",value:function(){this.navigation.end()}}]),i}(k.a);Object(l.a)([Object(y.b)()],ir.prototype,"viewpoint",void 0),Object(l.a)([Object(y.b)()],ir.prototype,"navigation",void 0);var rr=ir=Object(l.a)([Object(b.a)("esri.views.2d.actions.Rotate")],ir),nr=new Bi.a({targetGeometry:new zi.a}),ar=[0,0],sr=function(e){s(l,e);var t,i,r,n,o=u(l);function l(e){var t;return f(this,l),(t=o.call(this,e))._endTimer=null,t.animationManager=null,t}return m(l,[{key:"initialize",value:function(){this.pan=new Zi({navigation:this}),this.rotate=new rr({navigation:this}),this.pinch=new $i({navigation:this}),this.zoomBox=new Vi({view:this.view,navigation:this})}},{key:"destroy",value:function(){this.zoomBox.destroy(),this.zoomBox=null,this.animationManager=null}},{key:"begin",value:function(){this._set("interacting",!0)}},{key:"end",value:function(){this._lastEventTimestamp=performance.now(),this._startTimer(250)}},{key:"zoom",value:(n=a(regeneratorRuntime.mark((function e(t){var i,r=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=r.length>1&&void 0!==r[1]?r[1]:this._getDefaultAnchor(),this.stop(),this.begin(),!this.view.constraints.snapToZoom||!this.view.constraints.effectiveLODs){e.next=3;break}return e.abrupt("return",t<1?this.zoomIn(i):this.zoomOut(i));case 3:this.setViewpoint(i,t,0,[0,0]);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"zoomIn",value:(r=a(regeneratorRuntime.mark((function e(t){var i,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.view,r=i.constraints.snapToNextScale(i.scale),e.abrupt("return",this._zoomToScale(r,t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"zoomOut",value:(i=a(regeneratorRuntime.mark((function e(t){var i,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this.view,r=i.constraints.snapToPreviousScale(i.scale),e.abrupt("return",this._zoomToScale(r,t));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"setViewpoint",value:function(e,t,i,r){this.begin(),this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,e,t,i,r),this.end()}},{key:"setViewpointImmediate",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[0,0],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:this._getDefaultAnchor();this.view.state.viewpoint=this._scaleRotateTranslateViewpoint(this.view.viewpoint,r,e,t,i)}},{key:"continousRotateClockwise",value:function(){var e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(function(e){Object(Ei.r)(e,e,-1)}))}},{key:"continousRotateCounterclockwise",value:function(){var e=this.get("view.viewpoint");this.animationManager.animateContinous(e,(function(e){Object(Ei.r)(e,e,1)}))}},{key:"resetRotation",value:function(){this.view.rotation=0}},{key:"continousPanLeft",value:function(){this._continuousPan([-10,0])}},{key:"continousPanRight",value:function(){this._continuousPan([10,0])}},{key:"continousPanUp",value:function(){this._continuousPan([0,10])}},{key:"continousPanDown",value:function(){this._continuousPan([0,-10])}},{key:"stop",value:function(){this.pan.stopMomentumNavigation(),this.animationManager.stop(),this.end(),null!==this._endTimer&&(clearTimeout(this._endTimer),this._endTimer=null,this._set("interacting",!1))}},{key:"_continuousPan",value:function(e){var t=this,i=this.get("view.viewpoint");this.animationManager.animateContinous(i,(function(i){Object(Ei.w)(i,i,e),t.view.constraints.constrainByGeometry(i)}))}},{key:"_startTimer",value:function(e){var t=this;return null!==this._endTimer||(this._endTimer=setTimeout((function(){t._endTimer=null;var e=performance.now()-t._lastEventTimestamp;e<250?t._endTimer=t._startTimer(e):t._set("interacting",!1)}),e)),this._endTimer}},{key:"_getDefaultAnchor",value:function(){var e=this.view,t=e.size,i=e.padding,r=i.left,n=i.right,a=i.top,s=i.bottom;return ar[0]=.5*(t[0]-n+r),ar[1]=.5*(t[1]-s+a),ar}},{key:"_zoomToScale",value:(t=a(regeneratorRuntime.mark((function e(t){var i,r,n,a,s,o,u,l,h,c=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=c.length>1&&void 0!==c[1]?c[1]:this._getDefaultAnchor(),r=this.view,n=r.constraints,a=r.scale,s=r.viewpoint,o=r.size,u=r.padding,l=n.canZoomInTo(t),h=n.canZoomOutTo(t),t<a&&!l||t>a&&!h){e.next=4;break}return e.abrupt("return",(Object(Ei.p)(nr,s,t/a,0,i,o,u),n.constrainByGeometry(nr),r.goTo(nr,{animate:!0})));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"_scaleRotateTranslateViewpoint",value:function(e,t,i,r,n){var a=this.view,s=a.size,o=a.padding,u=a.constraints,l=a.scale,h=a.viewpoint,c=l*i,d=u.canZoomInTo(c),f=u.canZoomOutTo(c);return(i<1&&!d||i>1&&!f)&&(i=1),Object(Ei.w)(h,h,n),Object(Ei.p)(e,h,i,r,t,s,o),u.constrainByGeometry(e)}}]),l}(k.a);Object(l.a)([Object(y.b)()],sr.prototype,"animationManager",void 0),Object(l.a)([Object(y.b)({type:Boolean,readOnly:!0})],sr.prototype,"interacting",void 0),Object(l.a)([Object(y.b)()],sr.prototype,"pan",void 0),Object(l.a)([Object(y.b)()],sr.prototype,"pinch",void 0),Object(l.a)([Object(y.b)()],sr.prototype,"rotate",void 0),Object(l.a)([Object(y.b)()],sr.prototype,"view",void 0),Object(l.a)([Object(y.b)()],sr.prototype,"zoomBox",void 0);var or=sr=Object(l.a)([Object(b.a)("esri.views.2d.navigation.MapViewNavigation")],sr),ur=o("r0DZ"),lr=o("fEsP"),hr=o("LbAs"),cr={shaders:{vertexShader:Object(Be.a)("magnifier/magnifier.vert"),fragmentShader:Object(Be.a)("magnifier/magnifier.frag")},attributes:{a_pos:0}},dr=function(e){s(i,e);var t=u(i);function i(){var e;return f(this,i),(e=t.call(this))._handles=new ur.a,e._resourcePixelRatio=1,e.visible=!1,e}return m(i,[{key:"destroy",value:function(){this._handles.destroy(),this._handles=null,this._disposeRenderResources(),this._resourcesTask&&(this._resourcesTask.abort(),this._resourcesTask=null)}},{key:"background",get:function(){return this._background},set:function(e){this._background=e,this.requestRender()}},{key:"magnifier",get:function(){return this._magnifier},set:function(e){var t=this;this._magnifier=e,this._handles.removeAll(),this._handles.add([Object(ee.init)(e,"version",(function(){t.visible=e.visible&&Object(T.k)(e.position)&&e.size>0,t.requestRender()})),e.watch(["mask","overlay"],(function(){return t._reloadResources()})),e.watch("size",(function(){t._disposeRenderResources(),t.requestRender()}))])}},{key:"doRender",value:function(e){var t,i=e.context;if(this._resourcesTask){if(e.drawPhase===fe.c.MAP&&this._canRender()){this._updateResources(e);var r=this._magnifier;if(!Object(T.j)(r.position)){var n=e.pixelRatio,a=r.size*n,s=Math.ceil(1/r.factor*a);this._readbackTexture.resize(s,s);var o=e.state.size,u=n*o[0],l=n*o[1],h=.5*s,c=.5*s,d=Object(R.c)(n*r.position.x,h,u-h-1),f=Object(R.c)(l-n*r.position.y,c,l-c-1);i.setBlendingEnabled(!0);var p=d-h,m=f-c,v=this._readbackTexture;i.bindTexture(v,0),i.gl.copyTexImage2D(v.descriptor.target,0,v.descriptor.pixelFormat,p,m,s,s,0);var g=null==(t=this.background)?void 0:t.color,_=g?[g.a*g.r/255,g.a*g.g/255,g.a*g.b/255,g.a]:[1,1,1,1],y=(d+r.offset.x*n)/u*2-1,b=(f-r.offset.y*n)/l*2-1,w=a/u*2,x=a/l*2,k=this._program;i.bindVAO(this._vertexArrayObject),i.bindTexture(this._overlayTexture,6),i.bindTexture(this._maskTexture,7),i.bindProgram(k),k.setUniform4fv("u_background",_),k.setUniform1i("u_readbackTexture",0),k.setUniform1i("u_overlayTexture",6),k.setUniform1i("u_maskTexture",7),k.setUniform4f("u_drawPos",y,b,w,x),k.setUniform1i("u_maskEnabled",r.maskEnabled?1:0),k.setUniform1i("u_overlayEnabled",r.overlayEnabled?1:0),i.setStencilTestEnabled(!1),i.setColorMask(!0,!0,!0,!0),i.drawArrays(5,0,4),i.bindVAO()}}}else this._reloadResources()}},{key:"_canRender",value:function(){return this.mask&&this.overlay&&null!=this._magnifier}},{key:"_reloadResources",value:function(){var e=this;this._resourcesTask&&this._resourcesTask.abort();var t=Object(T.k)(this._magnifier)?this._magnifier.maskUrl:null,i=Object(T.k)(this._magnifier)?this._magnifier.overlayUrl:null;this._resourcesTask=Object(Ge.h)(function(){var r=a(regeneratorRuntime.mark((function r(n){var s,u,l,h,c,d,f;return regeneratorRuntime.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return s=Object(T.j)(t)||Object(T.j)(i)?function(){var e=a(regeneratorRuntime.mark((function e(t){var i,r,n,a,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=o.e(151).then(o.bind(null,"RzSf")),r=o.e(152).then(o.bind(null,"o3Xd")),e.t0=Object(hr.a),e.next=5,i;case 5:return e.t1=e.sent.default,e.t2={signal:t},n=(0,e.t0)(e.t1,e.t2),e.t3=Object(hr.a),e.next=11,r;case 11:return e.t4=e.sent.default,e.t5={signal:t},a=(0,e.t3)(e.t4,e.t5),e.next=16,n;case 16:return e.t6=e.sent,e.next=19,a;case 19:return e.t7=e.sent,s={mask:e.t6,overlay:e.t7},e.abrupt("return",(Object(Ge.u)(t),s));case 22:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()(n):null,u=Object(T.k)(t)?Object(We.default)(t,{responseType:"image",signal:n}).then((function(e){return e.data})):s.then((function(e){return e.mask})),l=Object(T.k)(i)?Object(We.default)(i,{responseType:"image",signal:n}).then((function(e){return e.data})):s.then((function(e){return e.overlay})),r.next=5,Promise.all([u,l]);case 5:h=r.sent,c=g(h,2),d=c[0],f=c[1],e.mask=d,e.overlay=f,e._disposeRenderResources(),e.requestRender();case 10:case"end":return r.stop()}}),r)})));return function(e){return r.apply(this,arguments)}}())}},{key:"_disposeRenderResources",value:function(){this._readbackTexture=Object(T.f)(this._readbackTexture),this._overlayTexture=Object(T.f)(this._overlayTexture),this._maskTexture=Object(T.f)(this._maskTexture),this._vertexArrayObject=Object(T.f)(this._vertexArrayObject),this._program=Object(T.f)(this._program)}},{key:"_updateResources",value:function(e){if(e.pixelRatio!==this._resourcePixelRatio&&this._disposeRenderResources(),!this._readbackTexture){var t=e.context;this._resourcePixelRatio=e.pixelRatio;var i=Math.ceil(this._magnifier.size*e.pixelRatio);this._program=function(e){return Object(ce.a)(e,cr)}(t);var r=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new le.a(t,cr.attributes,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:ue.a.createVertex(t,35044,r)}),this.overlay.width=i,this.overlay.height=i,this._overlayTexture=new Qe.a(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0,preMultiplyAlpha:!Object(x.w)(this.overlay.src)||!e.driverTestResult.svgAlwaysPremultipliesAlpha},this.overlay),this.mask.width=i,this.mask.height=i,this._maskTexture=new Qe.a(t,{target:3553,pixelFormat:6406,internalFormat:6406,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);var n=1/this._magnifier.factor;this._readbackTexture=new Qe.a(t,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.ceil(n*i),height:Math.ceil(n*i)})}}}]),i}(lr.a)}}])}();