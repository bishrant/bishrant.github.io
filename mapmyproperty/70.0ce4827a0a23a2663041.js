(function(){(this||window).webpackJsonp.registerAbsMids({"arcgis-js-api/core/requireUtils":"ADZV","esri/core/requireUtils":"ADZV","esri/layers/support/FieldsIndex":"I90O","arcgis-js-api/layers/support/FieldsIndex":"I90O","arcgis-js-api/layers/support/Field":"KQcO","esri/layers/support/Field":"KQcO","esri/views/2d/layers/features/support/DataTile":"KgG2","esri/core/SetPool":"L6z/","esri/layers/support/fieldType":"Q3lp","esri/views/2d/layers/features/support/DataTileFeaturesIndex":"W1uT","esri/views/2d/layers/features/controllers/EditsQueue":"ak1O","esri/views/2d/layers/features/support/TileUpdateQueue":"sOkP","esri/views/2d/layers/features/controllers/OnDemandController":"uqzM"})})(),(window.webpackJsonp=window.webpackJsonp||[]).push([[70],{ADZV:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r("7bfM"),r("qsST"),r("qMld")],void 0===(n=(function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0});var o=i.getLogger("esri.core.requireUtils");t.when=function e(t,i){return r.deprecatedFunction(o,"when",{moduleName:"requireUtils",replacement:"Use `promiseUtils.create()` instead.",version:"4.10",warnOnce:!0}),Array.isArray(i)?n.create((function(e){t(i,(function(){for(var t=[],r=0;r<arguments.length;r++)t[r]=arguments[r];e(t)}))})):e(t,[i]).then((function(e){return e[0]}))},t.getAbsMid=function(e,t,r){return t.toAbsMid?t.toAbsMid(e):r.id.replace(/\/[^\/]*$/gi,"/")+e}}).apply(null,i))||(e.exports=n)},I90O:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r("xhoE")],void 0===(n=(function(e,t,r){function i(e){return"date"===e.type||"esriFieldTypeDate"===e.type}function n(e){return e.toLowerCase().trim()}return function(){function e(e){if(this.fields=e,this._fieldsMap=new Map,this._dateFieldsSet=new Set,this.dateFields=[],e){for(var t=[],r=0,o=e;r<o.length;r++){var s=o[r],u=s&&s.name;if(u){var a=n(u);this._fieldsMap.set(u,s),this._fieldsMap.set(a,s),t.push(a),i(s)&&(this.dateFields.push(s),this._dateFieldsSet.add(s))}}t.sort(),this.uid=t.join(",")}}return e.prototype.destroy=function(){this._fieldsMap.clear()},e.prototype.has=function(e){return null!=this.get(e)},e.prototype.get=function(e){return null!=e?this._fieldsMap.get(e)||this._fieldsMap.get(n(e)):void 0},e.prototype.isDateField=function(e){return this._dateFieldsSet.has(this.get(e))},e.prototype.normalizeFieldName=function(e){var t=this.get(e);if(t)return t.name},e}()}).apply(null,i))||(e.exports=n)},KQcO:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r("9opi"),r("qKT0"),r("ImIS"),r("ycL1"),r("Vx27"),r("1dvD"),r("ZsQS"),r("Q3lp")],void 0===(n=(function(e,t,r,i,n,o,s,u,a,l){var d=new n.default({binary:"binary",coordinate:"coordinate",countOrAmount:"count-or-amount",dateAndTime:"date-and-time",description:"description",locationOrPlaceName:"location-or-place-name",measurement:"measurement",nameOrTitle:"name-or-title",none:"none",orderedOrRanked:"ordered-or-ranked",percentageOrRatio:"percentage-or-ratio",typeOrCategory:"type-or-category",uniqueIdentifier:"unique-identifier"});return function(e){function t(t){var r=e.call(this,t)||this;return r.alias=null,r.defaultValue=void 0,r.description=null,r.domain=null,r.editable=!0,r.length=-1,r.name=null,r.nullable=!0,r.type=null,r.valueType=null,r}var n;return r(t,e),n=t,t.prototype.readDescription=function(e,t){var r,i=t.description;try{r=JSON.parse(i)}catch(e){}return r?r.value:null},t.prototype.readValueType=function(e,t){var r,i=t.description;try{r=JSON.parse(i)}catch(e){}return r?d.fromJSON(r.fieldValueType):null},t.prototype.clone=function(){return new n({alias:this.alias,defaultValue:this.defaultValue,description:this.description,domain:this.domain&&this.domain.clone()||null,editable:this.editable,length:this.length,name:this.name,nullable:this.nullable,type:this.type,valueType:this.valueType})},i([s.property({type:String,json:{write:!0}})],t.prototype,"alias",void 0),i([s.property({type:[String,Number],json:{write:{allowNull:!0}}})],t.prototype,"defaultValue",void 0),i([s.property()],t.prototype,"description",void 0),i([s.reader("description")],t.prototype,"readDescription",null),i([s.property({types:a.types,json:{read:{reader:a.fromJSON},write:!0}})],t.prototype,"domain",void 0),i([s.property({type:Boolean,json:{write:!0}})],t.prototype,"editable",void 0),i([s.property({type:u.Integer,json:{write:!0}})],t.prototype,"length",void 0),i([s.property({type:String,json:{write:!0}})],t.prototype,"name",void 0),i([s.property({type:Boolean,json:{write:!0}})],t.prototype,"nullable",void 0),i([s.enumeration.serializable()(l.kebabDict)],t.prototype,"type",void 0),i([s.property()],t.prototype,"valueType",void 0),i([s.reader("valueType",["description"])],t.prototype,"readValueType",null),n=i([s.subclass("esri.layers.support.Field")],t)}(s.declared(o.JSONSupport))}).apply(null,i))||(e.exports=n)},KgG2:function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this.displayTile=null,this.tile=null,this.done=!1,this.queryInfoHash=null,this.returnExceeded=!1}return Object.defineProperty(e.prototype,"key",{get:function(){return this.tile.key},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"id",{get:function(){return this.tile.id},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"bounds",{get:function(){return this.tile.bounds},enumerable:!0,configurable:!0}),e}();t.default=r}).apply(null,i))||(e.exports=n)},"L6z/":function(e,t,r){var i,n;i=[r.dj.c(e.i),t],void 0===(n=(function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(){this._pool=[],this._set=new Set}return e.prototype.acquire=function(){if(0===this._pool.length)return new Set;var e=this._pool.pop();return this._set.delete(e),e},e.prototype.release=function(e){e&&!this._set.has(e)&&(e.clear(),this._pool.length<5e4&&(this._pool.push(e),this._set.add(e)))},e.acquire=function(){return i.acquire()},e.release=function(e){return i.release(e)},e}();t.default=r;var i=new r}).apply(null,i))||(e.exports=n)},Q3lp:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r("ImIS")],void 0===(n=(function(e,t,r){Object.defineProperty(t,"__esModule",{value:!0}),t.kebabDict=new r.default({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"oid",esriFieldTypeGeometry:"geometry",esriFieldTypeBlob:"blob",esriFieldTypeRaster:"raster",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"global-id",esriFieldTypeXML:"xml"})}).apply(null,i))||(e.exports=n)},W1uT:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r("L6z/"),r("rfv1"),r("fUL3")],void 0===(n=(function(e,t,r,i,n){Object.defineProperty(t,"__esModule",{value:!0});var o=[],s=new Set,u=function(){function e(){this._tileById=new Map,this._tilesToFeatures=new Map,this._featureToTiles=new Map}return e.prototype.destroy=function(){this.clear()},e.prototype.add=function(e){var t=this;if(!this.has(e.id)){var i=e;this._tileById.set(i.id,i),this._tilesToFeatures.set(i,r.default.acquire()),this._tilesToFeatures.forEach((function(e,r){i!==r&&(n.isParentOf(i,r)?e.forEach((function(e){t._link(i,e)})):n.isChildOf(i,r)&&t.featureStore.forEachInBounds(i.bounds,(function(r){e.has(r.objectId)&&t._link(i,r.objectId)})))}))}},e.prototype.clear=function(){this._tilesToFeatures.forEach((function(e){return r.default.release(e)})),this._tilesToFeatures.clear(),this._featureToTiles.forEach((function(e){return r.default.release(e)})),this._featureToTiles.clear(),this._tileById.clear()},e.prototype.delete=function(e){var t=this,r=this.get(e.id);o.length=0,this._tilesToFeatures.get(r).forEach((function(e){var i=t._featureToTiles.get(e);i.has(r)&&1===i.size?o.push(e):t._unlink(r,e)}));for(var i=0,n=o;i<n.length;i++)this._unlink(r,n[i]);this.featureStore.removeManyById(o),this._tilesToFeatures.delete(r),this._tileById.delete(r.id),o.length=0},e.prototype.forEach=function(e,t){return this._tileById.forEach(e,t)},e.prototype.get=function(e){return this._tileById.get(e)},e.prototype.has=function(e){return this._tileById.has(e)},e.prototype.setTileFeatures=function(e,t){var i=this,n=this.get(e.id);this._tilesToFeatures.has(n)||(this._tileById.set(n.id,n),this._tilesToFeatures.set(n,r.default.acquire()));for(var u=0,a=t;u<a.length;u++)s.add(a[u].objectId);o.length=0,this._tilesToFeatures.get(n).forEach((function(e){if(!s.has(e)){var t=i._featureToTiles.get(e);t.has(n)&&1===t.size?o.push(e):i._unlink(n,e)}}));for(var l=0,d=o;l<d.length;l++)this._unlink(n,d[l]);this.featureStore.removeManyById(o),this.featureStore.addMany(t),s.forEach((function(e){i._link(n,e)})),s.clear(),o.length=0},e.prototype.addOrUpdateFeatures=function(e){for(var t=this,r=new Set,n=new i.default({geometryType:this.featureStore.geometryType,hasM:this.featureStore.hasM,hasZ:this.featureStore.hasZ}),o=0,s=this.deleteFeaturesById(e.map((function(e){return e.objectId})));o<s.length;o++)r.add(s[o]);n.addMany(e),this._tileById.forEach((function(e){n.forEachInBounds(e.bounds,(function(i){t._link(e,i.objectId),r.add(e)}))})),this.featureStore.addMany(e);var u=[];return r.forEach((function(e){return u.push(e)})),u},e.prototype.deleteFeaturesById=function(e){for(var t=this,i=new Set,n=this,o=0,s=e;o<s.length;o++)!function(e){var o=n._featureToTiles.get(e);o&&(o.forEach((function(r){i.add(r),t._tilesToFeatures.get(r).delete(e)})),r.default.release(o),n._featureToTiles.delete(e))}(s[o]);this.featureStore.removeManyById(e);var u=[];return i.forEach((function(e){return u.push(e)})),u},e.prototype._link=function(e,t){this._featureToTiles.get(t)||this._featureToTiles.set(t,r.default.acquire()),this._featureToTiles.get(t).add(e),this._tilesToFeatures.get(e).add(t)},e.prototype._unlink=function(e,t){this._featureToTiles.get(t).delete(e),this._tilesToFeatures.get(e).delete(t),0===this._featureToTiles.get(t).size&&(r.default.release(this._featureToTiles.get(t)),this._featureToTiles.delete(t))},e}();t.default=u}).apply(null,i))||(e.exports=n)},ak1O:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r("qKT0"),r("Q2wQ"),r("HZ3d"),r("9opi"),r("Gtr7"),r("qMld"),r("Vx27"),r("2Kdy")],void 0===(n=(function(e,t,r,i,n,o,s,u,a){Object.defineProperty(t,"__esModule",{value:!0});var l=function(e){function t(t){var r=e.call(this,t)||this;return r._queue=[],r._onGoingRequest=null,r._abortController=u.createAbortController(),r}return o(t,e),t.prototype.destroy=function(){this.clear()},Object.defineProperty(t.prototype,"updating",{get:function(){return!this.destroyed&&(this._queue.length>0||null!=this._onGoingRequest)},enumerable:!0,configurable:!0}),t.prototype.clear=function(){if(this.destroyed)throw new Error("instance is already destroyed");for(var e=this._queue.pop();e;)e.resolver.reject(u.createAbortError()),e=this._queue.pop();this._queue.length=0,this._abortController.abort(),this._abortController=u.createAbortController()},t.prototype.push=function(e){return n(this,void 0,void 0,(function(){var t,r=this;return i(this,(function(i){if(this.destroyed)throw new Error("instance is already destroyed");return t=u.createResolver(),this._queue.push({event:e,resolver:t}),this.notifyChange("updating"),Promise.resolve().then((function(){r._processNext()})),[2,t.promise]}))}))},t.prototype._processNext=function(){return n(this,void 0,void 0,(function(){var e,t,r,n,o,s,u,a,l,d,c,h,p,f,y,g,_,v,b,T,m,I=this;return i(this,(function(i){switch(i.label){case 0:if(this._onGoingRequest)return[2];for(e=[],t=new Set,r=new Set,n=new Set,o=this._queue.shift();o;){for(u=(s=o.event).addedFeatures,a=s.deletedFeatures,l=s.updatedFeatures,e.push(o.resolver),d=0,c=u;d<c.length;d++)b=(h=c[d]).objectId,h.error||(t.add(b),r.add(b),n.delete(b));for(p=0,f=l;p<f.length;p++)b=(y=f[p]).objectId,y.error||(r.add(b),n.delete(b));for(g=0,_=a;g<_.length;g++)b=(v=_[g]).objectId,v.error||(t.has(b)?t.delete(b):n.add(b),r.delete(b));o=this._queue.shift()}return r.size||n.size?(T=[],m=[],r.size&&r.forEach((function(e){T.push(e)})),n.size&&n.forEach((function(e){m.push(e)})),this._onGoingRequest=Promise.resolve().then((function(){return I.processEdits(T,m,{signal:I._abortController.signal})})).catch((function(){})),this.notifyChange("updating"),[4,this._onGoingRequest]):(this.notifyChange("updating"),e.forEach((function(e){return e()})),[2]);case 1:return i.sent(),this._onGoingRequest=null,this.notifyChange("updating"),e.forEach((function(e){return e()})),this._queue.length>0&&this._processNext(),[2]}}))}))},r([a.property({constructOnly:!0})],t.prototype,"processEdits",void 0),r([a.property({readOnly:!0})],t.prototype,"updating",null),r([a.subclass("esri.views.2d.layers.features.controllers.EditsQueue")],t)}(a.declared(s));t.EditsQueue=l}).apply(null,i))||(e.exports=n)},sOkP:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r("9opi"),r("qKT0"),r("Q2wQ"),r("HZ3d"),r("Gtr7"),r("qMld"),r("afW+"),r("Vx27"),r("W9tT"),r("ked+")],void 0===(n=(function(e,t,r,i,n,o,s,u,a,l,d,c){Object.defineProperty(t,"__esModule",{value:!0});var h=[0,0],p=function(e){function t(t){var r=e.call(this,t)||this;return r._queue=new Map,r._isPaused=!1,r._scheduledNextHandle=null,r._timestamp=Date.now(),r.tileInfoView=null,r._next=r._next.bind(r),r._finalize=r._finalize.bind(r),r}return r(t,e),Object.defineProperty(t.prototype,"length",{get:function(){return this._queue.size},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return this._queue.size>0||null!=this._onGoingTile},enumerable:!0,configurable:!0}),t.prototype.abort=function(e){this._onGoingTile&&this._onGoingTile.tileId===e&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null),this._queue.delete(e),this._scheduleNext(),this.notifyChange("updating")},t.prototype.clear=function(){this._queue.clear(),this._onGoingTile&&(this._onGoingTile.abortController.abort(),this._onGoingTile=null),this._cancelNext(),this.notifyChange("updating")},t.prototype.has=function(e){return this._queue.has(e)},t.prototype.isOngoing=function(e){return this._onGoingTile&&this._onGoingTile.tileId===e},t.prototype.pause=function(){this._isPaused||(this._isPaused=!0,this._cancelNext())},t.prototype.push=function(e,t){if(!this._queue.has(e)){var r=u.createAbortController();this._queue.set(e,{tileId:e,key:c.TileKey.pool.acquire(e),timestamp:t||this._timestamp,abortController:r}),this._scheduleNext(),this.notifyChange("updating")}},t.prototype.refresh=function(){this._timestamp=Date.now(),this.reset()},t.prototype.reset=function(){var e=this._onGoingTile;e&&this.push(e.tileId,this._timestamp),this.notifyChange("updating")},t.prototype.resume=function(){this._isPaused&&(this._isPaused=!1,this._scheduleNext()),this.notifyChange("updating")},t.prototype._finalize=function(){this._onGoingTile=null,this.notifyChange("updating"),this._scheduleNext()},t.prototype._cancelNext=function(){this._scheduledNextHandle&&(this._scheduledNextHandle.remove(),this._scheduledNextHandle=null)},t.prototype._scheduleNext=function(){this._isPaused||this._scheduledNextHandle||0===this._queue.size||null!=this._onGoingTile||(this._scheduledNextHandle=a.schedule(this._next))},t.prototype._next=function(){return o(this,void 0,void 0,(function(){var e,t,r,i;return n(this,(function(n){switch(n.label){case 0:if(null==this._scheduledNextHandle||0===this._queue.size||this._onGoingTile)return this._scheduledNextHandle=null,[2];if(this._scheduledNextHandle=null,e=this._peek(),t=e.abortController.signal,r=e.tileId,c.TileKey.pool.release(e.key),this._queue.delete(r),this._onGoingTile=e,i=this.process(r,this._timestamp,{signal:t}),this.notifyChange("updating"),!function(e){return e&&"function"==typeof e.then}(i))return[3,4];n.label=1;case 1:return n.trys.push([1,3,,4]),[4,i];case 2:case 3:return n.sent(),[3,4];case 4:return this._finalize(),[2]}}))}))},t.prototype._peek=function(){var e=this;if(!this.state)throw new Error("state not set");var t=this.tileInfoView,r=this.state.center,i=Number.NEGATIVE_INFINITY,n=Number.POSITIVE_INFINITY,o=null;return this._queue.forEach((function(s){t.getTileCoords(h,s.key);var u=e._timestamp-s.timestamp;if(isNaN(u))(a=d.vec2.distance(h,r))<n&&(n=a,o=s);else if(u===i){var a;(a=d.vec2.distance(h,r))<n&&(n=a,o=s)}else u>i&&(i=u,n=Number.POSITIVE_INFINITY,o=s)})),o},i([l.property({readOnly:!0})],t.prototype,"length",null),i([l.property({constructOnly:!0})],t.prototype,"process",void 0),i([l.property()],t.prototype,"state",void 0),i([l.property({constructOnly:!0})],t.prototype,"tileInfoView",void 0),i([l.property({readOnly:!0})],t.prototype,"updating",null),i([l.subclass("esri.views.2d.layers.features.support.TileUpdateQueue")],t)}(l.declared(s));t.default=p}).apply(null,i))||(e.exports=n)},uqzM:function(e,t,r){var i,n;i=[r.dj.c(e.i),t,r("9opi"),r("qKT0"),r("2Atf"),r("Q2wQ"),r("HZ3d"),r("QVms"),r("ma1f"),r("H1tY"),r("qsST"),r("VCyw"),r("qMld"),r("8MXS"),r("8V7H"),r("Vx27"),r("N7S/"),r("Lzvl"),r("+6sX"),r("B16N"),r("YaB4"),r("Btct"),r("ak1O"),r("KgG2"),r("W1uT"),r("fUL3"),r("sOkP"),r("EBSo")],void 0===(n=(function(e,t,r,i,n,o,s,u,a,l,d,c,h,p,f,y,g,_,v,b,T,m,I,F,S,w,x,Q){Object.defineProperty(t,"__esModule",{value:!0});var q=d.getLogger("esri.views.2d.layers.features.controllers.OnDemandController"),O=l("esri-featurelayer-webgl"),E=l("esri-mobile"),j={maxDrillLevel:O&&"object"==typeof O&&null!=O.maxDrillLevel?O.maxDrillLevel:E?1:4,maxRecordCountFactor:O&&"object"==typeof O&&null!=O.maxRecordCountFactor?O.maxRecordCountFactor:E?1:3,enablePBFQuery:!O||"object"!=typeof O||null==O.enablePBFQuery||O.enablePBFQuery},C=new Set,P=[],N=function(){function e(e,t){this.objectIdField=t,this.client=f.openWithPorts(e)}return e.prototype.destroy=function(){this.client.close(),this.client=null},e.prototype.executeQuery=function(e,t){return s(this,void 0,void 0,(function(){var r;return o(this,(function(i){switch(i.label){case 0:return[4,this.client.invoke("queryFeatures",e.toJSON(),t)];case 1:return r=i.sent(),[2,v.convertFromFeatureSet(r,this.objectIdField)]}}))}))},e}(),M=function(){function e(e){this.source=e}return e.prototype.destroy=function(){},e.prototype.executeQuery=function(e,t){return s(this,void 0,void 0,(function(){return o(this,(function(r){switch(r.label){case 0:return[4,b.executeQueryPBF(this.source,e,{type:"optimized"},t)];case 1:return[2,r.sent().data]}}))}))},e}(),D=function(){function e(e,t){this.source=e,this.objectIdField=t}return e.prototype.destroy=function(){},e.prototype.executeQuery=function(e,t){return s(this,void 0,void 0,(function(){var r;return o(this,(function(i){switch(i.label){case 0:return[4,b.executeQuery(this.source,e,t)];case 1:return r=i.sent().data,[2,v.convertFromFeatureSet(r,this.objectIdField)]}}))}))},e}(),A=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type="on-demand",t._queryInfoHash=null,t._dataTileIndex=new S.default,t._editsQueue=new I.EditsQueue({processEdits:t._processEdits.bind(t)}),t._featuresInFlight=new Map,t}return r(t,e),t.prototype.initialize=function(){var e=this,t=this._createFeatureStore();t.onFeatureAdd=this.onFeatureAdd.bind(this),t.onFeatureRemove=this.onFeatureRemove.bind(this),this._set("featureStore",t),this._dataTileIndex.featureStore=this.featureStore,this._dataTileIndex.forEach((function(e){return e.done=!1})),this._fetchQueue=new Q({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchTile(t,e.queryInfo,r)}}),this._patchQueue=new Q({concurrency:10,strategy:"center-first",tileInfoView:this.tileStore.tileScheme,process:function(t,r){return e._fetchTile(t.dataTile,t.queryInfo,r)}}),this._updateQueue=new x.default({tileInfoView:this.tileStore.tileScheme,process:function(t,r,i){return e._updateTile(t,r,i)}});var r=this.service,i=r.capabilities,n=r.source,o=r.objectIdField;this.sourceAdapter=Array.isArray(n)?new N(n,o):j.enablePBFQuery&&i.query.supportsFormatPBF?new M(n):new D(n,o),this.handles.add([this.watch("updating",(function(t){return!t&&e.onIdle()}))]),this.featureStore.events.on("valueRangesChanged",(function(t){e.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}})}))},t.prototype.destroy=function(){this._fetchQueue.clear(),this._patchQueue.clear(),this._updateQueue.clear(),this._editsQueue.destroy(),this.queryEngine.destroy(),this.sourceAdapter.destroy()},Object.defineProperty(t.prototype,"queryEngine",{get:function(){return this._createQueryEngine(this.featureStore)},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"updating",{get:function(){return!this.viewState||this._fetchQueue.updating||this._patchQueue.updating||this._updateQueue.updating||this._editsQueue.updating},enumerable:!0,configurable:!0}),t.prototype.update=function(e,t){return s(this,void 0,void 0,(function(){var r,i,n,s,u,a,l=this;return o(this,(function(o){switch(o.label){case 0:return this.validateConfig(e),r=JSON.stringify(this.config.filters),i=this.renderer.getAttributeHash(),n=e.availableFields.filter((function(e){return-1===l.availableFields.indexOf(e)})),s=this.config.definitionExpression,this._set("config",e),s!==this.config.definitionExpression&&this._set("queryEngine",this._createQueryEngine(this.featureStore)),[4,this.updatePixelBuffer()];case 1:return o.sent(),u=r!==JSON.stringify(e.filters),a=i!==this.renderer.getAttributeHash(),t?a?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,3]:[3,6];case 2:o.sent(),o.label=3;case 3:return[4,this.attributeStore.updateFilters(this)];case 4:return o.sent(),[4,this.featureStore.update(u,e)];case 5:return o.sent(),this.refresh(),[2];case 6:return n.length?[4,this._handleAttributeChange(n)]:[3,8];case 7:o.sent(),o.label=8;case 8:return"heatmap"===this.renderer.type?[2]:a?[4,this.attributeStore.setAttributeBindings(this.renderer,this.arcadeInfo)]:[3,10];case 9:o.sent(),this.featureStore.forEach((function(e){return l.attributeStore.setAttributeData(e.localId,e,l.geometryInfo,l.viewParams)})),o.label=10;case 10:return[4,this.attributeStore.updateFilters(this)];case 11:return o.sent(),[4,this.featureStore.update(u,e)];case 12:return o.sent(),[4,this.attributeStore.sendUpdates()];case 13:return o.sent(),[2]}}))}))},t.prototype.invalidate=function(){return s(this,void 0,void 0,(function(){var e,t;return o(this,(function(r){for(e=0,t=this.tileStore.tiles;e<t.length;e++)this._updateQueue.push(t[e].id,Date.now());return[2]}))}))},t.prototype.onIdle=function(){this.featureStore.sweepClusters()},t.prototype.onEdits=function(e){var t=this;return this._fetchQueue.pause(),this._fetchQueue.reset(),this._editsQueue.push(e).then((function(){t._editsQueue.updating||t._fetchQueue.resume()}))},t.prototype.queryFeatures=function(e){return this.queryEngine.executeQuery(e)},t.prototype.queryFeatureCount=function(e){return this.queryEngine.executeQueryForCount(e)},t.prototype.queryObjectIds=function(e){return this.queryEngine.executeQueryForIds(e)},t.prototype.queryExtent=function(e){return this.queryEngine.executeQueryForExtent(e)},t.prototype.queryStatistics=function(e){return s(this,void 0,void 0,(function(){var e,t,r,i=this;return o(this,(function(u){switch(u.label){case 0:return e=0,t=0,r=0,[4,h.all(this.tileStore.tiles.map((function(n){return s(i,void 0,void 0,(function(){var i,s,u,a,l,d,h,p;return o(this,(function(o){switch(o.label){case 0:return s={pixelBuffer:this._pixelBuffer,returnGeometry:(i=this.queryInfo).returnGeometry,returnCentroid:i.returnCentroid,returnOutline:this.returnOutline},u=c(),[4,this.featureStore.executeTileQuery(n,this.spatialReference,s)];case 1:for(a=o.sent().features,l=c(),r+=l-u,e+=a.length,d=0,h=a;d<h.length;d++)(p=h[d]).geometry&&(_.isPolygon(p.geometry)?t+=p.geometry.rings.reduce((function(e,t){return e+t.length}),0):_.isPolyline(p.geometry)&&(t+=p.geometry.paths.reduce((function(e,t){return e+t.length}),0)));return[2]}}))}))})))];case 1:return u.sent(),[2,n({},this.featureStore.storeStatistics,{displayedFeatureCount:e,displayedVertexCount:t,displayPreProcessTime:r})]}}))}))},t.prototype.refresh=function(){return s(this,void 0,void 0,(function(){var e=this;return o(this,(function(t){switch(t.label){case 0:return this._queryInfoHash=Math.random().toString(),this._dataTileIndex.clear(),this._fetchQueue.pause(),this._updateQueue.pause(),this._editsQueue.clear(),this._fetchQueue.clear(),this._updateQueue.clear(),this.featureStore.startMarkingUsedFeatures(),this._manageTiles(this.tileStore.tiles),this._fetchQueue.resume(),[4,p.whenFalseOnce(this._fetchQueue,"updating")];case 1:return t.sent(),this.featureStore.sweep(),this.featureStore.forEach((function(t){return e.attributeStore.setAttributeData(t.localId,t,e.geometryInfo,e.viewParams)})),this.attributeStore.sendUpdates(),this._updateQueue.resume(),[2]}}))}))},t.prototype.setViewState=function(e){var t=this,r=this.viewState&&this.viewState.scale;this.inherited(arguments),this._fetchQueue.state=e,this._updateQueue.state=e,r!==this.viewState.scale&&this.attributeStore.hasScaleExpr&&(this.featureStore.forEach((function(e){return t.attributeStore.setAttributeData(e.localId,e,t.geometryInfo,t.viewParams)})),this.attributeStore.sendUpdates())},t.prototype.getAggregate=function(e){return this.featureStore.getAggregate(e)},t.prototype.getAggregateValueRanges=function(){return this.featureStore.getAggregateValueRanges()},t.prototype.onTileUpdate=function(e){this._manageTiles(e.added,e.removed),this.featureStore.onTileUpdate(e)},t.prototype.onFeatureAdd=function(e){if(this._featuresInFlight.has(e.objectId)){var t=this._featuresInFlight.get(e.objectId).attributes;e.attributes=n({},t,e.attributes),this._featuresInFlight.delete(e.objectId)}e.localId=this.attributeStore.createLocalId(e.objectId),this.attributeStore.setAttributeData(e.localId,e,this.geometryInfo,this.viewParams)},t.prototype._handleAttributeChange=function(e){return s(this,void 0,void 0,(function(){return o(this,(function(t){switch(t.label){case 0:return[4,this._fetchChangedFields(e)];case 1:return t.sent(),[2]}}))}))},t.prototype._fetchChangedTileFields=function(e,t){return s(this,void 0,void 0,(function(){var r;return o(this,(function(i){return(r=this._dataTileIndex.get(e.id))?[2,this._fetchChangedTileFieldsDrill(r,t)]:[2]}))}))},t.prototype._fetchChangedTileFieldsDrill=function(e,t,r){return void 0===r&&(r=0),s(this,void 0,void 0,(function(){var i,s,u,a,l,d,c,p,f=this;return o(this,(function(o){switch(o.label){case 0:return i=n({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField])}),e.returnExceeded=e.returnExceeded||r>=j.maxDrillLevel,[4,this._patchQueue.push({key:e.key,dataTile:e,queryInfo:i})];case 1:return(s=o.sent()).exceededTransferLimit&&r<j.maxDrillLevel?(u=e.tile.createChildTiles(),a=u.map((function(t){var r=new F.default;return r.tile=t,r.displayTile=e.displayTile,r})),[4,h.all(a.map((function(e){return f._fetchChangedTileFieldsDrill(e,t,r+1)})))]):[3,3];case 2:return o.sent(),[2];case 3:for(l=0,d=s.features;l<d.length;l++)this.featureStore.has((c=d[l]).objectId)?(p=this.featureStore.getFeature(c.objectId)).attributes=n({},p.attributes,c.attributes):this._featuresInFlight.set(c.objectId,c);return[2]}}))}))},t.prototype._fetchChangedTileFieldsPaged=function(e,t,r){return void 0===r&&(r=0),s(this,void 0,void 0,(function(){var i,s,u,a,l,d,c;return o(this,(function(o){switch(o.label){case 0:return i=this.service.tileMaxRecordCount*(this.service.capabilities.query.supportsMaxRecordCountFactor?1:j.maxRecordCountFactor),s=n({},this.queryInfo,{returnGeometry:!1,returnCentroid:!1,outFields:t.concat([this.service.objectIdField]),resultOffset:r*i,num:i}),e.returnExceeded=!0,[4,this._patchQueue.push({key:e.key,dataTile:e,queryInfo:s})];case 1:for(u=o.sent(),a=0,l=u.features;a<l.length;a++)this.featureStore.has((d=l[a]).objectId)?(c=this.featureStore.getFeature(d.objectId)).attributes=n({},c.attributes,d.attributes):this._featuresInFlight.set(d.objectId,d);return u.exceededTransferLimit?[2,this._fetchChangedTileFieldsPaged(e,t,r+1)]:[2]}}))}))},t.prototype._fetchChangedFields=function(e){return s(this,void 0,void 0,(function(){var t,r=this;return o(this,(function(i){switch(i.label){case 0:return t=this.tileStore.tiles.map((function(t){return r._fetchChangedTileFields(t,e)})),[4,h.all(t)];case 1:return i.sent(),[2]}}))}))},t.prototype._manageTiles=function(e,t){void 0===t&&(t=null);for(var r=this._dataTileIndex,i=this._fetchQueue,n=this._updateQueue,o="esriGeometryPoint"===this.service.geometryType,s=this,u=0,a=e;u<a.length;u++)!function(e){var t=r.get(e.id);t?(t.displayTile=e,o?r.forEach((function(r){w.isChildOf(r,t)&&(r.displayTile=e)})):t.done=!1):((t=new F.default).tile=e.clone(),t.displayTile=e,r.add(t)),s._processDataTile(t)}(c=a[u]);if(t)for(var l=0,d=t;l<d.length;l++){var c;C.add(c=d[l]),n.abort(c.id)}r.forEach((function(e){C.has(e.displayTile)&&P.push(e)}));for(var h=0,p=P;h<p.length;h++){var f=p[h];i.abort(f.id),r.delete(f)}P.length=0,C.clear()},t.prototype._processDataTile=function(e){var t=this,r=e.key,i=this._fetchQueue,n=r.id,o=this._queryInfoHash,s=r.level-e.displayTile.key.level>=j.maxDrillLevel;if(this._dataTileIndex.add(e),e.done||i.has(n)){if(e.queryInfoHash!==o||e.returnExceeded!==s)if(e.done)e.done=!1;else{if(!i.isOngoing(n))return e.queryInfoHash=o,void(e.returnExceeded=s);i.abort(n)}}else e.queryInfoHash=o,e.returnExceeded=s;e.done?this._invalidateTile(e.displayTile):i.has(n)||i.push(e).then((function(r){return t._handleResponse(e,r)})).catch((function(r){h.isAbortError(r)||q.error(new a("featurelayer-controller:tile-error","Encountered an error when handling tile response",r)),e.done=!0,t._invalidateTile(e.displayTile)}))},t.prototype._handleResponse=function(e,t){if(e.done=!0,v.hydrateOptimizedFeatureSet(t),t.exceededTransferLimit)if(e.returnExceeded)this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);else{for(var r=e.tile.createChildTiles(),i=0,n=r;i<n.length;i++){var o=n[i],s=new F.default;s.tile=o,s.displayTile=e.displayTile,this._processDataTile(s)}u.release(r)}else this._dataTileIndex.setTileFeatures(e,t.features),this._deleteChildrenDataTiles(e);this._invalidateTile(e.tile)},t.prototype._deleteChildrenDataTiles=function(e){this._dataTileIndex.forEach((function(t){w.isChildOf(t,e)&&P.push(t)}));for(var t=0,r=P;t<r.length;t++){var i=r[t];this._fetchQueue.abort(i.id),this._dataTileIndex.delete(i)}P.length=0},t.prototype._fetchTile=function(e,t,r){return s(this,void 0,void 0,(function(){var i,n,s,u,a,l,d,c;return o(this,(function(o){switch(o.label){case 0:return i=new g({xmin:e.bounds[0],ymin:e.bounds[1],xmax:e.bounds[2],ymax:e.bounds[3],spatialReference:this.spatialReference}),u=this._createQuery(i,(s="esriGeometryPoint"===(n=this.service.geometryType)?e.tile:e.displayTile).extent,s.resolution,t,j.maxRecordCountFactor,e.returnExceeded),[4,this.sourceAdapter.executeQuery(u,r)];case 1:if(a=o.sent(),"esriGeometryPolygon"===n)for(l=0,d=a.features;l<d.length;l++)(c=d[l]).geometry=v.removeCollinearVectices(c.geometry,c.geometry,n,!1,!1);return[2,a]}}))}))},t.prototype._invalidateTile=function(e){for(var t=this._updateQueue,r=0,i=this.tileStore.intersections(e,this._pixelBuffer);r<i.length;r++){var n=i[r].tile;t.push(n.id,n.updateTimestamp)}},t.prototype._updateTile=function(e,t,r){return s(this,void 0,void 0,(function(){var i,n,s,u,a,l,d,c,p=this;return o(this,(function(o){switch(o.label){case 0:return i=this.tileStore.get(e),[4,this.featureStore.executeTileQuery(i,this.spatialReference,{pixelBuffer:this._pixelBuffer,returnGeometry:(n=this.queryInfo).returnGeometry,returnCentroid:n.returnCentroid,returnOutline:this.returnOutline})];case 1:return s=o.sent(),u=s.features,a=s.objectIds,[4,this.attributeStore.sendUpdates()];case 2:return o.sent(),l={geometryType:this.service.geometryType,features:u,fields:this.service.fields,objectIdFieldName:this.service.objectIdField,transform:i.transform},d=[],c=!0,this._dataTileIndex.forEach((function(e){i.id!==e.id&&w.isChildOf(e,i)&&c&&!e.done&&(c=!1)})),c&&i&&i.objectIds.forEach((function(e){if(!a.has(e)){var t=p.attributeStore.getLocalId(e);d.push(t)}})),a.forEach((function(e){i.objectIds.add(e)})),i.updateTimestamp=t,[2,this.processor.onTileData(i,{clear:!0,addOrUpdate:l.features,remove:d,transformParams:T.Utils.getTransformParams(l)},r).catch((function(e){h.isAbortError(e)||q.error("update-tile",e)}))]}}))}))},t.prototype._processEdits=function(e,t,r){return s(this,void 0,void 0,(function(){var i,u,a,l,d,c=this;return o(this,(function(p){switch(p.label){case 0:return i=this._createTempQueryEngine(),u=this._createObjectIdsQuery(e),e.length?[4,this.sourceAdapter.executeQuery(u)]:[3,2];case 1:a=p.sent(),v.hydrateOptimizedFeatureSet(a),this._dataTileIndex.addOrUpdateFeatures(a.features),i.featureStore.addMany(a.features),p.label=2;case 2:return l=t.concat(e).map((function(e){return c.attributeStore.getLocalId(e)})),this._dataTileIndex.deleteFeaturesById(t),this.attributeStore.sendUpdates(),d=n({},this.queryInfo,{pixelBuffer:this._pixelBuffer,returnOutline:this.returnOutline}),this.tileStore.tiles.map((function(e){return s(c,void 0,void 0,(function(){var t;return o(this,(function(n){switch(n.label){case 0:return[4,i.featureStore.executeTileQuery(e,this.spatialReference,d)];case 1:return t=n.sent().features,[2,this.processor.onTileData(e,{addOrUpdate:t,remove:l,transformParams:{transform:e.transform,hasZ:!1,hasM:!1}},r).catch((function(e){h.isAbortError(e)||q.error("update-tile",e)}))]}}))}))})),i.destroy(),[2]}}))}))},t.prototype._createObjectIdsQuery=function(e){var t=this._createDefaultQuery(this.queryInfo);return t.objectIds=e,t},i([y.property()],t.prototype,"_fetchQueue",void 0),i([y.property()],t.prototype,"_patchQueue",void 0),i([y.property()],t.prototype,"_updateQueue",void 0),i([y.property()],t.prototype,"_editsQueue",void 0),i([y.property({readOnly:!0})],t.prototype,"featureStore",void 0),i([y.property()],t.prototype,"sourceAdapter",void 0),i([y.property({readOnly:!0,dependsOn:["featureStore","service"]})],t.prototype,"queryEngine",null),i([y.property({dependsOn:["viewState","_fetchQueue.updating","_updateQueue.updating","_patchQueue.updating","_editsQueue.updating"]})],t.prototype,"updating",null),i([y.subclass("esri.views.2d.layers.features.controllers.OnDemandController")],t)}(y.declared(m.default));t.default=A}).apply(null,i))||(e.exports=n)}}]);