!function(){function e(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function t(t){for(var n=1;n<arguments.length;n++){var a=null!=arguments[n]?arguments[n]:{};n%2?e(Object(a),!0).forEach((function(e){r(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):e(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function r(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function n(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!r){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return a(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return a(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var l,s=!0,u=!1;return{s:function(){r=r.call(e)},n:function(){var e=r.next();return s=e.done,e},e:function(e){u=!0,l=e},f:function(){try{s||null==r.return||r.return()}finally{if(u)throw l}}}}function a(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function i(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}function l(e,t){return(l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function s(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=o(e);if(t){var a=o(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return u(this,r)}}function u(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function o(e){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function c(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function f(e,t,r){return t&&d(e.prototype,t),r&&d(e,r),e}(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{"4zW0":function(e,r,a){"use strict";a.r(r),a.d(r,"constructAssociationMetaDataFeatureSetFromUrl",(function(){return re})),a.d(r,"constructFeatureSet",(function(){return ee})),a.d(r,"constructFeatureSetFromPortalItem",(function(){return ce})),a.d(r,"constructFeatureSetFromRelationship",(function(){return ne})),a.d(r,"constructFeatureSetFromUrl",(function(){return $})),a.d(r,"createFeatureSetCollectionFromMap",(function(){return le})),a.d(r,"createFeatureSetCollectionFromService",(function(){return se})),a.d(r,"getPortal",(function(){return ue})),a.d(r,"initialiseMetaDataCache",(function(){return X})),a.d(r,"lookupUser",(function(){return oe}));var l=a("9MzC"),u=a("975N"),o=a("Lqtk"),d=a("AiS/"),h=a("p+Gi"),y=a("hTzF"),p=a("lNzE"),_=a("H72m"),v=a("ZqIb"),g=a("nC36"),m=a("Xbkg"),b=a("WZb1"),w=a("jWBI"),F=a("idrm"),S=a("ofM5"),k=a("ZPxV"),I=a("B8fU"),O=a("sdy9"),C=a("gLc9"),j=a("T3Nt"),D=a("LK1Z"),R=a("lq8Q"),T=function(){function e(){c(this,e)}return f(e,[{key:"clone",value:function(){var t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}},{key:"toStatisticsName",value:function(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg";default:return"count"}}}],[{key:"parseStatField",value:function(t,r,n){var a=new e;a.field=t;var i=v.WhereClause.create(r,n),l=function(e){if("function"===e.parseTree.type){if(0===e.parseTree.args.value.length)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");var t=v.WhereClause.create(Object(I.j)(e.parseTree.args.value[0],y.a.Standardised,e.parameters),e.fieldsIndex);return{name:e.parseTree.name,expr:t}}return null}(i);if(null===l)throw new Error("Invalid Statistic Function");var s=l.name.toUpperCase().trim();if("MIN"===s){if(a.typeofstat="MIN",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===s){if(a.typeofstat="MAX",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===s)a.typeofstat="COUNT",a.workingexpr=l.expr;else if("STDEV"===s){if(a.typeofstat="STDDEV",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===s){if(a.typeofstat="SUM",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===s){if(a.typeofstat="AVG",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===s){if(a.typeofstat="AVG",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==s)throw new Error("Invalid Statistic Function");if(a.typeofstat="VAR",a.workingexpr=l.expr,null===i)throw new Error("Invalid Statistic Function Parameters")}return a}}]),e}(),x=a("fvq6");function N(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}var P=function(e){i(r,e);var t=s(r);function r(e){var n;return c(this,r),(n=t.call(this,e))._decodedStatsfield=[],n._decodedGroupbyfield=[],n._candosimplegroupby=!0,n.phsyicalgroupbyfields=[],n.objectIdField="ROW__ID",n._internalObjectIdField="ROW__ID",n._adaptedFields=[],n.declaredClass="esri.arcade.featureset.actions.Aggregate",n._uniqueIds=1,n._maxQuery=10,n._maxProcessing=10,n._parent=e.parentfeatureset,n._config=e,n}return f(r,[{key:"isTable",value:function(){return!0}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._getFilteredSet("",null,null,null,e).then((function(e){return t._wset=e,t._wset})):Object(l.s)(this._wset)}},{key:"_isInFeatureSet",value:function(){return y.b.InFeatureSet}},{key:"nextUniqueName",value:function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t}},{key:"convertToEsriFieldType",value:function(e){return e}},{key:"_initialiseFeatureSet",value:function(){var e={},t=!1,r=1,a=this._parent?this._parent.getFieldsIndex():new C.a([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){for(var i=!1,l=0;l<this._config.groupbyfields.length;l++)if(this._config.groupbyfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}if(!1===i)for(var s=0;s<this._config.statsfields.length;s++)if(this._config.statsfields[s].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}!1===i?t=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}var u,o=n(this._config.statsfields);try{for(o.s();!(u=o.n()).done;){var c=u.value,d=new T;d.field=c.name,d.tofieldname=c.name,d.workingexpr=c.expression instanceof v.WhereClause?c.expression:v.WhereClause.create(c.expression,a),d.typeofstat=N(c.statistic),this._decodedStatsfield.push(d)}}catch(U){o.e(U)}finally{o.f()}this._decodedGroupbyfield=[];var f,h=n(this._config.groupbyfields);try{for(h.s();!(f=h.n()).done;){var p=f.value,_={name:p.name,singlefield:null,tofieldname:p.name,expression:p.expression instanceof v.WhereClause?p.expression:v.WhereClause.create(p.expression,a)};this._decodedGroupbyfield.push(_)}}catch(U){h.e(U)}finally{h.f()}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";var g,m=n(this._parent.fields);try{for(m.s();!(g=m.n()).done;){e[g.value.name.toUpperCase()]=1}}catch(U){m.e(U)}finally{m.f()}this.types=null}else this.geometryType=y.m.point,this.typeIdField="",this.types=null,this.spatialReference=new b.a({wkid:4326});this.fields=[];var w=new T;w.field=this.nextUniqueName(e),w.tofieldname=this.objectIdField,w.workingexpr=v.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),w.typeofstat="MIN",this._decodedStatsfield.push(w);var F,k=n(this._decodedGroupbyfield);try{for(k.s();!(F=k.n()).done;){var O=F.value,j=new S.a;if(O.name=this.nextUniqueName(e),j.name=O.tofieldname,j.alias=j.name,Object(I.c)(O.expression)){var R=this._parent.getField(Object(I.i)(O.expression,y.a.Standardised));if(!R)throw new Error("Field is not present for Aggregation");O.name=R.name,O.singlefield=R.name,this.phsyicalgroupbyfields.push(R.name),j.type=R.type}else{j.type=this.convertToEsriFieldType(Object(I.f)(O.expression,this._parent.fields));var x=new S.a;x.name=O.name,x.alias=x.name,this.phsyicalgroupbyfields.push(O.name),this._adaptedFields.push(new D.d(x,O.expression)),this._candosimplegroupby=!1}this.fields.push(j)}}catch(U){k.e(U)}finally{k.f()}if(this._adaptedFields.length>0){var P,E=n(this._parent.fields);try{for(E.s();!(P=E.n()).done;){var A=P.value;this._adaptedFields.push(new D.c(A))}}catch(U){E.e(U)}finally{E.f()}}for(var L=0;L<this._decodedStatsfield.length;L++){var q=new S.a,B=null,G=this._decodedStatsfield[L];G.field=this.nextUniqueName(e),G.tofieldname===this.objectIdField&&(this._internalObjectIdField=G.field),q.name=G.tofieldname,q.alias=q.name;var W=null!==G.workingexpr&&Object(I.c)(G.workingexpr)?Object(I.i)(G.workingexpr,y.a.Standardised):"";switch(this._decodedStatsfield[L].typeofstat){case"SUM":if(""!==W){if(!(B=this._parent.getField(W)))throw new Error("Field is not present for Aggregation");q.type=B.type}else q.type="double";break;case"MIN":case"MAX":if(""!==W){if(!(B=this._parent.getField(W)))throw new Error("Field is not present for Aggregation");q.type=B.type}else q.type="double";break;case"COUNT":q.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==W&&!(B=this._parent.getField(W)))throw new Error("Field is not present for Aggregation");q.type="double"}this.fields.push(q)}}},{key:"_canDoAggregates",value:function(){return Object(l.s)(!1)}},{key:"_getFeatures",value:function(e,t,r,n){var a=this,i=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,i)?this._expandPagedSet(e,i,0,0,n).then((function(){return a._getFeatures(e,t,r,n)})):Object(l.s)("success")}},{key:"_getFilteredSet",value:function(e,t,r,a,i){var s=this;if(""!==e)return Object(l.s)(new k.a([],[],!0,null));var u=null,o={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((function(){if(null!==r)for(var e=0;e<s._decodedStatsfield.length;e++)if(!0===Object(I.h)(r,s._decodedStatsfield[e].tofieldname)){o.nowhereclause=!0,r=null;break}if(null!==a){o.ordered=!0;for(var t=0;t<s._decodedStatsfield.length;t++)if(!0===a.scanForField(s._decodedStatsfield[t].tofieldname)){a=null,o.ordered=!1;break}if(null!==a){var i,u=n(s._decodedGroupbyfield);try{for(u.s();!(i=u.n()).done;){var c=i.value;if(null===c.singlefield&&!0===a.scanForField(c.tofieldname)){a=null,o.ordered=!1;break}}}catch(d){u.e(d)}finally{u.f()}}}return!1===s._candosimplegroupby?Object(l.s)(!1):s._parent._canDoAggregates(s.phsyicalgroupbyfields,s._decodedStatsfield,"",null,null)})).then((function(e){if(e){var t=null;r&&(t=s._reformulateWhereClauseWithoutGroupByFields(r));var n=null;return a&&(n=s._reformulateOrderClauseWithoutGroupByFields(a)),s._parent._getAggregatePagesDataSourceDefinition(s.phsyicalgroupbyfields,s._decodedStatsfield,"",null,t,n,s._internalObjectIdField).then((function(e){return s._checkCancelled(i),u=!0===o.nowhereclause?new k.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===o.ordered&&e._ordered,s._clonePageDefinition(e.pagesDefinition)):new k.a(e._candidates.slice(0),e._known.slice(0),!0===o.ordered&&e._ordered,s._clonePageDefinition(e.pagesDefinition))}))}var l=s._parent;if(s._adaptedFields.length>0&&(l=new D.a({parentfeatureset:s._parent,adaptedFields:s._adaptedFields,extraFilter:null})),!0===o.nowhereclause)u=new k.a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:s._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new m.a({parentfeatureset:l,orderbyclause:new R.a(s.phsyicalgroupbyfields.join(",")+","+s._parent.objectIdField+" ASC")})}});else{var c=l;if(null!==r){var d=null;r&&(d=s._reformulateWhereClauseWithoutGroupByFields(r)),c=new g.a({parentfeatureset:c,whereclause:d})}u=new k.a(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:s._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new m.a({parentfeatureset:c,orderbyclause:new R.a(s.phsyicalgroupbyfields.join(",")+","+s._parent.objectIdField+" ASC")})}})}return u}))}},{key:"_reformulateWhereClauseWithoutStatsFields",value:function(e){var t,r=n(this._decodedStatsfield);try{for(r.s();!(t=r.n()).done;){var a=t.value;e=Object(I.g)(e,a.tofieldname,Object(I.i)(a.workingexpr,y.a.Standardised),this._parent.getFieldsIndex())}}catch(i){r.e(i)}finally{r.f()}return e}},{key:"_reformulateWhereClauseWithoutGroupByFields",value:function(e){var t,r=n(this._decodedGroupbyfield);try{for(r.s();!(t=r.n()).done;){var a=t.value;a.tofieldname!==a.name&&(e=Object(I.g)(e,a.tofieldname,Object(I.i)(a.expression,y.a.Standardised),this._parent.getFieldsIndex()))}}catch(i){r.e(i)}finally{r.f()}return e}},{key:"_reformulateOrderClauseWithoutGroupByFields",value:function(e){var t,r=[],a=n(this._decodedGroupbyfield);try{for(a.s();!(t=a.n()).done;){var i=t.value;i.tofieldname!==i.name&&r.push({field:i.tofieldname,newfield:i.name})}}catch(l){a.e(l)}finally{a.f()}return r.length>0?e.replaceFields(r):e}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}},{key:"_refineSetBlock",value:function(e,t,r){var n=this;try{return!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery)?this._expandPagedSet(e,this._maxQuery,0,0,r).then((function(){return n._refineSetBlock(e,t,r)})):(this._checkCancelled(r),this._refineKnowns(e,t),Object(l.s)(e))}catch(a){return Object(l.r)(a)}}},{key:"_expandPagedSet",value:function(e,t,r,n,a){return this._expandPagedSetFeatureSet(e,t,r,n,a)}},{key:"_getPhysicalPage",value:function(e,t,r){var a=this;return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?Object(l.c)((function(t,n){a._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r,[]).then((function(e){t(e)}),n)})):this._getAgregagtePhysicalPage(e,t,r).then((function(e){var t,r=n(e);try{for(r.s();!(t=r.n()).done;){var i,l=t.value,s={geometry:l.geometry,attributes:{}},u=n(a._decodedGroupbyfield);try{for(u.s();!(i=u.n()).done;){var o=i.value;s.attributes[o.tofieldname]=l.attributes[o.name]}}catch(h){u.e(h)}finally{u.f()}var c,d=n(a._decodedStatsfield);try{for(d.s();!(c=d.n()).done;){var f=c.value;s.attributes[f.tofieldname]=l.attributes[f.field]}}catch(h){d.e(h)}finally{d.f()}a._featureCache[s.attributes[a.objectIdField]]=new w.a(s)}}catch(h){r.e(h)}finally{r.f()}return e.length}))}},{key:"_sequentialGetPhysicalItem",value:function(e,t,r,n){var a=this;return Object(l.c)((function(i,l){null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(r)),!0===e.pagesDefinition.internal.fullyResolved||0===t?i(n.length):a._nextAggregateItem(e,t,r,n,(function(l){i(null===l?n.length:a._sequentialGetPhysicalItem(e,t-=1,r,n))}),l)}))}},{key:"_nextAggregateItem",value:function(e,t,r,n,a,i){var l=this;try{Object(F.q)(e.pagesDefinition.internal.iterator.next()).then((function(s){if(null===s)if(null!==e.pagesDefinition.internal.workingItem){var u=l._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);n.push(u),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(u.attributes[l.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,a(null)}else e.pagesDefinition.internal.fullyResolved=!0,a(null);else{var o=l._generateAggregateHash(s);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[s],id:o};else{if(o!==e.pagesDefinition.internal.workingItem.id){var c=l._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return n.push(c),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(c.attributes[l.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[s],id:o},void a(c)}e.pagesDefinition.internal.workingItem.features.push(s)}l._nextAggregateItem(e,t,r,n,a,i)}}),i)}catch(s){i(s)}}},{key:"_calculateFieldStat",value:function(e,t,r){for(var n=[],a=0;a<e.features.length;a++)if(null!==t.workingexpr){var i=t.workingexpr.calculateValue(e.features[a]);null!==i&&n.push(i)}else n.push(null);switch(t.typeofstat){case"MIN":r.attributes[t.tofieldname]=Object(O.a)("min",n,-1);break;case"MAX":r.attributes[t.tofieldname]=Object(O.a)("max",n,-1);break;case"SUM":r.attributes[t.tofieldname]=Object(O.a)("sum",n,-1);break;case"COUNT":r.attributes[t.tofieldname]=n.length;break;case"VAR":r.attributes[t.tofieldname]=Object(O.a)("var",n,-1);break;case"STDDEV":r.attributes[t.tofieldname]=Object(O.a)("stddev",n,-1);break;case"AVG":r.attributes[t.tofieldname]=Object(O.a)("avg",n,-1)}return!0}},{key:"_calculateAndAppendAggregateItem",value:function(e){var t,r={attributes:{},geometry:null},a=n(this._decodedGroupbyfield);try{for(a.s();!(t=a.n()).done;){var i=t.value,l=i.singlefield?e.features[0].attributes[i.singlefield]:i.expression.calculateValue(e.features[0]);r.attributes[i.tofieldname]=l}}catch(f){a.e(f)}finally{a.f()}var s,u=n(this._decodedStatsfield);try{for(u.s();!(s=u.n()).done;){var o=s.value;this._calculateFieldStat(e,o,r)}}catch(f){u.e(f)}finally{u.f()}for(var c=[],d=0;d<this._decodedStatsfield.length;d++)c.push(this._calculateFieldStat(e,this._decodedStatsfield[d],r));return this._featureCache[r.attributes[this.objectIdField]]=new w.a({attributes:r.attributes,geometry:r.geometry}),r}},{key:"_generateAggregateHash",value:function(e){var t,r="",a=n(this._decodedGroupbyfield);try{for(a.s();!(t=a.n()).done;){var i=t.value,l=i.singlefield?e.attributes[i.singlefield]:i.expression.calculateValue(e);r+=null==l?":":":"+l.toString()}}catch(s){a.e(s)}finally{a.f()}return Object(x.a)(r,x.b.String)}},{key:"_stat",value:function(){return Object(l.s)({calculated:!1})}},{key:"getFeatureByObjectId",value:function(){return Object(l.s)(null)}}],[{key:"registerAction",value:function(){j.a._featuresetFunctions.groupby=function(e,t){return new r({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}]),r}(j.a),E=a("gBat"),A=a("YP08"),L=a("W9Wu"),q=a("qatw"),B=a("db86"),G=a("ZlUD"),W=a("8prj"),U=a("875+"),M=a("xk++"),V=a("hufI"),Q=a("6fyR"),z=a("/uz8"),J=function(e){i(r,e);var t=s(r);function r(e){var n;return c(this,r),(n=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",n._removeGeometry=!1,n._overrideFields=null,n.formulaCredential=null,n._pageJustIds=!1,n._requestStandardised=!1,e.spatialReference&&(n.spatialReference=e.spatialReference),n._transparent=!0,n._maxProcessing=1e3,n._layer=e.layer,n._wset=null,void 0!==e.outFields&&(n._overrideFields=e.outFields),void 0!==e.includeGeometry&&(n._removeGeometry=!1===e.includeGeometry),n}return f(r,[{key:"_maxQueryRate",value:function(){return y.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(e){this._pageJustIds=e}},{key:"convertQueryToLruCacheKey",value:function(e){var t=Object(y.q)(e.toJSON());return Object(x.a)(t,x.b.String)}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(l.c)((function(t,r){try{if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(n){r(n)}}),r),e._layer.load()}catch(n){r(n)}}))),this._loadPromise}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],r=n(this.fields);try{for(r.s();!(e=r.n()).done;){var a=e.value;if("oid"===a.type)t.push(a);else{var i,l=n(this._layer.outFields);try{for(l.s();!(i=l.n()).done;){if(i.value.toLowerCase()===a.name.toLowerCase()){t.push(a);break}}}catch(m){l.e(m)}finally{l.f()}}}}catch(m){r.e(m)}finally{r.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var s,u=[],o=[],c=n(this.fields);try{for(c.s();!(s=c.n()).done;){var d=s.value;if("oid"===d.type)u.push(d),o.push(d.name);else{var f,h=n(this._overrideFields);try{for(h.s();!(f=h.n()).done;){if(f.value.toLowerCase()===d.name.toLowerCase()){u.push(d),o.push(d.name);break}}}catch(m){h.e(m)}finally{h.f()}}}}catch(m){c.e(m)}finally{c.f()}this.fields=u,this._overrideFields=o}if(this._layer.source&&this._layer.source.sourceJSON){var p=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=y.a.StandardisedNoInterval,null!=p&&p>=10.61&&(this._databaseType=y.a.Standardised)):null!=p&&(p>=10.5&&(this._databaseType=y.a.StandardisedNoInterval,this._requestStandardised=!0),p>=10.61&&(this._databaseType=y.a.Standardised))}this.objectIdField=this._layer.objectIdField;var _,v=n(this.fields);try{for(v.s();!(_=v.n()).done;){var g=_.value;"global-id"===g.type&&(this.globalIdField=g.name)}}catch(m){v.e(m)}finally{v.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"_isInFeatureSet",value:function(){return y.b.InFeatureSet}},{key:"_refineSetBlock",value:function(e){return Object(l.s)(e)}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(l.s)(this._wset)}},{key:"_runDatabaseProbe",value:function(e){var t=this;return Object(l.c)((function(r,n){try{t._ensureLoaded().then((function(){try{var a=new M.a;a.where=e.replace("OBJECTID",t._layer.objectIdField),t._layer.queryObjectIds(a).then((function(){r(!0)}),(function(){try{r(!1)}catch(e){n(e)}}))}catch(a){n(a)}}))}catch(a){n(a)}}))}},{key:"_canUsePagination",value:function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}},{key:"_cacheableFeatureSetSourceKey",value:function(){return this._layer.url}},{key:"pbfSupportedForQuery",value:function(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}},{key:"queryPBF",value:function(e){return e.quantizationParameters={mode:"edit"},Object(Q.executeQueryPBF)(this._layer.parsedUrl,e,new V.b({})).then((function(e){return W.default.fromJSON(Object(G.j)(e.data)).unquantize()}))}},{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}},{key:"executeQuery",value:function(e,t){var r=this,n=new z.a({url:this._layer.parsedUrl.path}),a="execute"===t&&this.pbfSupportedForQuery(e),i=null;if(this.recentlyUsedQueries){var l=this.convertQueryToLruCacheKey(e);null===(i=this.recentlyUsedQueries.getFromCache(l))&&(i=!0!==a?n[t](e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(l,i),i=i.catch((function(e){throw r.recentlyUsedQueries.removeFromCache(l),e})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===i&&(i=!0!==a?n[t](e):this.queryPBF(e)),i}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return this.databaseType().then((function(l){if(i.isTable()&&t&&null!==e&&""!==e)return new k.a([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,r,n,a);var s="",u=!1;null!==n&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(s=n.constructClause(),u=!0);var o=new M.a;return o.where=null===r?null===t?"1=1":"":Object(I.i)(r,l),i._requestStandardised&&(o.sqlFormat="standard"),o.spatialRelationship=i._makeRelationshipEnum(e),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==s?s.split(","):null,o.geometry=null===t?null:t,o.relationParameter=i._makeRelationshipParam(e),i.executeQuery(o,"executeForIds").then((function(e){return null===e&&(e=[]),i._checkCancelled(a),new k.a([],e,u,null)}))}))}},{key:"_expandPagedSet",value:function(e,t,r,n,a){return this._expandPagedSetFeatureSet(e,t,r,n,a)}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,n,a){var i=this;try{var s="",u=!1;return null!==n&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(s=n.constructClause(),u=!0),this.databaseType().then((function(n){var l=null===r?null===t?"1=1":"":Object(I.i)(r,n);i._layer.definitionExpression&&(l=""!==l?"(("+i._layer.definitionExpression+") AND ("+l+"))":i._layer.definitionExpression);var o=i._maxQueryRate(),c=i._layer.capabilities.query.maxRecordCount;void 0!==c&&c<o&&(o=c);var d=null;if(!0===i._pageJustIds)d=new k.a([],["GETPAGES"],u,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:l,orderByFields:s,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{var f=!0;!0===i._removeGeometry&&(f=!1);var h=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);d=new k.a([],["GETPAGES"],u,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:h.join(","),resultRecordCount:o,resultOffset:0,geometry:null===t?null:t,where:l,orderByFields:s,returnGeometry:f,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return i._expandPagedSet(d,o,0,1,a).then((function(){return d}))}))}catch(u){return Object(l.r)(u)}}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){var n=this;try{var a=e.pagesDefinition.internal.lastRetrieved,i=a,s=e.pagesDefinition.internal.lastPage,u=new M.a;return this._requestStandardised&&(u.sqlFormat="standard"),u.spatialRelationship=e.pagesDefinition.spatialRel,u.relationParameter=e.pagesDefinition.relationParam,u.outFields=e.pagesDefinition.outFields.split(","),u.num=e.pagesDefinition.resultRecordCount,u.start=e.pagesDefinition.internal.lastPage,u.geometry=e.pagesDefinition.geometry,u.where=e.pagesDefinition.where,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,u.returnGeometry=e.pagesDefinition.returnGeometry,u.outSpatialReference=this.spatialReference,this.executeQuery(u,"execute").then((function(t){if(n._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return"done";for(var l=0;l<t.features.length;l++)e.pagesDefinition.internal.set[i+l]=t.features[l].attributes[n._layer.objectIdField];if(!1===n._pageJustIds)for(var u=0;u<t.features.length;u++)n._featureCache[t.features[u].attributes[n._layer.objectIdField]]=t.features[u];return(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(s){return Object(l.r)(s)}}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r,a=!1,i=n(t);try{for(i.s();!(r=i.n()).done;){if(r.value.toUpperCase()===this.objectIdField.toUpperCase()){a=!0;break}}}catch(l){i.e(l)}finally{i.f()}return!1===a&&t.push(this.objectIdField),t}},{key:"_getFeatures",value:function(e,t,r,n){var a=this,i=[];try{if(-1!==t&&void 0===this._featureCache[t]&&i.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,n).then((function(){return a._getFeatures(e,t,r,n)}));for(var s=0,u=e._lastFetchedIndex;u<e._known.length;u++){if(e._lastFetchedIndex+=1,s++,void 0===this._featureCache[e._known[u]]){var o=!1;if(null!=this._layer._mode){var c=this._layer._mode;if(void 0!==c._featureMap[e._known[u]]){var d=c._featureMap[e._known[u]];null!==d&&(o=!0,this._featureCache[e._known[u]]=d)}}if(!1===o&&(e._known[u]!==t&&i.push(e._known[u]),i.length>=this._maxProcessingRate()-1))break}if(s>=r&&0===i.length)break}if(0===i.length)return Object(l.s)("success");try{var f=new M.a;return this._requestStandardised&&(f.sqlFormat="standard"),f.objectIds=i,f.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),f.returnGeometry=!0,!0===this._removeGeometry&&(f.returnGeometry=!1),f.outSpatialReference=this.spatialReference,this.executeQuery(f,"execute").then((function(e){if(a._checkCancelled(n),void 0!==e.error)return Object(l.r)(new Error(e.error));for(var t=0;t<e.features.length;t++)a._featureCache[e.features[t].attributes[a._layer.objectIdField]]=e.features[t];return"success"}))}catch(h){return Object(l.r)(h)}}catch(h){return Object(l.r)(h)}}},{key:"_getDistinctPages",value:function(e,t,r,n,a,i,s,u,o){var c=this;return this._ensureLoaded().then((function(){return c.databaseType()})).then((function(d){for(var f=r.parseTree.column,h=0;h<c._layer.fields.length;h++)if(c._layer.fields[h].name.toLowerCase()===f.toLowerCase()){f=c._layer.fields[h].name;break}var y=new M.a;c._requestStandardised&&(y.sqlFormat="standard");var p=null===i?null===a?"1=1":"":Object(I.i)(i,d);return c._layer.definitionExpression&&(p=""!==p?"(("+c._layer.definitionExpression+") AND ("+p+"))":c._layer.definitionExpression),y.where=p,y.spatialRelationship=c._makeRelationshipEnum(n),y.relationParameter=c._makeRelationshipParam(n),y.geometry=null===a?null:a,y.returnDistinctValues=!0,y.returnGeometry=!1,y.outFields=[f],c.executeQuery(y,"execute").then((function(d){if(c._checkCancelled(o),!d.hasOwnProperty("features"))return Object(l.r)(new Error("Unnexected Result querying statistics from layer"));for(var h=!1,y=0;y<c._layer.fields.length;y++)if(c._layer.fields[y].name===f){"date"===c._layer.fields[y].type&&(h=!0);break}for(var p=0;p<d.features.length;p++){if(h){var _=d.features[p].attributes[f];u.push(null!==_?new Date(_):_)}else u.push(d.features[p].attributes[f]);if(u.length>=s)break}return 0===d.features.length?u:d.features.length===c._layer.capabilities.query.maxRecordCount&&u.length<s?c._getDistinctPages(e+d.features.length,t,r,n,a,i,s,u,o).then((function(e){return{calculated:!0,result:e}})):u}))}))}},{key:"_distinctStat",value:function(e,t,r,n,a,i,l){return this._getDistinctPages(0,e,t,r,n,a,i,[],l).then((function(e){return{calculated:!0,result:e}}))}},{key:"isTable",value:function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}},{key:"_countstat",value:function(e,t,r,n){var a=this;return this.databaseType().then((function(e){var i=new M.a;if(a._requestStandardised&&(i.sqlFormat="standard"),a.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};var l=null===n?null===r?"1=1":"":Object(I.i)(n,e);return a._layer.definitionExpression&&(l=""!==l?"(("+a._layer.definitionExpression+") AND ("+l+"))":a._layer.definitionExpression),i.where=l,i.where=l,i.spatialRelationship=a._makeRelationshipEnum(t),i.relationParameter=a._makeRelationshipParam(t),i.geometry=null===r?null:r,i.returnGeometry=!1,a.executeQuery(i,"executeForCount").then((function(e){return{calculated:!0,result:e}}))}))}},{key:"_stats",value:function(e,t,r,n,a,i,s){var u=this;return this._ensureLoaded().then((function(){var o=u._layer.capabilities&&u._layer.capabilities.query&&!0===u._layer.capabilities.query.supportsSqlExpression,c=u._layer.capabilities&&u._layer.capabilities.query&&!0===u._layer.capabilities.query.supportsStatistics,d=u._layer.capabilities&&u._layer.capabilities.query&&!0===u._layer.capabilities.query.supportsDistinct;return"count"===e?d?u._countstat(e,r,n,a):{calculated:!1}:!1===c||!1===Object(I.c)(t)&&!1===o||!1===t.isStandardized?""!==r||null!==a?{calculated:!1}:u._manualStat(e,t,i,s):"distinct"===e?!1===d?""!==r||null!==a?{calculated:!1}:u._manualStat(e,t,i,s):u._distinctStat(e,t,r,n,a,i,s):u.databaseType().then((function(i){if(u.isTable()&&n&&null!==r&&""!==r)return{calculated:!0,result:null};var s=new M.a;u._requestStandardised&&(s.sqlFormat="standard");var o=null===a?null===n?"1=1":"":Object(I.i)(a,i);u._layer.definitionExpression&&(o=""!==o?"(("+u._layer.definitionExpression+") AND ("+o+"))":u._layer.definitionExpression),s.where=o,s.spatialRelationship=u._makeRelationshipEnum(r),s.relationParameter=u._makeRelationshipParam(r),s.geometry=null===n?null:n;var c=new U.a;c.statisticType=Object(O.c)(e),c.onStatisticField=Object(I.i)(t,i),c.outStatisticFieldName="ARCADE_STAT_RESULT",s.returnGeometry=!1;var d="ARCADE_STAT_RESULT";return s.outStatistics=[c],u.executeQuery(s,"execute").then((function(e){if(!e.hasOwnProperty("features")||0===e.features.length)return Object(l.r)(new Error("Unnexected Result querying statistics from layer"));for(var t=!1,r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){d=e.fields[r].name,"date"===e.fields[r].type&&(t=!0);break}if(t){var n=e.features[0].attributes[d];return null!==n&&(n=new Date(e.features[0].attributes[d])),{calculated:!0,result:n}}return{calculated:!0,result:e.features[0].attributes[d]}}))}))}))}},{key:"_stat",value:function(e,t,r,n,a,i,l){return this._stats(e,t,r,n,a,i,l)}},{key:"_canDoAggregates",value:function(e,t){var r=this;return this._ensureLoaded().then((function(){var e=!1,n=r._layer.capabilities&&r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsSqlExpression;if(void 0!==r._layer.capabilities&&null!==r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsStatistics&&!0===r._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(var a=0;a<t.length-1;a++)null!==t[a].workingexpr&&(!1===t[a].workingexpr.isStandardized||!1===Object(I.c)(t[a].workingexpr)&&!1===n)&&(e=!1);return!1!==e}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,n,a,i,l){var s=this;return this._ensureLoaded().then((function(){return s.databaseType()})).then((function(u){var o="",c=!1,d=!1;null!==i&&s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsOrderBy&&(o=i.constructClause(),d=!0),s._layer.capabilities&&s._layer.capabilities.query&&!1===s._layer.capabilities.query.supportsPagination&&(d=!1,c=!0,o=s._layer.objectIdField);for(var f=[],h=0;h<t.length;h++){var y=new U.a;y.onStatisticField=null!==t[h].workingexpr?Object(I.i)(t[h].workingexpr,u):"",y.outStatisticFieldName=t[h].field,y.statisticType=t[h].toStatisticsName(),f.push(y)}""===o&&(o=e.join(","));var p=s._maxQueryRate(),_=s._layer.capabilities.query.maxRecordCount;void 0!==_&&_<p&&(p=_);var v=null===a?null===n?"1=1":"":Object(I.i)(a,u);return s._layer.definitionExpression&&(v=""!==v?"(("+s._layer.definitionExpression+") AND ("+v+"))":s._layer.definitionExpression),new k.a([],["GETPAGES"],d,{groupbypage:!0,spatialRel:s._makeRelationshipEnum(r),relationParam:s._makeRelationshipParam(r),outFields:["*"],useOIDpagination:c,generatedOid:l,resultRecordCount:p,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:f,geometry:null===n?null:n,where:v,orderByFields:o,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))}},{key:"_getAgregagtePhysicalPage",value:function(e,t,r){var n=this;try{var a=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(a=""!==a?"("+a+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());var i=e.pagesDefinition.internal.lastRetrieved,s=i,u=e.pagesDefinition.internal.lastPage,o=new M.a;return this._requestStandardised&&(o.sqlFormat="standard"),o.where=a,o.spatialRelationship=e.pagesDefinition.spatialRel,o.relationParameter=e.pagesDefinition.relationParam,o.outFields=e.pagesDefinition.outFields,o.outStatistics=e.pagesDefinition.outStatistics,o.geometry=e.pagesDefinition.geometry,o.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,o.num=e.pagesDefinition.resultRecordCount,o.start=e.pagesDefinition.internal.lastPage,o.returnGeometry=e.pagesDefinition.returnGeometry,o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&o.geometry&&o.spatialRelationship?Object(l.s)([]):this.executeQuery(o,"execute").then((function(t){if(n._checkCancelled(r),!t.hasOwnProperty("features"))return Object(l.r)(new Error("Unnexected Result querying aggregates from layer"));var a=[];if(e.pagesDefinition.internal.lastPage!==u)return[];for(var o=0;o<t.features.length;o++)e.pagesDefinition.internal.set[s+o]=t.features[o].attributes[e.pagesDefinition.generatedOid];for(var c=0;c<t.features.length;c++)a.push(new w.a({attributes:t.features[c].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,a}))}catch(i){return Object(l.r)(i)}}},{key:"relationshipMetaData",value:function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}},{key:"serviceUrl",value:function(){return Object(y.i)(this._layer.parsedUrl.path)}},{key:"queryAttachments",value:function(e,t,r,n){var a=this;if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){var i={objectIds:[e]};return(t&&t>0||r&&r>0)&&(i.size=[t&&t>0?t:0,r&&r>0?r:t+1]),n&&n.length>0&&(i.attachmentTypes=n),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:i,method:"attachments"}),this._layer.queryAttachments(i).then((function(t){var r=[];return t&&t[e]&&t[e].forEach((function(t){var n=a._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString();r.push(new B.a(t.id,t.name,t.contentType,t.size,n))})),r}))}return Object(l.s)([])}},{key:"queryRelatedFeatures",value:function(e){var t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return null!=e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),Object(o.default)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then((function(e){if(e.data){var t={},r=e.data;if(r&&r.relatedRecordGroups){var a,i=r.spatialReference,s=n(r.relatedRecordGroups);try{for(s.s();!(a=s.n()).done;){var u,o=a.value,c=o.objectId,d=[],f=n(o.relatedRecords);try{for(f.s();!(u=f.n()).done;){var h=u.value;h.geometry&&(h.geometry.spatialReference=i);var y=new w.a({geometry:h.geometry?Object(q.a)(h.geometry):null,attributes:h.attributes});d.push(y)}}catch(p){f.e(p)}finally{f.f()}t[c]={features:d,exceededTransferLimit:!0===r.exceededTransferLimit}}}catch(p){s.e(p)}finally{s.f()}}return t}return Object(l.r)("Invalid Request")}))}},{key:"getFeatureByObjectId",value:function(e,t){var r=new z.a({url:this._layer.parsedUrl.path}),n=new M.a;return n.outFields=t,n.returnGeometry=!1,n.outSpatialReference=this.spatialReference,n.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:n,method:"execute"}),r.execute(n).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getIdentityUser",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=u.b)?void 0:t.findCredential(e._layer.url);return r?r.userId:null}))}},{key:"getOwningSystemUrl",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=u.b)?void 0:t.findServerInfo(e._layer.url);if(r)return Object(l.s)(r.owningSystemUrl);var n=e._layer.url,a=n.toLowerCase().indexOf("/rest/services");return(n=a>-1?n.substring(0,a):n)?(n+="/rest/info",Object(l.c)((function(e,t){Object(o.default)(n,{query:{f:"json"}}).then((function(t){var r="";t.data&&t.data.owningSystemUrl&&(r=t.data.owningSystemUrl),e(r)}),(function(t){e("")}))}))):Object(l.s)("")}))}}],[{key:"create",value:function(e,t,n,a,i){return new r({layer:new L.default({url:e,outFields:null===t?["*"]:t}),spatialReference:n,lrucache:a,interceptor:i})}}]),r}(j.a),K=a("OAJp"),Z=a("n6Nx"),H=function(e){i(r,e);var t=s(r);function r(e){var n;return c(this,r),(n=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",n._findObjectId=-1,n._requestStandardised=!1,n._removeGeometry=!1,n._overrideFields=null,n.featureObjectId=null,n.relatedLayer=null,n.relationship=null,e.spatialReference&&(n.spatialReference=e.spatialReference),n._transparent=!0,n._maxProcessing=1e3,n._layer=e.layer,n._wset=null,n._findObjectId=e.objectId,n.featureObjectId=e.objectId,n.relationship=e.relationship,n.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(n._overrideFields=e.outFields),void 0!==e.includeGeometry&&(n._removeGeometry=!1===e.includeGeometry),n}return f(r,[{key:"_maxQueryRate",value:function(){return y.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(l.c)((function(t,r){Object(l.b)([e._layer.load(),e.relatedLayer.load()]).then((function(){e._initialiseFeatureSet(),t(e)}),r)}))),this._loadPromise}},{key:"nativeCapabilities",value:function(){return this.relatedLayer.nativeCapabilities()}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var e,t=[],r=[],a=n(this.fields);try{for(a.s();!(e=a.n()).done;){var i=e.value;if("oid"===i.type)t.push(i),r.push(i.name);else{var l,s=n(this._overrideFields);try{for(s.s();!(l=s.n()).done;){if(l.value.toLowerCase()===i.name.toLowerCase()){t.push(i),r.push(i.name);break}}}catch(o){s.e(o)}finally{s.f()}}}}catch(o){a.e(o)}finally{a.f()}this.fields=t,this._overrideFields=r}var u=this._layer.nativeCapabilities();u&&(this._databaseType=u.databaseType,this._requestStandardised=u.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}},{key:"databaseType",value:function(){var e=this;return this.relatedLayer.databaseType().then((function(){return e._databaseType=e.relatedLayer._databaseType,e._databaseType}))}},{key:"isTable",value:function(){return this.relatedLayer.isTable()}},{key:"_isInFeatureSet",value:function(){return y.b.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(l.s)(this._wset)}},{key:"_changeFeature",value:function(e){var t,r={},a=n(this.fields);try{for(a.s();!(t=a.n()).done;){var i=t.value;r[i.name]=e.attributes[i.name]}}catch(l){a.e(l)}finally{a.f()}return new w.a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return this.databaseType().then((function(){if(i.isTable()&&t&&null!==e&&""!==e)return new k.a([],[],!0,null);var l=i._layer.nativeCapabilities();if(!1===l.canQueryRelated)return new k.a([],[],!0,null);if(l.capabilities.queryRelated&&l.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,r,n,a);var s="",u=!1;null!==n&&l.capabilities&&l.capabilities.queryRelated&&!0===l.capabilities.queryRelated.supportsOrderBy&&(s=n.constructClause(),u=!0);var o=new Z.a;o.objectIds=[i._findObjectId];var c=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);o.outFields=c,o.relationshipId=i.relationship.id,o.where="1=1";var d=!0;return!0===i._removeGeometry&&(d=!1),o.returnGeometry=d,i._requestStandardised&&(o.sqlFormat="standard"),o.outSpatialReference=i.spatialReference,o.orderByFields=""!==s?s.split(","):null,l.source.queryRelatedFeatures(o).then((function(n){i._checkCancelled(a);for(var l=n[i._findObjectId]?n[i._findObjectId].features:[],s=[],o=0;o<l.length;o++)i._featureCache[l[o].attributes[i._layer.objectIdField]]=l[o],s.push(l[o].attributes[i._layer.objectIdField]);var c=t&&null!==e&&""!==e,d=null!=r;return new k.a(c||d?s:[],c||d?[]:s,u,null)}))}))}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r,a=!1,i=n(t);try{for(i.s();!(r=i.n()).done;){if(r.value.toUpperCase()===this.objectIdField.toUpperCase()){a=!0;break}}}catch(l){i.e(l)}finally{i.f()}return!1===a&&t.push(this.objectIdField),t}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,n,a){var i=this;try{var s="",u=!1,o=this._layer.nativeCapabilities();return null!==n&&o&&o.capabilities.queryRelated&&!0===o.capabilities.queryRelated.supportsOrderBy&&(s=n.constructClause(),u=!0),this.databaseType().then((function(){var n=i._maxQueryRate(),l=o.capabilities.query.maxRecordCount;void 0!==l&&l<n&&(n=l);var c,d=t&&null!==e&&""!==e,f=null!=r,h=!0;!0===i._removeGeometry&&(h=!1);var y=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);return c=new k.a(d||f?["GETPAGES"]:[],d||f?[]:["GETPAGES"],u,{outFields:y.join(","),resultRecordCount:n,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:s,returnGeometry:h,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),i._expandPagedSet(c,n,0,0,a).then((function(){return c}))}))}catch(u){return Object(l.r)(u)}}},{key:"_expandPagedSet",value:function(e,t,r,n,a){return this._expandPagedSetFeatureSet(e,t,r,n,a)}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){var n=this;try{var a=e.pagesDefinition.internal.lastRetrieved,i=a,s=e.pagesDefinition.internal.lastPage,u=this._layer.nativeCapabilities(),o=new Z.a;return!0===this._requestStandardised&&(o.sqlFormat="standard"),o.relationshipId=this.relationship.id,o.objectIds=e.pagesDefinition.objectIds,o.resultOffset=e.pagesDefinition.internal.lastPage,o.resultRecordCount=e.pagesDefinition.resultRecordCount,o.outFields=e.pagesDefinition.outFields.split(","),o.where=e.pagesDefinition.where,o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,o.returnGeometry=e.pagesDefinition.returnGeometry,o.outSpatialReference=this.spatialReference,u.source.queryRelatedFeatures(o).then((function(t){if(n._checkCancelled(r),e.pagesDefinition.internal.lastPage!==s)return 0;for(var l=t[n._findObjectId]?t[n._findObjectId].features:[],u=0;u<l.length;u++)e.pagesDefinition.internal.set[i+u]=l[u].attributes[n._layer.objectIdField];for(var o=0;o<l.length;o++)n._featureCache[l[o].attributes[n._layer.objectIdField]]=l[o];return l.length!==e.pagesDefinition.resultRecordCount&&(!t[n._findObjectId]||!1===t[n._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=a+l.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,l.length}))}catch(s){return Object(l.r)(s)}}},{key:"_getFeatures",value:function(e,t,r,n){var a=this,i=[];-1!==t&&void 0===this._featureCache[t]&&i.push(t);var s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,n).then((function(){return a._getFeatures(e,t,r,n)}));for(var u=0,o=e._lastFetchedIndex;o<e._known.length&&(++u<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[o]&&void 0===this._featureCache[e._known[o]]&&(e._known[o]!==t&&i.push(e._known[o]),i.length>r)))&&!(u>=r&&0===i.length);o++);return 0===i.length?Object(l.s)("success"):Object(l.r)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e,t,r){return Object(l.s)(e)}},{key:"_stat",value:function(e,t,r,n,a,i,s){return Object(l.s)({calculated:!1})}},{key:"gdbVersion",get:function(){return this.relatedLayer.gdbVersion}},{key:"_canDoAggregates",value:function(e,t,r,n,a){return Object(l.s)(!1)}},{key:"relationshipMetaData",value:function(){return this.relatedLayer.relationshipMetaData()}},{key:"serviceUrl",value:function(){return this.relatedLayer.serviceUrl()}},{key:"queryAttachments",value:function(e,t,r,n){return this.relatedLayer.queryAttachments(e,t,r,n)}},{key:"getFeatureByObjectId",value:function(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}},{key:"getOwningSystemUrl",value:function(){return this.relatedLayer.getOwningSystemUrl()}},{key:"getIdentityUser",value:function(){return this.relatedLayer.getIdentityUser()}}]),r}(j.a);function X(){null===_.a.applicationCache&&(_.a.applicationCache=new _.a)}function Y(e,t){if(_.a.applicationCache){var r=_.a.applicationCache.getLayerInfo(e);if(r)return r.then((function(r){return Object(l.s)(new L.default({url:e,outFields:t,sourceJSON:r}))}));var n=new L.default({url:e,outFields:t}),a=Object(l.c)((function(e,t){n.load().then((function(){e(n.sourceJSON)}),(function(e){t(e)}))}));return _.a.applicationCache&&(_.a.applicationCache.setLayerInfo(e,a),a=a.catch((function(t){throw _.a.applicationCache.clearLayerInfo(e),t}))),a.then((function(){return Object(l.s)(n)}))}return Object(l.s)(new L.default({url:e,outFields:t}))}function $(e,t,r,n,a){var i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return Y(e,["*"]).then((function(e){return Object(l.s)(ee(e,t,r,n,a,i))}))}function ee(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:null;return!0===e._hasMemorySource()?new K.a({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:i}):new J({layer:e,spatialReference:t,outFields:r,includeGeometry:n,lrucache:a,interceptor:i})}function te(e){if(null!==_.a.applicationCache){var t=_.a.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=Object(o.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.layers||(t.layers=[]),t.tables||(t.tables=[]),Object(l.s)(t)}return Object(l.s)({layers:[],tables:[]})}));return null!==_.a.applicationCache&&(_.a.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw _.a.applicationCache.clearLayerInfo(e),t}))),r}function re(e,t){var r={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null};return te(e).then((function(a){if(r.metadata=a,a.controllerDatasetLayers&&null!=a.controllerDatasetLayers.utilityNetworkLayerId){if(a.layers){var i,s=n(a.layers);try{for(s.s();!(i=s.n()).done;){var u=i.value;r.layerNameLkp[u.id]=u.name}}catch(y){s.e(y)}finally{s.f()}}if(a.tables){var c,d=n(a.tables);try{for(d.s();!(c=d.n()).done;){var f=c.value;r.layerNameLkp[f.id]=f.name}}catch(y){d.e(y)}finally{d.f()}}var h=a.controllerDatasetLayers.utilityNetworkLayerId;return r.networkId=h,function(e,t){var r="QUERYDATAELEMTS:"+t.toString()+":"+e;if(null!==_.a.applicationCache){var n=_.a.applicationCache.getLayerInfo(r);if(null!==n)return n}var a=Object(o.default)(e+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([t.toString()]),f:"json"}}).then((function(e){if(e.data){var t=e.data;if(t.layerDataElements&&t.layerDataElements[0])return t.layerDataElements[0]}throw new Error("Not Found")}));return null!==_.a.applicationCache&&(_.a.applicationCache.setLayerInfo(r,a),a=a.catch((function(e){throw _.a.applicationCache.clearLayerInfo(r),e}))),a}(e,h).then((function(a){if(a){r.queryelem=a,r.queryelem&&r.queryelem.dataElement&&void 0!==r.queryelem.dataElement.schemaGeneration&&(r.unVersion=r.queryelem.dataElement.schemaGeneration),r.lkp={},r.queryelem.dataElement.domainNetworks||(r.queryelem.dataElement.domainNetworks=[]);var i,s=n(r.queryelem.dataElement.domainNetworks);try{for(s.s();!(i=s.n()).done;){var u,c=i.value,d=n(c.edgeSources?c.edgeSources:[]);try{for(d.s();!(u=d.n()).done;){var f=u.value,p={layerId:f.layerId,sourceId:f.sourceId,className:r.layerNameLkp[f.layerId]?r.layerNameLkp[f.layerId]:null};p.className&&(r.lkp[p.className]=p)}}catch(y){d.e(y)}finally{d.f()}var g,m=n(c.junctionSources?c.junctionSources:[]);try{for(m.s();!(g=m.n()).done;){var b=g.value,w={layerId:b.layerId,sourceId:b.sourceId,className:r.layerNameLkp[b.layerId]?r.layerNameLkp[b.layerId]:null};w.className&&(r.lkp[w.className]=w)}}catch(y){m.e(y)}finally{m.f()}}}catch(y){s.e(y)}finally{s.f()}if(r.queryelem.dataElement.terminalConfigurations){var F,S=n(r.queryelem.dataElement.terminalConfigurations);try{for(S.s();!(F=S.n()).done;){var k,I=n(F.value.terminals);try{for(I.s();!(k=I.n()).done;){var O=k.value;r.terminals.push({terminalId:O.terminalId,terminalName:O.terminalName})}}catch(y){I.e(y)}finally{I.f()}}}catch(y){S.e(y)}finally{S.f()}}return function(e){if(null!==_.a.applicationCache){var t=_.a.applicationCache.getLayerInfo(e);if(null!==t)return t}var r=Object(o.default)(e,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return Object(l.s)(t)}return Object(l.s)(null)}));return null!==_.a.applicationCache&&(_.a.applicationCache.setLayerInfo(e,r),r=r.catch((function(t){throw _.a.applicationCache.clearLayerInfo(e),t}))),r}(e+"/"+h).then((function(n){if(n.systemLayers&&null!=n.systemLayers.associationsTableId){var a=[];return r.unVersion>=4&&(a.push("STATUS"),a.push("PERCENTALONG")),$(e+"/"+n.systemLayers.associationsTableId.toString(),t,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID"].concat(a),!1,null,null).then((function(e){return e.load()})).then((function(e){return r.unVersion>=4?(e=e.filter(v.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",e.getFieldsIndex()))).load():e})).then((function(e){return{lkp:r.lkp,associations:e,unVersion:r.unVersion,terminals:r.terminals}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}return{associations:null,unVersion:r.unVersion,lkp:null,terminals:[]}}))}function ne(e,t,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],l=arguments.length>6&&void 0!==arguments[6]?arguments[6]:null,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null,u=e.serviceUrl();return u?$(u="/"===u.charAt(u.length-1)?u+t.relatedTableId.toString():u+"/"+t.relatedTableId.toString(),n,a,i,l,s).then((function(u){return new H({layer:e,relatedLayer:u,relationship:t,objectId:r,spatialReference:n,outFields:a,includeGeometry:i,lrucache:l,interceptor:s})})):null}g.a.registerAction(),P.registerAction(),m.a.registerAction(),E.a.registerAction(),A.a.registerAction();var ae=function(e){i(n,e);var r=s(n);function n(e){var t,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return c(this,n),(t=r.call(this))._map=e,t._overridespref=a,t.lrucache=i,t.interceptor=l,t._instantLayers=[],t}return f(n,[{key:"makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=ee(e,this._overridespref,null===r?["*"]:r,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}},{key:"featureSetByName",value:function(e){var r=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return r.featureSetByName(e,n,a)}catch(i){return Object(l.r)(i)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),s=0;s<this._instantLayers.length;s++){var u=this._instantLayers[s];if(u.opitem.title===e&&u.includeGeometry===n&&u.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}var o=this._map.layers.find((function(t){return t instanceof L.default&&t.title===e}));if(o)return this.resolvePromise(this.makeAndAddFeatureSet(o,n,a));if(this._map.tables){var c=this._map.tables.find((function(t){return!!(t.title&&t.title===e||t.title&&t.title===e)}));if(c){if(c instanceof L.default)return this.resolvePromise(this.makeAndAddFeatureSet(c,n,a));if(c._materializedTable);else{var d=c.outFields?c:t(t({},c),{},{outFields:["*"]});c._materializedTable=new L.default(d)}return c._materializedTable.load().then((function(){return r.resolvePromise(r.makeAndAddFeatureSet(c._materializedTable,n,a))}))}}return this.resolvePromise(null)}},{key:"featureSetById",value:function(e){var r=this,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then((function(){try{return r.featureSetById(e,n,a)}catch(i){return Object(l.r)(i)}}));null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),s=0;s<this._instantLayers.length;s++){var u=this._instantLayers[s];if(u.opitem.id===e&&u.includeGeometry===n&&u.outFields===i)return this.resolvePromise(this._instantLayers[s].featureset)}var o=this._map.layers.find((function(t){return t instanceof L.default&&t.id===e}));if(o)return this.resolvePromise(this.makeAndAddFeatureSet(o,n,a));if(this._map.tables){var c=this._map.tables.find((function(t){return t.id===e}));if(c){if(c instanceof L.default)return this.resolvePromise(this.makeAndAddFeatureSet(c,n,a));if(c._materializedTable);else{var d=t(t({},c),{},{outFields:["*"]});c._materializedTable=new L.default(d)}return c._materializedTable.load().then((function(){return r.resolvePromise(r.makeAndAddFeatureSet(c._materializedTable,n,a))}))}}return this.resolvePromise(null)}}]),n}(p.a),ie=function(e){i(r,e);var t=s(r);function r(e){var n,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,l=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return c(this,r),(n=t.call(this))._url=e,n._overridespref=a,n.lrucache=i,n.interceptor=l,n.metadata=null,n._instantLayers=[],n}return f(r,[{key:"url",get:function(){return this._url}},{key:"makeAndAddFeatureSet",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=ee(e,this._overridespref,null===r?["*"]:r,t,this.lrucache);return this._instantLayers.push({featureset:n,opitem:e,includeGeometry:t,outFields:JSON.stringify(r)}),n}},{key:"_loadMetaData",value:function(){var e=this;return te(this._url).then((function(t){return e.metadata=t,t}))}},{key:"load",value:function(){return this._loadMetaData()}},{key:"clone",value:function(){return new r(this._url,this._overridespref,this.lrucache,this.interceptor)}},{key:"featureSetByName",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null===a&&(a=["*"]),a=(a=a.slice(0)).sort();for(var i=JSON.stringify(a),l=0;l<this._instantLayers.length;l++){var s=this._instantLayers[l];if(s.opitem.title===e&&s.includeGeometry===r&&s.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}return this._loadMetaData().then((function(i){var l,s=null,u=n(i.layers?i.layers:[]);try{for(u.s();!(l=u.n()).done;){var o=l.value;o.name===e&&(s=o)}}catch(h){u.e(h)}finally{u.f()}if(!s){var c,d=n(i.tables?i.tables:[]);try{for(d.s();!(c=d.n()).done;){var f=c.value;f.name===e&&(s=f)}}catch(h){d.e(h)}finally{d.f()}}return s?Y(t._url+"/"+s.id,["*"]).then((function(e){return t.makeAndAddFeatureSet(e,r,a)})):t.resolvePromise(null)}))}},{key:"featureSetById",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:["*"];null===a&&(a=["*"]),a=(a=a.slice(0)).sort();var i=JSON.stringify(a);e=null!=e?e.toString():"";for(var l=0;l<this._instantLayers.length;l++){var s=this._instantLayers[l];if(s.opitem.id===e&&s.includeGeometry===r&&s.outFields===i)return this.resolvePromise(this._instantLayers[l].featureset)}return this._loadMetaData().then((function(i){var l,s=null,u=n(i.layers?i.layers:[]);try{for(u.s();!(l=u.n()).done;){var o=l.value;null!=o.id&&o.id.toString()===e&&(s=o)}}catch(h){u.e(h)}finally{u.f()}if(!s){var c,d=n(i.tables?i.tables:[]);try{for(d.s();!(c=d.n()).done;){var f=c.value;null!=f.id&&f.id.toString()===e&&(s=f)}}catch(h){d.e(h)}finally{d.f()}}return s?Y(t._url+"/"+s.id,["*"]).then((function(e){return t.makeAndAddFeatureSet(e,r,a)})):t.resolvePromise(null)}))}}]),r}(p.a);function le(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new ae(e,t,r,n)}function se(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return new ie(e,t,r,n)}function ue(e,t){return null===e?t:new d.a({url:e.field("url")})}function oe(e,r,n){return u.b.findCredential(e.restUrl)?"loaded"===e.loadStatus&&""===r&&e.user&&e.user.sourceJSON&&!1===n?Object(l.s)(e.user.sourceJSON):""===r?Object(o.default)(e.restUrl+"/community/self",{responseType:"json",query:t({f:"json"},!1===n?{}:{returnUserLicenseTypeExtensions:!0})}).then((function(e){if(e.data){var t=e.data;if(t&&t.username)return Object(l.s)(t)}return Object(l.s)(null)})):Object(o.default)(e.restUrl+"/community/users/"+r,{responseType:"json",query:{f:"json"}}).then((function(e){if(e.data){var t=e.data;return t.error?null:Object(l.s)(t)}return Object(l.s)(null)})):Object(l.s)(null)}function ce(e,t,r,n,a,i,s){var u=arguments.length>7&&void 0!==arguments[7]?arguments[7]:null;if(_.a.applicationCache){var o=_.a.applicationCache.getLayerInfo(e+":"+i.url);if(o)return o.then((function(i){try{var o=new L.default({url:Object(y.i)(i.url)+"/"+t,outFields:["*"]});return Object(l.s)(ee(o,r,n,a,s,u))}catch(e){return Object(l.r)(e)}}),(function(e){return Object(l.r)(e)}))}return Object(l.c)((function(l,o){var c=new h.default({id:e,portal:i}).load();_.a.applicationCache&&_.a.applicationCache.setLayerInfo(e+":"+i.url,c),c.then((function(i){try{var c=new L.default({url:Object(y.i)(i.url)+"/"+t,outFields:["*"]});l(ee(c,r,n,a,s,u))}catch(e){o(e)}}),(function(t){_.a.applicationCache&&_.a.applicationCache.clearLayerInfo(e+":"+i.url),o(t)}))}))}},LK1Z:function(e,t,r){"use strict";r.d(t,"a",(function(){return F})),r.d(t,"b",(function(){return m})),r.d(t,"c",(function(){return g})),r.d(t,"d",(function(){return w})),r.d(t,"e",(function(){return b}));var a=r("9MzC"),l=r("WZb1"),u=r("jWBI"),o=r("hTzF"),d=r("hUmP"),h=r("ZPxV"),y=r("ZqIb"),p=r("B8fU"),_=r("T3Nt"),v=function(){function e(){c(this,e),this.sqlRewritable=!1}return f(e,[{key:"postInitialization",value:function(e,t){}}]),e}(),g=function(e){i(r,e);var t=s(r);function r(e){var n;return c(this,r),(n=t.call(this)).field=e,n.sqlRewritable=!0,n}return f(r,[{key:"extractValue",value:function(e){return e.attributes[this.field.name]}},{key:"rewriteSql",value:function(e){return{rewritten:this.sqlRewritable,where:e}}}]),r}(v),m=function(e){i(r,e);var t=s(r);function r(e,n,a){var i;return c(this,r),(i=t.call(this)).originalField=e,i.sqlRewritable=!0,i.field=Object(o.c)(e),i.field.name=n,i.field.alias=a,i}return f(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:this.sqlRewritable,where:Object(p.g)(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return e.attributes[this.originalField.name]}}]),r}(v),b=function(e){i(r,e);var t=s(r);function r(e,n,a){var i;for(var l in c(this,r),(i=t.call(this)).field=e,i.codefield=n,i.lkp=a,i.reverseLkp={},a)i.reverseLkp[a[l]]=l;return i.sqlRewritable=!0,i}return f(r,[{key:"rewriteSql",value:function(e,t){var n=this.evaluateNodeToWhereClause(e.parseTree,o.a.Standardised,this.field.name,this.codefield instanceof y.WhereClause?Object(p.i)(this.codefield,o.a.Standardised):this.codefield,e.parameters);return n.indexOf(r.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:y.WhereClause.create(n,t._parent.getFieldsIndex())}}},{key:"evaluateNodeToWhereClause",value:function(e,t){var a,i,l,s,u=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,c=arguments.length>4?arguments[4]:void 0;switch(e.type){case"interval":return Object(p.b)(this.evaluateNodeToWhereClause(e.value,t,u,o,c),e.qualifier,e.op);case"case_expression":var d=" CASE ";"simple"===e.format&&(d+=this.evaluateNodeToWhereClause(e.operand,t,u,r.BADNESS,c));for(var f=0;f<e.clauses.length;f++)d+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[f].operand,t,u,r.BADNESS,c)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[f].value,t,u,r.BADNESS,c);return null!==e.else&&(d+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,u,r.BADNESS,c)),d+=" END ";case"param":var h=c[e.value.toLowerCase()];if("string"==typeof h)return"'"+c[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(h instanceof Date)return Object(p.d)(h,t);if(h instanceof Array){for(var y=[],_=0;_<h.length;_++)"string"==typeof h[_]?y.push("'"+h[_].toString().replace(/'/g,"''")+"'"):h[_]instanceof Date?y.push(Object(p.d)(h[_],t)):y.push(h[_].toString());return y}return h.toString();case"expr_list":i=[];var v,g=n(e.value);try{for(g.s();!(v=g.n()).done;){var m=v.value;i.push(this.evaluateNodeToWhereClause(m,t,u,o,c))}}catch(T){g.e(T)}finally{g.f()}return i;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,u,r.BADNESS,c)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" AND "+this.evaluateNodeToWhereClause(e.right,t,u,o,c)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" OR "+this.evaluateNodeToWhereClause(e.right,t,u,o,c)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IS NOT NULL )";case"IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var b,w=[],F=!0,S=n(e.right.value);try{for(S.s();!(b=S.n()).done;){var k=b.value;if("string"!==k.type){F=!1;break}if(void 0===this.lkp[k.value]){F=!1;break}w.push(this.lkp[k.value].toString())}}catch(T){S.e(T)}finally{S.f()}if(F)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+w.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,u,o,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+a.join(",")+")) "}return(s=this.evaluateNodeToWhereClause(e.right,t,u,o,c))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+s.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" IN ("+s+")) ";case"NOT IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var I,O=[],C=!0,j=n(e.right.value);try{for(j.s();!(I=j.n()).done;){var D=I.value;if("string"!==D.type){C=!1;break}if(void 0===this.lkp[D.value]){C=!1;break}O.push(this.lkp[D.value].toString())}}catch(T){j.e(T)}finally{j.f()}if(C)return" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+O.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,u,o,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+a.join(",")+")) "}return(s=this.evaluateNodeToWhereClause(e.right,t,u,o,c))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+s.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,o,c)+" NOT IN ("+s+")) ";case"BETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"NOTBETWEEN":return l=this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)," ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" NOT BETWEEN "+l[0]+" AND "+l[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+o+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+o+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,u,r.BADNESS,c)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,u,r.BADNESS,c)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return Object(p.d)(e.value,t);case"number":return e.value.toString();case"current_time":return Object(p.e)("date"===e.mode,t);case"column_ref":return u&&u.toLowerCase()===e.column.toLowerCase()?"("+o+")":e.column;case"function":var R=this.evaluateNodeToWhereClause(e.args,t,u,r.BADNESS,c);return Object(p.k)(e.name,R,t)}throw new Error("Unsupported sql syntax "+e.type)}},{key:"extractValue",value:function(e){return this.codefield instanceof y.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]}}]),r}(v);b.BADNESS="_!!!_BAD_LKP_!!!!";var w=function(e){i(r,e);var t=s(r);function r(e,n){var a;return c(this,r),(a=t.call(this)).field=e,a.sql=n,a}return f(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:!0,where:Object(p.g)(e,this.field.name,Object(p.i)(this.sql,o.a.Standardised),t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return this.sql.calculateValueCompiled(e)}}]),r}(v),F=function(e){i(r,e);var t=s(r);function r(e){var n;return c(this,r),(n=t.call(this,e))._calcFunc=null,n.declaredClass="esri.arcade.featureset.actions.Adapted",n.adaptedFields=null,n._extraFilter=null,n._extraFilter=e.extraFilter,n._parent=e.parentfeatureset,n._maxProcessing=30,n.adaptedFields=e.adaptedFields,n}return f(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new l.a({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=o.m.point,this.typeIdField="",this.types=null),this.fields=[];var e,t=n(this.adaptedFields);try{for(t.s();!(e=t.n()).done;){var r=e.value;r.postInitialization(this,this._parent),this.fields.push(r.field)}}catch(a){t.e(a)}finally{t.f()}}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._extraFilter?t._getFilteredSet("",null,null,null,e):t._parent._getSet(e)})).then((function(r){return t._checkCancelled(e),t._wset=new h.a(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):Object(a.s)(this._wset)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,i){var l=this,s=[];-1!==t&&void 0===this._featureCache[t]&&s.push(t);var o=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,o))return this._expandPagedSet(e,o,0,0,i).then((function(){return l._getFeatures(e,t,r,i)}));for(var c=0,f=e._lastFetchedIndex;f<e._known.length&&(++c<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[f]]&&(e._known[f]!==t&&s.push(e._known[f]),s.length>=o-1)));f++);if(0===s.length)return Object(a.s)("success");e=new h.a([],s,e._ordered,null);var y=Math.min(s.length,r);return this._parent._getFeatures(e,-1,y,i).then((function(){l._checkCancelled(i);for(var e=[],t=0;t<y;t++){var r=l._parent._featureFromCache(s[t]);void 0!==r&&e.push({geometry:r.geometry,attributes:r.attributes,id:s[t]})}for(var a=0,o=e;a<o.length;a++){var c,f=o[a],h=[],p=n(l.adaptedFields);try{for(p.s();!(c=p.n()).done;){var _=c.value;h[_.field.name]=_.extractValue(f)}}catch(v){p.e(v)}finally{p.f()}l._featureCache[f.id]=new u.a({attributes:h,geometry:Object(d.a)(f.geometry)})}return"success"}))}},{key:"_fetchAndRefineFeatures",value:function(){return Object(a.r)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,a,i){var l,s=this,u=this.reformulateWithoutAdaptions(r);l=u.cannot,r=u.where;var o=!1;if(null!==a){o=!0;var c,d=[],f=n(this.adaptedFields);try{for(f.s();!(c=f.n()).done;){var y=c.value;if(!(y instanceof g)&&!0===a.scanForField(y.field.name)){if(!(y instanceof m)){a=null,o=!1;break}d.push({field:y.field.name,newfield:y.originalField.name})}}}catch(_){f.e(_)}finally{f.f()}a&&d.length>0&&(a=a.replaceFields(d))}return null!==r?null!==this._extraFilter&&(r=Object(p.a)(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then((function(){return s._parent._getFilteredSet(e,t,r,a,i)})).then((function(e){return s._checkCancelled(i),!0===l?new h.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===o&&e._ordered,s._clonePageDefinition(e.pagesDefinition)):new h.a(e._candidates.slice(0),e._known.slice(0),!0===o&&e._ordered,s._clonePageDefinition(e.pagesDefinition))}))}},{key:"reformulateWithoutAdaptions",value:function(e){var t={cannot:!1,where:e};if(null!==e){var r,a=n(this.adaptedFields);try{for(a.s();!(r=a.n()).done;){var i=r.value;if(!0===Object(p.h)(e,i.field.name)){var l=i.rewriteSql(e,this);if(!0!==l.rewritten){t.cannot=!0,t.where=null;break}t.where=l.where}}}catch(s){a.e(s)}finally{a.f()}}return t}},{key:"_stat",value:function(e,t,r,n,i,l,s){var u=this,o=!1,c=this.reformulateWithoutAdaptions(t);return o=c.cannot,t=c.where,c=this.reformulateWithoutAdaptions(i),o=o||c.cannot,null!==(i=c.where)?null!==this._extraFilter&&(i=Object(p.a)(this._extraFilter,i)):i=this._extraFilter,!0===o?null===i&&""===r&&null===n?this._manualStat(e,t,l,s):Object(a.s)({calculated:!1}):this._parent._stat(e,t,r,n,i,l,s).then((function(a){return!1===a.calculated?null===i&&""===r&&null===n?u._manualStat(e,t,l,s):{calculated:!1}:a}))}},{key:"_canDoAggregates",value:function(e,t,r,i,l){if(null===this._parent)return Object(a.s)(!1);for(var s=0;s<e.length;s++){var u,o=n(this.adaptedFields);try{for(o.s();!(u=o.n()).done;){var c=u.value;if(e[s].toLowerCase()===c.field.name.toLowerCase()&&!(c instanceof g))return Object(a.s)(!1)}}catch(m){o.e(m)}finally{o.f()}}for(var d=[],f=0;f<t.length;f++){var h=t[f];if(null!==h.workingexpr){var y=this.reformulateWithoutAdaptions(h.workingexpr);if(y.cannot)return Object(a.s)(!1);var _=h.clone();_.workingexpr=y.where,d.push(_)}else d.push(h)}var v=this.reformulateWithoutAdaptions(l);return v.cannot?Object(a.s)(!1):(null!==(l=v.where)?null!==this._extraFilter&&(l=Object(p.a)(this._extraFilter,l)):l=this._extraFilter,this._parent._canDoAggregates(e,d,r,i,l))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,n,i,l,s){if(null===this._parent)return Object(a.r)(new Error("Should never be called"));for(var u=[],o=0;o<t.length;o++){var c=t[o];if(null!==c.workingexpr){var d=this.reformulateWithoutAdaptions(c.workingexpr);if(d.cannot)return Object(a.r)(new Error("Should never be called"));var f=c.clone();f.workingexpr=d.where,u.push(f)}else u.push(c)}var h=this.reformulateWithoutAdaptions(i);return h.cannot?Object(a.r)(new Error("Should never be called")):(null!==(i=h.where)?null!==this._extraFilter&&(i=Object(p.a)(this._extraFilter,i)):i=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,u,r,n,i,l,s))}}],[{key:"findField",value:function(e,t){var r,a=n(e);try{for(a.s();!(r=a.n()).done;){var i=r.value;if(i.name.toLowerCase()===t.toString().toLowerCase())return i}}catch(l){a.e(l)}finally{a.f()}return null}}]),r}(_.a)},OAJp:function(e,t,r){"use strict";var a=r("9MzC"),l=r("N2DF"),u=r("jWBI"),o=r("ofM5"),d=r("hTzF"),h=r("ZPxV"),y=r("B8fU"),p=r("T3Nt"),_=r("orEy"),v=r("xk++"),g=r("W9Wu"),m=function(e){i(r,e);var t=s(r);function r(e){var n;return c(this,r),(n=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",n._removeGeometry=!1,n._overrideFields=null,n._forceIsTable=!1,e.spatialReference&&(n.spatialReference=e.spatialReference),n._transparent=!0,n._maxProcessing=1e3,n._layer=e.layer,n._wset=null,!0===e.isTable&&(n._forceIsTable=!0),void 0!==e.outFields&&(n._overrideFields=e.outFields),void 0!==e.includeGeometry&&(n._removeGeometry=!1===e.includeGeometry),n}return f(r,[{key:"_maxQueryRate",value:function(){return d.f}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=Object(a.c)((function(t,r){if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{e._initialiseFeatureSet(),t(e)}catch(n){r(n)}}),r),e._layer.load()}))),this._loadPromise}},{key:"gdbVersion",get:function(){return""}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e,t=[],r=n(this.fields);try{for(r.s();!(e=r.n()).done;){var a=e.value;if("oid"===a.type)t.push(a);else{var i,l=n(this._layer.outFields);try{for(l.s();!(i=l.n()).done;){if(i.value.toLowerCase()===a.name.toLowerCase()){t.push(a);break}}}catch(g){l.e(g)}finally{l.f()}}}}catch(g){r.e(g)}finally{r.f()}this.fields=t}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var s,u=[],o=[],c=n(this.fields);try{for(c.s();!(s=c.n()).done;){var f=s.value;if("oid"===f.type)u.push(f),o.push(f.name);else{var h,y=n(this._overrideFields);try{for(y.s();!(h=y.n()).done;){if(h.value.toLowerCase()===f.name.toLowerCase()){u.push(f),o.push(f.name);break}}}catch(g){y.e(g)}finally{y.f()}}}}catch(g){c.e(g)}finally{c.f()}this.fields=u,this._overrideFields=o}this.objectIdField=this._layer.objectIdField;var p,_=n(this.fields);try{for(_.s();!(p=_.n()).done;){var v=p.value;"global-id"===v.type&&(this.globalIdField=v.name)}}catch(g){_.e(g)}finally{_.f()}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=d.a.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"isTable",value:function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}},{key:"_isInFeatureSet",value:function(){return d.b.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):Object(a.s)(this._wset)}},{key:"_changeFeature",value:function(e){var t,r={},a=n(this.fields);try{for(a.s();!(t=a.n()).done;){var i=t.value;r[i.name]=e.attributes[i.name]}}catch(l){a.e(l)}finally{a.f()}return new u.a({geometry:!0===this._removeGeometry?null:e.geometry,attributes:r})}},{key:"_getFilteredSet",value:function(e,t,r,n,i){var l=this,s="",u=!1;if(null!==n&&(s=n.constructClause(),u=!0),this.isTable()&&t&&null!==e&&""!==e){var o=new h.a([],[],!0,null);return Object(a.s)(o)}var c=new v.a;return c.where=null===r?null===t?"1=1":"":Object(y.i)(r,d.a.Standardised),c.spatialRelationship=this._makeRelationshipEnum(e),c.outSpatialReference=this.spatialReference,c.orderByFields=""!==s?s.split(","):null,c.geometry=null===t?null:t,c.returnGeometry=!0,c.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(c).then((function(e){if(null===e)return new h.a([],[],u,null);l._checkCancelled(i);var t=[];return e.features.forEach((function(e){var r=e.attributes[l._layer.objectIdField];t.push(r),l._featureCache[r]=l._changeFeature(e)})),new h.a([],t,u,null)}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_queryAllFeatures",value:function(){var e=this;if(this._wset)return Object(a.s)(this._wset);var t=new v.a;return t.where="1=1",this._ensureLoaded().then((function(){if(e._layer.source&&e._layer.source.items){var r=[];return e._layer.source.items.forEach((function(t){var n=t.attributes[e._layer.objectIdField];r.push(n),e._featureCache[n]=e._changeFeature(t)})),e._wset=new h.a([],r,!1,null),e._wset}return e._layer.queryFeatures(t).then((function(t){var r=[];return t.features.forEach((function(t){var n=t.attributes[e._layer.objectIdField];r.push(n),e._featureCache[n]=e._changeFeature(t)})),e._wset=new h.a([],r,!1,null),e._wset}))}))}},{key:"_getFeatures",value:function(e,t,r){var n=[];-1!==t&&void 0===this._featureCache[t]&&n.push(t);for(var i=e._lastFetchedIndex;i<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[i]]&&(e._known[i]!==t&&n.push(e._known[i]),n.length>r)));i++);return 0===n.length?Object(a.s)("success"):Object(a.r)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e){return Object(a.s)(e)}},{key:"_stat",value:function(){return Object(a.s)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return Object(a.s)(!1)}},{key:"relationshipMetaData",value:function(){return[]}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}},{key:"queryAttachments",value:function(){return Object(a.s)([])}},{key:"getFeatureByObjectId",value:function(e){var t=new v.a;return t.where=this.objectIdField+"="+e.toString(),this._layer.queryFeatures(t).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getOwningSystemUrl",value:function(){return Object(a.s)("")}},{key:"getIdentityUser",value:function(){return Object(a.s)("")}}],[{key:"_cloneAttr",value:function(e){var t={};for(var r in e)t[r]=e[r];return t}},{key:"create",value:function(e,t){var a=e.layerDefinition.objectIdField,i=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",s=[];if(e.layerDefinition.types){var u,c=n(e.layerDefinition.types);try{for(c.s();!(u=c.n()).done;){var d=u.value;s.push(_.a.fromJSON(d))}}catch(q){c.e(q)}finally{c.f()}}var f=e.layerDefinition.geometryType;void 0===f&&(f=e.featureSet.geometryType||"");var h=e.featureSet.features,y=t.toJSON();if(""===a||void 0===a){var p,v=!1,m=n(e.layerDefinition.fields);try{for(m.s();!(p=m.n()).done;){var b=p.value;if("oid"===b.type||"esriFieldTypeOID"===b.type){a=b.name,v=!0;break}}}catch(q){m.e(q)}finally{m.f()}if(!1===v){for(var w="FID",F=!0,S=0;F;){var k,I=!0,O=n(e.layerDefinition.fields);try{for(O.s();!(k=O.n()).done;){if(k.value.name===w){I=!1;break}}}catch(q){O.e(q)}finally{O.f()}!0===I?F=!1:w="FID"+(++S).toString()}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:w,alias:w});for(var C=[],j=0;j<h.length;j++)C.push({geometry:e.featureSet.features[j].geometry,attributes:e.featureSet.features[j].attributes?this._cloneAttr(e.featureSet.features[j].attributes):{}}),C[j].attributes[w]=j;h=C,a=w}}var D,R=[],T=n(e.layerDefinition.fields);try{for(T.s();!(D=T.n()).done;){var x=D.value;R.push(x instanceof o.a?x:o.a.fromJSON(x))}}catch(q){T.e(q)}finally{T.f()}var N=f;switch(N){case"esriGeometryPoint":N="point";break;case"esriGeometryPolyline":N="polyline";break;case"esriGeometryPolygon":N="polygon";break;case"esriGeometryExtent":N="extent";break;case"esriGeometryMultipoint":N="multipoint"}var P,E=n(h);try{for(E.s();!(P=E.n()).done;){var A=P.value;A.geometry&&A.geometry instanceof l.a==0&&(A.geometry.type=N,void 0===A.geometry.spatialReference&&(A.geometry.spatialReference=y))}}catch(q){E.e(q)}finally{E.f()}var L={outFields:["*"],source:h,fields:R,types:s,typeIdField:i,objectIdField:a,spatialReference:t};return L.geometryType=N||"point",new r({layer:new g.default(L),spatialReference:t,isTable:null===N||""===N})}}]),r}(p.a);t.a=m},Xbkg:function(e,t,r){"use strict";var a=r("9MzC"),l=r("idrm"),u=r("ZPxV"),o=r("T3Nt"),d=r("lq8Q"),h=function(e){i(r,e);var t=s(r);function r(e){var n;return c(this,r),(n=t.call(this,e))._orderbyclause=null,n.declaredClass="esri.arcade.featureset.actions.OrderBy",n._maxProcessing=100,n._orderbyclause=e.orderbyclause,n._parent=e.parentfeatureset,n}return f(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,t._orderbyclause,e)})).then((function(r){return t._checkCancelled(e),t._wset=r,t._wset})):Object(a.s)(this._wset)}},{key:"manualOrderSet",value:function(e,t){var r=this;return this.getIdColumnDictionary(e,[],-1,t).then((function(e){r._orderbyclause.order(e);for(var t=new u.a([],[],!0,null),n=0;n<e.length;n++)t._known.push(e[n].id);return t}))}},{key:"getIdColumnDictionary",value:function(e,t,r,i){var s=this;if(r<e._known.length-1){var u=this._maxQueryRate();if("GETPAGES"===e._known[r+1])return Object(l.q)(this._parent._expandPagedSet(e,u,0,0,i)).then((function(){return s.getIdColumnDictionary(e,t,r,i)}));for(var o=r+1,c=[];o<e._known.length&&"GETPAGES"!==e._known[o];)c.push(e._known[o]),o++;return r+=c.length,Object(l.q)(this._parent._getFeatureBatch(c,i)).then((function(a){s._checkCancelled(i);var l,u=n(a);try{for(u.s();!(l=u.n()).done;){var o=l.value;t.push({id:o.attributes[s.objectIdField],feature:o})}}catch(c){u.e(c)}finally{u.f()}return s.getIdColumnDictionary(e,t,r,i)}))}return e._candidates.length>0?Object(l.q)(this._refineSetBlock(e,this._maxProcessingRate(),i)).then((function(){return s._checkCancelled(i),s.getIdColumnDictionary(e,t,r,i)})):Object(a.s)(t)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,n){return this._parent._getFeatures(e,t,r,n)}},{key:"_featureFromCache",value:function(e){if(void 0===this._featureCache[e]){var t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}},{key:"_fetchAndRefineFeatures",value:function(){return Object(a.r)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,null===n?i._orderbyclause:n,a)})).then((function(e){i._checkCancelled(a);var n=new u.a(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition)),l=!0;return e._candidates.length>0&&(l=!1),!1===n._ordered?i.manualOrderSet(n,a).then((function(e){return!1===l&&(null===t&&null===r||(e=new u.a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)))),e})):n}))}}],[{key:"registerAction",value:function(){o.a._featuresetFunctions.orderBy=function(e){return""===e?this:new r({parentfeatureset:this,orderbyclause:new d.a(e)})}}}]),r}(o.a);t.a=h},YP08:function(e,t,r){"use strict";var n=r("9MzC"),a=r("hTzF"),l=r("ZPxV"),u=r("T3Nt"),o=function(e){i(r,e);var t=s(r);function r(e){var n;return c(this,r),(n=t.call(this,e))._topnum=0,n.declaredClass="esri.arcade.featureset.actions.Top",n._countedin=0,n._maxProcessing=100,n._topnum=e.topnum,n._parent=e.parentfeatureset,n}return f(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getSet(e)})).then((function(e){return t._wset=new l.a(e._candidates.slice(0),e._known.slice(0),!1,t._clonePageDefinition(e.pagesDefinition)),t._setKnownLength(t._wset)>t._topnum&&(t._wset._known=t._wset._known.slice(0,t._topnum)),t._setKnownLength(t._wset)>=t._topnum&&(t._wset._candidates=[]),t._wset})):Object(n.s)(this._wset)}},{key:"_setKnownLength",value:function(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);if(t===a.b.NotInFeatureSet)return t;var r=this._idstates[e];return r===a.b.InFeatureSet||r===a.b.NotInFeatureSet?r:t===a.b.InFeatureSet&&void 0===r?this._countedin<this._topnum?(this._idstates[e]=a.b.InFeatureSet,this._countedin++,a.b.InFeatureSet):(this._idstates[e]=a.b.NotInFeatureSet,a.b.NotInFeatureSet):a.b.Unknown}},{key:"_expandPagedSet",value:function(e,t,r,a,i){var l=this;if(null===this._parent)return Object(n.r)(new Error("Parent Paging not implemented"));if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){var s=e._known.length;return s>0&&"GETPAGES"===e._known[s-1]&&(e._known.length=s-1),(s=e._candidates.length)>0&&"GETPAGES"===e._candidates[s-1]&&(e._candidates.length=s-1),Object(n.s)("success")}return this._parent._expandPagedSet(e,t,r,a,i).then((function(t){return l._setKnownLength(e)>l._topnum&&(e._known.length=l._topnum),l._setKnownLength(e)>=l._topnum&&(e._candidates.length=0),t}))}},{key:"_getFeatures",value:function(e,t,r,a){var i=this,s=[],u=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,u))return this._expandPagedSet(e,u,0,0,a).then((function(){return i._getFeatures(e,t,r,a)}));-1!==t&&void 0===this._featureCache[t]&&s.push(t);for(var o=0,c=e._lastFetchedIndex;c<e._known.length&&(++o<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[c]]&&(e._known[c]!==t&&s.push(e._known[c]),s.length>u-1)));c++);if(0===s.length)return Object(n.s)("success");var d=new l.a([],s,!1,null),f=Math.min(s.length,r);return this._parent._getFeatures(d,-1,f,a).then((function(){for(var e=0;e<f;e++){var t=i._parent._featureFromCache(s[e]);void 0!==t&&(i._featureCache[s[e]]=t)}return"success"}))}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return this._ensureLoaded().then((function(){return i._getSet(a)})).then((function(e){return new l.a(e._candidates.slice(0).concat(e._known.slice(0)),[],!1,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_refineKnowns",value:function(e,t){for(var r=0,n=null,i=[],l=0;l<e._candidates.length;l++){var s=this._isInFeatureSet(e._candidates[l]);if(s===a.b.InFeatureSet){if(e._known.push(e._candidates[l]),r+=1,null===n?n={start:l,end:l}:n.end===l-1?n.end=l:(i.push(n),n={start:l,end:l}),e._known.length>=this._topnum)break}else if(s===a.b.NotInFeatureSet)null===n?n={start:l,end:l}:n.end===l-1?n.end=l:(i.push(n),n={start:l,end:l}),r+=1;else if(s===a.b.Unknown)break;if(r>=t)break}null!==n&&i.push(n);for(var u=i.length-1;u>=0;u--)e._candidates.splice(i[u].start,i[u].end-i[u].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])}},{key:"_stat",value:function(){return Object(n.s)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return Object(n.s)(!1)}}],[{key:"registerAction",value:function(){u.a._featuresetFunctions.top=function(e){return new r({parentfeatureset:this,topnum:e})}}}]),r}(u.a);t.a=o},fvq6:function(e,t,r){"use strict";r.d(t,"a",(function(){return d})),r.d(t,"b",(function(){return n}));var n={Base64:0,Hex:1,String:2,Raw:3};function a(e,t){var r=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(r>>16)<<16|65535&r}function i(e,t,r,n,i,l){return a(function(e,t){return e<<t|e>>>32-t}(a(a(t,e),a(n,l)),i),r)}function l(e,t,r,n,a,l,s){return i(t&r|~t&n,e,t,a,l,s)}function s(e,t,r,n,a,l,s){return i(t&n|r&~n,e,t,a,l,s)}function u(e,t,r,n,a,l,s){return i(t^r^n,e,t,a,l,s)}function o(e,t,r,n,a,l,s){return i(r^(t|~n),e,t,a,l,s)}function c(e,t){e[t>>5]|=128<<t%32,e[14+(t+64>>>9<<4)]=t;for(var r=1732584193,n=-271733879,i=-1732584194,c=271733878,d=0;d<e.length;d+=16){var f=r,h=n,y=i,p=c;r=l(r,n,i,c,e[d+0],7,-680876936),c=l(c,r,n,i,e[d+1],12,-389564586),i=l(i,c,r,n,e[d+2],17,606105819),n=l(n,i,c,r,e[d+3],22,-1044525330),r=l(r,n,i,c,e[d+4],7,-176418897),c=l(c,r,n,i,e[d+5],12,1200080426),i=l(i,c,r,n,e[d+6],17,-1473231341),n=l(n,i,c,r,e[d+7],22,-45705983),r=l(r,n,i,c,e[d+8],7,1770035416),c=l(c,r,n,i,e[d+9],12,-1958414417),i=l(i,c,r,n,e[d+10],17,-42063),n=l(n,i,c,r,e[d+11],22,-1990404162),r=l(r,n,i,c,e[d+12],7,1804603682),c=l(c,r,n,i,e[d+13],12,-40341101),i=l(i,c,r,n,e[d+14],17,-1502002290),r=s(r,n=l(n,i,c,r,e[d+15],22,1236535329),i,c,e[d+1],5,-165796510),c=s(c,r,n,i,e[d+6],9,-1069501632),i=s(i,c,r,n,e[d+11],14,643717713),n=s(n,i,c,r,e[d+0],20,-373897302),r=s(r,n,i,c,e[d+5],5,-701558691),c=s(c,r,n,i,e[d+10],9,38016083),i=s(i,c,r,n,e[d+15],14,-660478335),n=s(n,i,c,r,e[d+4],20,-405537848),r=s(r,n,i,c,e[d+9],5,568446438),c=s(c,r,n,i,e[d+14],9,-1019803690),i=s(i,c,r,n,e[d+3],14,-187363961),n=s(n,i,c,r,e[d+8],20,1163531501),r=s(r,n,i,c,e[d+13],5,-1444681467),c=s(c,r,n,i,e[d+2],9,-51403784),i=s(i,c,r,n,e[d+7],14,1735328473),r=u(r,n=s(n,i,c,r,e[d+12],20,-1926607734),i,c,e[d+5],4,-378558),c=u(c,r,n,i,e[d+8],11,-2022574463),i=u(i,c,r,n,e[d+11],16,1839030562),n=u(n,i,c,r,e[d+14],23,-35309556),r=u(r,n,i,c,e[d+1],4,-1530992060),c=u(c,r,n,i,e[d+4],11,1272893353),i=u(i,c,r,n,e[d+7],16,-155497632),n=u(n,i,c,r,e[d+10],23,-1094730640),r=u(r,n,i,c,e[d+13],4,681279174),c=u(c,r,n,i,e[d+0],11,-358537222),i=u(i,c,r,n,e[d+3],16,-722521979),n=u(n,i,c,r,e[d+6],23,76029189),r=u(r,n,i,c,e[d+9],4,-640364487),c=u(c,r,n,i,e[d+12],11,-421815835),i=u(i,c,r,n,e[d+15],16,530742520),r=o(r,n=u(n,i,c,r,e[d+2],23,-995338651),i,c,e[d+0],6,-198630844),c=o(c,r,n,i,e[d+7],10,1126891415),i=o(i,c,r,n,e[d+14],15,-1416354905),n=o(n,i,c,r,e[d+5],21,-57434055),r=o(r,n,i,c,e[d+12],6,1700485571),c=o(c,r,n,i,e[d+3],10,-1894986606),i=o(i,c,r,n,e[d+10],15,-1051523),n=o(n,i,c,r,e[d+1],21,-2054922799),r=o(r,n,i,c,e[d+8],6,1873313359),c=o(c,r,n,i,e[d+15],10,-30611744),i=o(i,c,r,n,e[d+6],15,-1560198380),n=o(n,i,c,r,e[d+13],21,1309151649),r=o(r,n,i,c,e[d+4],6,-145523070),c=o(c,r,n,i,e[d+11],10,-1120210379),i=o(i,c,r,n,e[d+2],15,718787259),n=o(n,i,c,r,e[d+9],21,-343485551),r=a(r,f),n=a(n,h),i=a(i,y),c=a(c,p)}return[r,n,i,c]}function d(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:n.Hex,r=t||n.Base64,a=c(function(e){for(var t=[],r=0,n=8*e.length;r<n;r+=8)t[r>>5]|=(255&e.charCodeAt(r/8))<<r%32;return t}(e),8*e.length);switch(r){case n.Raw:return a;case n.Hex:return function(e){for(var t="0123456789abcdef",r=[],n=0,a=4*e.length;n<a;n++)r.push(t.charAt(e[n>>2]>>n%4*8+4&15)+t.charAt(e[n>>2]>>n%4*8&15));return r.join("")}(a);case n.String:return function(e){for(var t=[],r=0,n=32*e.length;r<n;r+=8)t.push(String.fromCharCode(e[r>>5]>>>r%32&255));return t.join("")}(a);case n.Base64:return function(e){for(var t=[],r=0,n=4*e.length;r<n;r+=3)for(var a=(e[r>>2]>>r%4*8&255)<<16|(e[r+1>>2]>>(r+1)%4*8&255)<<8|e[r+2>>2]>>(r+2)%4*8&255,i=0;i<4;i++)t.push(8*r+6*i>32*e.length?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(a>>6*(3-i)&63));return t.join("")}(a)}}},lNzE:function(e,t,r){"use strict";var n=r("9MzC");t.a=function(){function e(){c(this,e),this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}return f(e,[{key:"add",value:function(e,t,r){this._layerById[t]=r,this._layerByName[e]=r}},{key:"featureSetByName",value:function(e){return this.resolvePromise(void 0===this._layerByName[e]?null:this._layerByName[e])}},{key:"featureSetById",value:function(e){return this.resolvePromise(void 0===this._layerById[e]?null:this._layerById[e])}},{key:"castToText",value:function(){return"object, FeatureSetCollection"}},{key:"resolvePromise",value:function(e){return Object(n.s)(e)}}]),e}()},lq8Q:function(e,t,r){"use strict";function a(e,t){return e===t?0:null===e?-1:null===t?1:e<t?-1:1}var i=function(){function e(t){c(this,e);var r=t.split(",");this._fields=[],this._directions=[];for(var n=0;n<r.length;n++){var a=r[n].match(/\S+/g);this._fields.push(a[0]),2===a.length?"asc"===a[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}return f(e,[{key:"constructClause",value:function(){for(var e="",t=0;t<this._fields.length;t++)0!==t&&(e+=","),e+=this._fields[t],e+=1===this._directions[t]?" ASC":" DESC";return e}},{key:"order",value:function(e){var t=this;e.sort((function(e,r){for(var n=0;n<t._fields.length;n++){var i,l=t.featureValue(e.feature,t._fields[n],n),s=t.featureValue(r.feature,t._fields[n],n);if(0!==(i=1===t._directions[n]?a(l,s):-1*a(l,s)))return i}return 0}))}},{key:"scanForField",value:function(e){for(var t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}},{key:"replaceFields",value:function(t){for(var r="",a=0;a<this._fields.length;a++){0!==a&&(r+=",");var i,l=this._fields[a],s=n(t);try{for(s.s();!(i=s.n()).done;){var u=i.value;if(l.toLowerCase()===u.field.toLowerCase()){l=u.newfield;break}}}catch(o){s.e(o)}finally{s.f()}r+=l,r+=1===this._directions[a]?" ASC":" DESC"}return new e(r)}},{key:"featureValue",value:function(e,t,r){var n=e.attributes[t];if(void 0!==n)return n;for(var a in e.attributes)if(t.toLowerCase()===a.toLowerCase())return this._fields[r]=a,e.attributes[a];return null}}]),e}();t.a=i},nC36:function(e,t,r){"use strict";var n=r("9MzC"),a=r("WZb1"),l=r("hTzF"),u=r("ZPxV"),o=r("ZqIb"),d=r("B8fU"),h=r("T3Nt"),y=function(e){i(r,e);var t=s(r);function r(e){var n;return c(this,r),(n=t.call(this,e)).declaredClass="esri.arcade.featureset.actions.AttributeFilter",n._maxProcessing=1e3,n._parent=e.parentfeatureset,e.whereclause instanceof o.WhereClause?(n._whereclause=e.whereclause,n._whereClauseFunction=null):(n._whereClauseFunction=e.whereclause,n._whereclause=null),n}return f(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new a.a({wkid:4326}),this.geometryType=l.m.point)}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getFilteredSet("",null,t._whereclause,null,e)})).then((function(r){return t._checkCancelled(e),t._wset=null!==t._whereClauseFunction?new u.a(r._candidates.slice(0).concat(r._known.slice(0)),[],r._ordered,t._clonePageDefinition(r.pagesDefinition)):new u.a(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):Object(n.s)(this._wset)}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);return t===l.b.NotInFeatureSet?t:void 0===(t=this._idstates[e])?l.b.Unknown:t}},{key:"_getFeature",value:function(e,t,r){return this._parent._getFeature(e,t,r)}},{key:"_getFeatures",value:function(e,t,r,n){return this._parent._getFeatures(e,t,r,n)}},{key:"_featureFromCache",value:function(e){return this._parent._featureFromCache(e)}},{key:"executeWhereClause",value:function(e){return this._whereclause.testFeature(e)}},{key:"executeWhereClauseDeferred",value:function(e){if(null!==this._whereClauseFunction)try{var t=this._whereClauseFunction(e);return Object(n.o)(t)?t:Object(n.s)(t)}catch(r){return Object(n.r)(r)}return Object(n.s)(this.executeWhereClause(e))}},{key:"_fetchAndRefineFeatures",value:function(e,t,r){var a=this,i=new u.a([],e,!1,null),s=Math.min(t,e.length);return this._parent._getFeatures(i,-1,s,r).then((function(){if(a._checkCancelled(r),null==a._whereClauseFunction){for(var i=0;i<s;i++){var u=a._parent._featureFromCache(e[i]);a._idstates[e[i]]=!0===a.executeWhereClause(u)?l.b.InFeatureSet:l.b.NotInFeatureSet}return"success"}for(var o=[],c=0;c<s;c++){var d=a._parent._featureFromCache(e[c]);o.push(a.executeWhereClauseDeferred(d))}return Object(n.b)(o).then((function(r){for(var n=0;n<t;n++)a._idstates[e[n]]=!0===r[n]?l.b.InFeatureSet:l.b.NotInFeatureSet;return"success"}))}))}},{key:"_getFilteredSet",value:function(e,t,r,n,a){var i=this;return null!==this._whereClauseFunction||(null!==r?null!==this._whereclause&&(r=Object(d.a)(this._whereclause,r)):r=this._whereclause),this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,n,a)})).then((function(e){return i._checkCancelled(a),null!==i._whereClauseFunction?new u.a(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)):new u.a(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_stat",value:function(e,t,r,a,i,l,s){var u=this;if(null!==this._whereClauseFunction)return null===i&&""===r&&null===a?this._manualStat(e,t,l,s):Object(n.s)({calculated:!1});var o=this._whereclause;return null!==i&&null!==this._whereclause&&(o=Object(d.a)(this._whereclause,i)),this._parent._stat(e,t,r,a,o,l,s).then((function(n){return!1===n.calculated?null===i&&""===r&&null===a?u._manualStat(e,t,l,s):{calculated:!1}:n}))}},{key:"_canDoAggregates",value:function(e,t,r,a,i){return null!==this._whereClauseFunction?Object(n.s)(!1):(null!==i?null!==this._whereclause&&(i=Object(d.a)(this._whereclause,i)):i=this._whereclause,null===this._parent?Object(n.s)(!1):this._parent._canDoAggregates(e,t,r,a,i))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,i,l,s){return null===this._parent?Object(n.r)(new Error("Should never be called")):(null!==i?null!==this._whereclause&&(i=Object(d.a)(this._whereclause,i)):i=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,r,a,i,l,s))}}],[{key:"registerAction",value:function(){h.a._featuresetFunctions.filter=function(e){if("function"==typeof e)return new r({parentfeatureset:this,whereclause:e});var t=null;return e instanceof o.WhereClause&&(t=e),new r({parentfeatureset:this,whereclause:t})}}}]),r}(h.a);t.a=y}}])}();