!function(){function e(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,r)}return n}function t(t){for(var r=1;r<arguments.length;r++){var a=null!=arguments[r]?arguments[r]:{};r%2?e(Object(a),!0).forEach(function(e){n(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):e(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function n(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t,n,r,a,i,o){try{var l=e[i](o),s=l.value}catch(u){return void n(u)}l.done?t(s):Promise.resolve(s).then(r,a)}function a(e){return function(){var t=this,n=arguments;return new Promise(function(a,i){var o=e.apply(t,n);function l(e){r(o,a,i,l,s,"next",e)}function s(e){r(o,a,i,l,s,"throw",e)}l(void 0)})}}function i(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"==typeof e)return o(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return o(e,t)}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,l=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return l=e.done,e},e:function(e){s=!0,i=e},f:function(){try{l||null==n.return||n.return()}finally{if(s)throw i}}}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}function l(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var n,r=f(e);if(t){var a=f(this).constructor;n=Reflect.construct(r,arguments,a)}else n=r.apply(this,arguments);return c(this,n)}}function c(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function f(e){return(f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function p(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function v(e,t,n){return t&&h(e.prototype,t),n&&h(e,n),e}(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{LfYK:function(e,n,r){"use strict";r.r(n),r.d(n,"ElevationQuery",function(){return D}),r.d(n,"GeometryDescriptor",function(){return C}),r.d(n,"getFinestLodIndex",function(){return F});var o=r("srIe"),s=r("zlDU"),c=r("9MzC"),f=r("SuVq"),h=r("V9wi"),y=r("UhwK"),m=r("eSsm"),d=r("gEht"),x=r("kYAx"),g=r("gYg2"),b=(r("wSAH"),r("6S2I")),k=r("l4ZG"),w=r("IXLn");r("4GrV");var R=b.a.getLogger("esri.layers.support.ElevationSampler"),T=function(){function e(){p(this,e)}return v(e,[{key:"queryElevation",value:function(e){return function(e,t){var n=j(e,t.spatialReference);if(!n)return null;switch(e.type){case"point":!function(e,t,n){e.z=Object(o.r)(n.elevationAt(t),0)}(e,n,t);break;case"polyline":!function(e,t,n){E.spatialReference=t.spatialReference;for(var r=e.hasM&&!e.hasZ,a=0;a<e.paths.length;a++)for(var i=e.paths[a],l=t.paths[a],s=0;s<i.length;s++){var u=i[s],c=l[s];E.x=c[0],E.y=c[1],r&&(u[3]=u[2]),u[2]=Object(o.r)(n.elevationAt(E),0)}e.hasZ=!0}(e,n,t);break;case"multipoint":!function(e,t,n){E.spatialReference=t.spatialReference;for(var r=e.hasM&&!e.hasZ,a=0;a<e.points.length;a++){var i=e.points[a],l=t.points[a];E.x=l[0],E.y=l[1],r&&(i[3]=i[2]),i[2]=Object(o.r)(n.elevationAt(E),0)}e.hasZ=!0}(e,n,t)}return e}(e.clone(),this)}},{key:"on",value:function(){return A}},{key:"projectIfRequired",value:function(e,t){return j(e,t)}}]),e}(),O=function(e){l(n,e);var t=u(n);function n(e,r,a){var i;p(this,n),(i=t.call(this)).tile=e,i.noDataValue=a,i.extent=Object(x.p)(e.tile.extent,r.spatialReference);var o=Object(d.f)(r.spatialReference),l=r.lodAt(e.tile.level).resolution*o;return i.demResolution={min:l,max:l},i}return v(n,[{key:"spatialReference",get:function(){return this.extent.spatialReference}},{key:"contains",value:function(e){var t=this.projectIfRequired(e,this.spatialReference);return Object(w.e)(this.extent,t)}},{key:"elevationAt",value:function(e){var t=this.projectIfRequired(e,this.spatialReference);if(!t)return null;if(!this.contains(e)){var n=this.extent;R.warn("#elevationAt()","Point used to sample elevation (".concat(e.x,", ").concat(e.y,") is outside of the sampler extent (").concat(n.xmin,", ").concat(n.ymin,", ").concat(n.xmax,", ").concat(n.ymax,")"))}return this.tile.sample(t.x,t.y)}}]),n}(T),_=function(e){l(n,e);var t=u(n);function n(e,r,a){var i,o;p(this,n),i=t.call(this),"number"==typeof r?(i.noDataValue=r,o=null):(o=r,i.noDataValue=a),i.samplers=o?e.map(function(e){return new O(e,o,i.noDataValue)}):e;var l=i.samplers[0];if(l){i.extent=l.extent.clone();var s=l.demResolution,u=s.min,c=s.max;i.demResolution={min:u,max:c};for(var f=1;f<i.samplers.length;f++){var h=i.samplers[f];i.extent.union(h.extent),i.demResolution.min=Math.min(i.demResolution.min,h.demResolution.min),i.demResolution.max=Math.max(i.demResolution.max,h.demResolution.max)}}else i.extent=Object(x.p)(Object(x.g)(),o.spatialReference),i.demResolution={min:0,max:0};return i}return v(n,[{key:"spatialReference",get:function(){return this.extent.spatialReference}},{key:"elevationAt",value:function(e){var t=this.projectIfRequired(e,this.spatialReference);if(!t)return null;var n,r=i(this.samplers);try{for(r.s();!(n=r.n()).done;){var a=n.value;if(a.contains(t))return a.elevationAt(t)}}catch(o){r.e(o)}finally{r.f()}return R.warn("#elevationAt()","Point used to sample elevation (".concat(e.x,", ").concat(e.y,") is outside of the sampler")),null}}]),n}(T);function j(e,t){var n=e.spatialReference;return n.equals(t)?e:Object(k.a)(n,t)?Object(k.d)(e,t):(R.error("Cannot project geometry spatial reference (wkid:".concat(n.wkid,") to elevation sampler spatial reference (wkid:").concat(t.wkid,")")),null)}var E=new f.a,A={remove:function(){}},q=function(){function e(t,n){if(p(this,e),this.tile=t,n){var r=this.tile.extent;this.samplerData={pixelData:n.values,width:n.width,height:n.height,safeWidth:.99999999*(n.width-1),noDataValue:n.noDataValue,dx:(n.width-1)/(r[2]-r[0]),dy:(n.width-1)/(r[3]-r[1]),x0:r[0],y1:r[3]}}else this.samplerData=null}return v(e,[{key:"sample",value:function(e,t){if(this.samplerData)return function(e,t,n){var r=e.safeWidth,a=e.width,i=e.pixelData,o=e.noDataValue,l=I(e.dy*(e.y1-n),0,r),s=I(e.dx*(t-e.x0),0,r),u=Math.floor(l),c=Math.floor(s),f=u*a+c,p=f+a,h=i[f],v=i[p],y=i[f+1],m=i[p+1];if(h!==o&&v!==o&&y!==o&&m!==o){var d=s-c,x=h+(y-h)*d;return x+(v+(m-v)*d-x)*(l-u)}}(this.samplerData,e,t)}}]),e}();function I(e,t,n){return e<t?t:e>n?n:e}var D=function(){function e(){p(this,e)}var n,r,i,l,u,f,h,y,b,k,w,R,T,O,j;return v(e,[{key:"queryAll",value:(j=a(regeneratorRuntime.mark(function e(n,r,a){var i,o,l,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if((n=a&&a.ignoreInvisibleLayers?n.filter(function(e){return e.visible}):n.slice()).length){e.next=2;break}throw new s.a("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");case 2:return i=C.fromGeometry(r),o=!1,a&&a.returnSampleInfo||(o=!0),l=t(t(t({},P),a),{},{returnSampleInfo:!0}),e.next=8,this.query(n[n.length-1],i,l);case 8:return u=e.sent,e.next=11,this._queryAllContinue(n,u,l);case 11:return c=e.sent,e.abrupt("return",(c.geometry=c.geometry.export(),o&&delete c.sampleInfo,c));case 13:case"end":return e.stop()}},e,this)})),function(e,t,n){return j.apply(this,arguments)})},{key:"query",value:(O=a(regeneratorRuntime.mark(function e(n,r,a){var i,o,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}throw new s.a("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");case 2:if(r&&(r instanceof C||"point"===r.type||"multipoint"===r.type||"polyline"===r.type)){e.next=4;break}throw new s.a("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation");case 4:return i=t(t({},P),a),o=new M(n,r.spatialReference,i),l=i.signal,e.next=7,n.load({signal:l});case 7:return e.next=9,this._createGeometryDescriptor(o,r,l);case 9:return e.next=11,this._selectTiles(o,l);case 11:return e.next=13,this._populateElevationTiles(o,l);case 13:return this._sampleGeometryWithElevation(o),e.abrupt("return",this._createQueryResult(o,l));case 15:case"end":return e.stop()}},e,this)})),function(e,t,n){return O.apply(this,arguments)})},{key:"createSampler",value:(T=a(regeneratorRuntime.mark(function e(n,r,a){var i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}throw new s.a("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from");case 2:if(r&&"extent"===r.type){e.next=4;break}throw new s.a("elevation-query:invalid-extent","Invalid or undefined extent");case 4:return i=t(t({},P),a),e.abrupt("return",this._createSampler(n,r,i));case 6:case"end":return e.stop()}},e,this)})),function(e,t,n){return T.apply(this,arguments)})},{key:"createSamplerAll",value:(R=a(regeneratorRuntime.mark(function e(n,r,a){var i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if((n=a&&a.ignoreInvisibleLayers?n.filter(function(e){return e.visible}):n.slice()).length){e.next=2;break}throw new s.a("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from");case 2:if(r&&"extent"===r.type){e.next=4;break}throw new s.a("elevation-query:invalid-extent","Invalid or undefined extent");case 4:return i=t(t(t({},P),a),{},{returnSampleInfo:!0}),e.next=7,this._createSampler(n[n.length-1],r,i);case 7:return o=e.sent,e.abrupt("return",this._createSamplerAllContinue(n,r,o,i));case 9:case"end":return e.stop()}},e,this)})),function(e,t,n){return R.apply(this,arguments)})},{key:"_createSampler",value:(w=a(regeneratorRuntime.mark(function e(t,n,r,a){var i,o,l,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return i=r.signal,e.next=3,t.load({signal:i});case 3:if(o=n.spatialReference,l=t.tileInfo.spatialReference,e.t0=o.equals(l),e.t0){e.next=9;break}return e.next=8,Object(g.f)([{source:o,dest:l}],{signal:i});case 8:n=Object(g.j)(n,l);case 9:return s=new z(t,n,r,a),e.next=12,this._selectTiles(s,i);case 12:return e.next=14,this._populateElevationTiles(s,i);case 14:return e.abrupt("return",new _(s.elevationTiles,s.layer.tileInfo,s.options.noDataValue));case 15:case"end":return e.stop()}},e,this)})),function(e,t,n,r){return w.apply(this,arguments)})},{key:"_createSamplerAllContinue",value:(k=a(regeneratorRuntime.mark(function e(t,n,r,a){var i,o,l,s;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t.pop(),t.length){e.next=2;break}return e.abrupt("return",r);case 2:return i=r.samplers.map(function(e){return Object(x.k)(e.extent)}),e.next=5,this._createSampler(t[t.length-1],n,a,i);case 5:if(0!==(o=e.sent).samplers.length){e.next=8;break}return e.abrupt("return",r);case 8:return l=r.samplers.concat(o.samplers),s=new _(l,a.noDataValue),e.abrupt("return",this._createSamplerAllContinue(t,n,s,a));case 10:case"end":return e.stop()}},e,this)})),function(e,t,n,r){return k.apply(this,arguments)})},{key:"_queryAllContinue",value:(b=a(regeneratorRuntime.mark(function e(t,n,r){var a,i,o,l,s,u,c,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(a=t.pop(),i=n.geometry.coordinates,o=[],l=[],s=0;s<i.length;s++)(u=n.sampleInfo[s]).demResolution>=0?u.source||(u.source=a):t.length&&(o.push(i[s]),l.push(s));if(t.length&&0!==o.length){e.next=4;break}return e.abrupt("return",n);case 4:return c=n.geometry.clone(o),e.next=7,this.query(t[t.length-1],c,r);case 7:return f=e.sent,e.abrupt("return",(l.forEach(function(e,t){i[e].z=f.geometry.coordinates[t].z,n.sampleInfo[e].demResolution=f.sampleInfo[t].demResolution}),this._queryAllContinue(t,n,r)));case 9:case"end":return e.stop()}},e,this)})),function(e,t,n){return b.apply(this,arguments)})},{key:"_createQueryResult",value:(y=a(regeneratorRuntime.mark(function e(t,n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.geometry.project(t.outSpatialReference,n);case 2:return e.t0=e.sent.export(),e.t1=t.options.noDataValue,r={geometry:e.t0,noDataValue:e.t1},e.abrupt("return",(t.options.returnSampleInfo&&(r.sampleInfo=this._extractSampleInfo(t)),t.geometry.coordinates.forEach(function(e){e.tile=null,e.elevationTile=null}),r));case 6:case"end":return e.stop()}},e,this)})),function(e,t){return y.apply(this,arguments)})},{key:"_createGeometryDescriptor",value:(h=a(regeneratorRuntime.mark(function e(t,n,r){var a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.layer.tileInfo.spatialReference,!(n instanceof C)){e.next=7;break}return e.next=4,n.project(i,r);case 4:a=e.sent,e.next=10;break;case 7:return e.next=9,Object(g.f)([{source:n.spatialReference,dest:i}],{signal:r});case 9:a=Object(g.j)(n,i);case 10:if(a){e.next=12;break}throw new s.a("elevation-query:spatial-reference-mismatch","Cannot query elevation in '".concat(n.spatialReference.wkid,"' on an elevation service in '").concat(i.wkid,"'"));case 12:t.geometry=C.fromGeometry(a);case 13:case"end":return e.stop()}},e)})),function(e,t,n){return h.apply(this,arguments)})},{key:"_selectTiles",value:(f=a(regeneratorRuntime.mark(function e(t,n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.options.demResolution,"geometry"===t.type&&this._preselectOutsideLayerExtent(t),"number"!=typeof r){e.next=5;break}this._selectTilesClosestResolution(t),e.next=14;break;case 5:if("finest-contiguous"!==r){e.next=10;break}return e.next=8,this._selectTilesFinestContiguous(t,n);case 8:e.next=14;break;case 10:if("auto"===r){e.next=12;break}throw new s.a("elevation-query:invalid-dem-resolution","Invalid dem resolution value '".concat(r,'\', expected a number, "finest-contiguous" or "auto"'));case 12:return e.next=14,this._selectTilesAuto(t,n);case 14:case"end":return e.stop()}},e,this)})),function(e,t){return f.apply(this,arguments)})},{key:"_preselectOutsideLayerExtent",value:function(e){var t=new q(null);t.sample=function(){return e.options.noDataValue},e.outsideExtentTile=t;var n=e.layer.fullExtent;e.geometry.coordinates.forEach(function(e){var r=e.x,a=e.y;(r<n.xmin||r>n.xmax||a<n.ymin||a>n.ymax)&&(e.elevationTile=t)})}},{key:"_selectTilesClosestResolution",value:function(e){var t=this._findNearestDemResolutionLODIndex(e.layer.tileInfo,e.options.demResolution);e.selectTilesAtLOD(t)}},{key:"_findNearestDemResolutionLODIndex",value:function(e,t){for(var n=t/Object(d.f)(e.spatialReference),r=e.lods[0],a=0,i=1;i<e.lods.length;i++){var o=e.lods[i];Math.abs(o.resolution-n)<Math.abs(r.resolution-n)&&(r=o,a=i)}return a}},{key:"_selectTilesFinestContiguous",value:(u=a(regeneratorRuntime.mark(function e(t,n){var r;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=F(t.layer.tileInfo,t.options.minDemResolution),e.next=3,this._selectTilesFinestContiguousAt(t,r,n);case 3:case"end":return e.stop()}},e,this)})),function(e,t){return u.apply(this,arguments)})},{key:"_selectTilesFinestContiguousAt",value:(l=a(regeneratorRuntime.mark(function e(t,n,r){var a,i,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.layer,t.selectTilesAtLOD(n),!(n<0)){e.next=3;break}return e.abrupt("return");case 3:if(i=a.tilemapCache,o=t.getTilesToFetch(),e.prev=4,!i){e.next=10;break}return e.next=8,Object(c.x)(Promise.all(o.map(function(e){return i.fetchAvailability(e.level,e.row,e.col,{signal:r})})),r);case 8:e.next=14;break;case 10:return e.next=12,this._populateElevationTiles(t,r);case 12:if(t.allElevationTilesFetched()){e.next=14;break}throw t.clearElevationTiles(),new s.a("elevation-query:has-unavailable-tiles");case 14:e.next=21;break;case 16:return e.prev=16,e.t0=e.catch(4),Object(c.t)(e.t0),e.next=21,this._selectTilesFinestContiguousAt(t,n-1,r);case 21:case"end":return e.stop()}},e,this,[[4,16]])})),function(e,t,n){return l.apply(this,arguments)})},{key:"_populateElevationTiles",value:(i=a(regeneratorRuntime.mark(function e(t,n){var r,i,l,s,u;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.getTilesToFetch(),i={},l=t.options.cache,s=t.options.noDataValue,u=r.map(function(){var e=a(regeneratorRuntime.mark(function e(r){var a,u,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(a="".concat(t.layer.uid,":").concat(r.id,":").concat(s),u=Object(o.k)(l)?l.get(a):null,!Object(o.k)(u)){e.next=6;break}e.t0=u,e.next=9;break;case 6:return e.next=8,t.layer.fetchTile(r.level,r.row,r.col,{noDataValue:s,signal:n});case 8:e.t0=e.sent;case 9:c=e.t0,Object(o.k)(l)&&l.put(a,c),i[r.id]=new q(r,c);case 11:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()),e.next=3,Object(c.x)(Object(c.j)(u),n);case 3:t.populateElevationTiles(i);case 4:case"end":return e.stop()}},e)})),function(e,t){return i.apply(this,arguments)})},{key:"_selectTilesAuto",value:(r=a(regeneratorRuntime.mark(function e(t,n){var r,i,o,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(this._selectTilesAutoFinest(t),this._reduceTilesForMaximumRequests(t),r=t.layer.tilemapCache){e.next=4;break}return e.abrupt("return",this._selectTilesAutoPrefetchUpsample(t,n));case 4:return i=t.getTilesToFetch(),o={},l=i.map(function(){var e=a(regeneratorRuntime.mark(function e(t){var a,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return a={id:null,level:0,row:0,col:0,extent:Object(x.g)()},e.next=3,Object(m.c)(r.fetchAvailabilityUpsample(t.level,t.row,t.col,a,{signal:n}));case 3:!1===(i=e.sent).ok?Object(c.t)(i.error):o[t.id]=a;case 5:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()),e.next=7,Object(c.x)(Promise.all(l),n);case 7:t.remapTiles(o);case 8:case"end":return e.stop()}},e,this)})),function(e,t){return r.apply(this,arguments)})},{key:"_reduceTilesForMaximumRequests",value:function(e){var t=e.layer.tileInfo,n=0,r={},a=function(e){e.id in r?r[e.id]++:(r[e.id]=1,n++)},i=function(e){var t=r[e.id];1===t?(delete r[e.id],n--):r[e.id]=t-1};e.forEachTileToFetch(a,i);for(var o=!0;o&&(o=!1,e.forEachTileToFetch(function(r){n<=e.options.maximumAutoTileRequests||(i(r),t.upsampleTile(r)&&(o=!0),a(r))},i),o););}},{key:"_selectTilesAutoFinest",value:function(e){var t=F(e.layer.tileInfo,e.options.minDemResolution);e.selectTilesAtLOD(t,e.options.maximumAutoTileRequests)}},{key:"_selectTilesAutoPrefetchUpsample",value:(n=a(regeneratorRuntime.mark(function e(t,n){var r,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.layer.tileInfo,e.next=3,this._populateElevationTiles(t,n);case 3:if(a=!1,t.forEachTileToFetch(function(e,t){r.upsampleTile(e)?a=!0:t()}),e.t0=a,!e.t0){e.next=9;break}return e.next=9,this._selectTilesAutoPrefetchUpsample(t,n);case 9:case"end":return e.stop()}},e,this)})),function(e,t){return n.apply(this,arguments)})},{key:"_sampleGeometryWithElevation",value:function(e){e.geometry.coordinates.forEach(function(t){var n=t.elevationTile,r=e.options.noDataValue;if(n){var a=n.sample(t.x,t.y);void 0!==a?r=a:t.elevationTile=null}t.z=r})}},{key:"_extractSampleInfo",value:function(e){var t=e.layer.tileInfo,n=Object(d.f)(t.spatialReference);return e.geometry.coordinates.map(function(r){var a=-1;return r.elevationTile&&r.elevationTile!==e.outsideExtentTile&&(a=t.lodAt(r.elevationTile.tile.level).resolution*n),{demResolution:a}})}}]),e}(),C=function(){function e(){p(this,e)}var t;return v(e,[{key:"export",value:function(){return this._exporter(this.coordinates,this.spatialReference)}},{key:"clone",value:function(t){var n=this,r=new e;return r.geometry=this.geometry,r.spatialReference=this.spatialReference,r.coordinates=t||this.coordinates.map(function(e){return n._cloneCoordinate(e)}),r._exporter=this._exporter,r}},{key:"project",value:(t=a(regeneratorRuntime.mark(function e(t,n){var r,a,i,o,l=this;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.spatialReference.equals(t)){e.next=2;break}return e.abrupt("return",this.clone());case 2:return e.next=4,Object(g.f)([{source:this.spatialReference,dest:t}],{signal:n});case 4:if(r=new h.a({spatialReference:this.spatialReference,points:this.coordinates.map(function(e){return[e.x,e.y]})}),a=Object(g.j)(r,t)){e.next=7;break}return e.abrupt("return",null);case 7:return i=this.coordinates.map(function(e,t){var n=l._cloneCoordinate(e),r=a.points[t];return n.x=r[0],n.y=r[1],n}),o=this.clone(i),e.abrupt("return",(o.spatialReference=t,o));case 9:case"end":return e.stop()}},e,this)})),function(e,n){return t.apply(this,arguments)})},{key:"_cloneCoordinate",value:function(e){return{x:e.x,y:e.y,z:e.z,m:e.m,tile:null,elevationTile:null}}}],[{key:"fromGeometry",value:function(t){var n=new e;if(n.geometry=t,n.spatialReference=t.spatialReference,t instanceof e)n.coordinates=t.coordinates.map(function(e){return n._cloneCoordinate(e)}),n._exporter=function(e,n){var r=t.clone(e);return r.spatialReference=n,r};else switch(t.type){case"point":var r=t,a=r.hasZ,o=r.hasM;n.coordinates=a&&o?[{x:r.x,y:r.y,z:r.z,m:r.m}]:a?[{x:r.x,y:r.y,z:r.z}]:o?[{x:r.x,y:r.y,m:r.m}]:[{x:r.x,y:r.y}],n._exporter=function(e,n){return t.hasM?new f.a(e[0].x,e[0].y,e[0].z,e[0].m,n):new f.a(e[0].x,e[0].y,e[0].z,n)};break;case"multipoint":var l=t,s=l.hasZ,u=l.hasM;n.coordinates=l.points.map(s&&u?function(e){return{x:e[0],y:e[1],z:e[2],m:e[3]}}:s?function(e){return{x:e[0],y:e[1],z:e[2]}}:u?function(e){return{x:e[0],y:e[1],m:e[2]}}:function(e){return{x:e[0],y:e[1]}}),n._exporter=function(e,n){return t.hasM?new h.a({points:e.map(function(e){return[e.x,e.y,e.z,e.m]}),hasZ:!0,hasM:!0,spatiaReference:n}):new h.a(e.map(function(e){return[e.x,e.y,e.z]}),n)};break;case"polyline":var c,p=t,v=[],m=[],d=t.hasZ,x=t.hasM,g=0,b=i(p.paths);try{for(b.s();!(c=b.n()).done;){var k=c.value;if(m.push([g,g+k.length]),g+=k.length,d&&x){var w,R=i(k);try{for(R.s();!(w=R.n()).done;){var T=w.value;v.push({x:T[0],y:T[1],z:T[2],m:T[3]})}}catch(S){R.e(S)}finally{R.f()}}else if(d){var O,_=i(k);try{for(_.s();!(O=_.n()).done;){var j=O.value;v.push({x:j[0],y:j[1],z:j[2]})}}catch(S){_.e(S)}finally{_.f()}}else if(x){var E,A=i(k);try{for(A.s();!(E=A.n()).done;){var q=E.value;v.push({x:q[0],y:q[1],m:q[2]})}}catch(S){A.e(S)}finally{A.f()}}else{var I,D=i(k);try{for(D.s();!(I=D.n()).done;){var C=I.value;v.push({x:C[0],y:C[1]})}}catch(S){D.e(S)}finally{D.f()}}}}catch(S){b.e(S)}finally{b.f()}n.coordinates=v,n._exporter=function(e,n){var r=e.map(t.hasM?function(e){return[e.x,e.y,e.z,e.m]}:function(e){return[e.x,e.y,e.z]}),a=m.map(function(e){return r.slice(e[0],e[1])});return new y.a({paths:a,hasM:t.hasM,hasZ:!0,spatialReference:n})}}return n}}]),e}(),S=function e(t,n){p(this,e),this.layer=t,this.options=n},M=function(e){l(n,e);var t=u(n);function n(e,r,a){var i;return p(this,n),(i=t.call(this,e,a)).outSpatialReference=r,i.type="geometry",i}return v(n,[{key:"selectTilesAtLOD",value:function(e){if(e<0)this.geometry.coordinates.forEach(function(e){return e.tile=null});else{var t=this.layer.tileInfo,n=t.lods[e].level;this.geometry.coordinates.forEach(function(e){e.tile=t.tileAt(n,e.x,e.y)})}}},{key:"allElevationTilesFetched",value:function(){return!this.geometry.coordinates.some(function(e){return!e.elevationTile})}},{key:"clearElevationTiles",value:function(){var e,t=i(this.geometry.coordinates);try{for(t.s();!(e=t.n()).done;){var n=e.value;n.elevationTile!==this.outsideExtentTile&&(n.elevationTile=null)}}catch(r){t.e(r)}finally{t.f()}}},{key:"populateElevationTiles",value:function(e){var t,n=i(this.geometry.coordinates);try{for(n.s();!(t=n.n()).done;){var r=t.value;!r.elevationTile&&r.tile&&(r.elevationTile=e[r.tile.id])}}catch(a){n.e(a)}finally{n.f()}}},{key:"remapTiles",value:function(e){var t,n=i(this.geometry.coordinates);try{for(n.s();!(t=n.n()).done;){var r=t.value;r.tile=e[r.tile.id]}}catch(a){n.e(a)}finally{n.f()}}},{key:"getTilesToFetch",value:function(){var e,t={},n=[],r=i(this.geometry.coordinates);try{for(r.s();!(e=r.n()).done;){var a=e.value,o=a.tile;a.elevationTile||!a.tile||t[o.id]||(t[o.id]=o,n.push(o))}}catch(l){r.e(l)}finally{r.f()}return n}},{key:"forEachTileToFetch",value:function(e){var t,n=i(this.geometry.coordinates);try{var r=function(){var n=t.value;n.tile&&!n.elevationTile&&e(n.tile,function(){return n.tile=null})};for(n.s();!(t=n.n()).done;)r()}catch(a){n.e(a)}finally{n.f()}}}]),n}(S),z=function(e){l(n,e);var t=u(n);function n(e,r,a,i){var o;return p(this,n),(o=t.call(this,e,a)).type="extent",o.elevationTiles=[],o.candidateTiles=[],o.fetchedCandidates=new Set,o.extent=r.intersection(e.fullExtent),o.maskExtents=i,o}return v(n,[{key:"selectTilesAtLOD",value:function(e,t){var n=this._maximumLodForRequests(t),r=Math.min(n,e);r<0?this.candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(r)}},{key:"_maximumLodForRequests",value:function(e){var t=this.layer.tileInfo;if(!e)return t.lods.length-1;for(var n=this.extent,r=t.lods.length-1;r>=0;r--){var a=t.lods[r],i=a.resolution*t.size[1];if(Math.ceil(n.width/(a.resolution*t.size[0]))*Math.ceil(n.height/i)<=e)return r}return-1}},{key:"allElevationTilesFetched",value:function(){return this.candidateTiles.length===this.elevationTiles.length}},{key:"clearElevationTiles",value:function(){this.elevationTiles.length=0,this.fetchedCandidates.clear()}},{key:"populateElevationTiles",value:function(e){var t,n=i(this.candidateTiles);try{for(n.s();!(t=n.n()).done;){var r=t.value,a=e[r.id];a&&(this.fetchedCandidates.add(r),this.elevationTiles.push(a))}}catch(o){n.e(o)}finally{n.f()}}},{key:"remapTiles",value:function(e){this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles.map(function(t){return e[t.id]}))}},{key:"getTilesToFetch",value:function(){return this.candidateTiles}},{key:"forEachTileToFetch",value:function(e,t){var n=this,r=this.candidateTiles;this.candidateTiles=[],r.forEach(function(r){if(n.fetchedCandidates.has(r))t&&t(r);else{var a=!1;e(r,function(){return a=!0}),a?t&&t(r):n.candidateTiles.push(r)}}),this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles,t)}},{key:"_uniqueNonOverlappingTiles",value:function(e,t){var n,r={},a=[],o=i(e);try{for(o.s();!(n=o.n()).done;){var l=n.value;r[l.id]?t&&t(l):(r[l.id]=l,a.push(l))}}catch(u){o.e(u)}finally{o.f()}var s=a.sort(function(e,t){return e.level-t.level});return s.filter(function(e,n){for(var r=0;r<n;r++)if(Object(x.d)(s[r].extent,e.extent))return t&&t(e),!1;return!0})}},{key:"_selectCandidateTilesCoveringExtentAt",value:function(e){this.candidateTiles.length=0;for(var t=this.layer.tileInfo,n=t.lods[e],r=this.extent,a=t.tileAt(n.level,r.xmin,r.ymin),i=n.resolution*t.size[1],o=Math.ceil((r.xmax-a.extent[0])/(n.resolution*t.size[0])),l=Math.ceil((r.ymax-a.extent[1])/i),s=0;s<l;s++)for(var u=0;u<o;u++){var c={id:null,level:a.level,row:a.row-s,col:a.col+u};t.updateTileInfo(c),this._tileIsMasked(c)||this.candidateTiles.push(c)}}},{key:"_tileIsMasked",value:function(e){return!!this.maskExtents&&this.maskExtents.some(function(t){return Object(x.d)(t,e.extent)})}}]),n}(S);function F(e,t){var n=e.lods.length-1;if(t>0){var r=e.lods.findIndex(function(e){return e.resolution<t});0===r?n=0:r>0&&(n=r-1)}return n}var P={maximumAutoTileRequests:20,noDataValue:0,returnSampleInfo:!1,demResolution:"auto",minDemResolution:0};n.default=D}}])}();